@model TRS2._0.Models.ViewModels.AdminIndexViewModel

@{
    ViewData["Title"] = "Admin Dashboard";
}

<h1 class="text-center my-4">Admin Dashboard</h1>

<div class="container">
    <!-- Primera fila: Trabajos Automatizados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Trabajos Automatizados</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap">
                        <h4>Orden: Proyectos, Grupos de Personal, Personal, Lideres, Dedicaciones y Afiliaciones, Carga de Out of Contract Liquidaciones, Bajas y Vacaciones, Generacion PM Mensuales </h4>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaProyectos')">Proyectos</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaGruposPersonas')">Grupos de Personas</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaPersonal')">Carga de Personal</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaLideres')">Líderes</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaAfiliacionesYDedicaciones')">Afiliaciones y Dedicaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/Liquidaciones')">Liquidaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/ProcesaLiquidaciones')">Procesar Liquidaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/ProcesoLiquidacionesAvd')">Procesar Liquidaciones Adv</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/UpdateLeaveTable')">Ausencias y Vacaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/Carga')">PMs Mensuales</button>      
                        <button class="btn btn-success m-2" onclick="triggerJob('/AdjustGlobalEffort')">Ajuste de Effort Global</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda fila: Visor de Logs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4>Visor de Logs</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="logFileSelect" class="form-label">Seleccionar Archivo de Log:</label>
                        <select id="logFileSelect" class="form-select" onchange="loadLogFile()">
                            <option value="">Cargando archivos de log...</option>
                        </select>
                    </div>
                    <div id="logContent" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa;">
                        <p>Seleccione un archivo de log para visualizar su contenido...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera fila: Cargar Excel y Generar PM -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h4>Seleccionar Carpeta para Cargar Excel</h4>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <button id="selectFolderButton" class="btn btn-primary">Seleccionar Carpeta</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h4>Generar Valores PM</h4>
                </div>
                <div class="card-body">
                    <form asp-action="GeneratePMValues" method="post" class="row g-3">
                        <div class="col-md-6">
                            <label for="year" class="form-label">Año</label>
                            <input type="number" name="year" class="form-control" placeholder="Year" required />
                        </div>
                        <div class="col-md-6">
                            <label for="month" class="form-label">Mes</label>
                            <input type="number" name="month" class="form-control" placeholder="Month" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Generar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Cuarta fila: Valores PM Diarios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Valores PM Diarios</h4>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Año</th>
                                <th>Mes</th>
                                <th>Días Laborables</th>
                                <th>PM por Día</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var pm in Model.DailyPMValues.OrderBy(pm => pm.Year).ThenBy(pm => pm.Month))
                            {
                                <tr>
                                    <td>@pm.Year</td>
                                    <td>@pm.Month</td>
                                    <td>@pm.WorkableDays</td>
                                    <td>@pm.PmPerDay</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quinta fila: Calcular PM Diario y Mensual -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light text-dark">
                    <h4>Calcular PM Diario</h4>
                </div>
                <div class="card-body">
                    <form asp-action="CalculateDailyPM" method="post" class="row g-3">
                        <div class="col-8">
                            <label for="personId" class="form-label">Persona</label>
                            <select name="personId" class="form-select" required>
                                @foreach (var person in Model.People)
                                {
                                    <option value="@person.Value">@person.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="date" class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Calcular</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light text-dark">
                    <h4>Calcular PM Mensual</h4>
                </div>
                <div class="card-body">
                    <form asp-action="CalculateMonthlyPM" method="post" class="row g-3">
                        <div class="col-8">
                            <label for="personId" class="form-label">Persona</label>
                            <select name="personId" class="form-select" required>
                                @foreach (var person in Model.People)
                                {
                                    <option value="@person.Value">@person.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="date" class="form-label">Mes</label>
                            <input type="month" name="date" class="form-control" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Calcular</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sexta fila: Gestionar Roles -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4>Gestionar Roles de Usuario</h4>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Nombre de Usuario</th>
                                <th>Rol</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.Users)
                            {
                                <tr>
                                    <td>@user.Text</td>
                                    <td>
                                        <form asp-action="AssignRole" method="post" class="d-flex align-items-center">
                                            <input type="hidden" name="userId" value="@user.Value" />
                                            <select name="role" class="form-select mx-2">
                                                @foreach (var role in Model.Roles)
                                                {
                                                    <option value="@role.Value">@role.Text</option>
                                                }
                                            </select>
                                            <button type="submit" class="btn btn-primary">Asignar</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Séptima fila: Ajuste de Esfuerzo -->
    <div class="container">
        <h3 class="text-center">Ajuste de Esfuerzo</h3>
        <form id="effort-adjustment-form">
            <div class="form-group">
                <label for="project-select">Proyecto:</label>
                <select id="project-select" class="form-control" onchange="loadWorkPackages()">
                    <option value="">Seleccione un proyecto</option>
                </select>
            </div>
            <div class="form-group">
                <label for="wp-select">Paquete de Trabajo:</label>
                <select id="wp-select" class="form-control" onchange="loadPersons()" disabled>
                    <option value="">Seleccione un paquete de trabajo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="person-select">Persona:</label>
                <select id="person-select" class="form-control" disabled>
                    <option value="">Seleccione una persona</option>
                </select>
            </div>
            <div class="form-group">
                <label for="month-input">Mes:</label>
                <input type="month" id="month-input" class="form-control" />
            </div>
            <button type="button" class="btn btn-primary" onclick="adjustEffort()">Ajustar Esfuerzo</button>
        </form>
    </div>

    <!-- Octava fila: Ajustar Timesheets por Rango de Fechas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>Ajustar Timesheets por Rango de Fechas</h4>
                </div>
                <div class="card-body">
                    <form id="adjust-timesheets-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Fecha de Inicio</label>
                                <input type="month" id="startDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Fecha de Fin</label>
                                <input type="month" id="endDate" name="endDate" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <button type="button" id="submitAdjustTimesheets" class="btn btn-primary w-100">
                                    Ejecutar Proceso
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Novena fila: Generar Informe de Ajustes de Timesheets -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Generar Informe de Ajustes de Timesheets</h4>
                </div>
                <div class="card-body">
                    <form id="generateReportForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="reportStartDate" class="form-label">Fecha de Inicio</label>
                                <input type="month" id="reportStartDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="reportEndDate" class="form-label">Fecha de Fin</label>
                                <input type="month" id="reportEndDate" name="endDate" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <button type="button" id="downloadReportBtn" class="btn btn-success w-100">
                                    Descargar Informe
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cargar lista de archivos de logs al iniciar la página
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/Admin/GetLogFiles')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const logFileSelect = document.getElementById('logFileSelect');
                    logFileSelect.innerHTML = ''; // Limpia opciones anteriores
                    if (data.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No hay archivos disponibles';
                        logFileSelect.appendChild(option);
                    } else {
                        data.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file;
                            option.textContent = file;
                            logFileSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    alert(`Error al cargar archivos de log: ${error.message}`);
                });
        });

        // Cargar contenido del archivo seleccionado
        function loadLogFile() {
            const selectedFile = document.getElementById('logFileSelect').value;
            fetch(`/Admin/GetLogFileContent?fileName=${selectedFile}`)
                .then(response => response.text())
                .then(content => {
                    document.getElementById('logContent').innerText = content;
                });

            // Actualización en tiempo real
            setInterval(() => {
                fetch(`/Admin/GetLogFileContent?fileName=${selectedFile}`)
                    .then(response => response.text())
                    .then(content => {
                        document.getElementById('logContent').innerText = content;
                    });
            }, 5000); // Actualiza cada 5 segundos
        }

        // Ejecutar un trabajo
        function triggerJob(endpoint) {
            fetch(endpoint, { method: 'GET' })
                .then(response => response.text())
                .then(message => alert(message))
                .catch(error => alert(`Error triggering job: ${error.message}`));
        }

        // Selección de carpeta para carga de Excel
        document.getElementById('selectFolderButton').addEventListener('click', function () {
            var input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.directory = true;
            input.multiple = true;
            input.addEventListener('change', function (event) {
                var files = event.target.files;
                var folderPath = files[0].webkitRelativePath.split('/')[0];
                fetch('/Admin/ProcessFolder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderPath: folderPath })
                }).then(response => response.json())
                    .then(data => console.log(data));
            });
            input.click();
        });

        async function loadProjects() {
            const response = await fetch('/Admin/GetProjects');
            const projects = await response.json();
            const select = document.getElementById('project-select');
            projects.sort((a, b) => a.acronim.localeCompare(b.acronim)); // Orden alfabético
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.projId;
                option.textContent = project.acronim;
                select.appendChild(option);
            });
        }

        async function loadWorkPackages() {
            const projectId = document.getElementById('project-select').value;
            if (!projectId) return;

            const response = await fetch(`/Admin/GetWorkPackages?projectId=${projectId}`);
            const workPackages = await response.json();
            const select = document.getElementById('wp-select');
            select.innerHTML = '<option value="">Seleccione un paquete de trabajo</option>';
            workPackages.sort((a, b) => a.name.localeCompare(b.name)); // Orden alfabético
            workPackages.forEach(wp => {
                const option = document.createElement('option');
                option.value = wp.id;
                option.textContent = wp.name;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        async function loadPersons() {
            const wpId = document.getElementById('wp-select').value;
            if (!wpId) return;

            const response = await fetch(`/Admin/GetPersonsInWorkPackage?wpId=${wpId}`);
            const persons = await response.json();
            const select = document.getElementById('person-select');
            select.innerHTML = '<option value="">Seleccione una persona</option>';
            persons.sort((a, b) => a.surname.localeCompare(b.surname)); // Orden alfabético por apellido
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person.person;
                option.textContent = `${person.surname}, ${person.name}`;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        async function adjustEffort() {
            const wpId = parseInt(document.getElementById('wp-select').value);
            const personId = parseInt(document.getElementById('person-select').value);
            const month = document.getElementById('month-input').value;

            if (!wpId || !personId || !month) {
                alert('Por favor, complete todos los campos.');
                return;
            }

            // Convertimos el mes al formato esperado por el backend
            const formattedMonth = `${month}-01T00:00:00`;

            const response = await fetch('/Admin/AdjustEffort', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wpId, personId, month: formattedMonth })
            });

            const result = await response.json();
            alert(result.message);
        }

            document.getElementById('submitAdjustTimesheets').addEventListener('click', async function () {
                const startDateInput = document.getElementById('startDate').value;
                const endDateInput = document.getElementById('endDate').value;
                console.log(startDateInput, endDateInput);
                if (!startDateInput || !endDateInput) {
                    alert('Por favor, complete las fechas de inicio y fin.');
                    return;
                }

                // Convertir los valores del campo "month" a fechas completas
                const startDate = new Date(startDateInput + '-01'); // Añadir el día para crear una fecha válida
                const endDate = new Date(endDateInput + '-01'); // Igual que arriba
                console.log(startDate, endDate);
                const response = await fetch('/Admin/AutoFillTimesheetsByDateRange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    })
                });

                const result = await response.json();
                alert(result.message);
            });


        document.getElementById('downloadReportBtn').addEventListener('click', async function () {
            const startDateInput = document.getElementById('reportStartDate').value;
            const endDateInput = document.getElementById('reportEndDate').value;

            console.log(startDateInput, endDateInput);

            if (!startDateInput || !endDateInput) {
                alert('Por favor, complete las fechas de inicio y fin.');
                return;
            }

            // Convertir los valores del campo "month" a fechas completas
            const startDate = new Date(startDateInput + '-01'); // Agregar el día para crear una fecha válida
            const endDate = new Date(endDateInput + '-01'); // Mismo proceso

            console.log("Fechas procesadas:", startDate, endDate);

            try {
                const response = await fetch('/Admin/GenerateAdjustmentReport', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al generar el informe.');
                }

                // Convertir la respuesta en un Blob y descargar el archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Ajustes_Timesheets.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();

                console.log("Informe descargado exitosamente.");
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al descargar el informe.');
            }
        });
    


        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
}
