@model IEnumerable<TRS2._0.Models.DataModels.Personnel>

@{
    ViewData["Title"] = "Travels";
    var selectedPersonId = ViewBag.SelectedPersonId;
}

<div class="container personnel-ux personnel-travels-ux">
<h2 class="personnel-page-title">Travel Management</h2>

<div class="personnel-filter-shell">
<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h3 class="text-primary">Select a Person</h3>
            <select id="personnelSelect" class="form-control mb-3">
                <option value="">Select a person from the list</option>
                @foreach (var person in Model)
                {
                    <option value="@person.Id">@person.Name @person.Surname</option>
                }
            </select>

            <p class="text-secondary">Or search for a name:</p>
            <input type="text" id="searchTerm" class="form-control mb-2" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <div id="searchResults" class="border rounded p-2 bg-light"></div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h3 class="text-primary">Person Details</h3>
            <div id="personDetails" class="card bg-light shadow-sm p-3">
                <!-- Aquí se cargarán los detalles del personal -->
                <p class="text-muted text-center">Select a person to view details</p>
            </div>
        </div>
    </div>
</div>
</div>

<hr />

<div id="travelsTableContainer" class="mt-4 personnel-data-shell">
    <!-- Tabla de viajes se cargará aquí -->
</div>
</div>

@section Scripts {
    <script>
        document.getElementById('personnelSelect').addEventListener('change', function () {
            var personId = this.value;
            fetchPersonDetails(personId);
            loadTravelData(personId);
        });

        function filterPersonnel() {
            var searchTerm = document.getElementById('searchTerm').value;

            $.ajax({
                url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    if (!data || data.length === 0) {
                        resultsDiv.innerHTML = '<p>No matches found.</p>';
                        return;
                    }

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result shadow-sm p-2 mb-2 bg-white rounded';
                        personDiv.textContent = `${person.name} ${person.surname}`;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');

                            fetchPersonDetails(person.id);
                            loadTravelData(person.id);
                        };

                        resultsDiv.appendChild(personDiv);
                    });

                    resultsDiv.style.display = 'block'; // Mostrar resultados
                },
                error: function (error) {
                    console.error("Error in filterPersonnel:", error);
                }
            });
        }

        function fetchPersonDetails(personId) {
            $.ajax({
                url: '@Url.Action("GetPersonDetails", "Personnels")',
                data: { id: personId },
                success: function (response) {
                    var detailsDiv = document.getElementById('personDetails');
                    detailsDiv.innerHTML = '';
                    if (response.success) {
                        var data = response.data;
                        detailsDiv.innerHTML = '<div class="card-body">' +
                            `<h5 class="card-title">${data.fullName || ''}</h5>` +
                            `<p><span class="card-detail-label">Affiliation:</span> ${data.affiliation || ''}</p>` +
                            `<p><span class="card-detail-label">Department:</span> ${data.departmentName || ''}</p>` +
                            `<p><span class="card-detail-label">Group:</span> ${data.personnelGroupName || ''}</p>` +
                            `<p><span class="card-detail-label">Group Leader:</span> ${data.responsiblePerson || ''}</p>` +
                            `<p><span class="card-detail-label">Contract Start:</span> ${data.startDate || ''}</p>` +
                            `<p><span class="card-detail-label">Contract End:</span> ${data.endDate || ''}</p>` +
                            '</div>';
                    } else {
                        detailsDiv.innerHTML = '<p class="text-danger text-center">Person details not found.</p>';
                    }
                },
                error: function (error) {
                    console.error("Error in fetchPersonDetails:", error);
                }
            });
            document.getElementById('searchResults').style.display = 'none';
        }

        function loadTravelData(personId) {
            $.ajax({
                url: '@Url.Action("GetTravelData", "Personnels")',
                data: { personId: personId },
                success: function (response) {
                    if (!response.success) {
                        alert(response.message);
                        return;
                    }

                    var data = response.data;
                    var tableHtml = '<table class="table table-hover table-bordered shadow">';
                    tableHtml += '<thead class="thead-dark"><tr>';
                    tableHtml += '<th>#</th>';
                    tableHtml += '<th>Code</th>';
                    tableHtml += '<th>Start Date</th>';
                    tableHtml += '<th>End Date</th>';
                    tableHtml += '<th>Project 1</th>';
                    tableHtml += '<th>Dedication 1</th>';
                    tableHtml += '<th>Project 2</th>';
                    tableHtml += '<th>Dedication 2</th>';
                    tableHtml += '<th>Status</th>';
                    tableHtml += '<th>Actions</th>';
                    tableHtml += '</tr></thead>';
                    tableHtml += '<tbody>';

                    data.forEach(function (item, index) {
                        tableHtml += '<tr>';
                        tableHtml += `<td>${index + 1}</td>`;
                        tableHtml += `<td>${item.code}</td>`;
                        tableHtml += `<td>${item.startDate.split('T')[0]}</td>`;
                        tableHtml += `<td>${item.endDate.split('T')[0]}</td>`;
                        tableHtml += `<td>${item.project1 || ''}</td>`;
                        tableHtml += `<td>${item.dedication1 || ''}</td>`;
                        tableHtml += `<td>${item.project2 || ''}</td>`;
                        tableHtml += `<td>${item.dedication2 || ''}</td>`;
                        tableHtml += `<td class="${item.status === "Approved" ? 'text-success' : 'text-danger'}">${item.status}</td>`;

                        if (item.status === "Pending") {
                            tableHtml += `<td><button class="btn btn-success btn-sm mx-1" onclick="approveTravel('${item.code}')">Approve</button>`;
                            tableHtml += `<button class="btn btn-danger btn-sm mx-1" onclick="cancelTravel('${item.code}')">Cancel</button></td>`;
                        } else if (item.status === "Approved") {
                            tableHtml += `<td><button class="btn btn-danger btn-sm mx-1" onclick="cancelTravel('${item.code}')">Cancel</button></td>`;
                        } else {
                            tableHtml += '<td></td>';
                        }

                        tableHtml += '</tr>';
                    });

                    tableHtml += '</tbody></table>';
                    $('#travelsTableContainer').html(tableHtml);
                },
                error: function (error) {
                    console.error("Error loading travel data", error);
                }
            });
        }

        function approveTravel(travelId) {
            if (confirm('Are you sure you want to approve this travel?')) {
                $.post('@Url.Action("ApproveTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    var personId = $('#personnelSelect').val();
                    loadTravelData(personId);
                });
            }
        }

        function cancelTravel(travelId) {
            if (confirm('Are you sure you want to cancel this travel?')) {
                $.post('@Url.Action("CancelTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    var personId = $('#personnelSelect').val();
                    loadTravelData(personId);
                });
            }
        }
    </script>
}


<style>
    /* General styles */
    h2, h3 {
        font-weight: bold;
        text-align: center;
    }

    .text-primary {
        color: #007bff;
    }

    .text-secondary {
        color: #6c757d;
    }

    .text-success {
        color: #28a745;
        font-weight: bold;
    }

    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }

    .text-muted {
        color: #6c757d;
    }

    /* Search results container */
    #searchResults {
        max-height: 200px; 
        overflow-y: auto;
        background-color: #f8f9fa; 
        border: 1px solid #ddd; 
        border-radius: 5px; 
        padding: 10px;
        display: none;
    }

    .person-result {
        cursor: pointer;
        padding: 5px 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
    }

    .person-result:hover {
        background-color: #007bff;
        color: white;
    }

    .person-result.active {
        background-color: #0056b3;
        color: white;
    }

    /* Card styles */
    .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: none;
        background: linear-gradient(145deg, #ffffff, #e6e6e6);
        border-radius: 8px;
    }

    .card-body {
        padding: 20px;
    }

    .card-title {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .card-detail-label {
        font-weight: bold;
    }

    /* Table styles */
    .table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    .table th {
        background-color: #343a40;
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 14px;
    }

    .table td {
        text-align: center;
        padding: 8px;
        vertical-align: middle;
        font-size: 13px;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    .table-bordered {
        border: 1px solid #ddd;
    }

    .table-bordered td, .table-bordered th {
        border: 1px solid #ddd;
    }

    /* Button styles */
    .btn {
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.3s ease-in-out;
    }

    .btn-success {
        background-color: #28a745;
        border: none;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        border: none;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
        color: white;
    }

    .btn-sm {
        font-size: 11px;
    }

    /* Enhanced hover effect for buttons */
    .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Container spacing */
    .container {
        padding: 20px;
    }

    /* Highlighted table row */
    .table tbody tr td {
        transition: background-color 0.3s ease-in-out;
    }

    .table tbody tr:hover td {
        background-color: #f8f9fa;
    }

    
    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .card-title {
            font-size: 1.2rem;
        }

        .btn {
            font-size: 10px;
            padding: 4px 8px;
        }

        .table th, .table td {
            font-size: 12px;
        }
    }
</style>

