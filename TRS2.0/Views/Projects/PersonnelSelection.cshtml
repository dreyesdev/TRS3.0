@model TRS2._0.Models.ViewModels.ProjectPersonnelViewModel

@{
    ViewData["Title"] = "Personnel Selection";
    var orderedWorkPackages = Model.WorkPackages
        .OrderBy(wp => wp.Name.Equals("travels", StringComparison.OrdinalIgnoreCase))
        .ThenBy(wp => wp.Name)
        .ToList();
}

<div class="container mt-3 projects-ux projects-selection-ux">
    <div class="row">
        <!-- Detalles del proyecto -->
        <div class="col-md-6">
            <div class="card project-details-card">
                <div class="card-header text-center">Project Details</div>
                <div class="card-body">
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Acronym</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Acronim)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Title</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Title)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Contract</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Contract)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Start Date</dt>
                        <dd class="col-sm-8">@(Model.ProjectDetails.Start?.ToString("dd-MM-yyyy") ?? string.Empty)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">End Date</dt>
                        <dd class="col-sm-8">@(Model.ProjectDetails.End?.ToString("dd-MM-yyyy") ?? string.Empty)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Project Investigator</dt>
                        <dd class="col-sm-8">@ViewBag.PiFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Project Manager</dt>
                        <dd class="col-sm-8">@ViewBag.PmFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Finance Manager</dt>
                        <dd class="col-sm-8">@ViewBag.FmFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Type</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Type)</dd>
                    </dl>

                    <div class="card mt-4">
                        <div class="card-header">Third Parties</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="upcCheck" disabled @(Model.ProjectDetails.TpsUpc == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="upcCheck">UPC</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="icreaCheck" disabled @(Model.ProjectDetails.TpsIcrea == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="icreaCheck">ICREA</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="csicCheck" disabled @(Model.ProjectDetails.TpsCsic == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="csicCheck">CSIC</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Selección de personal -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header text-center">Person Selection</div>
                <div class="card-body">
                    <select id="personnelSelect" class="form-control mb-2">
                        <option value="">Please select a person from the list below:</option>
                        @foreach (var person in Model.AllPersonnel.OrderBy(p => p.Surname).ThenBy(p => p.Name))
                        {
                            <option value="@person.Id">@person.Surname, @person.Name</option>
                        }
                    </select>
                    <p class="mb-1">Or start typing here the name of the person:</p>
                    <input type="text" id="searchTerm" class="form-control mb-2" placeholder="Start typing..." onkeyup="filterPersonnel()" />
                    <div id="searchResults" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <hr />
                <div class="card mt-3">
                    <div class="card-header text-center">Person Details</div>
                    <div id="personDetails" class="card-body"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr />
<h3 class="text-center my-style">Personnel in Work Packages</h3>
<div class="container-fluid mt-4 projects-ux projects-selection-table-ux">
    <div class="row">
        <div class="col-md-12">
            <div class="project-personnel-wrapper">
                <table class="table table-bordered sticky-table">
                    <thead>
                        <tr>
                            <th class="sticky-header sticky-col name-column">People involved in @Model.ProjectDetails.Acronim project</th>
                            @foreach (var wp in orderedWorkPackages)
                            {
                                <th class="sticky-header wp-column">@wp.Name</th>
                            }
                            <th class="sticky-header action-column">
                                <button id="updateAllButton" class="btn btn-success" onclick="updateAll()">Update All</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var person in Model.ProjectPersonnel.Select(px => px.PersonNavigation).OrderBy(p => p.Surname))
                        {
                            <tr>
                                <td class="name-column sticky-col">@($"{person.Surname}, {person.Name}")</td>
                                @foreach (var wp in orderedWorkPackages)
                                {
                                    bool isAssigned = Model.WorkPackagePersonnel.Any(wpx => wpx.Wp == wp.Id && wpx.Person == person.Id);
                                    <td class="wp-column">
                                        <input class="wp-checkbox" type="checkbox"
                                        @(isAssigned ? "checked" : "")
                                               data-checked-original="@(isAssigned ? "true" : "false")"
                                               data-wp-id="@wp.Id"
                                               data-person-id="@person.Id" />
                                    </td>
                                }
                                <td class="action-column">
                                    <button onclick="removeFromProject(@person.Id)" class="btn btn-danger">Remove</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>






    @section Scripts {
        <script>
            document.getElementById('personnelSelect').addEventListener('change', function () {
                var personId = this.value;
                fetchPersonDetails(personId);
            });

                function filterPersonnel() {
                    var searchTerm = document.getElementById('searchTerm').value;

                    $.ajax({
                        url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                        data: { searchTerm: searchTerm },
                        success: function (data) {
                            var resultsDiv = document.getElementById('searchResults');
                            resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                            // Asume que el servidor ya limita los resultados a 10
                            data.forEach(function (person, index) {
                                if (index < 10) { // Esta comprobación es redundante si el servidor limita los resultados
                                    var personDiv = document.createElement('div');
                                    personDiv.className = 'person-result';
                                    personDiv.textContent = person.name + ' ' + person.surname;
                                    personDiv.setAttribute('data-person-id', person.id);

                                    personDiv.onclick = function () {
                                        // Marcar el resultado seleccionado como activo y limpiar los demás
                                        document.querySelectorAll('.person-result').forEach(function (el) {
                                            el.classList.remove('active');
                                        });
                                        this.classList.add('active');

                                        fetchPersonDetails(person.id);
                                    };

                                    resultsDiv.appendChild(personDiv);
                                }
                            });
                        }
                    });
                    document.getElementById('searchResults').style.display = 'block';
                }

                function fetchPersonDetails(personId) {
                    $.ajax({
                        url: '@Url.Action("GetPersonDetails", "Personnels")',
                        data: { id: personId },
                        success: function (response) {
                            var detailsDiv = document.getElementById('personDetails');
                            detailsDiv.innerHTML = '';
                            if (response.success) {
                                var data = response.data;
                                detailsDiv.innerHTML = `<div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.5em;">${data.fullName || ''}</h5>
                                    <p><span class="card-detail-label">Affiliation:</span> ${data.affiliation || ''}</p>
                                    <p><span class="card-detail-label">Department:</span> ${data.departmentName || ''}</p>
                                    <p><span class="card-detail-label">Group:</span> ${data.personnelGroupName || ''}</p>
                                    <p><span class="card-detail-label">Group Leader:</span> ${data.responsiblePerson || ''}</p>
                                    <p><span class="card-detail-label">Category:</span> ${data.category || ''}</p>
                                    <p><span class="card-detail-label">Contract Start:</span> ${data.startDate || ''}</p>
                                    <p><span class="card-detail-label">Contract End:</span> ${data.endDate || ''}</p>
                                                    <div class="text-align: center">
                                        <button onclick="addToProject(${personId})" class="btn btn-primary" style="margin-right: 50px;">Add to Project</button>
                                        <!-- El botón de Eliminar se añadirá aquí, condicionalmente -->
                                    </div>
                                </div>`;
                            } else {
                                detailsDiv.innerHTML = '<p>Person details not found.</p>';
                            }
                        }
                    });
                }


            function addToProject(personId) {
                var projectId = @Model.ProjectDetails.ProjId;
                $.ajax({
                    url: '@Url.Action("AddPersonToProject", "Projects")', // Asegúrate de que este endpoint y el nombre del controlador son correctos
                    type: 'POST',
                    data: { projectId: projectId, personId: personId },
                    success: function (response) {
                        if (response.success) {
                            // Aquí puedes agregar una notificación o actualizar la vista como necesites
                            alert(response.message);
                            location.reload();
                        } else {
                        alert(response.message);
                        }
                    }
                });
            }

            function removeFromProject(personId) {
                var projectId = @Model.ProjectDetails.ProjId;
                if (confirm("Are you sure you want to remove this person from the project?")) {
                    $.ajax({
                        url: '@Url.Action("RemovePersonFromProject", "Projects")', // Cambia el nombre del controlador y la acción según tu configuración
                        type: 'POST',
                        data: { projectId: projectId, personId: personId },
                        success: function (response) {
                            if (response.success) {
                                alert("Person removed from the project successfully.");
                                location.reload();
                            } else {
                                alert("There was a problem removing the person from the project.");
                            }
                        }
                    });
                }
            }

            function updateAll() {
                var changes = [];
                document.querySelectorAll('.wp-checkbox').forEach(function (checkbox) {
                    var originalState = checkbox.getAttribute('data-checked-original') === 'true';
                    if (checkbox.checked !== originalState) {
                        changes.push({
                            WpId: parseInt(checkbox.getAttribute('data-wp-id')),
                            PersonId: parseInt(checkbox.getAttribute('data-person-id'))
                        });
                    }
                });

                // Envía esta lista al controlador
                $.ajax({
                    url: '@Url.Action("UpdateWorkPackageAssignments", "Projects")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(changes),
                    success: function (response) {
                        // Procesar la respuesta
                        if (response.success) {
                            alert("Work package assignments updated successfully.");
                            location.reload();
                        } else {
                            alert("There was a problem updating the assignments.");
                        }
                    },
                    error: function (error) {
                        // Manejar el error
                        alert("An error occurred while updating the assignments.");
                    }
                });
            }

                document.addEventListener('click', function (event) {
                    var searchResults = document.getElementById('searchResults');
                    var searchTerm = document.getElementById('searchTerm');
                    if (!searchResults.contains(event.target) && !searchTerm.contains(event.target)) {
                        searchResults.style.display = 'none'; // Contraer la lista
                    }
                });

                document.getElementById('searchResults').addEventListener('click', function (event) {
                    if (event.target && event.target.matches('div.person-result')) {
                        var personName = event.target.textContent;
                        var personnelSelect = document.getElementById('personnelSelect');
                        // Actualiza el selector con el nombre de la persona seleccionada
                        personnelSelect.value = '';
                        personnelSelect.options[personnelSelect.options.length] = new Option(personName, event.target.getAttribute('data-person-id'), true, true);
                        // Contraer la lista después de seleccionar una persona
                        document.getElementById('searchResults').style.display = 'none';
                        // Opcional: Llama a fetchPersonDetails si necesitas cargar detalles en la tarjeta de detalles
                        fetchPersonDetails(event.target.getAttribute('data-person-id'));
                    }
                });

                
        </script>
    }

<style>
     .project-personnel-wrapper {
         max-height: 600px;
         overflow: auto;
         border: 1px solid #ccc;
         position: relative;
         background-color: white;
     }

     .sticky-table {
         border-collapse: separate;
         border-spacing: 0;
         width: max-content;
         min-width: 100%;
     }

         .sticky-table th,
         .sticky-table td {
             min-width: 120px;
             padding: 8px;
             text-align: center;
             border: 1px solid #dee2e6;
             background-color: white;
         }

         .sticky-table .sticky-header {
             position: sticky;
             top: 0;
             background-color: var(--blue-dark);
             color: white;
             z-index: 10;
         }

         .sticky-table .sticky-col {
             position: sticky;
             left: 0;
             background-color: #f8f9fa;
             z-index: 9;
         }

         .sticky-table .sticky-header.sticky-col {
             z-index: 11;
             background-color: #003366;
             color: white;
         }

     .name-column {
         min-width: 200px;
         max-width: 250px;
         font-weight: bold;
     }

     .wp-column {
         min-width: 60px;
         max-width: 80px;
     }

     .action-column {
         min-width: 100px;
         background-color: #f8f9fa;
     }

     .wp-checkbox {
         width: 25px;
         height: 25px;
         cursor: pointer;
         margin: auto;
         display: block;
     }

     .card-header {
         background-color: #005A9C;
         color: #FFFFFF;
         text-align: center;
         font-weight: bold;
         font-size: 24px;
     }

     .my-style {
         font-size: 2.5rem;
         font-weight: bold;
         color: #0056b3;
         text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
     }

     .detail-item:not(:last-child) {
         border-bottom: 1px solid #dee2e6;
         padding-bottom: 5px;
         margin-bottom: 5px;
     }
</style>








