@model TRS2._0.Models.ViewModels.ReportPeriodViewModel

@{
    ViewData["Title"] = "ProjectReport";
    // Inicializa las sumas de las columnas
    decimal totalEstimated = 0;
    decimal totalDistributed = 0;
    decimal totalCovered = 0;
    // Asume valores predeterminados o maneja el caso de null según sea necesario
    var startProject = Model.Project.Start ?? DateTime.Today; // Usar la fecha actual como valor por defecto
    var endProject = Model.Project.EndReportDate; // Usar la fecha actual como valor por defecto    
    int index = 1; // Inicializa el contador
    
}
<script src="~/lib/jquery/dist/jquery.min.js"></script>




<div class="container mt-3 projects-ux projects-report-ux">
    <div class="row">
        <!-- Encapsula los detalles del proyecto en una tarjeta -->
        <div class="col-md-6">
            <div class="card project-details-card">
                <div class="card-header text-center">
                    Project Details
                </div>
                <div class="card-body">
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Acronym</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Acronim)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Title</dt>
                            <dd class="col-sm-8">@Html.DisplayFor(model => model.Project.Title)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Contract</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Contract)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Start Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.Project.Start.HasValue ? Model.Project.Start.Value.ToString("dd-MM-yyyy") : string.Empty)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">End Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.Project.EndReportDate.ToString("dd-MM-yyyy"))</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Investigator</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PiFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Finance Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.FmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Type</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Type)</dd>
                        </div>
                    </dl>

                    <!-- Tarjeta para Third Parties -->
                    <div class="card mt-4">
                        <div style="text-align: center; background-color: black; color: white; font-size: 24px; font-weight: bold;">
                            Third Parties
                        </div>

                        <div class="card-body">
                            <div class="row">
                                <!-- Cada tick en su propia columna dentro de esta fila -->
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="upcCheck" disabled @((Model.Project.TpsUpc == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="upcCheck">UPC</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="icreaCheck" disabled @((Model.Project.TpsIcrea == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="icreaCheck">ICREA</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="csicCheck" disabled @((Model.Project.TpsCsic == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="csicCheck">CSIC</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header" style="text-align: center;">
                    Work Packages Details
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="text-align: center; background-color: black; color: white;">Name</th>
                                <th style="text-align: center; background-color: black; color: white;">Estimated</th>
                                <th style="text-align: center; background-color: black; color: white;">Distributed</th>
                                <th style="text-align: center; background-color: black; color: white;">Covered with Personnel</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var wp in ((IEnumerable<dynamic>)ViewBag.WpDetails)
                                .OrderBy(w => string.Equals((string)w.Name, "TRAVELS", StringComparison.OrdinalIgnoreCase) ? 1 : 0)
                                .ThenBy(w => { var match = System.Text.RegularExpressions.Regex.Match((string)(w.Name ?? string.Empty), @"\d+"); return match.Success ? int.Parse(match.Value) : int.MaxValue; })
                                .ThenBy(w => (string)w.Name))
                            {
                                // Calcula las sumas de las columnas
                                totalEstimated += Convert.ToDecimal(wp.Pms);
                                totalDistributed += Convert.ToDecimal(wp.Distributed);
                                totalCovered += Convert.ToDecimal(wp.Covered);

                                // Determina la clase para la fila según las condiciones
                                string rowClass = "";
                                string textStyle = "";
                                if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed == wp.Covered)
                                {
                                    rowClass = "table-success"; // Fondo verde claro
                                    textStyle = "text-success font-weight-bold"; // Texto verde oscuro y en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) != wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else
                                {
                                    rowClass = "table-light"; // Fondo amarillo claro
                                                              // No se aplica una clase de texto específica aquí; se manejará individualmente
                                }

                                <tr class="@rowClass">
                                    <td class="centered" style="text-align: center;">@wp.Name</td>
                                    <td class="centered" style="text-align: center;">@wp.Pms</td>
                                    <td class="centered" style="text-align: center;">@wp.Distributed</td>
                                    <td class="centered" style="text-align: center;">@wp.Covered</td>
                                </tr>
                            }
                            <!-- Fila de Total -->
                            <tr class="table-primary">
                                <th style="text-align: center; background-color: black; color: white;">Total</th>
                                <td class="centered bold" style="text-align: center;">@totalEstimated</td>
                                <td class="centered bold" style="text-align: center;">@totalDistributed</td>
                                <td class="centered bold" style="text-align: center;">@totalCovered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>
    <hr />
<div class="container mt-3 projects-ux projects-report-ux">
    @if (Model.ReportPeriods.Any())
    {
        <div class="card mt-4">
            <div class="card-header" style="text-align: center; background-color: black; color: white;">
                Report Periods Details
            </div>
            <div class="card-body">
                    <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: center; background-color: black; color: white;">Reporting Period</th>
                            <th style="text-align: center; background-color: black; color: white;">Period Date</th>
                            <th style="text-align: center; background-color: black; color: white;">Period in Months</th>
                            <th style="text-align: center; background-color: black; color: white;">Actions</th>
                        </tr>
                    </thead>
                    @foreach (var reportPeriod in Model.ReportPeriods)
                    {
                        int startMonth = ((reportPeriod.StartDate.Year - Model.Project.Start.Value.Year) * 12) + reportPeriod.StartDate.Month - Model.Project.Start.Value.Month + 1;
                        int endMonth = ((reportPeriod.EndDate.Year - Model.Project.Start.Value.Year) * 12) + reportPeriod.EndDate.Month - Model.Project.Start.Value.Month + 1;
                        <tr>
                                <td style="text-align:center;">
                                    <button type="button"
                                            class="btn btn-primary btn-block font-weight-bold periodo period-btn"
                                            data-periodo-id="@reportPeriod.Id">
                                        @($"P {index}")
                                    </button>
                                </td>
                            <td style="text-align: center;">@reportPeriod.StartDate.ToString("dd-MM-yyyy") / @reportPeriod.EndDate.ToString("dd-MM-yyyy")</td>
                            <td style="text-align: center;">M @startMonth / M @endMonth</td>
                            <td style="text-align: center;">
                                <button type="button" class="btn btn-danger" onclick="deleteReportPeriod(@reportPeriod.Id)">Delete</button>
                                    <button type="button"
                                            class="btn btn-secondary btn-block"
                                            onclick="loadPeriodRates(@reportPeriod.Id, @ViewBag.projId)">
                                        Rates
                                    </button>
                            </td>
                        </tr>
                        index++;
                    }
                </table>
            </div>
        </div>
        <hr />
    }else{
        <div class="alert alert-warning" role="alert">
            No report periods have been added yet.
        </div>
    }
        <div class="text-center my-3">
    <div id="reportPeriodsSection"></div>
    <button type="button" class="btn btn-primary" id="addReportPeriodBtn" onclick="loadReportPeriodForm()">Add Reporting Periods</button>
    <button type="button" class="btn btn-secondary" id="cancelReportPeriodBtn" onclick="cancelReportPeriodForm()" style="display:none;">Cancel</button>
            <div class="card mt-4">
                <div class="card-header bg-dark text-white text-center">
                    Export Options
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4 d-flex align-items-center">
                            <label for="manualDate" class="mb-0 mr-2 font-weight-bold">Manual Date:</label>
                            <input type="date" id="manualDate" class="form-control ml-2" />
                        </div>

                        <div class="col-md-4 d-flex align-items-center">
                            <label for="manualCode" class="mb-0 ml-3 mr-2 font-weight-bold">Manual Code:</label>
                            <input type="text" id="manualCode" class="form-control ml-2"/>
                        </div>
                    </div>


                    <div class="row text-center">
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportDeclaredHoursBtn" onclick="exportDeclaredHoursToCSV()" style="display:none;">
                                Export Declared Hours
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportEstimatedHoursBtn" onclick="exportEstimatedHoursToCSV()" style="display:none;">
                                Export Estimated Hours
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMsBtn" onclick="exportPMsToCSV()" style="display:none;">
                                Export PMs
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforWPToCSV" onclick="exportPMSforWPToCSV()" style="display:none;">
                                Export PMs per WP
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforAuditoria" onclick="exportPMSforAuditoriaToCSV()" style="display:none;">
                                Export Audit PMs
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforWPToCSVBtn" onclick="exportPMSAuditByWPToCSV()" style="display:none;">
                                Export Audit PMs per WP
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportWorkedDaysBtn" onclick="exportWorkedDaysToCSV()" style="display:none;">
                                Export Worked Days
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button"
                                    class="btn btn-success btn-block btn-smaller-text"
                                    id="exportEstimatedDaysBtn"
                                    onclick="exportEstimatedWorkedDaysToCSV()"
                                    style="display:none;">
                                Export Estimated Days
                            </button>
                        </div>
                    </div>
                </div>
            </div>
</div>





</div>
</div>
<div id="periodDetailsLoadingOverlay" style="display:none;">
    <div class="loading-box">
        <div class="loading-title">Cargando periodo…</div>
        <div class="loading-subtitle">
            Calculando datos por persona. Esto puede tardar en periodos grandes.
        </div>

        <div class="loading-progress">
            <div id="periodDetailsProgressBar" class="loading-progress-bar" style="width:0%"></div>
        </div>

        <div class="loading-percent">
            <span id="periodDetailsProgressText">0%</span>
        </div>
    </div>
</div>
<div id="detallesPeriodoContainer" class="table-container-period"></div>


<script>
      // Helper para limpiar textos de celdas (quita botones/etiquetas UI)
    function cleanCellText(col) {
        // Texto plano sin saltos
        let txt = col.innerText.replace(/(\r\n|\n|\r)/gm, ' ').trim();

        // Quitar etiquetas/botones habituales
        txt = txt
          .replace(/\b(Lock All|Reopen All|Lock|Reopen|Timesheet)\b/gi, '')
          .replace(/\s{2,}/g, ' ') // espacios dobles
          .trim();

        return txt;
    }


    // ------------------------------------------------------------
    // Period Details: anti-spam + overlay de carga + progreso estimado
    // ------------------------------------------------------------

    // Controla que solo haya 1 carga de PeriodDetails en vuelo.
    // Evita que el usuario dispare 20 requests al mismo endpoint.
    let periodDetailsInFlight = false;

    // Timer para animar el progreso "estimado".
    let periodDetailsProgressTimer = null;

    /**
     * Muestra el overlay bloqueante y arranca una barra de progreso "estimada".
     * Nota: el % NO es real, es UX para que el usuario no spamee el botón.
     */
    function showPeriodDetailsLoadingOverlay() {
        $('#periodDetailsLoadingOverlay').css('display', 'flex');

        let progress = 0;
        $('#periodDetailsProgressBar').css('width', '0%');
        $('#periodDetailsProgressText').text('0%');

        // Por si veníamos de una carga anterior
        if (periodDetailsProgressTimer) {
            clearInterval(periodDetailsProgressTimer);
            periodDetailsProgressTimer = null;
        }

        // Subida rápida al inicio y lenta al final, quedándose en ~90% hasta que responda el server.
        periodDetailsProgressTimer = setInterval(function () {
            if (progress < 70) progress += 4;
            else if (progress < 90) progress += 1;

            $('#periodDetailsProgressBar').css('width', progress + '%');
            $('#periodDetailsProgressText').text(progress + '%');
        }, 250);
    }

    /**
     * Oculta el overlay. Si fue OK, remata visualmente al 100%.
     */
    function hidePeriodDetailsLoadingOverlay(success) {
        if (periodDetailsProgressTimer) {
            clearInterval(periodDetailsProgressTimer);
            periodDetailsProgressTimer = null;
        }

        if (success) {
            $('#periodDetailsProgressBar').css('width', '100%');
            $('#periodDetailsProgressText').text('100%');

            // Pequeño delay para que el usuario perciba el "fin"
            setTimeout(function () {
                $('#periodDetailsLoadingOverlay').hide();
            }, 250);
        } else {
            $('#periodDetailsLoadingOverlay').hide();
        }
    }

    /**
     * Deshabilita los botones de periodo para evitar clicks repetidos.
     * OJO: en tu HTML la clase .periodo está en el <td>, y el botón está dentro,
     * por eso deshabilitamos el <button> hijo.
     */
    function setPeriodButtonsEnabled(enabled) {
        $('.periodo button').prop('disabled', !enabled);
    }

    $(document).ready(function () {

        $(document).on('click', '.periodo', function () {

            // Si ya hay una petición en curso, ignoramos el click.
            if (periodDetailsInFlight) return;

            periodDetailsInFlight = true;

            // Bloqueo UI
            setPeriodButtonsEnabled(false);
            showPeriodDetailsLoadingOverlay();

            // Datos del periodo seleccionado
            var periodoId = $(this).data('periodo-id');
            var projectId = @ViewBag.projId;

            // Esta parte la conservamos EXACTAMENTE como la tenías
            var startDate = $(this).closest('tr').find('td:nth-child(2)').text().split(' / ')[0];
            var endDate = $(this).closest('tr').find('td:nth-child(2)').text().split(' / ')[1];

            $.ajax({
                url: '/Projects/PeriodDetails',
                method: 'GET',
                data: { id: periodoId, projectId: projectId },

                // Si tus periodos grandes tardan más, sube este timeout.
                timeout: 120000,

                success: function (data) {
                    // Pintar parcial
                    $('#detallesPeriodoContainer').html(data);
                    $('#detallesPeriodoContainer').show();

                    // Mostrar botones (conservamos lo que ya hacías)
                    $('#exportPMsBtn').show();
                    $('#exportPMSforWPToCSV').show();
                    $('#exportPMSforAuditoria').show();
                    $('#exportDeclaredHoursBtn').show();
                    $('#exportEstimatedHoursBtn').show();
                    $('#exportPMSforWPToCSVBtn').show();
                    $('#exportWorkedDaysBtn').show();
                    $('#exportEstimatedDaysBtn').show();

                    // Guardar fechas del periodo seleccionado
                    $('#exportPMSforWPToCSV').data('start-date', startDate);
                    $('#exportPMSforWPToCSV').data('end-date', endDate);

                    // Cerrar overlay OK
                    hidePeriodDetailsLoadingOverlay(true);
                },

                error: function (xhr, status) {
                    // Si expira o falla, quitamos overlay y avisamos
                    hidePeriodDetailsLoadingOverlay(false);

                    // Abort/timeout: mensaje más claro
                    if (status === 'timeout') {
                        alert('La carga del periodo está tardando demasiado. Inténtalo de nuevo o revisa el tamaño del periodo.');
                    } else {
                        alert('No se pudo cargar el periodo. Inténtalo de nuevo.');
                    }
                },

                complete: function () {
                    // Pase lo que pase, se re-habilitan clicks y se libera el lock.
                    periodDetailsInFlight = false;
                    setPeriodButtonsEnabled(true);
                }
            });
        });

    });





    function loadReportPeriodForm() {
        $.ajax({
            url: '@Url.Action("ReportPeriodForm", "Projects", new { projId = ViewBag.projId })',
            type: 'GET',
            success: function (result) {
                $('#reportPeriodsSection').html(result);
                $('#addReportPeriodBtn').hide(); // Oculta el botón de añadir
                $('#cancelReportPeriodBtn').show(); // Muestra el botón de cancelar
            }
        });
    }

    function cancelReportPeriodForm() {
        $('#reportPeriodsSection').html(''); // Limpia la sección de la vista parcial
        $('#cancelReportPeriodBtn').hide(); // Oculta el botón de cancelar
        $('#addReportPeriodBtn').show(); // Muestra nuevamente el botón de "Add Reporting Periods"
    }

    function deleteReportPeriod(id) {
        if (confirm('Are you sure you want to delete this period?')) {
            $.post('/Projects/DeleteReportPeriod', { id: id }, function (data) {
                if (data.success) {
                    alert('Report period deleted successfully.');
                    // Actualizar la vista o recargar la página aquí si es necesario
                    location.reload();
                } else {
                    alert(data.message || 'An error occurred.');
                }
            });
        }
    }   

    function exportHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var declaredHours = col.getAttribute('data-declared-hours');
                var hoursInProject = col.getAttribute('data-hours-in-project');
                if (declaredHours && hoursInProject) {
                    rowData.push(`${declaredHours.replace('.', ',')} | ${hoursInProject.replace('.', ',')}`);
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_periodo.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

      function exportDeclaredHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col, colIdx) {
                var declaredHours = col.getAttribute('data-declared-hours');

                if (declaredHours) {
                    // Si hay atributo con el dato limpio, úsalo
                    rowData.push(declaredHours.replace('.', ','));
                } else {
                    // Si no, limpiamos el texto de la celda (quitando Lock/Reopen/etc.)
                    var txt = cleanCellText(col);

                    // Si quieres, limita la primera columna a “Nombre Apellidos” sin más adornos:
                    // if (colIdx === 0) { ... }  // opcional si en la primera columna es donde salen esos botones

                    rowData.push(txt.replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_declaradas.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportEstimatedHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var hoursInProject = col.getAttribute('data-hours-in-project');
                if (hoursInProject) {
                    rowData.push(hoursInProject.replace('.', ','));
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_estimadas.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function exportPMsToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var totalEffort = col.getAttribute('data-total-effort');
                if (totalEffort) {
                    rowData.push(totalEffort.replace('.', ','));
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "PMs_periodo.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function exportPMSforWPToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsperWPtoCSV", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsPerWP_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }

    function exportPMSforAuditoriaToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsAuditoria", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsAuditoria_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }  
    
    function exportPMSAuditByWPToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsAuditoriaByWP", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsAuditByWP_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }

        function exportWorkedDaysToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        fetch('@Url.Action("ExportWorkedDaysToCSV", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ProjectId: projectId,
                StartDate: startDateISO,
                EndDate: endDateISO
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `WorkedDays_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => console.error('Error exporting Worked Days:', error));
    }

        function exportEstimatedWorkedDaysToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir dd-MM-yyyy → yyyy-MM-dd (ISO)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO   = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        fetch('@Url.Action("ExportEstimatedWorkedDaysToCSV", "Projects")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ProjectId: projectId,
                StartDate: startDateISO,
                EndDate: endDateISO
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.blob();
        })
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `EstimatedWorkedDays_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => console.error('Error exporting Estimated Worked Days:', error));
    }

        function loadPeriodRates(periodId, projectId) {
        $.ajax({
            url: '@Url.Action("PeriodRates", "Projects")',
            data: {
                id: periodId,
                projectId: projectId
            },
            success: function (data) {
                // Cargamos la parcial _PeriodRates en el mismo contenedor
                $('#detallesPeriodoContainer').html(data);
                $('#detallesPeriodoContainer').show();

                // Si quieres, aquí puedes ocultar los botones de export asociados al grid antiguo:
                // $('#exportPMsBtn').hide();
                // $('#exportDeclaredHoursBtn').hide();
                // $('#exportEstimatedHoursBtn').hide();
                // $('#exportPMSforWPToCSV').hide();
                // etc...
            },
            error: function (xhr, status, error) {
                alert('Error loading rates view: ' + error);
            }
        });
    }



</script>



    <style>
        .periodo {
            cursor: pointer; /* Cambia el cursor a una mano para indicar que es clicable */
            color: blue; /* Cambia el color del texto a azul */
            text-decoration: none; /* Asegura que inicialmente no esté subrayado */
        }

            .periodo:hover {
                text-decoration: underline; /* Subraya el texto al pasar el ratón por encima */
            }

        .table-hover tbody tr:hover {
            background-color: #f5f5f5; /* Cambia este color según tus preferencias */
        }

    .table-container-period {
        max-width: 1600px;
        margin: 0 auto; /* Centra la tabla horizontalmente */
    }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    .card-header {
        background-color: #005A9C; /* Azul oscuro, ajusta el código de color según tu logo */
        color: #FFFFFF; /* Blanco */
        text-align: center;
        font-weight: bold;
        /* Otros estilos que desees mantener, como el padding, etc. */
    }

    .wp-checkbox {
        width: 25px; /* Tamaño del checkbox */
        height: 25px; /* Tamaño del checkbox */
        cursor: pointer; /* Cambia el cursor a mano al pasar sobre el checkbox */
        margin: auto; /* Centra el checkbox en la celda */
    }
    
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 2; /* Asegura que el encabezado se mantenga sobre el contenido desplazable */
    }

    .sticky-name-header {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 4; /* Asegura que la cabecera fija esté sobre el contenido desplazable */
    }

    .card-header {
        font-size: 24px; /* Aumenta el tamaño del texto */
        font-weight: bold; /* Texto en negrita */
        text-align: center; /* Texto centrado */
    }

    .my-style {
        font-size: 2.5rem; /* Ajusta el tamaño de la fuente */
        font-weight: bold;
        color: #0056b3; /* Cambia al color que prefieras */
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* Añade una ligera sombra */
    }

    .btn-smaller-text {
        font-size: 0.85rem; /* Reduce un poco el tamaño del texto */
        padding-left: 10px;
        padding-right: 10px;
        white-space: nowrap; /* Evita el salto de línea */
    }

    #manualDate {
        min-width: 150px;
    }

    .card-header {
        font-size: 20px;
    }

    .btn-block {
        white-space: nowrap;
    }

    #periodDetailsLoadingOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }

        #periodDetailsLoadingOverlay .loading-box {
            width: 420px;
            background: #fff;
            border-radius: 10px;
            padding: 16px 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            font-family: inherit;
        }

        #periodDetailsLoadingOverlay .loading-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        #periodDetailsLoadingOverlay .loading-subtitle {
            font-size: 13px;
            opacity: .8;
            margin-bottom: 12px;
        }

        #periodDetailsLoadingOverlay .loading-progress {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        #periodDetailsLoadingOverlay .loading-progress-bar {
            height: 100%;
            background: #0d6efd;
            transition: width .25s ease;
        }

        #periodDetailsLoadingOverlay .loading-percent {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
        }
    /* Botones de periodos: texto blanco siempre + hover con contraste */
    .period-btn {
        color: #fff !important;
        font-weight: 700;
    }

        /* Si el enlace azul viene porque hay <a> o estilos raros encima */
        .period-btn * {
            color: #fff !important;
        }

        /* Hover/focus: sube contraste sin cambiar el “estilo TRS” */
        .period-btn:hover,
        .period-btn:focus {
            color: #fff !important;
            filter: brightness(0.92);
            transform: translateY(-1px);
        }

        /* Cuando está deshabilitado (por el overlay), que se note */
        .period-btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }

    </style>

