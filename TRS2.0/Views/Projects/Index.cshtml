@model List<TRS2._0.Models.DataModels.Project>

<h1 class="text-center my-style">Projects <span id="selectedYearTitle"></span></h1>


<div class="filter-container d-flex justify-content-center align-items-center mb-4" style="gap: 20px;">
    <div>
        <label for="yearDropdown" class="form-label">Year:</label>
        <select id="yearDropdown" class="form-select">
            <option value="">All</option>
            @foreach (var year in ViewBag.UniqueYears)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>
    <div>
        <label for="searchByName" class="form-label">Name:</label>
        <input type="text" id="searchByName" class="form-control" placeholder="Search...">
    </div>
    <div>
        <label for="filterByType" class="form-label">Type:</label>
        <select id="filterByType" class="form-select">
            <option value="">All</option>
            @foreach (var type in Model.Select(p => p.Type).Distinct())
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
</div>

<div class="projects-container d-flex flex-wrap justify-content-around">
    @foreach (var type in Model.Select(p => p.Type).Distinct())
    {
        <div class="project-column m-2" data-type="@type" style="flex: 0 1 45%; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.1);">
            <h2 class="text-center mt-3">@type</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Where(p => p.Type == type && p.St1 == "ABIERTO" && p.St2 == "CONCEDIDO" && p.Visible == 1).OrderBy(p => p.Acronim))
                    {
                        <tr data-name="@item.Acronim" data-year="@item.Start.Value.Year">
                            <td>
                                <a asp-action="Details" asp-route-id="@item.ProjId">@item.Acronim</a>
                            </td>
                            <td>@item.Start.Value.Year - @item.End.Value.Year</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<script>
    document.getElementById('yearDropdown').addEventListener('change', function () {
        var selectedYear = this.value;
        var currentUrl = window.location.href;

        // Actualiza el título con el año seleccionado
        document.getElementById('selectedYearTitle').textContent = selectedYear ? `(${selectedYear})` : '';

        // Reemplaza o agrega el parámetro "selectedYear" en la URL
        var updatedUrl = updateQueryStringParameter(currentUrl, 'selectedYear', selectedYear);

        // Redirige a la URL actualizada
        window.location.href = updatedUrl;
    });

    function updateQueryStringParameter(uri, key, value) {
        var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        var separator = uri.indexOf('?') !== -1 ? "&" : "?";
        if (uri.match(re)) {
            return uri.replace(re, '$1' + key + "=" + value + '$2');
        }
        else {
            return uri + separator + key + "=" + value;
        }
    }

    // JavaScript para filtrar proyectos por nombre y tipo
    document.addEventListener('DOMContentLoaded', function () {
        const searchByNameInput = document.getElementById('searchByName');
        const filterByTypeSelect = document.getElementById('filterByType');
        const yearDropdown = document.getElementById('yearDropdown');

        function filterProjects() {
            const searchQuery = searchByNameInput.value.toLowerCase();
            const selectedType = filterByTypeSelect.value;
            const selectedYear = yearDropdown.value;

            document.querySelectorAll('.project-column').forEach(column => {
                const type = column.getAttribute('data-type');
                let matchesType = true;
                let matchesYear = true;

                if (selectedType && selectedType !== type) {
                    matchesType = false;
                }

                const rows = column.querySelectorAll('tbody tr');
                let matchesSearch = false;
                rows.forEach(row => {
                    const name = row.getAttribute('data-name').toLowerCase();
                    const year = row.getAttribute('data-year');
                    const isVisible = name.includes(searchQuery) && (selectedYear === "" || year === selectedYear);
                    row.style.display = isVisible ? '' : 'none';
                    if (isVisible) matchesSearch = true;
                });

                column.style.display = (matchesType && matchesSearch) ? '' : 'none';
            });
        }

        searchByNameInput.addEventListener('input', filterProjects);
        filterByTypeSelect.addEventListener('change', filterProjects);
        yearDropdown.addEventListener('change', filterProjects);
    });
</script>

<style>
    .filter-container {
        margin: 20px 0;
    }

    .projects-container {
        margin: 0 15px;
    }

    .project-column {
        margin-bottom: 20px;
    }

    table {
        margin-bottom: 0;
    }

    .filter-container > div {
        margin-bottom: 10px;
    }

    .filter-container > div {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .form-select, .form-control {
        width: auto; /* Ajusta el ancho según el contenido */
    }

    .projects-container {
        gap: 20px; /* Espacio entre los proyectos */
    }

    .project-column {
        flex: 1 1 45%; /* Ajusta esto según prefieras el ancho de las columnas */
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        padding: 20px;
    }

    .my-style {
        font-size: 2.5rem; /* Ajusta el tamaño de la fuente según necesites */
        font-weight: bold;
        color: #0056b3; /* Este es un azul sugerido, cámbialo según tu paleta de colores */
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* Añade una sombra para mayor profundidad */
    }

</style>

