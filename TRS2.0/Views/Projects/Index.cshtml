@model List<TRS2._0.Models.DataModels.Project>

<h1 class="text-center my-style">
    Projects <span id="selectedYearTitle">(@ViewBag.DefaultSelectedYear)</span>
</h1>

<div class="filter-container d-flex justify-content-center align-items-center mb-4" style="gap: 20px;">
    <div>
        <label for="yearDropdown" class="form-label">Year:</label>
        <select id="yearDropdown" class="form-select">
            <option value="">All</option>
            @foreach (var year in ViewBag.UniqueYears)
            {
                var isSelected = (int)year == (int)ViewBag.DefaultSelectedYear ? "selected" : "";
                @Html.Raw($"<option value=\"{year}\" {isSelected}>{year}</option>")
            }
        </select>
    </div>
    <div>
        <label for="searchByName" class="form-label">Name:</label>
        <input type="text" id="searchByName" class="form-control" placeholder="Search...">
    </div>
    <div>
        <label for="filterByType" class="form-label">Type:</label>
        <select id="filterByType" class="form-select">
            <option value="">All</option>
            @foreach (var type in Model.Select(p => p.Type).Distinct())
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
</div>

<div class="projects-container d-flex flex-wrap justify-content-around">
    @foreach (var type in Model.Select(p => p.Type).Distinct())
    {
        <div class="project-column m-2" data-type="@type" style="flex: 0 1 45%; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.1);">
            <h2 class="text-center mt-3">@type</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model
                        .Where(p => p.Type == type &&
                                    p.St1 == "ABIERTO" &&
                                    (p.St2 == "CONCEDIDO" || string.IsNullOrEmpty(p.St2)) &&
                                    p.Visible == 1)
                        .OrderBy(p => p.Acronim))
                    {
                        <tr data-name="@item.Acronim"
                            data-start="@item.Start.Value.Year"
                            data-end="@item.EndReportDate.Year">
                            <td>
                                <a asp-action="Details" asp-route-id="@item.ProjId">@item.Acronim</a>
                            </td>
                            <td>@item.Start.Value.Year - @item.End.Value.Year</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchByNameInput = document.getElementById('searchByName');
        const filterByTypeSelect = document.getElementById('filterByType');
        const yearDropdown = document.getElementById('yearDropdown');

            function filterProjects() {
        const searchQuery = searchByNameInput.value.toLowerCase();
        const selectedType = filterByTypeSelect.value;
        const selectedYear = yearDropdown.value;

        document.querySelectorAll('.project-column').forEach(column => {
            const type = column.getAttribute('data-type');
            let matchesType = !selectedType || selectedType === type;

            const rows = column.querySelectorAll('tbody tr');
            let hasVisibleRows = false;

            rows.forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                const start = parseInt(row.getAttribute('data-start'));
                const end = parseInt(row.getAttribute('data-end'));

                const matchesSearch = name.includes(searchQuery);
                const matchesYear = !selectedYear || (start <= selectedYear && end >= selectedYear);

                const isVisible = matchesSearch && matchesYear;

                row.style.display = isVisible ? '' : 'none';
                if (isVisible) hasVisibleRows = true;
            });

            column.style.display = matchesType && hasVisibleRows ? '' : 'none';
        });

        document.getElementById('selectedYearTitle').textContent = selectedYear ? `(${selectedYear})` : '(All)';
    }


        searchByNameInput.addEventListener('input', filterProjects);
        filterByTypeSelect.addEventListener('change', filterProjects);
        yearDropdown.addEventListener('change', filterProjects);

        // Aplicar filtro inicial
        filterProjects();

            // Reiniciar el valor visual del dropdown para que búsquedas actúen sobre todos
    yearDropdown.value = "";
    });
</script>

<style>
    .filter-container {
        margin: 20px 0;
    }

    .projects-container {
        margin: 0 15px;
        gap: 20px;
    }

    .project-column {
        flex: 1 1 45%;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .filter-container > div {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .form-select, .form-control {
        width: auto;
    }

    .my-style {
        font-size: 2.5rem;
        font-weight: bold;
        color: #0056b3;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
</style>
