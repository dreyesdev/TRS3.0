@model TRS2._0.Models.ViewModels.PeriodDetailsViewModel
@using System.Globalization

<div class="table-wrapper-custom table-responsive mx-3 mb-4 projects-ux projects-report-partial-ux">
    <table class="table table-bordered table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th class="nombre-columna text-center sticky-header sticky-col align-middle">
                    <div>Nombre</div>

                    <!-- Botones principales -->
                    <div class="d-flex justify-content-center gap-2 mt-2 mb-1 flex-wrap">
                        <button id="lockAllButton" class="btn btn-success btn-sm">Lock All</button>
                        <button id="reopenAllButton" class="btn btn-danger btn-sm">Reopen All</button>
                    </div>

                    <!-- Dropdown de acciones -->
                    <div class="dropdown mt-1">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="actionDropdown">
                            <li><a class="dropdown-item" href="#" id="lockSelectedButton">Lock Selected</a></li>
                            <li><a class="dropdown-item" href="#" id="reopenSelectedButton">Reopen Selected</a></li>
                            <li><a class="dropdown-item" href="#" id="downloadTimesheetsButton">Download Timesheets</a></li>
                        </ul>
                    </div>
                </th>
                @foreach (var monthDetail in Model.MonthDetails)
                {
                    <th class="nombre-mes text-center sticky-header">
                        <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center; font-weight: bold;">@monthDetail.Key</div>
                        <div style="text-align: center; font-weight: bold;">@monthDetail.Value</div>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var person in Model.Persons.OrderBy(p => p.Personnel.Surname))
            {
                <tr>
                    <td class="font-weight-bold sticky-col">
                        @person.Personnel.Surname, @person.Personnel.Name
                        <div class="mt-2 d-flex flex-row justify-content-center gap-2">
                            <button class="btn btn-outline-success btn-sm lock-person-btn"
                                    data-personid="@person.Personnel.Id"
                                    data-projectid="@ViewBag.ProjectId"
                                    data-periodid="@ViewBag.PeriodId">
                                Lock
                            </button>
                            <button class="btn btn-outline-danger btn-sm unlock-person-btn"
                                    data-personid="@person.Personnel.Id"
                                    data-projectid="@ViewBag.ProjectId"
                                    data-periodid="@ViewBag.PeriodId">
                                Reopen
                            </button>
                        </div>
                    </td>

                    @foreach (var monthDetail in Model.MonthDetails)
                    {
                        var monthDate = DateTime.Parse(monthDetail.Value);
                        var hasLoginInv = false;
                        var hasLoginResp = false;
                        string loginInvDate = null;
                        string loginRespDate = null;

                        if (person.LoginStatusByMonth != null && person.LoginStatusByMonth.TryGetValue(monthDate, out var logins))
                        {
                            hasLoginInv = !string.IsNullOrWhiteSpace(logins.InvestigatorDate);
                            hasLoginResp = !string.IsNullOrWhiteSpace(logins.ResponsibleDate);
                            loginInvDate = logins.InvestigatorDate;
                            loginRespDate = logins.ResponsibleDate;
                        }


                        decimal declaredHours = person.DeclaredHours.ContainsKey(monthDate) ? person.DeclaredHours[monthDate] : 0;
                        decimal hoursInProject = person.HoursinProyect.ContainsKey(monthDate) ? person.HoursinProyect[monthDate] : 0;
                        decimal completionPercentage = person.CompletionPercentage.ContainsKey(monthDate) ? person.CompletionPercentage[monthDate] : 0;
                        decimal totalEffort = person.TotalEffortinProyect.ContainsKey(monthDate) ? person.TotalEffortinProyect[monthDate] : 0;
                        int personnelId = person.Personnel.Id;
                        int year = monthDate.Year;

                        var statusKey = $"{monthDate.Year}-{monthDate.Month:D2}";
                        var status = person.PersonStatusByMonth.ContainsKey(statusKey) ? person.PersonStatusByMonth[statusKey] : (OutOfContract: false, Overloaded: false);
                        var isLocked = person.LockStatusByMonth.ContainsKey(statusKey) && person.LockStatusByMonth[statusKey];
                        var backgroundColor = status.OutOfContract ? "#FF8C00" : (status.Overloaded ? "#FFFF00" : "");

                        <td class="position-relative"
                            style="background-color: @backgroundColor; padding: 4px; vertical-align: top;"
                            data-declared-hours="@declaredHours"
                            data-hours-in-project="@hoursInProject"
                            data-total-effort="@totalEffort"
                            personId="@personnelId"
                            year="@year"
                            data-month="@monthDate.Month">

                            @* ✅ Solo mostrar checkbox si NO está "Out of Contract" *@
                            @if (!status.OutOfContract)
                            {
                                <input type="checkbox"
                                       class="cell-checkbox"                                       
                                       data-personid="@personnelId"
                                       data-year="@year"
                                       data-month="@monthDate.Month"
                                       data-projectid="@ViewBag.ProjectId"
                                       data-islocked="@isLocked.ToString().ToLower()" />

                            }

                            <!-- I / R en la esquina superior derecha -->
                            <div class="cell-flags" title="I=@(loginInvDate ?? "—") · R=@(loginRespDate ?? "—")">
                                <span>I: <span class="icon @(hasLoginInv ? "ok" : "ko")">@(hasLoginInv ? "✔" : "✖")</span></span>
                                <span>R: <span class="icon @(hasLoginResp ? "ok" : "ko")">@(hasLoginResp ? "✔" : "✖")</span></span>
                            </div>


                            <div class="d-flex justify-content-center align-items-center" style="flex-grow: 1; font-size: 0.875rem; font-weight:bold;">
                                <span>@declaredHours | @hoursInProject</span>
                            </div>

                            @if (status.OutOfContract)
                            {
                                <div class="text-center mt-2" style="width: 100%; font-weight:bold; white-space: nowrap;">Out of Contract</div>
                            }
                            else
                            {
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: @(completionPercentage.ToString("0"))%;" aria-valuenow="@completionPercentage" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="text-center" style="font-size: 0.75rem;">@completionPercentage%</div>
                            }

                            @if (!status.OutOfContract)
                            {
                                @if (isLocked)
                                {
                                    <div class="button-container mt-2">
                                        <button class="btn btn-danger w-100 unlock-button"
                                                onclick="updateLockStatus('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId', '@ViewBag.PeriodId', '/Projects/Unlock')">
                                            Desbloquear
                                        </button>
                                        <a href="javascript:void(0);" class="btn btn-info w-100 mt-2"
                                           onclick="exportTimesheetWithDate('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId')">
                                            Timesheet
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <button class="btn btn-success w-100 mt-2 lock-button"
                                            onclick="updateLockStatus('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId', '@ViewBag.PeriodId', '/Projects/Lock')">
                                        Bloquear
                                    </button>
                                }
                            }
                        </td>

                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    .nombre-columna {
        min-width: 250px; /* Ajusta según necesites */
        max-width: 350px;

    }

    .nombre-mes{
        min-width: 130px; /* Ajusta según necesites */
        max-width: 175px;
    }

    .table-container-period {
        max-height: 800px; /* Ajusta esto según la altura deseada */
        overflow-y: auto;
        overflow-x: auto; /* Habilita el scroll horizontal */
        max-width: 1200px; /* Ancho máximo para la tabla */
        margin: 0 auto; /* Centra la tabla horizontalmente */
    }

        .table td {
            max-width: 100px; /* Ancho máximo para las columnas */
            max-height: 100px; /* Altura máxima para las filas */
            overflow: hidden; /* Oculta el contenido que exceda el tamaño */
            text-overflow: ellipsis; /* Añade puntos suspensivos al contenido que exceda el tamaño */
            white-space: nowrap; /* Evita que el texto se divida en varias líneas */
        }

    .button-container {
        display: flex;
        flex-direction: column;
    }

        .button-container .btn {
            margin-bottom: 5px; /* Espacio entre los botones */
        }

    .table-wrapper-custom {
        max-height: 700px;
        overflow: auto;
        position: relative;
        border: 1px solid #ccc;
    }

    table {
        border-collapse: separate !important;
        border-spacing: 0;
        width: max-content;
        min-width: 100%;
    }

    th,
    td {
        min-width: 120px;
        max-width: 300px;
        white-space: nowrap;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background-color: #343a40 !important; /* el fondo oscuro del thead */
        color: white;
        z-index: 10;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 9;
    }

    .sticky-header.sticky-col {
        z-index: 11;
    }

    .cell-checkbox {
        transform: scale(1.4); /* Tamaño ligeramente más grande */
        accent-color: #007bff; /* Color visible en blanco */
        border: 1px solid #333; /* Borde más marcado */
        margin-top: 2px;
        margin-left: 2px;
    }

    .cell-flags {
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: .8rem;
        font-weight: 700;
        display: flex;
        gap: 8px;
    }

    .icon.ok {
        color: #28a745;
    }
    /* verde */
    .icon.ko {
        color: #dc3545;
    }
    /* rojo  */

</style>



<script>
    document.body.addEventListener('click', function (event) {
        if (event.target.matches('#lockAllButton')) {
            console.log("🔒 Botón 'Lock All' presionado.");
            var lockButtons = document.querySelectorAll('.lock-button');

            if (lockButtons.length === 0) {
                console.log("⚠️ No hay botones de bloqueo disponibles.");
                return;
            }

            lockButtons.forEach(button => {
                console.log("🔒 Ejecutando bloqueo en:", button);
                button.click();
            });
        }

        if (event.target.matches('#reopenAllButton')) {
            console.log("🔓 Botón 'Reopen All' presionado.");
            var unlockButtons = document.querySelectorAll('.unlock-button');

            if (unlockButtons.length === 0) {
                console.log("⚠️ No hay botones de desbloqueo disponibles.");
                return;
            }

            unlockButtons.forEach(button => {
                console.log("🔓 Ejecutando desbloqueo en:", button);
                button.click();
            });
        }
    });

        function updateLockStatus(personId, year, month, projectId, periodId, actionUrl) {
        console.log("Updating lock status:", { personId, year, month, projectId, periodId, actionUrl });

        document.getElementById('loadingOverlay').style.display = 'flex';

        // Guardar scroll de la página
        const windowScrollTop = document.documentElement.scrollTop || document.body.scrollTop;

        // Guardar scroll interno del contenedor
        const oldContainer = document.getElementById('detallesPeriodoContainer');
        const containerScrollTop = oldContainer ? oldContainer.scrollTop : 0;
        const containerScrollLeft = oldContainer ? oldContainer.scrollLeft : 0;

        var data = { personId: personId, projectId: projectId, year: year, month: month };

        $.ajax({
            url: actionUrl,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                if (response.success) {
                    $.ajax({
                        url: '/Projects/PeriodDetails',
                        data: { id: periodId, projectId: projectId },
                        success: function (partialViewResult) {
                            $('#detallesPeriodoContainer').html(partialViewResult);

                            // Esperar al repaint completo del DOM antes de restaurar el scroll
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    const newContainer = document.getElementById('detallesPeriodoContainer');
                                    if (newContainer) {
                                        newContainer.scrollTop = containerScrollTop;
                                        newContainer.scrollLeft = containerScrollLeft;
                                    }

                                    // Restaurar scroll global de la ventana
                                    window.scrollTo({ top: windowScrollTop, behavior: 'instant' });
                                });
                            });
                        },
                        complete: function () {
                            document.getElementById('loadingOverlay').style.display = 'none';
                        }
                    });
                } else {
                    alert('No se pudo actualizar el estado de bloqueo.');
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            },
            error: function (error) {
                console.log(error);
                alert('Ocurrió un error al intentar actualizar el estado de bloqueo.');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    }

            


        document.body.addEventListener('click', function (event) {
        // Lock all cells of a person
        if (event.target.matches('.lock-person-btn')) {
            const personId = event.target.dataset.personid;
            const projectId = event.target.dataset.projectid;
            const periodId = event.target.dataset.periodid;

            const cells = document.querySelectorAll(`td[personId="${personId}"]`);
            cells.forEach(cell => {
                const year = cell.getAttribute('year');
                const month = cell.getAttribute('data-month');
                const isOutOfContract = cell.innerHTML.includes('Out of Contract');
                const isAlreadyLocked = cell.querySelector('.unlock-button') !== null;

                if (!isOutOfContract && !isAlreadyLocked) {
                    updateLockStatus(personId, year, month, projectId, periodId, '/Projects/Lock');
                }
            });
        }

        // Unlock all cells of a person
        if (event.target.matches('.unlock-person-btn')) {
            const personId = event.target.dataset.personid;
            const projectId = event.target.dataset.projectid;
            const periodId = event.target.dataset.periodid;

            const cells = document.querySelectorAll(`td[personId="${personId}"]`);
            cells.forEach(cell => {
                const year = cell.getAttribute('year');
                const month = cell.getAttribute('data-month');
                const isOutOfContract = cell.innerHTML.includes('Out of Contract');
                const isLocked = cell.querySelector('.unlock-button') !== null;

                if (!isOutOfContract && isLocked) {
                    updateLockStatus(personId, year, month, projectId, periodId, '/Projects/Unlock');
                }
            });
        }
    });

            document.body.addEventListener('click', async function (event) {
        if (event.target.id === 'lockSelectedButton' || event.target.id === 'reopenSelectedButton') {
            const isLock = event.target.id === 'lockSelectedButton';
            const action = isLock ? 'Lock' : 'Unlock';
            const actionUrl = `/Projects/${action}`;

            const selectedCheckboxes = document.querySelectorAll('.cell-checkbox:checked');
            const cellsToProcess = [];

            selectedCheckboxes.forEach(cb => {
                const td = cb.closest('td');
                const hasUnlockButton = td.querySelector('.unlock-button') !== null;
                const hasLockButton = td.querySelector('.lock-button') !== null;

                const shouldInclude =
                    (isLock && hasLockButton) ||
                    (!isLock && hasUnlockButton);

                if (shouldInclude) {
                    cellsToProcess.push({
                        personId: parseInt(cb.dataset.personid),
                        year: parseInt(cb.dataset.year),
                        month: parseInt(cb.dataset.month),
                        projectId: parseInt(@ViewBag.ProjectId),
                        periodId: parseInt(@ViewBag.PeriodId)
                    });
                }
            });

            if (cellsToProcess.length === 0) {
                alert("No hay celdas válidas seleccionadas para esta acción.");
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                for (const cell of cellsToProcess) {
                    await fetch(actionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cell)
                    });
                }

                // Recargar la vista parcial tras los cambios
                $.ajax({
                    url: '/Projects/PeriodDetails',
                    data: {
                        id: @ViewBag.PeriodId,
                        projectId: @ViewBag.ProjectId
                    },
                    success: function (partialViewResult) {
                        $('#detallesPeriodoContainer').html(partialViewResult);
                    },
                    error: function () {
                        alert("Error al recargar la tabla tras el bloqueo/desbloqueo.");
                    },
                    complete: function () {
                        document.getElementById('loadingOverlay').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Error al procesar los cambios.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
    });

        document.getElementById('downloadTimesheetsButton').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.cell-checkbox:checked');

        checkboxes.forEach(cb => {
            const td = cb.closest('td');
            const timesheetBtn = td.querySelector('.btn-info');

            if (timesheetBtn) {
                const personId = cb.dataset.personid;
                const year = cb.dataset.year;
                const month = cb.dataset.month;
                const projectId = @ViewBag.ProjectId;

                // Construir la URL y lanzar la descarga
                const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}`;
                window.open(url, '_blank');
            }
        });
    });

    function exportTimesheetWithDate(personId, year, month, projectId) {
    const manualDateEl = document.getElementById('manualDate');
    const manualDate = manualDateEl && manualDateEl.value
        ? `&manualDate=${encodeURIComponent(manualDateEl.value)}`
        : '';
    const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${manualDate}`;
    window.open(url, '_blank');
  }

  function getManualParams() {
    const dateEl = document.getElementById('manualDate');
    const codeEl = document.getElementById('manualCode');

    let query = '';
    if (dateEl && dateEl.value) {
      query += `&manualDate=${encodeURIComponent(dateEl.value)}`;
    }
    if (codeEl && codeEl.value && codeEl.value.trim().length > 0) {
      // No lo trates como número: puede llevar ceros a la izquierda o letras
      query += `&manualCode=${encodeURIComponent(codeEl.value.trim())}`;
    }
    return query;
  }

  // Botón individual de cada celda
  function exportTimesheetWithDate(personId, year, month, projectId) {
    const extra = getManualParams();
    const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${extra}`;
    window.open(url, '_blank');
  }

  // "Download Timesheets" (cabecera, múltiple)
  document.getElementById('downloadTimesheetsButton')?.addEventListener('click', function () {
    const checkboxes = document.querySelectorAll('.cell-checkbox:checked');
    const extra = getManualParams();

    checkboxes.forEach(cb => {
      const personId = cb.dataset.personid;
      const year = cb.dataset.year;
      const month = cb.dataset.month;
      const projectId = @ViewBag.ProjectId;

      const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${extra}`;
      window.open(url, '_blank');
    });
  });

</script>

