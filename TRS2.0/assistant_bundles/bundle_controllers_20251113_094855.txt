=== BUNDLE: Controllers (20251113_094855) ===
----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\AccountController.cs -----
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TRS2._0.Models.DataModels;
using TRS2._0.Services;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using System.Security.Cryptography;
using System.Text;
using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Models;
using Microsoft.AspNetCore.Authorization;

namespace TRS2._0.Controllers
{
    public class AccountController : Controller
    {
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly SignInManager<ApplicationUser> _signInManager;
        private readonly TRSDBContext _context;
        private readonly IEmailSender _emailSender;
        private readonly ILogger<AccountController> _logger;
        private readonly RoleManager<IdentityRole> _roleManager;

        public AccountController(
            UserManager<ApplicationUser> userManager,
            SignInManager<ApplicationUser> signInManager,
            TRSDBContext context,
            IEmailSender emailSender,
            ILogger<AccountController> logger,
            RoleManager<IdentityRole> roleManager)
        {
            _userManager = userManager;
            _signInManager = signInManager;
            _context = context;
            _emailSender = emailSender;
            _logger = logger;
            _roleManager = roleManager;
        }

        [HttpGet]
        public IActionResult Login()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> Login(LoginViewModel model)
        {
            if (ModelState.IsValid)
            {
                var user = await _userManager.FindByNameAsync(model.BSCID);
                if (user == null)
                {
                    ModelState.AddModelError(string.Empty, "Your BSCID is incorrect or does not exist.");
                    return View(model);
                }

                // Verificar si el usuario tiene el rol de administrador
                var isAdmin = await _userManager.IsInRoleAsync(user, "Admin");

                int? personId = null;

                // Solo buscar el PersonId si el usuario NO es administrador
                if (!isAdmin)
                {
                    personId = await _context.Personnel
                        .Where(p => p.BscId == model.BSCID)
                        .Select(p => p.Id)
                        .FirstOrDefaultAsync();

                    if (personId == 0) // Si no se encuentra en Personnel
                    {
                        ModelState.AddModelError(string.Empty, "No personnel record found for this user.");
                        return View(model);
                    }
                }

                var result = await _signInManager.PasswordSignInAsync(user, model.Password, model.RememberMe, false);
                if (result.Succeeded)
                {
                    _logger.LogInformation("User {0} logged in at {1}.", user.UserName, DateTime.UtcNow);

                    // Si no es administrador, registrar el login en la base de datos solo si NO existe un registro para hoy
                    if (!isAdmin)
                    {
                        var today = DateTime.UtcNow.Date;

                        bool hasLoggedToday = await _context.UserLoginHistories
                            .AnyAsync(l => l.PersonId == personId.Value && l.LoginTime.Date == today);

                        if (!hasLoggedToday) // Solo registrar si no hay un registro previo hoy
                        {
                            var loginRecord = new UserLoginHistory
                            {
                                PersonId = personId.Value,
                                LoginTime = DateTime.UtcNow
                            };

                            _context.UserLoginHistories.Add(loginRecord);
                            await _context.SaveChangesAsync();
                        }
                        else
                        {
                            _logger.LogInformation("User {0} already logged in today. No duplicate record created.", user.UserName);
                        }
                    }

                    return RedirectToAction("Index", "Home");
                }

                ModelState.AddModelError(string.Empty, "Your password is incorrect.");
                _logger.LogWarning("Invalid login attempt.");
            }

            return View(model);
        }



        [HttpPost]
        public async Task<IActionResult> Logout()
        {
            await _signInManager.SignOutAsync();
            _logger.LogInformation("User logged out.");
            return RedirectToAction("Index", "Home");
        }

        [HttpGet]
        public IActionResult Register()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> Register(RegisterViewModel model)
        {
            if (ModelState.IsValid)
            {
                
                // Buscar persona en base de datos
                var personnel = await _context.Personnel.FirstOrDefaultAsync(p => p.BscId == model.BSCID);
                if (personnel == null)
                {
                    ModelState.AddModelError(string.Empty, "This user is not yet registered in our database. Please wait 24 hours or contact iss@bsc.es.");
                    return View(model);
                }

                // Comprobar si ya está registrado en Identity
                var existingUser = await _userManager.FindByNameAsync(model.BSCID);
                if (existingUser != null)
                {
                    ModelState.AddModelError(string.Empty, "This user already has an account. Please go to the login page and use 'I don't remember my password'.");
                    return View(model);
                }

                var password = await GenerateValidPasswordAsync();


                // Actualizar la tabla personnel
                personnel.Password = password;
                _context.Update(personnel);
                await _context.SaveChangesAsync();

                // Crear el usuario en Identity
                var user = new ApplicationUser { UserName = model.BSCID, Email = personnel.Email, PersonnelId = personnel.Id };
                var result = await _userManager.CreateAsync(user, password);

                if (result.Succeeded)
                {
                    _logger.LogInformation("User created a new account with password.");

                    var code = await _userManager.GenerateEmailConfirmationTokenAsync(user);
                    var callbackUrl = Url.Action("ConfirmEmail", "Account", new { userId = user.Id, code = code }, protocol: HttpContext.Request.Scheme);

                    string emailContent = $@"
                                            <html>
                                            <body>
                                                <p>Greetings, {personnel.Name},</p>

                                                <p>You now have access to the TRS 3.0 web application.</p>

                                                <p>To access the site, please use the following link: 
                                                    <a href='https://opstrs03.bsc.es/'>TRS 3.0</a>
                                                </p>

                                                <p>Your login credentials are:</p>
                                                <ul>
                                                    <li><strong>Username:</strong> <code style='font-family: monospace;'>{model.BSCID}</code></li>
                                                    <li><strong>Password:</strong> <code style='font-family: monospace;'>{password}</code></li>
                                                </ul>

                                                <p><strong style='color: darkred;'>Important:</strong> please copy and paste the password directly to avoid typos.</p>

                                                <p>If you experience issues logging in, try using a private/incognito window in your browser.</p>

                                                <p>If the problem persists, please contact us at 
                                                    <a href='mailto:iss@bsc.es'>iss@bsc.es</a>.
                                                </p>

                                                <p>Thank you for your collaboration.</p>

                                                <p>Sincerely,</p>
                                                <p>The ISS Team</p>
                                            </body>
                                            </html>";



                    await _emailSender.SendEmailAsync(personnel.Email, "Access to TRS 3.0", emailContent);

                    _logger.LogInformation("User registration email sent.");

                    // Asignar rol al usuario
                    var roleService = new RoleService(_roleManager, _userManager);
                    var roleResult = await roleService.AssignRoleToUser(user.Id, "Researcher");

                    if (!roleResult.Succeeded)
                    {
                        var errors = string.Join(", ", roleResult.Errors.Select(e => e.Description));
                        _logger.LogError($"Error assigning role to user {user.UserName}: {errors}");
                    }


                    return RedirectToAction(nameof(RegisterConfirmation));

                }

                foreach (var error in result.Errors)
                {
                    ModelState.AddModelError(string.Empty, error.Description);
                }
            }

            _logger.LogWarning("Invalid registration attempt.");
            return View(model);
        }


        [HttpGet]
        public IActionResult ForgotPassword()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> ForgotPassword(ForgotPasswordViewModel model)
        {
            if (ModelState.IsValid)
            {
                var user = await _userManager.FindByEmailAsync(model.Email);
                if (user == null)
                {
                    return RedirectToAction(nameof(Login)); // Redirigir en lugar de mostrar vista de confirmación
                }

                var code = await _userManager.GeneratePasswordResetTokenAsync(user);
                var callbackUrl = Url.Action(nameof(ResetPassword), "Account", new { code }, protocol: HttpContext.Request.Scheme);
                await _emailSender.SendEmailAsync(model.Email, "Reset Password",
                    $"Please reset your password by clicking <a href='{callbackUrl}'>here</a>");

                _logger.LogInformation($"Password reset email sent to {model.Email}.");
                return RedirectToAction(nameof(ForgotPasswordConfirmation));

            }

            _logger.LogWarning("Invalid forgot password attempt.");
            return View(model);
        }

        [HttpGet]
        public IActionResult ResetPassword(string code = null)
        {
            return code == null ? View("Error") : View(new ResetPasswordViewModel { Code = code });
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ResetPassword(ResetPasswordViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }

            var user = await _userManager.FindByEmailAsync(model.Email);
            if (user == null)
            {
                return RedirectToAction(nameof(Login)); // Redirigir en lugar de mostrar vista de confirmación
            }

            var result = await _userManager.ResetPasswordAsync(user, model.Code, model.Password);
            if (result.Succeeded)
            {
                return RedirectToAction(nameof(ResetPasswordConfirmation)); // Se elimina ResetPasswordConfirmation
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error.Description);
            }
            return View(model);
        }

        [HttpGet]
        public IActionResult ResetPasswordConfirmation()
        {
            return View();
        }

        [HttpGet]
        public IActionResult ChangePassword()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ChangePassword(ChangePasswordViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }

            var user = await _userManager.GetUserAsync(User);
            if (user == null)
            {
                return RedirectToAction(nameof(Login));
            }

            var result = await _userManager.ChangePasswordAsync(user, model.OldPassword, model.NewPassword);
            if (result.Succeeded)
            {
                _logger.LogInformation("User changed their password successfully.");
                await _signInManager.RefreshSignInAsync(user);
                return RedirectToAction("ChangePasswordConfirmation");
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error.Description);
            }
            return View(model);
        }

        [HttpGet]
        public IActionResult ChangePasswordConfirmation()
        {
            return View();
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]        
        public async Task<IActionResult> AdminResetPassword(string userId)
        {
            var user = await _userManager.FindByIdAsync(userId);
            if (user == null)
            {
                return Json(new { success = false, message = "User not found." });
            }

            var personnel = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == user.PersonnelId);
            if (personnel == null)
            {
                return Json(new { success = false, message = "Linked personnel not found." });
            }

            var password = await GenerateValidPasswordAsync();

            var token = await _userManager.GeneratePasswordResetTokenAsync(user);

            // Refrescar el user para evitar problemas de concurrencia
            await _context.Entry(user).ReloadAsync();

            var result = await _userManager.ResetPasswordAsync(user, token, password);

            if (!result.Succeeded)
            {
                var errorMessages = string.Join("; ", result.Errors.Select(e => e.Description));
                return Json(new
                {
                    success = false,
                    message = $"Password reset failed: {errorMessages}",
                    password = password
                });
            }

            // ✅ Guardar la nueva contraseña en Personnel
            personnel.Password = password;
            _context.Update(personnel);
            await _context.SaveChangesAsync();

            try
            {
                string emailContent = $@"
        <html>
        <body>
            <p>Hello {personnel.Name},</p>
            <p>Your password for TRS 3.0 has been reset by an administrator.</p>
            <p><strong>Username:</strong> {user.UserName}</p>
            <p><strong>New Password:</strong> {password}</p>
            <p>Please log in using the following link: <a href='https://opstrs03.bsc.es/'>TRS 3.0</a></p>
            <p>If you experience any issues, please contact <a href='mailto:iss@bsc.es'>iss@bsc.es</a>.</p>
        </body>
        </html>";

                await _emailSender.SendEmailAsync(personnel.Email, "Your TRS 3.0 Password Has Been Reset", emailContent);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending reset password email to user {UserName}", user.UserName);

                return Json(new
                {
                    success = false,
                    message = $"Password reset succeeded, but failed to send email. Error: {ex.Message}",
                    password = password
                });
            }

            return Json(new
            {
                success = true,
                message = "Password reset and email sent successfully.",
                password = password
            });
        }




        private async Task<string> GenerateValidPasswordAsync()
        {
            const int length = 12;
            const string uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const string lowercase = "abcdefghijklmnopqrstuvwxyz";
            const string digits = "0123456789";
            const string specialChars = "!@#$%^&*()-_=+,.?/";

            string allChars = uppercase + lowercase + digits + specialChars;
            Random rnd = new Random();

            while (true)
            {
                string password =
                    uppercase[rnd.Next(uppercase.Length)].ToString() +
                    lowercase[rnd.Next(lowercase.Length)] +
                    digits[rnd.Next(digits.Length)] +
                    specialChars[rnd.Next(specialChars.Length)];

                for (int i = 4; i < length; i++)
                {
                    password += allChars[rnd.Next(allChars.Length)];
                }

                // Mezclar caracteres
                password = new string(password.ToCharArray().OrderBy(x => rnd.Next()).ToArray());

                // Validar usando el validador real de Identity
                var tempUser = new ApplicationUser(); // Usuario temporal
                if (await ValidatePasswordAsync(tempUser, password))
                {
                    return password;
                }

                // Si no es válido, se genera de nuevo (while loop)
            }
        }



        private string HashPassword(string password)
        {
            using (var sha256 = SHA256.Create())
            {
                var bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
                var builder = new StringBuilder();
                foreach (var t in bytes)
                {
                    builder.Append(t.ToString("x2"));
                }
                return builder.ToString();
            }
        }

        public IActionResult ForgotPasswordConfirmation()
        {
            return View();
        }

        private async Task<bool> ValidatePasswordAsync(ApplicationUser user, string password)
        {
            var validators = _userManager.PasswordValidators;
            foreach (var validator in validators)
            {
                var result = await validator.ValidateAsync(_userManager, user, password);
                if (!result.Succeeded)
                {
                    return false;
                }
            }
            return true;
        }

        [HttpGet]
        public IActionResult RegisterConfirmation()
        {
            return View();
        }


    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\AdminController.cs -----

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using OfficeOpenXml;
using Serilog;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;
using Microsoft.Extensions.Options;

using static TRS2._0.Services.WorkCalendarService;

namespace TRS2._0.Controllers
{
    [Authorize(Roles = "Admin")]
    public class AdminController : Controller
    {
        private readonly WorkCalendarService _workCalendarService;
        private readonly TRSDBContext _context;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly RoleManager<IdentityRole> _roleManager;
        private readonly ILogger<AdminController> _logger;
        private readonly LoadDataService _loadDataService;
        private readonly ReminderService _reminderService;
        private readonly ReminderEmailOptions _reminderOptions;
        private readonly IEmailSender _emailSender;
        private readonly string _logDirectory = Path.Combine(Directory.GetCurrentDirectory(), "Logs");


        public AdminController(WorkCalendarService workCalendarService, TRSDBContext context, UserManager<ApplicationUser> userManager, RoleManager<IdentityRole> roleManager, ILogger<AdminController> logger, LoadDataService loadDataService, ReminderService reminderService, IOptions<ReminderEmailOptions> reminderOptions, IEmailSender emailSender)
        {
            _workCalendarService = workCalendarService;
            _context = context;
            _userManager = userManager;
            _roleManager = roleManager;
            _logger = logger;
            _loadDataService = loadDataService;
            _reminderService = reminderService;
            _reminderOptions = reminderOptions.Value;
            _emailSender = emailSender;
        }

        public async Task<IActionResult> Index()
        {
            var pmValues = await _context.DailyPMValues.ToListAsync();

            if (pmValues == null)
            {
                pmValues = new List<DailyPMValue>();
            }

            var people = await _context.Personnel
                .OrderBy(p => p.Name)
                .Select(p => new SelectListItem
                {
                    Value = p.Id.ToString(),
                    Text = p.Name
                }).ToListAsync();

            var logs = await _context.ProcessExecutionLogs
                        .OrderByDescending(p => p.ExecutionTime)
                        .Take(10)
                        .ToListAsync();

            var users = await _userManager.Users.ToListAsync();
            var roles = await _roleManager.Roles.ToListAsync();

            var model = new AdminIndexViewModel
            {
                ProcessLogs = logs,
                DailyPMValues = pmValues,
                People = people,
                Users = users.Select(u => new SelectListItem { Value = u.Id, Text = u.UserName }).ToList(),
                Roles = roles.Select(r => new SelectListItem { Value = r.Name, Text = r.Name }).ToList()
            };

            ViewBag.People = people;
            return View(model);
        }

        [HttpPost]
        public async Task<IActionResult> AssignRole(string userId, string role)
        {
            var user = await _userManager.FindByIdAsync(userId);
            if (user != null)
            {
                var currentRoles = await _userManager.GetRolesAsync(user);
                await _userManager.RemoveFromRolesAsync(user, currentRoles);
                await _userManager.AddToRoleAsync(user, role);
            }

            return RedirectToAction("Index");
        }

        [HttpPost]
        public async Task<IActionResult> GeneratePMValues(int year, int month)
        {
            try
            {
                int workingDays = await _workCalendarService.CalculateWorkingDays(year, month);
                decimal pmValuePerDay = workingDays > 0 ? Math.Round((decimal)(1.0 / workingDays), 4) : 0;

                var newDailyPMValue = new DailyPMValue
                {
                    Year = year,
                    Month = month,
                    WorkableDays = workingDays,
                    PmPerDay = pmValuePerDay
                };

                _context.DailyPMValues.Add(newDailyPMValue);
                await _context.SaveChangesAsync();

                return Json(new { success = true });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message });
            }
        }

        [HttpPost]
        public async Task<IActionResult> GenerateYearlyPMValues(int year)
        {
            try
            {
                List<DailyPMValue> dailyPMValues = new List<DailyPMValue>();

                for (int month = 1; month <= 12; month++)
                {
                    int workingDays = await _workCalendarService.CalculateWorkingDays(year, month);
                    decimal pmValuePerDay = workingDays > 0 ? Math.Round((decimal)(1.0 / workingDays), 6) : 0;

                    var existingValue = await _context.DailyPMValues
                        .FirstOrDefaultAsync(d => d.Year == year && d.Month == month);

                    if (existingValue != null)
                    {
                        existingValue.WorkableDays = workingDays;
                        existingValue.PmPerDay = pmValuePerDay;
                        _context.DailyPMValues.Update(existingValue);
                    }
                    else
                    {
                        var newDailyPMValue = new DailyPMValue
                        {
                            Year = year,
                            Month = month,
                            WorkableDays = workingDays,
                            PmPerDay = pmValuePerDay
                        };

                        dailyPMValues.Add(newDailyPMValue);
                    }
                }

                if (dailyPMValues.Any())
                {
                    _context.DailyPMValues.AddRange(dailyPMValues);
                }

                await _context.SaveChangesAsync();

                return Json(new { success = true });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message });
            }
        }

        public async Task<IActionResult> DailyPMValuesList()
        {
            var values = await _context.DailyPMValues.ToListAsync();
            return PartialView("_DailyPMValuesList", values);
        }

        [HttpPost]
        public async Task<IActionResult> CalculateDailyPM(int personId, DateTime date)
        {
            var dailyPM = await _workCalendarService.CalculateDailyPM(personId, date);
            return Json(dailyPM);
        }

        [HttpPost]
        public async Task<IActionResult> CalculateMonthlyPM(int personId, DateTime date)
        {
            var monthlyPM = await _workCalendarService.CalculateMonthlyPM(personId, date.Year, date.Month);
            return Json(monthlyPM);
        }

        [HttpPost]
        public IActionResult ProcessFolder([FromBody] FolderPathModel model)
        {
            // Ruta para el archivo de log
            var logPath = Path.Combine(Directory.GetCurrentDirectory(), "Logs", "ProcesamientoTimesheetLog.txt");
            var basePath = Path.GetDirectoryName(Path.Combine(Directory.GetCurrentDirectory(), "Logs"));
            var errorFolderPath = Path.Combine(basePath, "Archivos a tratar");

            // Crear carpeta de errores si no existe
            if (!Directory.Exists(errorFolderPath))
            {
                Directory.CreateDirectory(errorFolderPath);
            }

            // Configuración del logger
            var logger = new LoggerConfiguration()
                .MinimumLevel.Debug()
                .WriteTo.File(logPath, rollingInterval: RollingInterval.Day)
                .CreateLogger();

            int totalInsertedRecords = 0; // Contador de registros introducidos
            int totalUpdatedRecords = 0; // Contador de registros actualizados
            int totalErrors = 0; // Contador de errores generales
            int personNotFoundErrors = 0; // Contador de personas no encontradas
            int projectNotFoundErrors = 0; // Contador de proyectos no encontrados
            int workPackageNotFoundErrors = 0; // Contador de paquetes de trabajo no encontrados
            int invalidHoursErrors = 0; // Contador de valores de horas inválidos

            var notFoundPersons = new HashSet<string>(); // Lista de personas no encontradas
            var notFoundWorkPackages = new List<(string FileName, int Row, string ProjectCode, string WorkPackage, string ExpectedDatabaseString, string ReceivedString)>(); // Paquetes de trabajo no encontrados
            var invalidHoursDetails = new List<(string FileName, int Row, int Column, string InvalidValue)>(); // Detalles de horas inválidas

            try
            {
                var folderPath = model.FolderPath;

                // Convertir la ruta a absoluta si es relativa
                if (!Path.IsPathRooted(folderPath))
                {
                    folderPath = Path.GetFullPath(folderPath);
                }

                // Configurar el contexto de la licencia de EPPlus
                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

                // Obtener todos los archivos .xlsx en todas las subcarpetas
                var files = Directory.GetFiles(folderPath, "*.xlsx", SearchOption.AllDirectories);

                foreach (var file in files)
                {
                    var fileName = Path.GetFileName(file);
                    logger.Information("Procesando archivo: {File}", fileName);

                    bool fileHasErrors = false;

                    try
                    {
                        using (var package = new ExcelPackage(new FileInfo(file)))
                        {
                            var worksheet = package.Workbook.Worksheets[0];

                            // Leer el mes, año y persona
                            var monthAbbreviation = worksheet.Cells["B11"].Text.ToLower();
                            var year = int.Parse(worksheet.Cells["B12"].Text);
                            var month = DateTime.ParseExact(monthAbbreviation, "MMM", CultureInfo.InvariantCulture).Month;
                            var daysInMonth = DateTime.DaysInMonth(year, month);

                            var personName = worksheet.Cells["B9"].Text;

                            // Unir nombre y apellidos y normalizar eliminando acentos y haciendo insensible a mayúsculas/minúsculas
                            string Normalize(string input) => new string(input
                                .Normalize(NormalizationForm.FormD)
                                .Where(c => CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                                .ToArray()).ToLower();

                            var normalizedPersonName = Normalize(personName);

                            // Buscar en la base de datos utilizando la cadena completa normalizada
                            var personnel = _context.Personnel
                                .AsEnumerable() // Procesar en memoria para normalizar
                                .FirstOrDefault(p => Normalize(p.Name + " " + p.Surname) == normalizedPersonName);

                            if (personnel == null)
                            {
                                logger.Warning("No se encontró la persona {PersonName} en la base de datos.", personName);
                                personNotFoundErrors++;
                                totalErrors++;
                                notFoundPersons.Add(personName);
                                fileHasErrors = true;
                                continue;
                            }

                            var personnelId = personnel.Id;

                            // Procesar cada fila desde la fila 23 hasta el final del rango de datos
                            for (int row = 23; row <= worksheet.Dimension.End.Row; row++)
                            {
                                var line = worksheet.Cells[row, 1].Text;

                                // Verificar si hemos llegado a la línea "Total Hours worked on project"
                                if (line.StartsWith("Total Hours worked on project", StringComparison.OrdinalIgnoreCase))
                                {
                                    break;
                                }

                                // Validar y extraer datos del paquete de trabajo
                                var queryResult = _context.Projects
                                    .Join(_context.Wps,
                                          p => p.ProjId,
                                          wp => wp.ProjId,
                                          (p, wp) => new {
                                              FullString = (p.SapCode + " " + p.Acronim + " - " + wp.Name + " " + wp.Title).ToLower(),
                                              Project = p,
                                              WorkPackage = wp
                                          })
                                    .FirstOrDefault(result => result.FullString == line.ToLower());

                                if (queryResult == null)
                                {
                                    // Manejar casos especiales (sin descripción o con nombre en lugar de descripción)
                                    var possiblePackage = line.Split('-').LastOrDefault();

                                    if (possiblePackage != null)
                                    {
                                        possiblePackage = possiblePackage.Trim();
                                    }

                                    var packageQuery = _context.Projects
                                        .Join(_context.Wps,
                                              p => p.ProjId,
                                              wp => wp.ProjId,
                                              (p, wp) => new {
                                                  PackageName = wp.Name.ToLower(),
                                                  Project = p,
                                                  WorkPackage = wp
                                              })
                                        .FirstOrDefault(result => possiblePackage != null && result.PackageName == possiblePackage.ToLower());

                                    if (packageQuery == null)
                                    {
                                        logger.Warning(
                                            "No se encontró el paquete de trabajo y proyecto en el archivo {FileName}, línea {Row}. Proyecto: {ProjectCode}, Paquete recibido: {ReceivedString}",
                                            fileName, row, line.Split(' ')[0], line);

                                        workPackageNotFoundErrors++;
                                        totalErrors++;
                                        fileHasErrors = true;

                                        var projectCode = line.Split(' ')[0]; // Asumiendo que el código del proyecto está al inicio
                                        notFoundWorkPackages.Add((
                                            FileName: fileName,
                                            Row: row,
                                            ProjectCode: projectCode,
                                            WorkPackage: line,
                                            ExpectedDatabaseString: "No disponible",
                                            ReceivedString: line
                                        ));
                                        continue;
                                    }
                                    queryResult = new { FullString = "", Project = packageQuery.Project, WorkPackage = packageQuery.WorkPackage };
                                }

                                var project = queryResult.Project;
                                var workPackage = queryResult.WorkPackage;

                                var wpxPerson = _context.Wpxpeople.FirstOrDefault(wpx => wpx.Person == personnelId && wpx.Wp == workPackage.Id);
                                if (wpxPerson == null)
                                {
                                    logger.Warning("El paquete de trabajo {WorkPackageName} no está vinculado a la persona {PersonName}.", workPackage.Name, personName);
                                    workPackageNotFoundErrors++;
                                    totalErrors++;
                                    fileHasErrors = true;
                                    notFoundWorkPackages.Add((
                                        FileName: fileName,
                                        Row: row,
                                        ProjectCode: project.SapCode,
                                        WorkPackage: workPackage.Name,
                                        ExpectedDatabaseString: queryResult.FullString,
                                        ReceivedString: line
                                    ));
                                    continue;
                                }

                                // Leer las horas trabajadas para cada día del mes
                                for (int col = 3; col < 3 + daysInMonth; col++)
                                {
                                    var hoursText = worksheet.Cells[row, col].Text;
                                    if (string.IsNullOrWhiteSpace(hoursText)) continue;

                                    // Permitir separadores decimales ',' y '.' para valores decimales intermedios
                                    var cultureInfo = new CultureInfo("es-ES");
                                    if (!decimal.TryParse(hoursText, NumberStyles.AllowDecimalPoint | NumberStyles.AllowThousands, cultureInfo, out decimal hours))
                                    {
                                        logger.Warning("Valor no válido en archivo {FileName}, fila {Row}, columna {Col}: {HoursText}. Se asignará 0.", fileName, row, col, hoursText);
                                        invalidHoursErrors++;
                                        totalErrors++;
                                        fileHasErrors = true;
                                        invalidHoursDetails.Add((fileName, row, col, hoursText));
                                        hours = 0;
                                    }

                                    if (hours < 0 || hours > 24) // Validar rango permitido
                                    {
                                        logger.Warning("Horas fuera de rango en archivo {FileName}, fila {Row}, columna {Col}: {Hours}. Se asignará 0.", fileName, row, col, hours);
                                        invalidHoursErrors++;
                                        totalErrors++;
                                        fileHasErrors = true;
                                        invalidHoursDetails.Add((fileName, row, col, hours.ToString()));
                                        hours = 0;
                                    }

                                    var day = col - 2; // La columna C corresponde al día 1
                                    var date = new DateTime(year, month, day);

                                    var existingTimesheet = _context.Timesheets.FirstOrDefault(ts => ts.WpxPersonId == wpxPerson.Id && ts.Day == date);
                                    if (existingTimesheet != null)
                                    {
                                        existingTimesheet.Hours = hours;
                                        totalUpdatedRecords++;
                                    }
                                    else
                                    {
                                        var timesheet = new Timesheet
                                        {
                                            WpxPersonId = wpxPerson.Id,
                                            Day = date,
                                            Hours = hours
                                        };
                                        _context.Timesheets.Add(timesheet);
                                        totalInsertedRecords++;
                                    }

                                    logger.Information("Registrado: {Day}/{Month}/{Year} - {Hours} horas para paquete {WorkPackageName}.", day, month, year, hours, workPackage.Name);
                                }
                            }

                            // Guardar cambios en la base de datos
                            _context.SaveChanges();
                        }
                    }
                    catch (Exception ex)
                    {
                        logger.Error(ex, "Error al procesar el archivo {FileName}", fileName);
                        totalErrors++;
                        fileHasErrors = true;
                    }

                    // Mover archivos con errores a la carpeta "Archivos a tratar"
                    if (fileHasErrors)
                    {
                        var destinationPath = Path.Combine(errorFolderPath, fileName);
                        if (System.IO.File.Exists(destinationPath))
                        {
                            System.IO.File.Delete(destinationPath); // Eliminar si ya existe
                        }
                        System.IO.File.Copy(file, destinationPath);
                    }
                }

                logger.Information("Total de registros insertados: {TotalInserted}", totalInsertedRecords);
                logger.Information("Total de registros actualizados: {TotalUpdated}", totalUpdatedRecords);
                logger.Information("Errores totales: {TotalErrors}", totalErrors);
                logger.Information("Personas no encontradas: {PersonErrors}", personNotFoundErrors);
                logger.Information("Proyectos no encontrados: {ProjectErrors}", projectNotFoundErrors);
                logger.Information("Paquetes de trabajo no encontrados: {WorkPackageErrors}", workPackageNotFoundErrors);
                logger.Information("Errores de valores de horas: {InvalidHoursErrors}", invalidHoursErrors);

                logger.Information("Personas no encontradas:");
                foreach (var person in notFoundPersons)
                {
                    logger.Information("- {Person}", person);
                }

                logger.Information("Paquetes de trabajo no encontrados:");
                foreach (var wp in notFoundWorkPackages)
                {
                    logger.Information("- Archivo: {FileName}, Línea: {Row}, Proyecto: {ProjectCode}, Paquete recibido: {ReceivedString}, Paquete esperado: {ExpectedDatabaseString}", wp.FileName, wp.Row, wp.ProjectCode, wp.ReceivedString, wp.ExpectedDatabaseString);
                }

                logger.Information("Errores de horas inválidas:");
                foreach (var invalidHour in invalidHoursDetails)
                {
                    logger.Information("- Archivo: {FileName}, Línea: {Row}, Columna: {Column}, Valor inválido: {InvalidValue}", invalidHour.FileName, invalidHour.Row, invalidHour.Column, invalidHour.InvalidValue);
                }
            }
            catch (Exception ex)
            {
                logger.Error(ex, "Error general durante el procesamiento de la carpeta {FolderPath}", model.FolderPath);
                return Json(new { success = false, message = "Se produjo un error. Consulte los registros para más detalles." });
            }
            finally
            {
                logger.Dispose();
            }

            return Json(new
            {
                success = true,
                message = "Procesamiento completado correctamente.",
                insertedRecords = totalInsertedRecords,
                updatedRecords = totalUpdatedRecords,
                totalErrors = totalErrors,
                personErrors = personNotFoundErrors,
                projectErrors = projectNotFoundErrors,
                workPackageErrors = workPackageNotFoundErrors,
                invalidHoursErrors = invalidHoursErrors,
                notFoundPersons = notFoundPersons.ToList(),
                notFoundWorkPackages = notFoundWorkPackages.Select(wp => new { wp.FileName, wp.Row, wp.ProjectCode, wp.WorkPackage, wp.ExpectedDatabaseString, wp.ReceivedString }).ToList(),
                invalidHoursDetails = invalidHoursDetails.Select(i => new { i.FileName, i.Row, i.Column, i.InvalidValue }).ToList()
            });
        }



        [Authorize(Policy = "AllowLogsPolicy")]
        [HttpGet("GetLogFiles")]
        [Route("Admin/GetLogFiles")]
        public IActionResult GetLogFiles()
        {
            _logger.LogInformation("Intentando obtener archivos de log desde: {LogDirectory}", _logDirectory);

            if (!Directory.Exists(_logDirectory))
            {
                _logger.LogWarning("El directorio de logs no existe: {LogDirectory}", _logDirectory);
                return Json(new string[0]);
            }

            var logFiles = Directory.GetFiles(_logDirectory, "*.txt")
                                    .Select(Path.GetFileName)
                                    .ToArray();

            _logger.LogInformation("Archivos encontrados: {LogFiles}", string.Join(", ", logFiles));

            return Json(logFiles);
        }

        [Authorize(Policy = "AllowLogsPolicy")]
        [HttpGet("GetLogFileContent")]
        [Route("/Admin/GetLogFileContent")]
        public IActionResult GetLogFileContent(string fileName)
        {
            var filePath = Path.Combine(_logDirectory, fileName);
            if (!System.IO.File.Exists(filePath))
                return NotFound("Log file not found.");

            var content = System.IO.File.ReadAllText(filePath);
            return Content(content);
        }

        [HttpGet]
        public async Task<IActionResult> GetProjects()
        {
            var projects = await _context.Projects
                .Select(p => new { p.ProjId, p.Acronim })
                .ToListAsync();

            return Json(projects);
        }

        [HttpGet]
        public async Task<IActionResult> GetWorkPackages(int projectId)
        {
            var workPackages = await _context.Wps
                .Where(wp => wp.ProjId == projectId)
                .Select(wp => new { wp.Id, wp.Name })
                .ToListAsync();

            return Json(workPackages);
        }

        [HttpGet]
        public async Task<IActionResult> GetPersonsInWorkPackage(int wpId)
        {
            var persons = await _context.Wpxpeople
                .Where(wpx => wpx.Wp == wpId)
                .Select(wpx => new { wpx.Person, wpx.PersonNavigation.Name, wpx.PersonNavigation.Surname })
                .ToListAsync();

            return Json(persons);
        }

        [HttpPost]
        public async Task<IActionResult> AdjustEffort([FromBody] AdjustEffortRequest model)
        {
            if (model == null || model.WpId <= 0 || model.PersonId <= 0 || model.Month == DateTime.MinValue)
            {
                return Json(new { message = "Error: Los datos enviados son inválidos." });
            }

            var result = await _workCalendarService.AdjustEffortAsync(model.WpId, model.PersonId, model.Month);
            return Json(new { message = result });
        }

        [HttpPost]
        public async Task<IActionResult> AutoFillTimesheetsByDateRange([FromBody] DateRangeModel dateRange)
        {
            try
            {
                // Llama al servicio para ejecutar el proceso con el rango proporcionado
                
                await _loadDataService.AutoFillTimesheetsByDateRangeAsync(dateRange.StartDate, dateRange.EndDate);

                return Json(new { success = true, message = "Timesheets actualizados correctamente." });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error al ajustar las timesheets: {ex.Message}");
                return Json(new { success = false, message = "Error al ajustar las timesheets." });
            }
        }

        [HttpPost]
        public async Task<IActionResult> GenerateAdjustmentReport([FromBody] DateRangeModel dateRange)
        {
            try
            {
                _logger.LogInformation($"✅ Iniciando generación del informe para fechas: {dateRange.StartDate} - {dateRange.EndDate}");

                var employeesToAdjust = await _loadDataService.GetAdjustmentData(dateRange.StartDate, dateRange.EndDate);

                if (employeesToAdjust == null || employeesToAdjust.Count == 0)
                {
                    _logger.LogWarning("⚠️ No hay empleados con ajustes en este período.");
                    return StatusCode(500, new { success = false, message = "No se encontraron empleados para ajustar." });
                }

                _logger.LogInformation($"🔍 Se encontraron {employeesToAdjust.Count} empleados para procesar.");

                // **Crear el CSV con separadores adecuados (; en lugar de ,)**
                var csvBuilder = new StringBuilder();
                csvBuilder.AppendLine("ID Persona;Nombre;Apellido;Departamento;Grupo;Mes;Work Package;Proyecto;Effort Asignado;Effort Esperado;Días Laborables;Días Ajustados;Estado");

                foreach (var employee in employeesToAdjust)
                {
                    var estado = employee.AjustadoAutomaticamente == "Sí" ? "Ajustado" : "Requiere Revisión";
                    csvBuilder.AppendLine($"{employee.PersonId};{employee.Nombre};{employee.Apellido};{employee.Departamento};{employee.Grupo};{employee.Mes};{employee.WorkPackage};{employee.Proyecto};{employee.EffortAsignado};{employee.EffortEsperado};{employee.DiasLaborables};{employee.DiasAjustados};{estado}");
                }

                // **Forzar UTF-8 con BOM para que Excel detecte bien el archivo**
                byte[] bytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(csvBuilder.ToString())).ToArray();
                var stream = new MemoryStream(bytes);

                return File(stream, "text/csv", "Ajustes_Timesheets.csv");
            }
            catch (Exception ex)
            {
                _logger.LogError($"❌ Error en GenerateAdjustmentReport: {ex.Message} - {ex.StackTrace}");
                return StatusCode(500, new { success = false, message = "Error interno al generar el informe." });
            }
        }

        [HttpPost]
        public async Task<IActionResult> RunDataLoadNow([FromServices] LoadDataService loadDataService)
        {
            await loadDataService.RunScheduledJobs();
            return RedirectToAction("Index");
        }

        public async Task<IActionResult> SearchPersonByName(string query)
        {
            if (string.IsNullOrWhiteSpace(query))
                return Json(new List<object>());

            var results = await _context.Personnel
                .Where(p => (p.Name + " " + p.Surname).Contains(query))
                .OrderBy(p => p.Name)
                .Take(15)
                .Select(p => new { id = p.Id, name = p.Name, surname = p.Surname })
                .ToListAsync();

            return Json(results);
        }

        [HttpPost]
        public async Task<IActionResult> AutoFillTimesheetForPersonAndMonth([FromBody] AutoFillRequest model)
        {
            if (model == null || model.PersonId <= 0)
                return Json(new { success = false, message = "Petición inválida." });

            var monthStart = new DateTime(model.TargetMonth.Year, model.TargetMonth.Month, 1);

            // Validación de condiciones
            var cumpleCondiciones = await (from pf in _context.Persefforts
                                           join wxp in _context.Wpxpeople on pf.WpxPerson equals wxp.Id
                                           where pf.Value != 0 &&
                                                 pf.Month.Year == monthStart.Year &&
                                                 pf.Month.Month == monthStart.Month &&
                                                 wxp.Person == model.PersonId
                                           group pf by new { wxp.Person, pf.Month } into g
                                           where g.Count() == 1
                                           select g.Key).AnyAsync();

            if (!cumpleCondiciones)
            {
                return Json(new
                {
                    success = false,
                    message = $"No se puede ejecutar el proceso para la persona seleccionada en {monthStart:yyyy-MM}. No cumple los requisitos (debe tener effort en un único WP en ese mes)."
                });
            }

            try
            {
                await _loadDataService.AutoFillTimesheetForPersonAndMonthAsync(model.PersonId, monthStart);
                return Json(new { success = true, message = "Proceso completado correctamente." });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = $"Error: {ex.Message}" });
            }
        }


        public class AutoFillRequest
        {
            public int PersonId { get; set; }
            public DateTime TargetMonth { get; set; }
        }

        [HttpGet]
        public async Task<IActionResult> SearchUserByName(string query)
        {
            if (string.IsNullOrWhiteSpace(query))
                return Json(new List<object>());

            var users = await _userManager.Users
                .Where(u => u.UserName.Contains(query))
                .Select(u => new { u.Id, u.UserName })
                .Take(10)
                .ToListAsync();

            return Json(users);
        }

        [HttpGet]
        public async Task<IActionResult> AjustarOverloadManual()
        {
            var persons = await _context.Personnel
                .OrderBy(p => p.Name)
                .Select(p => new SelectListItem
                {
                    Value = p.Id.ToString(),
                    Text = p.Name + " " + p.Surname
                })
                .ToListAsync();

            ViewBag.Persons = persons;
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> AjustarOverloadManual(int personId, int year, int month)
        {
            var persons = await _context.Personnel
                .OrderBy(p => p.Name)
                .Select(p => new SelectListItem
                {
                    Value = p.Id.ToString(),
                    Text = p.Name + " " + p.Surname
                })
                .ToListAsync();

            ViewBag.Persons = persons;

            var isOverloaded = await _workCalendarService.IsOverloadedAsync(personId, year, month);

            if (!isOverloaded)
            {
                ViewBag.Message = $"✅ La persona seleccionada no está overload en {month:00}/{year}.";
                return View();
            }

            var result = await _workCalendarService.AdjustMonthlyOverloadAsync(personId, year, month);

            ViewBag.Message = result.Success
                ? $"✅ Ajuste completado correctamente para la persona en {month:00}/{year}."
                : $"❌ Ajuste fallido. Motivo: {result.Message}";

            return View();
        }

        [HttpPost]
        public async Task<IActionResult> LanzarAjusteDesdeFecha(DateTime fechaInicio)
        {
            try
            {
                await _loadDataService.AdjustOverloadsFromDateAsync(fechaInicio);
                TempData["GlobalAjusteMensaje"] = $"✅ Proceso de ajuste lanzado desde {fechaInicio:yyyy-MM-dd}.";
            }
            catch (Exception ex)
            {
                TempData["GlobalAjusteMensaje"] = $"❌ Error al lanzar el ajuste: {ex.Message}";
            }

            return RedirectToAction("AjustarOverloadManual");
        }

        [HttpPost]
        public async Task<IActionResult> FixUsersWithoutRole()
        {
            var users = await _userManager.Users.ToListAsync();
            int fixedCount = 0;
            int alreadyOk = 0;

            foreach (var user in users)
            {
                var roles = await _userManager.GetRolesAsync(user);
                if (!roles.Any())
                {
                    var result = await _userManager.AddToRoleAsync(user, "Researcher");
                    if (result.Succeeded)
                        fixedCount++;
                }
                else
                {
                    alreadyOk++;
                }
            }

            return Json(new
            {
                success = true,
                message = $"✅ Rol 'Researcher' asignado a {fixedCount} usuario(s) sin rol. Otros {alreadyOk} ya estaban correctamente configurados."
            });
        }

        [HttpPost]        
        public async Task<IActionResult> SendTimesheetReminderTest(string email, bool firstWeek)
        {
            if (string.IsNullOrWhiteSpace(email))
                return Json(new { success = false, message = "Debe indicar un correo electrónico válido." });

            var person = await _context.Personnel.FirstOrDefaultAsync(p => p.Email == email);
            if (person == null)
                return Json(new { success = false, message = $"No se encontró ninguna persona con el correo {email}." });

            await _reminderService.SendTimesheetRemindersToSingleUserAsync(person.Id, firstWeek);

            return Json(new
            {
                success = true,
                message = $"Recordatorio enviado a {email}. Ver logs del servidor para confirmar."
            });
        }

        [HttpGet]
        [Authorize(Policy = "AdminPolicy")]
        public async Task<IActionResult> RemindersWeeklyDryRun(int? year, int? month, bool onlySend = true)
        {
            var today = DateTime.Today;
            int y = year ?? (today.Month == 1 ? today.Year - 1 : today.Year);
            int m = month ?? (today.Month == 1 ? 12 : today.Month - 1);

            var targetMonth = new DateTime(y, m, 1);
            var data = await _reminderService.ComputeWeeklyReminderCandidatesAsync(targetMonth, onlySend);

            return Json(new
            {
                TargetMonth = targetMonth.ToString("yyyy-MM"),
                UseAssignmentCap = _reminderOptions.UseAssignmentCap,
                ReplyTo = _reminderOptions.ReplyTo,
                CandidatesCount = data.Count,             // ahora ya filtrado
                WillSendCount = data.Count,               // coincide porque solo devuelves “send”
                Items = data
            });
        }



        [HttpPost]
        [Authorize(Policy = "AdminPolicy")]
        public async Task<IActionResult> SendReplyToSmokeTest(string to)
        {
            if (string.IsNullOrWhiteSpace(to))
                return BadRequest("Parámetro 'to' requerido.");

            string subject = "TRS Reply-To smoke test";
            string body = @"
        <p>Este es un email de prueba para verificar <strong>Reply-To</strong>.</p>
        <p>Responde con “Responder” a este email y comprueba que el destinatario del reply es:
        <code>" + (_reminderOptions.ReplyTo ?? "(no configurado)") + @"</code></p>";

            // Si la implementación soporta adjuntos/Reply-To, úsala
            if (_emailSender is IEmailSenderWithAttachments withAttach)
            {
                await withAttach.SendEmailAsync(
                    to: to,
                    subject: subject,
                    htmlBody: body,
                    attachments: Array.Empty<EmailAttachment>(),
                    copyTo: null,
                    replyTo: _reminderOptions.ReplyTo,
                    fromDisplayName: _reminderOptions.FromDisplayName
                );
            }
            else
            {
                // Fallback: envía sin Reply-To (si tu IEmailSender no tiene esa sobrecarga)
                await _emailSender.SendEmailAsync(email: to, subject: subject, message: body);
                _logger.LogWarning("Reply-To no aplicado: la implementación de IEmailSender no soporta Reply-To. Usa IEmailSenderWithAttachments.");
            }

            return Ok(new
            {
                SentTo = to,
                ReplyToExpected = _reminderOptions.ReplyTo,
                FromDisplayName = _reminderOptions.FromDisplayName
            });
        }


        [HttpGet]
        [Authorize(Policy = "AdminPolicy")]
        public async Task<IActionResult> RemindersWeeklyDryRunView(int? year, int? month, string? q = null, bool onlySend = true)
        {
            var today = DateTime.Today;
            int y = year ?? (today.Month == 1 ? today.Year - 1 : today.Year);
            int m = month ?? (today.Month == 1 ? 12 : today.Month - 1);
            var targetMonth = new DateTime(y, m, 1);

            var data = await _reminderService.ComputeWeeklyReminderCandidatesAsync(targetMonth, onlySend);

            if (!string.IsNullOrWhiteSpace(q))
            {
                var ql = q.Trim().ToLowerInvariant();
                data = data.Where(d =>
                    (d.PersonName ?? "").ToLowerInvariant().Contains(ql) ||
                    (d.Email ?? "").ToLowerInvariant().Contains(ql)
                ).ToList();
            }

            ViewBag.TargetMonth = targetMonth.ToString("MMMM yyyy");
            ViewBag.UseAssignmentCap = _reminderOptions.UseAssignmentCap;
            ViewBag.ReplyTo = _reminderOptions.ReplyTo;
            ViewBag.Query = q ?? "";
            ViewBag.Year = y;
            ViewBag.Month = m;

            data = data
                .OrderBy(r => r.PersonName)
                .ToList();

            return View("RemindersWeeklyDryRunView", data);
        }


    }



}





public class FolderPathModel
{
    public string FolderPath { get; set; }
}

public class AdjustEffortRequest
{
    public int WpId { get; set; }
    public int PersonId { get; set; }
    public DateTime Month { get; set; }
}

public class DateRangeModel
{
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
}


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\ErrorController.cs -----
using Microsoft.AspNetCore.Mvc;

namespace TRS2._0.Controllers
{
    public class ErrorController : Controller
    {
        [Route("Error/AccessDenied")]
        public IActionResult AccessDenied()
        {
            return View();
        }
    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\HomeController.cs -----
using Microsoft.AspNetCore.Mvc;
using System.Diagnostics;
using TRS2._0.Models;

namespace TRS2._0.Controllers
{
    public class HomeController : Controller
    {
        private readonly ILogger<HomeController> _logger;

        public HomeController(ILogger<HomeController> logger)
        {
            _logger = logger;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult Privacy()
        {
            return View();
        }

        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error()
        {
            return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }

        public IActionResult Welcome()
        {
            return View();
        }

    }

    [Route("diagnostic")]
    public class DiagnosticController : Controller
    {
        private readonly IConfiguration _configuration;

        public DiagnosticController(IConfiguration configuration)
        {
            _configuration = configuration;
        }

        [HttpGet("db")]
        public IActionResult GetDatabaseConnection()
        {
            var connectionString = _configuration.GetConnectionString("DefaultConnection");
            return Ok($"Base de datos en uso: {connectionString}");
        }
    }
}


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\LeaderController.cs -----
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Globalization;
using System.Linq;
using System.Text;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;

namespace TRS2._0.Controllers
{
    [Authorize(Roles = "Leader, Admin, ProjectManager")]   


    public class LeaderController : Controller
    {
        private readonly TRSDBContext _context;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly WorkCalendarService _workCalendarService;

        public LeaderController(TRSDBContext context, UserManager<ApplicationUser> userManager, WorkCalendarService workCalendarService)
        {
            _context = context;
            _userManager = userManager;
            _workCalendarService = workCalendarService;
        }

        [HttpGet]
        public async Task<IActionResult> EffortSummary(int? year = null)
        {
            if (year == null)
                year = DateTime.Today.Year;

            var currentUser = await _userManager.GetUserAsync(User);

            var effectiveLeaderId = await GetEffectiveLeaderId(currentUser);
            if (!effectiveLeaderId.HasValue)
                return Forbid();

            IQueryable<Personnel> personsQuery = _context.Personnel.AsQueryable();

            // Cargar TODAS las entradas del líder
            var leaderEntries = await _context.Leaders
                .Where(l => l.LeaderId == effectiveLeaderId.Value)
                .ToListAsync();

            if (!leaderEntries.Any())
            {
                if (User.IsInRole("ProjectManager"))
                    return View("NotLeaderMessage");

                return Forbid();
            }

            // Identificar todos los grupos y departamentos del líder
            var groupIds = leaderEntries
                .Where(l => l.Tipo == "G")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            var deptIds = leaderEntries
                .Where(l => l.Tipo == "D")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            // Filtrar personas que pertenezcan a cualquiera de los grupos o departamentos del líder
            personsQuery = personsQuery.Where(p =>                            
                            (
                                (groupIds.Any() && groupIds.Contains((int)p.PersonnelGroup)) ||
                                (deptIds.Any() && deptIds.Contains((int)p.Department))
                            )
                        );


            // Fechas de inicio y fin del año
            var monthStart = new DateTime(year.Value, 1, 1);
            var monthEnd = new DateTime(year.Value, 12, 31);

            // Filtrar solo personas con contrato activo en cualquier momento del año
            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d =>
                    d.PersId == p.Id &&
                    d.Start <= monthEnd &&
                    (d.End == null || d.End >= monthStart))
            );

            var persons = await personsQuery.ToListAsync();
            var personIds = persons.Select(p => p.Id).ToList();

            // Obtener los WPX de esas personas
            var wpxPeople = await _context.Wpxpeople
                .Include(wpx => wpx.WpNavigation)
                    .ThenInclude(wp => wp.Proj)
                .Where(wpx => personIds.Contains(wpx.Person))
                .ToListAsync();

            var wpxIds = wpxPeople.Select(wpx => wpx.Id).ToList();

            // Cargar efforts
            var persefforts = await _context.Persefforts
                .Where(p => wpxIds.Contains(p.WpxPerson) &&
                            p.Month >= monthStart && p.Month <= monthEnd)
                .ToListAsync();

            // Agrupar efforts por persona → proyecto → WP
            var effortsByPerson = wpxPeople
                .GroupBy(wpx => wpx.Person)
                .ToDictionary(g => g.Key, g =>
                    g.GroupBy(wpx => wpx.WpNavigation.Proj)
                    .OrderBy(pg => pg.Key.Acronim)
                    .Select(projectGroup =>
                    {
                        var wpEfforts = projectGroup
                            .Select(wpx =>
                            {
                                var monthlyEffort = new Dictionary<int, decimal>();
                                decimal totalEffort = 0;

                                for (int m = 1; m <= 12; m++)
                                {
                                    var effortSum = persefforts
                                        .Where(pe => pe.WpxPerson == wpx.Id && pe.Month.Year == year && pe.Month.Month == m)
                                        .Sum(pe => pe.Value);

                                    monthlyEffort[m] = effortSum;
                                    totalEffort += effortSum;
                                }

                                return new { wpx, monthlyEffort, totalEffort };
                            })
                            .Where(x => x.totalEffort > 0) // Solo WPs con algo de esfuerzo
                            .Select(x => new LeaderEffortDetail
                            {
                                WP = x.wpx.WpNavigation.Name,
                                MonthlyEffort = x.monthlyEffort
                            })
                            .ToList();

                        return wpEfforts.Any()
                            ? new LeaderEffortDetail
                            {
                                Project = projectGroup.Key.Acronim,
                                SubEfforts = wpEfforts,
                                MonthlyEffort = new Dictionary<int, decimal>()
                            }
                            : null;
                    })
                    .Where(p => p != null)
                    .ToList()
                );

            // Construir el modelo
            var model = new LeaderEffortViewModel
            {
                Year = year.Value,
                People = persons
                    .OrderBy(p => p.Surname)
                    .ThenBy(p => p.Name)
                    .Select(p => new LeaderEffortPersonViewModel
                    {
                        PersonId = p.Id,
                        FullName = $"{p.Surname}, {p.Name}",
                        HasMultipleProjectsOrWPs = effortsByPerson.ContainsKey(p.Id) && effortsByPerson[p.Id].Count > 1,
                        Efforts = effortsByPerson.ContainsKey(p.Id) ? effortsByPerson[p.Id] : new List<LeaderEffortDetail>()
                    }).ToList()
            };

            return View(model);
        }


        [HttpGet]
        public async Task<IActionResult> TimesheetOverview(int? year = null)
        {
            int selectedYear = year ?? DateTime.Today.Year;

            var currentUser = await _userManager.GetUserAsync(User);
            if (!User.IsInRole("Admin") && currentUser?.PersonnelId == null)
                return Forbid();

            int? effectiveLeaderId = null;
            if (User.IsInRole("Admin"))
            {
                if (Request.Query.ContainsKey("leaderId") && int.TryParse(Request.Query["leaderId"], out int parsedId))
                    effectiveLeaderId = parsedId;
                else
                    effectiveLeaderId = 1071; // Simulación por defecto
            }
            else if (User.IsInRole("Leader"))
            {
                effectiveLeaderId = currentUser?.PersonnelId;
            }

            if (!effectiveLeaderId.HasValue)
                return Forbid();

            // ⬇️ NUEVO: cargar TODAS las entradas del líder
            var leaderEntries = await _context.Leaders
                .Where(l => l.LeaderId == effectiveLeaderId.Value)
                .ToListAsync();

            if (!leaderEntries.Any())
            {
                if (User.IsInRole("ProjectManager"))
                    return View("NotLeaderMessage");

                return Forbid();
            }

            // ⬇️ NUEVO: identificar todos los grupos y departamentos del líder
            var groupIds = leaderEntries
                .Where(l => l.Tipo == "G")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            var deptIds = leaderEntries
                .Where(l => l.Tipo == "D")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            // ⬇️ NUEVO: filtrar personas que pertenezcan a cualquiera de los grupos/departamentos
            IQueryable<Personnel> personsQuery = _context.Personnel.AsQueryable();
            personsQuery = personsQuery.Where(p =>
                (groupIds.Any() && groupIds.Contains((int)p.PersonnelGroup)) ||
                (deptIds.Any() && deptIds.Contains((int)p.Department))
            );

            // Fechas del año seleccionado
            var monthStart = new DateTime(selectedYear, 1, 1);
            var monthEnd = new DateTime(selectedYear, 12, 31);

            // Igual que en EffortSummary: sólo personas con contrato activo en algún momento del año
            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d =>
                    d.PersId == p.Id &&
                    d.Start <= monthEnd &&
                    (d.End == null || d.End >= monthStart))
            );

            // A partir de aquí, el código original
            var persons = await personsQuery
                .OrderBy(p => p.Surname).ThenBy(p => p.Name)
                .ToListAsync();

            var personIds = persons.Select(p => p.Id).ToList();

            var wpxPeople = await _context.Wpxpeople
                .Where(wpx => personIds.Contains(wpx.Person))
                .ToListAsync();

            var wpxIds = wpxPeople.Select(wpx => wpx.Id).ToList();

            var allTimesheets = await _context.Timesheets
                .Where(ts => wpxIds.Contains(ts.WpxPersonId) && ts.Day.Year == selectedYear)
                .ToListAsync();

            var allLeaves = await _context.Leaves
                .Where(l => l.Day.Year == selectedYear)
                .ToListAsync();

            var allHolidays = await _context.NationalHolidays
                .Where(h => h.Date.Year == selectedYear)
                .ToListAsync();

            var dailyHoursCache = await _workCalendarService.PreloadDailyWorkHoursWithDedicationAsync(personIds, selectedYear);

            var result = new LeaderTimesheetOverviewViewModel
            {
                Year = selectedYear,
                People = new List<LeaderTimesheetPersonViewModel>()
            };

            foreach (var person in persons)
            {
                var entry = new LeaderTimesheetPersonViewModel
                {
                    PersonId = person.Id,
                    FullName = $"{person.Surname}, {person.Name}",
                    MonthlyHours = new Dictionary<int, (decimal Registered, decimal Max)>()
                };

                var wpxForPerson = wpxPeople.Where(w => w.Person == person.Id).Select(w => w.Id).ToList();

                for (int m = 1; m <= 12; m++)
                {
                    var monthStartDate = new DateTime(selectedYear, m, 1);
                    var monthEndDate = monthStartDate.AddMonths(1).AddDays(-1);

                    var declared = allTimesheets
                        .Where(ts => wpxForPerson.Contains(ts.WpxPersonId) &&
                                     ts.Day >= monthStartDate &&
                                     ts.Day <= monthEndDate)
                        .Sum(ts => ts.Hours);

                    var max = _workCalendarService.CalculateGlobalHoursFromCache(
                        person.Id, selectedYear, m, dailyHoursCache, allLeaves, allHolidays);

                    entry.MonthlyHours[m] = (declared, max);
                }

                result.People.Add(entry);
            }

            return View("TimesheetOverview", result);
        }


        [HttpGet]
        public async Task<IActionResult> GlobalEffortSummary(int? year = null)
        {
            int selectedYear = year ?? DateTime.Today.Year;

            var currentUser = await _userManager.GetUserAsync(User);
            var effectiveLeaderId = await GetEffectiveLeaderId(currentUser);
            if (!effectiveLeaderId.HasValue)
                return Forbid();

            // 1) Cargar TODAS las entradas del líder (G y D)
            var leaderEntries = await _context.Leaders
                .Where(l => l.LeaderId == effectiveLeaderId.Value)
                .ToListAsync();

            if (!leaderEntries.Any())
            {
                if (User.IsInRole("ProjectManager"))
                    return View("NotLeaderMessage");

                return Forbid();
            }

            var groupIds = leaderEntries
                .Where(l => l.Tipo == "G")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            var deptIds = leaderEntries
                .Where(l => l.Tipo == "D")
                .Select(l => l.GrupoDepartamento)
                .ToList();

            // 2) Fechas del año (usaremos rango en vez de comparar por .Year)
            var yearStart = new DateTime(selectedYear, 1, 1);
            var yearEnd = new DateTime(selectedYear, 12, 31);

            // 3) Personas en el ámbito (unión de grupos/deptos) y con contrato activo en algún momento del año
            IQueryable<Personnel> personsQuery = _context.Personnel.AsQueryable();

            personsQuery = personsQuery.Where(p =>
                (groupIds.Any() && groupIds.Contains((int)p.PersonnelGroup)) ||
                (deptIds.Any() && deptIds.Contains((int)p.Department))
            );

            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d =>
                    d.PersId == p.Id &&
                    d.Start <= yearEnd &&
                   (d.End == null || d.End >= yearStart))
            );

            var persons = await personsQuery
                .OrderBy(p => p.Surname).ThenBy(p => p.Name)
                .ToListAsync();

            var personIds = persons.Select(p => p.Id).ToList();
            if (personIds.Count == 0)
                return View("GlobalEffortSummary", new LeaderGlobalEffortViewModel
                {
                    Year = selectedYear,
                    People = new List<LeaderGlobalEffortPersonViewModel>()
                });

            // 4) WPxPerson de las personas filtradas
            var wpxpeople = await _context.Wpxpeople
                .Where(wpx => personIds.Contains(wpx.Person))
                .ToListAsync();

            var wpxIds = wpxpeople.Select(wpx => wpx.Id).ToList();

            // Mapa rápido wpxId -> personId para evitar First(...) en el GroupBy
            var wpxToPerson = wpxpeople.ToDictionary(w => w.Id, w => w.Person);

            // 5) Efforts del año (rango, no .Year) y agregado por persona/mes
            var efforts = await _context.Persefforts
                .Where(p => wpxIds.Contains(p.WpxPerson) && p.Month >= yearStart && p.Month <= yearEnd)
                .ToListAsync();

            var effortData = efforts
                .GroupBy(p => new { PersonId = wpxToPerson[p.WpxPerson], Month = p.Month.Month })
                .Select(g => new
                {
                    g.Key.PersonId,
                    g.Key.Month,
                    TotalEffort = g.Sum(x => x.Value)
                })
                .ToList();

            // 6) Máximos de la tabla PersMonthEfforts (mismo rango)
            var maxEfforts = await _context.PersMonthEfforts
                .Where(p => personIds.Contains(p.PersonId) && p.Month >= yearStart && p.Month <= yearEnd)
                .ToListAsync();

            var model = new LeaderGlobalEffortViewModel
            {
                Year = selectedYear,
                People = new List<LeaderGlobalEffortPersonViewModel>()
            };

            // 7) Construcción del modelo por persona
            foreach (var person in persons)
            {
                var monthly = new Dictionary<int, (decimal Registered, decimal Max)>();

                for (int m = 1; m <= 12; m++)
                {
                    var registered = effortData.FirstOrDefault(e => e.PersonId == person.Id && e.Month == m)?.TotalEffort ?? 0m;
                    var max = maxEfforts.FirstOrDefault(x => x.PersonId == person.Id && x.Month.Month == m)?.Value ?? 0m;

                    monthly[m] = (registered, max);
                }

                model.People.Add(new LeaderGlobalEffortPersonViewModel
                {
                    PersonId = person.Id,
                    FullName = $"{person.Surname}, {person.Name}",
                    MonthlyEffort = monthly
                });
            }

            return View("GlobalEffortSummary", model);
        }


        [HttpGet]
        public async Task<IActionResult> ExportGlobalEffortToCsv(int? year = null)
        {
            if (year == null)
                year = DateTime.Today.Year;

            var currentUser = await _userManager.GetUserAsync(User);
            var effectiveLeaderId = await GetEffectiveLeaderId(currentUser);
            if (!effectiveLeaderId.HasValue)
                return Forbid();

            var leaderEntry = await _context.Leaders.FirstOrDefaultAsync(l => l.LeaderId == effectiveLeaderId);
            if (leaderEntry == null)
            {
                if (User.IsInRole("ProjectManager"))
                    return View("NotLeaderMessage");

                return Forbid();
            }

            IQueryable<Personnel> personsQuery = _context.Personnel;
            if (leaderEntry.Tipo == "D")
                personsQuery = personsQuery.Where(p => p.Department == leaderEntry.GrupoDepartamento);
            else if (leaderEntry.Tipo == "G")
                personsQuery = personsQuery.Where(p => p.PersonnelGroup == leaderEntry.GrupoDepartamento);

            var monthStart = new DateTime(year.Value, 1, 1);
            var monthEnd = new DateTime(year.Value, 12, 31);

            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d => d.PersId == p.Id && d.Start <= monthEnd && (d.End == null || d.End >= monthStart))
            );

            var persons = await personsQuery.OrderBy(p => p.Surname).ThenBy(p => p.Name).ToListAsync();
            var personIds = persons.Select(p => p.Id).ToList();

            var wpxpeople = await _context.Wpxpeople.Where(w => personIds.Contains(w.Person)).ToListAsync();
            var wpxIds = wpxpeople.Select(w => w.Id).ToList();

            var efforts = await _context.Persefforts
                .Where(p => wpxIds.Contains(p.WpxPerson) && p.Month.Year == year.Value)
                .ToListAsync();

            var effortData = efforts
                .GroupBy(p => new
                {
                    PersonId = wpxpeople.First(w => w.Id == p.WpxPerson).Person,
                    Month = p.Month.Month
                })
                .Select(g => new
                {
                    g.Key.PersonId,
                    g.Key.Month,
                    TotalEffort = g.Sum(x => x.Value)
                })
                .ToList();

            var maxEfforts = await _context.PersMonthEfforts
                .Where(p => personIds.Contains(p.PersonId) && p.Month.Year == year.Value)
                .ToListAsync();

            var sb = new StringBuilder();

            // Cabecera: Person, January, February, ...
            sb.Append("Person");
            for (int m = 1; m <= 12; m++)
            {
                sb.Append($";{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)}");
            }
            sb.AppendLine();

            foreach (var person in persons)
            {
                sb.Append($"{person.Surname}, {person.Name}");

                for (int m = 1; m <= 12; m++)
                {
                    var assigned = effortData.FirstOrDefault(e => e.PersonId == person.Id && e.Month == m)?.TotalEffort ?? 0;
                    var max = maxEfforts.FirstOrDefault(x => x.PersonId == person.Id && x.Month.Month == m)?.Value ?? 0;

                    sb.Append($";{assigned:0.##}|{max:0.##}");
                }

                sb.AppendLine();
            }

            var fileName = $"GlobalEffortSummary_{year}.csv";
            var csvBytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(sb.ToString())).ToArray(); // BOM manual

            return File(csvBytes, "text/csv", fileName);


        }

        [HttpGet]
        public async Task<IActionResult> ExportTimesheetOverviewToCsv(int? year = null)
        {
            if (year == null) year = DateTime.Today.Year;

            var currentUser = await _userManager.GetUserAsync(User);
            int? effectiveLeaderId = User.IsInRole("Admin") ? 1061 : currentUser?.PersonnelId;
            if (!effectiveLeaderId.HasValue) return Forbid();

            var leaderEntry = await _context.Leaders.FirstOrDefaultAsync(l => l.LeaderId == effectiveLeaderId);
            if (leaderEntry == null) return Forbid();

            IQueryable<Personnel> personsQuery = _context.Personnel;
            if (leaderEntry.Tipo == "D")
                personsQuery = personsQuery.Where(p => p.Department == leaderEntry.GrupoDepartamento);
            else if (leaderEntry.Tipo == "G")
                personsQuery = personsQuery.Where(p => p.PersonnelGroup == leaderEntry.GrupoDepartamento);

            var monthStart = new DateTime(year.Value, 1, 1);
            var monthEnd = new DateTime(year.Value, 12, 31);

            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d => d.PersId == p.Id && d.Start <= monthEnd && (d.End == null || d.End >= monthStart))
            );

            var persons = await personsQuery.OrderBy(p => p.Surname).ThenBy(p => p.Name).ToListAsync();
            var personIds = persons.Select(p => p.Id).ToList();

            var wpxpeople = await _context.Wpxpeople
                .Where(w => personIds.Contains(w.Person))
                .ToListAsync();

            var wpxIds = wpxpeople.Select(w => w.Id).ToList();

            var timesheets = await _context.Timesheets
                .Where(t => wpxIds.Contains(t.WpxPersonId) && t.Day.Year == year.Value)
                .ToListAsync();

            var dailyHoursCache = await _workCalendarService.PreloadDailyWorkHoursWithDedicationAsync(personIds, year.Value);
            var allLeaves = await _context.Leaves.Where(l => l.Day.Year == year.Value).ToListAsync();
            var allHolidays = await _context.NationalHolidays.Where(h => h.Date.Year == year.Value).ToListAsync();

            var sb = new StringBuilder();
            sb.Append("Person");
            for (int m = 1; m <= 12; m++)
            {
                sb.Append($";{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)}");
            }
            sb.AppendLine();

            foreach (var person in persons)
            {
                sb.Append($"{person.Surname}, {person.Name}");

                var wpxForPerson = wpxpeople.Where(w => w.Person == person.Id).Select(w => w.Id).ToList();
                var tsForPerson = timesheets.Where(t => wpxForPerson.Contains(t.WpxPersonId)).ToList();

                for (int m = 1; m <= 12; m++)
                {
                    var registered = tsForPerson.Where(t => t.Day.Month == m).Sum(t => t.Hours);

                    var max = _workCalendarService.CalculateGlobalHoursFromCache(
                        person.Id, year.Value, m,
                        dailyHoursCache, allLeaves, allHolidays
                    );

                    sb.Append($";{registered:0.##}|{max:0.##}");
                }

                sb.AppendLine();
            }

            var fileName = $"TimesheetOverview_{year}.csv";
            var csvBytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(sb.ToString())).ToArray();
            return File(csvBytes, "text/csv", fileName);
        }

        [HttpGet]
        public async Task<IActionResult> ExportEffortSummaryToCsv(int year)
        {
            var currentUser = await _userManager.GetUserAsync(User);
            if (!User.IsInRole("Admin") && currentUser?.PersonnelId == null)
                return Forbid();

            int? effectiveLeaderId = User.IsInRole("Admin") ? 1061 : currentUser?.PersonnelId;
            if (!effectiveLeaderId.HasValue)
                return Forbid();

            var leaderEntry = await _context.Leaders.FirstOrDefaultAsync(l => l.LeaderId == effectiveLeaderId);
            if (leaderEntry == null)
                return Forbid();

            IQueryable<Personnel> personsQuery = _context.Personnel;
            if (leaderEntry.Tipo == "D")
                personsQuery = personsQuery.Where(p => p.Department == leaderEntry.GrupoDepartamento);
            else
                personsQuery = personsQuery.Where(p => p.PersonnelGroup == leaderEntry.GrupoDepartamento);

            var monthStart = new DateTime(year, 1, 1);
            var monthEnd = new DateTime(year, 12, 31);

            personsQuery = personsQuery.Where(p =>
                _context.Dedications.Any(d => d.PersId == p.Id && d.Start <= monthEnd && (d.End == null || d.End >= monthStart)));

            var persons = await personsQuery
                .OrderBy(p => p.Surname)
                .ThenBy(p => p.Name)
                .ToListAsync();

            var personIds = persons.Select(p => p.Id).ToList();

            var wpxpeople = await _context.Wpxpeople
                .Include(w => w.WpNavigation)
                    .ThenInclude(wp => wp.Proj)
                .Where(w => personIds.Contains(w.Person))
                .ToListAsync();

            var wpxIds = wpxpeople.Select(wpx => wpx.Id).ToList();

            var efforts = await _context.Persefforts
                .Where(e => wpxIds.Contains(e.WpxPerson) && e.Month.Year == year)
                .ToListAsync();

            // Agrupar los datos y filtrar los que no tienen ningún esfuerzo en todo el año
            var grouped = wpxpeople
                .Select(wpx =>
                {
                    var monthly = Enumerable.Range(1, 12).ToDictionary(
                        m => m,
                        m => efforts.FirstOrDefault(e => e.WpxPerson == wpx.Id && e.Month.Month == m)?.Value ?? 0
                    );

                    var total = monthly.Values.Sum();
                    return new
                    {
                        PersonId = wpx.Person,
                        PersonName = persons.First(p => p.Id == wpx.Person),
                        Project = wpx.WpNavigation.Proj.Acronim,
                        WP = wpx.WpNavigation.Name,
                        MonthlyEfforts = monthly,
                        Total = total
                    };
                })
                .Where(g => g.Total > 0) // ❌ Excluir sin ningún effort en todo el año
                .OrderBy(g => g.PersonName.Surname)
                .ThenBy(g => g.PersonName.Name)
                .ThenBy(g => g.Project)
                .ThenBy(g => g.WP)
                .ToList();

            var sb = new StringBuilder();
            sb.AppendLine("Person;Project;WP;Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec");

            foreach (var row in grouped)
            {
                var name = $"{row.PersonName.Surname}, {row.PersonName.Name}";
                var line = $"\"{name}\";\"{row.Project}\";\"{row.WP}\"";

                for (int m = 1; m <= 12; m++)
                {
                    var val = row.MonthlyEfforts[m].ToString("0.##", CultureInfo.InvariantCulture);
                    line += $";{val}";
                }

                sb.AppendLine(line);
            }

            var fileName = $"EffortSummary_{year}.csv";
            var csvBytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(sb.ToString())).ToArray();
            return File(csvBytes, "text/csv", fileName);
        }

        private async Task<int?> GetEffectiveLeaderId(ApplicationUser currentUser)
        {
            if (User.IsInRole("Admin"))
                return Request.Query.ContainsKey("leaderId") && int.TryParse(Request.Query["leaderId"], out int parsedId) ? parsedId : 1071;

            if (User.IsInRole("Leader") || User.IsInRole("ProjectManager"))
            {
                if (currentUser?.PersonnelId == null)
                    return null;

                bool isLeader = await _context.Leaders.AnyAsync(l => l.LeaderId == currentUser.PersonnelId);
                return isLeader ? currentUser.PersonnelId : null;
            }

            return null;
        }

    }

}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\LoadDataController.cs -----
using Microsoft.AspNetCore.Mvc;
using Quartz;
using TRS2._0.Services;

namespace TRS2._0.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class LoadDataController : ControllerBase
    {
        private readonly ISchedulerFactory _schedulerFactory;

        public LoadDataController(ISchedulerFactory schedulerFactory)
        {
            _schedulerFactory = schedulerFactory;
        }

        [HttpGet("/Carga")]
        public async Task<IActionResult> TriggerLoadDataJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "UpdateMonthlyPMs"},
            
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena con los parámetros específicos
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de carga de datos se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de datos no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de datos: {ex.Message}");
            }
        }


        [HttpGet("/Liquidaciones")]
        public async Task<IActionResult> TriggerLiquidationJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "Liquid.txt");
                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "LoadLiquidationsFromFile"},
                    {"FilePath", filePath}
                 };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de liquidación se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de liquidación no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de liquidación: {ex.Message}");
            }
        }

        [HttpGet("/ProcesaLiquidaciones")]

        public async Task<IActionResult> TriggerProcessLiquidationJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "ProcessLiquidations"},                    
                };
                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de procesamiento de liquidaciones se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de procesamiento de liquidaciones no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de procesamiento de liquidaciones: {ex.Message}");
            }
        }

        [HttpGet("/ProcesoLiquidacionesAvd")]

        public async Task<IActionResult> TriggerProcessLiquidationAdvJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "ProcessLiquidationsAdvanced"},
                };
                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de procesamiento de liquidaciones avanzado se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de procesamiento de liquidaciones avanzado no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de procesamiento de liquidaciones avanzado: {ex.Message}");
            }
        }

        [HttpGet("/CargaPersonal")]

        public async Task<IActionResult> TriggerLoadPersonnelJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Construye la ruta al archivo dentro del directorio de salida de la aplicación
                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "PERSONAL.txt");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "LoadPersonnelFromFile"},
                    {"FilePath", filePath}
                };
                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de carga de personal se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de personal no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de personal: {ex.Message}");
            }
        }

        [HttpGet("/CargaAfiliacionesYDedicaciones")]
        public async Task<IActionResult> TriggerLoadAffiliationsAndDedicationsJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Construye la ruta al archivo dentro del directorio de salida de la aplicación
                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "DEDICACIO3.txt");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                                {
                                    {"Action", "LoadAffiliationsAndDedicationsFromFile"},
                                    {"FilePath", filePath}
                                };


                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de carga de afiliaciones y dedicaciones se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de afiliaciones y dedicaciones no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de afiliaciones y dedicaciones: {ex.Message}");
            }
        }

        [HttpGet("/CargaGruposPersonas")]

        public async Task<IActionResult> TriggerLoadPersonGroupsJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Construye la ruta al archivo dentro del directorio de salida de la aplicación
                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "GRUPS.txt");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "LoadPersonnelGroupsFromFile"},
                    {"FilePath", filePath}
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de carga de grupos de personas se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de grupos de personas no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de grupos de personas: {ex.Message}");
            }
        }

        [HttpGet("/CargaLideres")]

        public async Task<IActionResult> TriggerLoadLeadersJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Construye la ruta al archivo dentro del directorio de salida de la aplicación
                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "Leaders.txt");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "LoadLeadersFromFile"},
                    {"FilePath", filePath}
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de carga de líderes se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de líderes no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de líderes: {ex.Message}");
            }
        }

        [HttpGet("/CargaProyectos")]

        public async Task<IActionResult> TriggerLoadProjectsJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Construye la ruta al archivo dentro del directorio de salida de la aplicación
                var filePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Dataload", "PROJECTES.txt");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "LoadProjectsFromFile"},
                    {"FilePath", filePath}
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey,jobDataMap);
                    return Ok("El trabajo de carga de proyectos se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de carga de proyectos no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de carga de proyectos: {ex.Message}");
            }
        }

        [HttpGet("/FetchAndSaveAgreementEvents")]
        public async Task<IActionResult> TriggerFetchAndSaveAgreementEventsJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "FetchAndSaveAgreementEvents"}
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de obtención y guardado de eventos de acuerdos se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de obtención y guardado de eventos de acuerdos no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de obtención y guardado de eventos de acuerdos: {ex.Message}");
            }
        }

        [HttpGet("/UpdatePersonnelUserIds")]
        public async Task<IActionResult> TriggerUpdatePersonnelUserIdsJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
            {
                {"Action", "UpdatePersonnelUserIds"}
            };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de actualización de UserIds se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de actualización de UserIds no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de actualización de UserIds: {ex.Message}");
            }
        }

        [HttpGet("/UpdateLeaveTable")]
        public async Task<IActionResult> TriggerUpdateLeaveTableJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
        {
            {"Action", "UpdateLeaveTable"}
        };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de actualización de la tabla leave se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de actualización de la tabla leave no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Maneja adecuadamente la excepción
                return StatusCode(500, $"Error al iniciar el trabajo de actualización de la tabla leave: {ex.Message}");
            }
        }

        [HttpGet("/ProcessInvestigatorsTimesheet")]
        public async Task<IActionResult> TriggerProcessInvestigatorsTimesheetJob()
        {
            try
            {
                // Obtén una instancia del scheduler
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
        {
            { "Action", "ProcessInvestigatorsTimesheet" }
        };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de procesamiento del timesheet para investigadores se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de procesamiento del timesheet para investigadores no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Manejo adecuado de excepciones con un código de error HTTP 500
                return StatusCode(500, $"Error al iniciar el trabajo de procesamiento del timesheet para investigadores: {ex.Message}");
            }
        }

        [HttpGet("/OutOfContractLoad")]
        public async Task<IActionResult> TriggerOutOfContractLoadJob()
        {
            try
            {
                // Obtén una instancia del scheduler
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
        {
            {"Action", "LoadOutOfContract"}
        };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena
                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de procesamiento fuera de contrato se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de procesamiento fuera de contrato no se encontró.");
                }
            }
            catch (Exception ex)
            {
                // Manejo adecuado de excepciones con un código de error HTTP 500
                return StatusCode(500, $"Error al iniciar el trabajo de procesamiento fuera de contrato: {ex.Message}");
            }
        }

        [HttpGet("/AdjustGlobalEffort")]

        public async Task<IActionResult> TriggerAdjustGlobalEffortJob()
        {
            try
            {
                var scheduler = await _schedulerFactory.GetScheduler();
                var jobKey = new JobKey("LoadDataServiceJob");

                // Configura JobDataMap con los parámetros específicos para esta acción
                var jobDataMap = new JobDataMap
                {
                    {"Action", "AdjustGlobalEffort"}
                };

                // Verifica si el trabajo ya está planificado o en ejecución y lo desencadena

                if (await scheduler.CheckExists(jobKey))
                {
                    await scheduler.TriggerJob(jobKey, jobDataMap);
                    return Ok("El trabajo de ajuste de esfuerzo global se ha iniciado.");
                }
                else
                {
                    return NotFound("El trabajo de ajuste de esfuerzo global no se encontró.");
                }
            }

            catch (Exception ex)
            {
                // Manejo adecuado de excepciones con un código de error HTTP 500
                return StatusCode(500, $"Error al iniciar el trabajo de ajuste de esfuerzo global: {ex.Message}");
            }
        }


    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\PersonnelsController.cs -----
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;

namespace TRS2._0.Controllers
{
    public class PersonnelsController : Controller
    {
        private readonly TRSDBContext _context;
        private readonly WorkCalendarService _workCalendarService;
        private readonly LoadDataService _loadDataService;

        public PersonnelsController(TRSDBContext context, WorkCalendarService workCalendarService, LoadDataService loadDataService)
        {
            _context = context;
            _workCalendarService = workCalendarService;
            _loadDataService = loadDataService;
        }

        // GET: Personnels
        public async Task<IActionResult> Index()
        {
            TempData.Remove("SelectedPersonId");
            var tRSDBContext = _context.Personnel.Include(p => p.DepartmentNavigation);
            return View(await tRSDBContext.ToListAsync());
        }

        // GET: Personnels/Details/5
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null || _context.Personnel == null)
            {
                return NotFound();
            }

            var personnel = await _context.Personnel
                .Include(p => p.DepartmentNavigation)
                .FirstOrDefaultAsync(m => m.Id == id);
            if (personnel == null)
            {
                return NotFound();
            }

            return View(personnel);
        }

        // GET: Personnels/Create
        public IActionResult Create()
        {
            ViewData["Department"] = new SelectList(_context.Departments, "Id", "Id");
            return View();
        }

        // POST: Personnels/Create
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create([Bind("Id,BscId,Name,Surname,Department,Affiliation,StartDate,EndDate,Category,Resp,PersonnelGroup,Email,A3code")] Personnel personnel)
        {
            if (ModelState.IsValid)
            {
                _context.Add(personnel);
                await _context.SaveChangesAsync();
                return RedirectToAction(nameof(Index));
            }
            ViewData["Department"] = new SelectList(_context.Departments, "Id", "Id", personnel.Department);
            return View(personnel);
        }

        // GET: Personnels/Edit/5
        public async Task<IActionResult> Edit(int? id)
        {
            if (id == null || _context.Personnel == null)
            {
                return NotFound();
            }

            var personnel = await _context.Personnel.FindAsync(id);
            if (personnel == null)
            {
                return NotFound();
            }
            ViewData["Department"] = new SelectList(_context.Departments, "Id", "Id", personnel.Department);
            return View(personnel);
        }

        // POST: Personnels/Edit/5
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(int id, [Bind("Id,BscId,Name,Surname,Department,Affiliation,StartDate,EndDate,Category,Resp,PersonnelGroup,Email,A3code")] Personnel personnel)
        {
            if (id != personnel.Id)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    _context.Update(personnel);
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!PersonnelExists(personnel.Id))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }
                return RedirectToAction(nameof(Index));
            }
            ViewData["Department"] = new SelectList(_context.Departments, "Id", "Id", personnel.Department);
            return View(personnel);
        }

        // GET: Personnels/Delete/5
        public async Task<IActionResult> Delete(int? id)
        {
            if (id == null || _context.Personnel == null)
            {
                return NotFound();
            }

            var personnel = await _context.Personnel
                .Include(p => p.DepartmentNavigation)
                .FirstOrDefaultAsync(m => m.Id == id);
            if (personnel == null)
            {
                return NotFound();
            }

            return View(personnel);
        }

        // POST: Personnels/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteConfirmed(int id)
        {
            if (_context.Personnel == null)
            {
                return Problem("Entity set 'TRSDBContext.Personnel'  is null.");
            }
            var personnel = await _context.Personnel.FindAsync(id);
            if (personnel != null)
            {
                _context.Personnel.Remove(personnel);
            }

            await _context.SaveChangesAsync();
            return RedirectToAction(nameof(Index));
        }

        private bool PersonnelExists(int id)
        {
            return (_context.Personnel?.Any(e => e.Id == id)).GetValueOrDefault();
        }

        [HttpGet]
        public async Task<IActionResult> GetFilteredPersonnel(string searchTerm)
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                // Devolver una lista vacía si no hay término de búsqueda
                return Json(new List<object>());
            }

            string[] searchParts = searchTerm.Split(' ');
            IQueryable<Personnel> query = _context.Personnel.Include(p => p.DepartmentNavigation);

            if (searchParts.Length > 1)
            {
                // Buscar por nombre y apellido si el término de búsqueda contiene un espacio
                string namePart = searchParts[0];
                string surnamePart = searchParts[1];
                query = query.Where(p => p.Name.Contains(namePart) && p.Surname.Contains(surnamePart));
            }
            else
            {
                // Buscar por nombre o apellido si el término de búsqueda no contiene un espacio
                query = query.Where(p => p.Name.Contains(searchTerm) || p.Surname.Contains(searchTerm));
            }

            // Ordenar los resultados por apellido y nombre
            query = query.OrderBy(p => p.Surname).ThenBy(p => p.Name);

            // Limitar los resultados a los primeros 50
            var filteredPersonnel = await query.Take(50)
                .Select(p => new
                {
                    p.Id,
                    p.Name,
                    p.Surname,
                    DepartmentName = p.DepartmentNavigation.Name
                })
                .ToListAsync();

            // Opcional: Guardar el ID de la primera persona encontrada en TempData
            if (filteredPersonnel.Any())
            {
                TempData["SelectedPersonId"] = filteredPersonnel.First().Id;
            }

            return Json(filteredPersonnel);
        }



        [HttpGet]
        public async Task<IActionResult> GetPersonDetails(int id)
        {
            TempData["SelectedPersonId"] = id;
            var personWithDetails = await _context.Personnel
                .Where(p => p.Id == id)
                .Select(p => new
                {
                    FullName = p.Name + " " + p.Surname,                    
                    DepartmentName = p.DepartmentNavigation.Name,
                    StartDate = p.StartDate.HasValue ? p.StartDate.Value.ToString("yyyy-MM-dd") : "",
                    EndDate = p.EndDate.HasValue ? p.EndDate.Value.ToString("yyyy-MM-dd") : "",
                    Category = p.Category,
                    ResponsiblePerson = _context.Personnel
                                        .Where(r => r.Id == p.Resp)
                                        .Select(r => r.Name + " " + r.Surname)
                                        .FirstOrDefault(), // Esto obtiene el nombre completo del responsable
                    PersonnelGroupName = _context.Personnelgroups
                                        .Where(pg => pg.Id == p.PersonnelGroup)
                                        .Select(pg => pg.GroupName)
                                        .FirstOrDefault(), // Esto obtiene el nombre del grupo de personal
                                                          // Agrega otros campos que necesites mostrar
                    Affiliation = p.Affiliation == 1 ? "BSC" : ""

                })
                .FirstOrDefaultAsync();

            if (personWithDetails == null)
                return Json(new { success = false });

            return Json(new { success = true, data = personWithDetails });
        }

        [HttpGet]
        // Método que muestra la vista del calendario
        public async Task<IActionResult> Calendar(int? personId)
        {

            if (personId.HasValue)
            {
                ViewBag.SelectedPersonId = personId.Value;
            }
            else if (TempData["SelectedPersonId"] != null)
            {
                ViewBag.SelectedPersonId = TempData["SelectedPersonId"];
                TempData.Keep("SelectedPersonId");
            }

            var persons = await _context.Personnel.ToListAsync();
            return View(persons);
        }

        [HttpGet]
        public async Task<IActionResult> GetLeaveEvents(int? personId)
        {
            if (!personId.HasValue)
                return Json(new List<object>());

            // Ejecutar en secuencia para evitar acceso simultáneo al DbContext
            var nationalHolidays = await _context.NationalHolidays
                .Select(n => new {
                    title = n.Description,
                    start = n.Date.ToString("yyyy-MM-dd"),
                    color = "green"
                })
                .ToListAsync();

            var travels = await _context.liqdayxproject
                .Where(l => l.PersId == personId)
                .Select(l => new {
                    title = "Travel",
                    start = l.Day.ToString("yyyy-MM-dd"),
                    color = "pink"
                })
                .ToListAsync();

            var leaves = await _context.Leaves
                .Where(l => l.PersonId == personId)
                .Select(l => new {
                    title = l.Type == 1 ? "Leave" :
                            l.Type == 2 ? "Personal Holiday" :
                            l.Type == 3 ? "No Contract Period" : "Partial Leave",
                    start = l.Day.ToString("yyyy-MM-dd"),
                    color = l.Type == 1 ? "darkorange" :
                            l.Type == 2 ? "lightblue" :
                            l.Type == 3 ? "red" : "lightcoral"
                })
                .ToListAsync();

            var events = nationalHolidays
                .Concat(travels)
                .Concat(leaves)
                .Cast<object>()
                .ToList();

            return Json(events);
        }




        [HttpGet]
        // Método que muestra la dedicacion de cada persona
        public async Task<IActionResult> Dedication(int? personId)
        {

            if (personId.HasValue)
            {
                ViewBag.SelectedPersonId = personId.Value;
            }
            else if (TempData["SelectedPersonId"] != null)
            {
                ViewBag.SelectedPersonId = TempData["SelectedPersonId"];
                TempData.Keep("SelectedPersonId");
            }

            var persons = await _context.Personnel.ToListAsync();
            return View(persons);
        }

        [HttpGet]
        public async Task<IActionResult> GetDedicationData(int personId)
        {
            var dedicationData = await _context.Dedications
                .Where(d => d.PersId == personId && d.Type != 0)
                .Select(d => new
                {
                    Id = d.Id,
                    pId = d.PersId,
                    StartDate = d.Start.ToString("yyyy-MM-dd"),
                    EndDate = d.End.ToString("yyyy-MM-dd"),
                    DedicationValue = 100 - (d.Reduc * 100) // Calcula el porcentaje
                })
                .ToListAsync();

            return Json(dedicationData);
        }

        [HttpPost]
        public async Task<IActionResult> UpdateDedication(int id, DateTime startDate, DateTime endDate, double dedication)
        {
            var dedicationToUpdate = await _context.Dedications.FindAsync(id);
            if (dedicationToUpdate == null)
            {
                return Json(new { success = false, message = "Dedication not found." });
            }

            dedicationToUpdate.Start = startDate;
            dedicationToUpdate.End = endDate;
            dedicationToUpdate.Reduc = (decimal)(1 - (dedication / 100));

            _context.Update(dedicationToUpdate);
            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "Dedication updated successfully." });
        }

        [HttpPost]
        public async Task<IActionResult> RemoveDedication(int id)
        {
            var dedicationToRemove = await _context.Dedications.FindAsync(id);
            if (dedicationToRemove == null)
            {
                return Json(new { success = false, message = "Dedication not found." });
            }

            _context.Dedications.Remove(dedicationToRemove);
            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "Dedication removed successfully." });
        }

        [HttpPost]

        public async Task<IActionResult> AddDedication(int personId, DateTime startDate, DateTime endDate, double dedication)
        {
            // Encontrar el valor máximo actual de Type para esa persona
            int maxType = await _context.Dedications
                .Where(d => d.PersId == personId)
                .Select(d => d.Type)
                .DefaultIfEmpty() // Esto asegura que se devuelva 0 si no hay registros
                .MaxAsync();

            // Incrementa el valor máximo en 1, o usa 2 si no hay registros existentes
            int newType = maxType == 0 ? 2 : maxType + 1;

            var dedicationToAdd = new Dedication
            {
                PersId = personId,
                Start = startDate,
                End = endDate,
                Reduc = (decimal)(1 - (dedication / 100)),
                Type = newType
            };

            _context.Dedications.Add(dedicationToAdd);
            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "Dedication added successfully." });
        }

        [HttpPost]
        public async Task<IActionResult> CalculateMonthlyPM(int personId, int year, int month)
        {
            var monthlyPM = await _workCalendarService.CalculateMonthlyPM(personId, year, month);
            
            return Json(new { success = true, data = monthlyPM });
        }

        // Método para mostrar la vista inicial de Travels
        [HttpGet]
        public async Task<IActionResult> Travels(int? personId)
        {
            // Si se ha proporcionado un ID de persona, lo pasamos a la vista
            if (personId.HasValue)
            {
                ViewBag.SelectedPersonId = personId.Value;
            }
            else if (TempData["SelectedPersonId"] != null)
            {
                // Si no hay ID, pero existe en TempData, se recupera
                ViewBag.SelectedPersonId = TempData["SelectedPersonId"];
                TempData.Keep("SelectedPersonId");
            }

            // Obtenemos la lista de personas del sistema
            var persons = await _context.Personnel.ToListAsync();
            return View(persons); // Pasamos la lista de personas a la vista
        }

        // Método para obtener los datos de viajes de una persona específica
        [HttpGet]
        public async Task<IActionResult> GetTravelData(int personId)
        {
            // Obtiene la lista de viajes relacionados con la persona
            var travels = await _context.Liquidations
                .Where(l => l.PersId == personId) // Filtra los viajes por el ID de la persona
                .Select(l => new
                {
                    Code = l.Id.ToString(),
                    StartDate = l.Start.ToString("yyyy-MM-dd"),
                    EndDate = l.End.ToString("yyyy-MM-dd"),
                    Project1 = l.Project1 ?? "N/A",
                    Dedication1 = (decimal?)l.Dedication1 ?? 0m,
                    Project2 = string.IsNullOrWhiteSpace(l.Project2) ? "N/A" : l.Project2,
                    Dedication2 = (decimal?)l.Dedication2 ?? 0m,
                    Status = l.Status == "3" ? "Approved" : l.Status == "2" ? "Cancelled" : "Pending"
                })
                .OrderBy(l => l.Status == "Pending" ? 0 : 1) // Ordena los viajes pendientes primero
                .ToListAsync(); // Convierte el resultado en una lista

            // Si no hay viajes, retorna un mensaje informativo
            if (travels == null || !travels.Any())
            {
                return Json(new { success = false, message = "No se encontraron viajes para esta persona." });
            }

            // Devuelve la lista de viajes con éxito
            return Json(new { success = true, data = travels });
        }

        // Método para mostrar la vista de viajes pendientes
        [HttpGet]
        public async Task<IActionResult> PendingTravels()
        {
            var pendingTravels = await _context.Liquidations
                .Where(l => l.Status == "4") 
                .Select(l => new
                {
                    Code = l.Id.ToString(),
                    PersonName = _context.Personnel
                        .Where(p => p.Id == l.PersId)
                        .Select(p => p.Name + " " + p.Surname)
                        .FirstOrDefault(), // Obtiene el nombre completo de la persona
                    StartDate = l.Start.ToString("yyyy-MM-dd"),
                    EndDate = l.End.ToString("yyyy-MM-dd"),
                    Project1 = l.Project1 ?? "N/A",
                    Dedication1 = (decimal?)l.Dedication1 ?? 0m,
                    Project2 = string.IsNullOrWhiteSpace(l.Project2) ? "N/A" : l.Project2,
                    Dedication2 = (decimal?)l.Dedication2 ?? 0m,
                    Destiny = l.Destiny,
                    Status = l.Status == "3" ? "Approved" : l.Status == "2" ? "Cancelled" : "Pending"
                })
                .ToListAsync(); // Convierte el resultado en una lista

            // Ordena los resultados en memoria
            var orderedPendingTravels = pendingTravels
                .OrderBy(l => l.Code.Substring(5, 2)) // Ordena por año
                .ThenBy(l => l.Code.Substring(0, 4)) // Luego ordena por el número de viaje
                .ToList();

            return View(orderedPendingTravels);
        }


        [HttpGet]
        public async Task<IActionResult> GetAllPendingTravels()
        {
            // Obtiene la lista de todos los viajes pendientes
            var pendingTravels = await _context.Liquidations
                .Where(l => l.Status == "4") // Filtra los viajes que están pendientes
                .Select(l => new
                {
                    Code = l.Id.ToString(),
                    PersonId = l.PersId,
                    PersonName = _context.Personnel
                        .Where(p => p.Id == l.PersId)
                        .Select(p => p.Name + " " + p.Surname)
                        .FirstOrDefault(), // Obtiene el nombre completo de la persona
                    StartDate = l.Start.ToString("yyyy-MM-dd"),
                    EndDate = l.End.ToString("yyyy-MM-dd"),
                    Project1 = l.Project1 ?? "N/A",
                    Dedication1 = (decimal?)l.Dedication1 ?? 0m,
                    Project2 = string.IsNullOrWhiteSpace(l.Project2) ? "N/A" : l.Project2,
                    Dedication2 = (decimal?)l.Dedication2 ?? 0m,
                    Status = "Pending"
                })
                .ToListAsync(); // Convierte el resultado en una lista

            // Si no hay viajes pendientes, retorna un mensaje informativo
            if (pendingTravels == null || !pendingTravels.Any())
            {
                return Json(new { success = false, message = "No se encontraron viajes pendientes." });
            }

            // Devuelve la lista de viajes pendientes con éxito
            return Json(new { success = true, data = pendingTravels });
        }




        // Método para aprobar un viaje (cambiar el estado a 3)
        [HttpPost]
        public async Task<IActionResult> ApproveTravel(string id)
        {
            try
            {
                // Buscamos el viaje por su ID
                var travel = await _context.Liquidations.FindAsync(id);
                if (travel == null)
                {
                    // Si no se encuentra, devolvemos un error
                    return Json(new { success = false, message = "Registro de viaje no encontrado." });
                }

                // Cambiamos el estado a 7 (aprobado y validado)
                travel.Status = "7";
                _context.Update(travel); // Marcamos el cambio
                await _context.SaveChangesAsync(); // Guardamos en la base de datos
                // Cargar de nuevo las liquidaciones a 0
                await _loadDataService.ProcessLiquidationsAsync();

                await _loadDataService.ProcessAdvancedLiquidationsAsync();


                return Json(new { success = true, message = "Viaje aprobado correctamente." }); // Respuesta de éxito
            }
            catch (Exception ex)
            {
                // Manejar errores inesperados
                return Json(new { success = false, message = $"Error al aprobar el viaje: {ex.Message}" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CancelTravel(string id)
        {
            try
            {                

                // Llama al método CancelLiquidation
                var result = await _loadDataService.CancelLiquidation(id);

                // Convertir el resultado a JsonResult para retornarlo directamente
                if (result is JsonResult jsonResult)
                {
                    return jsonResult;
                }

                // En caso de que no sea un JsonResult, retornar un error genérico
                return Json(new { success = false, message = "Unexpected response format from service." });
            }
            catch (Exception ex)
            {
                // Manejar errores inesperados
                return Json(new { success = false, message = $"Error canceling travel: {ex.Message}" });
            }
        }

        public async Task<IActionResult> LoginLog(int? year)
        {
            int selectedYear = year ?? DateTime.Now.Year;

            // Personas con contrato que toca el año
            var personIdsWithContract = await _context.Dedications
                .Where(d => d.Start != null && d.End != null
                    && d.Start <= new DateTime(selectedYear, 12, 31)
                    && d.End >= new DateTime(selectedYear, 1, 1))
                .Select(d => d.PersId)
                .Distinct()
                .ToListAsync();

            // Personas que además tienen algún effort en proyectos ABIERTO ese año
            var personIdsWithOpenEffort = await _context.Persefforts
                .Where(pe => pe.Month.Year == selectedYear)
                .Include(pe => pe.WpxPersonNavigation)
                    .ThenInclude(wpp => wpp.WpNavigation)
                        .ThenInclude(wp => wp.Proj)
                .Where(pe => pe.WpxPersonNavigation.WpNavigation.Proj != null
                          && pe.WpxPersonNavigation.WpNavigation.Proj.St1 == "ABIERTO")
                .Select(pe => pe.WpxPersonNavigation.Person)
                .Distinct()
                .ToListAsync();

            // Intersección: contrato + effort en proyecto abierto
            var eligibleIds = personIdsWithContract.Intersect(personIdsWithOpenEffort).ToList();

            var persons = await _context.Personnel
                .Where(p => eligibleIds.Contains(p.Id))
                .Include(p => p.DepartmentNavigation)
                .ToListAsync();

            // Todos los logins del año seleccionado
            var loginRows = await _context.UserLoginHistories
                .Where(l => l.LoginTime.Year == selectedYear)
                .Select(l => new { l.PersonId, l.LoginTime })
                .ToListAsync();

            // Primer login por persona/mes
            var firstLoginByPersMonth = loginRows
                .GroupBy(x => new { x.PersonId, Month = x.LoginTime.Month })
                .ToDictionary(
                    g => (g.Key.PersonId, g.Key.Month),
                    g => g.Min(x => x.LoginTime)
                );

            var entries = new List<LoginLogEntry>();

            foreach (var p in persons.OrderBy(p => p.Surname).ThenBy(p => p.Name))
            {
                var entry = new LoginLogEntry
                {
                    PersonName = $"{p.Surname}, {p.Name}",
                    Department = p.DepartmentNavigation?.Name ?? "",
                    Group = p.PersonnelGroup.HasValue
                        ? _context.Personnelgroups.FirstOrDefault(pg => pg.Id == p.PersonnelGroup)?.GroupName ?? ""
                        : "",
                    Email = p.Email ?? "",
                    MonthlyFirstLogin = new Dictionary<string, string>()
                };

                for (int m = 1; m <= 12; m++)
                {
                    var key = CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m);
                    if (firstLoginByPersMonth.TryGetValue((p.Id, m), out var dt))
                    {
                        // Formato compacto; cambia a "dd/MM/yyyy HH:mm" si quieres incluir hora
                        entry.MonthlyFirstLogin[key] = dt.ToLocalTime().ToString("dd/MM/yyyy");
                    }
                    else
                    {
                        entry.MonthlyFirstLogin[key] = ""; // sin login
                    }
                }

                entries.Add(entry);
            }

            var vm = new LoginLogViewModel
            {
                Year = selectedYear,
                Entries = entries
            };

            return View("LoginLog", vm);
        }

    }

}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\ProjectManagerController.cs -----
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Http;
using Microsoft.EntityFrameworkCore;
using TRS2._0.Services;
using TRS2._0.Models.DataModels;
using System.IO;
using System.Net.Mail;
using System.Threading.Tasks;
using System.Net;
using System.Collections.Generic;
using System;
using OfficeOpenXml;
using Serilog;
using System.Globalization;
using System.Linq;
using TRS2._0.Models.ViewModels.ProjectManager;
using TRS2._0.Models.ViewModels;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Authorization;
using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels;

[Authorize(Roles = "ProjectManager,Researcher,Admin")]
public class ProjectManagerController : Controller
{
    private readonly WorkCalendarService _workCalendarService;
    private readonly ILogger<ProjectManagerController> _logger;
    private readonly TRSDBContext _context;
    private readonly IConfiguration _configuration;
    private readonly UserManager<ApplicationUser> _userManager;

    public ProjectManagerController(WorkCalendarService workCalendarService, ILogger<ProjectManagerController> logger, TRSDBContext context, IConfiguration configuration, UserManager<ApplicationUser> userManager)
    {
        _workCalendarService = workCalendarService;
        _logger = logger;
        _context = context;
        _configuration = configuration;
        _userManager = userManager;
    }

    public async Task<IActionResult> Index()
    {
        var errores = await _context.TimesheetErrorLogs
    .Select(e => new TimesheetErrorLog
    {
        Id = e.Id,
        FileName = e.FileName,
        PersonName = e.PersonName,
        ProjectName = e.ProjectName,
        WorkPackageName = e.WorkPackageName,
        Month = e.Month,
        ErrorMessage = e.ErrorMessage,
        Timestamp = e.Timestamp,
        IsResolved = e.IsResolved,
        AuthorId = e.AuthorId ?? "" // 👈 aquí neutralizas el NULL
    })
    .OrderByDescending(e => e.Timestamp)
    .ToListAsync();


        var viewModel = new ProjectManagerViewModel
        {
            Errors = errores
        };

        return View(viewModel);
    }



    [HttpPost]
    public async Task<IActionResult> UploadAndProcessFiles(List<IFormFile> files)
    {
        var viewModel = new ProjectManagerViewModel();

        if (files == null || files.Count == 0)
        {
            ViewBag.Message = "No se seleccionaron archivos.";
            return View("Index", viewModel);
        }

        // Crear carpeta temporal única por sesión de usuario
        var userId = _userManager.GetUserId(User);
        var timestamp = DateTime.Now.ToString("yyyyMMddHHmmssfff");
        var sessionFolder = Path.Combine(Directory.GetCurrentDirectory(), "Uploads", $"{userId}_{timestamp}");

        Directory.CreateDirectory(sessionFolder);

        // Guardar los archivos subidos en la carpeta de sesión
        foreach (var file in files)
        {
            var filePath = Path.Combine(sessionFolder, file.FileName);
            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
        }

        // Procesar solo los archivos subidos en esta sesión
        viewModel = await ProcessFolderForPMs(sessionFolder);

        // Limpiar carpeta tras el procesamiento (éxito o error, no conservamos)
        try
        {
            Directory.Delete(sessionFolder, recursive: true);
        }
        catch (Exception ex)
        {
            _logger.LogWarning($"No se pudo borrar la carpeta temporal '{sessionFolder}': {ex.Message}");
        }

        ViewBag.Message = "Archivos procesados y esfuerzos ajustados correctamente.";
        return View("Index", viewModel);
    }



    private async Task<ProjectManagerViewModel> ProcessFolderForPMs(string folderPath)
    {
        var viewModel = new ProjectManagerViewModel
        {
            Errors = await _context.TimesheetErrorLogs.OrderByDescending(e => e.Timestamp).ToListAsync()
        };

        var currentUserId = _userManager.GetUserId(User);

        try
        {
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

            string[] files;
            if (System.IO.File.Exists(folderPath) && Path.GetExtension(folderPath).Equals(".xlsx", StringComparison.OrdinalIgnoreCase))
            {
                files = new[] { folderPath }; // solo un archivo específico
            }
            else if (System.IO.Directory.Exists(folderPath))
            {
                files = Directory.GetFiles(folderPath, "*.xlsx", SearchOption.AllDirectories);
            }
            else
            {
                throw new FileNotFoundException("No se encontró la ruta especificada ni como archivo ni como carpeta válida.");
            }

            foreach (var file in files)
            {
                using var package = new ExcelPackage(new FileInfo(file));
                var worksheet = package.Workbook.Worksheets[0];

                var monthAbbreviation = worksheet.Cells["B11"].Text.ToLower();
                var year = int.Parse(worksheet.Cells["B12"].Text);
                var month = DateTime.ParseExact(monthAbbreviation, "MMM", CultureInfo.InvariantCulture).Month;
                var daysInMonth = DateTime.DaysInMonth(year, month);
                var personName = worksheet.Cells["B9"].Text.Trim();

                var personnel = await _context.Personnel
                    .FirstOrDefaultAsync(p => (p.Name + " " + p.Surname).ToLower() == personName.ToLower());

                if (personnel == null)
                {
                    await LogErrorIfNotExists(file, personName, "N/A", "N/A", $"{month}/{year}", "Persona no encontrada en la base de datos.", currentUserId);
                    continue;
                }

                var personId = personnel.Id;

                for (int row = 23; row <= worksheet.Dimension.End.Row; row++)
                {
                    var line = worksheet.Cells[row, 1].Text;
                    if (line.StartsWith("Total Hours worked on project", StringComparison.OrdinalIgnoreCase)) break;

                    var lineParts = line.Split(' ');
                    if (lineParts.Length == 0)
                    {
                        await LogErrorIfNotExists(file, personName, "", "", $"{month}/{year}", "Línea vacía o mal formateada.", currentUserId);
                        continue;
                    }

                    string NormalizeStatic(string input) => string.Join(" ", input?.Trim().Split(new[] { ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>());

                    var sapCode = NormalizeStatic(lineParts[0]);

                    var projects = await _context.Projects.ToListAsync();
                    var project = projects.FirstOrDefault(p => NormalizeStatic(p.SapCode) == sapCode);

                    if (project == null)
                    {
                        await LogErrorIfNotExists(file, personName, line, "Desconocido", $"{month}/{year}", "Proyecto no encontrado (SAP Code).", currentUserId);
                        continue;
                    }

                    var wps = await _context.Wps.Where(wp => wp.ProjId == project.ProjId).ToListAsync();

                    var wpMatch = wps.FirstOrDefault(wp => NormalizeStatic(line.ToLower()).Contains(NormalizeStatic(wp.Name.ToLower())));

                    if (wpMatch == null)
                    {
                        await LogErrorIfNotExists(file, personName, line, project.Acronim, $"{month}/{year}", "WP no encontrado en el proyecto.", currentUserId);
                        continue;
                    }

                    var wpxPerson = await _context.Wpxpeople.FirstOrDefaultAsync(wpx => wpx.Person == personId && wpx.Wp == wpMatch.Id);

                    if (wpxPerson == null)
                    {
                        await LogErrorIfNotExists(file, personName, wpMatch.Name, project.Acronim, $"{month}/{year}", "El paquete de trabajo no está vinculado a la persona.", currentUserId);
                        continue;
                    }

                    for (int col = 3; col < 3 + daysInMonth; col++)
                    {
                        var hoursText = worksheet.Cells[row, col].Text;
                        if (string.IsNullOrWhiteSpace(hoursText)) continue;

                        var cultureInfo = new CultureInfo("es-ES");
                        if (!decimal.TryParse(hoursText, NumberStyles.AllowDecimalPoint | NumberStyles.AllowThousands, cultureInfo, out decimal hours))
                        {
                            await LogErrorIfNotExists(file, personName, wpMatch.Name, project.Acronim, $"{month}/{year}", $"Valor no válido en columna {col}: {hoursText}", currentUserId);
                            hours = 0;
                        }

                        var day = col - 2;
                        var date = new DateTime(year, month, day);

                        var existingTimesheet = await _context.Timesheets.FirstOrDefaultAsync(ts => ts.WpxPersonId == wpxPerson.Id && ts.Day == date);
                        if (existingTimesheet != null)
                            existingTimesheet.Hours = hours;
                        else
                            _context.Timesheets.Add(new Timesheet { WpxPersonId = wpxPerson.Id, Day = date, Hours = hours });
                    }

                    await _context.SaveChangesAsync();
                    await _workCalendarService.AdjustEffortAsync(wpMatch.Id, personId, new DateTime(year, month, 1));
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError($"Error al procesar la carpeta: {ex.Message}");
        }

        return viewModel;
    }




    [HttpPost]
    public async Task<IActionResult> MarkErrorAsResolved(int id)
    {
        var error = await _context.TimesheetErrorLogs.FindAsync(id);
        if (error != null)
        {
            _context.TimesheetErrorLogs.Remove(error);
            await _context.SaveChangesAsync();
        }

        return RedirectToAction("Index");
    }

    [Authorize(Roles = "ProjectManager,Researcher,Admin")]
    public IActionResult ReportError()
    {
        return View();
    }

    [HttpPost]
    [Authorize(Roles = "ProjectManager,Researcher,Admin")]
    public async Task<IActionResult> SubmitErrorReport(ReportErrorViewModel model)
    {
        if (!ModelState.IsValid)
        {
            return View("ReportError", model);
        }

        try
        {
            // Obtener configuración del SMTP desde appsettings.json
            var smtpSettings = _configuration.GetSection("Smtp");
            string host = smtpSettings["Host"];
            int port = int.Parse(smtpSettings["Port"]);
            string username = smtpSettings["Username"];
            string password = smtpSettings["Password"];

            // Obtener el usuario logueado
            var loggedInUser = await _context.Users.FirstOrDefaultAsync(u => u.UserName == User.Identity.Name);


            // Inicializar variables para nombre y apellido
            string name = string.Empty;
            string surname = string.Empty;

            if (loggedInUser != null)
            {
                // Obtener la información de Personnel usando el BscId
                var personnel = await _context.Personnel.FirstOrDefaultAsync(p => p.BscId == loggedInUser.UserName);
                if (personnel != null)
                {
                    name = personnel.Name;
                    surname = personnel.Surname;
                }
            }

            using (var client = new SmtpClient(host, port))
            {
                client.Credentials = new NetworkCredential(username, password);
                client.EnableSsl = true; // ⚠️ Prueba con false si sigue fallando

                var mailMessage = new MailMessage
                {
                    From = new MailAddress($"{username}@bsc.es"), // Usa el usuario autenticado
                    Subject = $"Nuevo Reporte de Error de {name} {surname}: {model.Title}",
                    Body = $"<h3>Detalles del Error</h3>" +
                           $"<p><strong>Título:</strong> {model.Title}</p>" +
                           $"<p><strong>Descripción:</strong></p><p>{model.Description}</p>",
                    IsBodyHtml = true
                };

                mailMessage.To.Add("david.reyes@bsc.es");
                mailMessage.CC.Add("cristian.cuadrado@bsc.es");

                // Adjuntar archivo si existe
                if (model.Attachment != null && model.Attachment.Length > 0)
                {
                    var fileName = Path.GetFileName(model.Attachment.FileName);
                    using (var stream = new MemoryStream())
                    {
                        await model.Attachment.CopyToAsync(stream);
                        mailMessage.Attachments.Add(new Attachment(new MemoryStream(stream.ToArray()), fileName));
                    }
                }

                await client.SendMailAsync(mailMessage);
            }

            TempData["SuccessMessage"] = "El reporte ha sido enviado con éxito.";
            return RedirectToAction("ReportError");
        }
        catch (SmtpException smtpEx)
        {
            _logger.LogError($"SMTP Error: {smtpEx.StatusCode} - {smtpEx.Message}");
            TempData["ErrorMessage"] = $"Hubo un error SMTP: {smtpEx.StatusCode} - {smtpEx.Message}";
        }
        catch (Exception ex)
        {
            _logger.LogError($"Error General al enviar correo: {ex.Message}");
            TempData["ErrorMessage"] = $"Hubo un error al enviar el reporte: {ex.Message}";
        }

        return RedirectToAction("ReportError");
    }

    private async Task LogErrorIfNotExists(string filePath, string personName, string workPackageName, string projectName, string month, string errorMessage, string authorId)
    {
        string fileName = Path.GetFileName(filePath);

        bool exists = await _context.TimesheetErrorLogs.AnyAsync(e =>
            e.FileName == fileName &&
            e.PersonName == personName &&
            e.WorkPackageName == workPackageName &&
            e.ProjectName == projectName &&
            e.Month == month &&
            e.ErrorMessage == errorMessage
        );

        if (!exists)
        {
            _context.TimesheetErrorLogs.Add(new TimesheetErrorLog
            {
                FileName = fileName,
                PersonName = personName,
                WorkPackageName = workPackageName,
                ProjectName = projectName,
                Month = month,
                ErrorMessage = errorMessage,
                AuthorId = authorId
            });
            await _context.SaveChangesAsync();
        }
    }


}




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\ProjectsController.cs -----
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TRS2._0.Models;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;
using System.Text.RegularExpressions;
using static TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel;
using System.Diagnostics;
using Microsoft.AspNetCore.Authorization;
using System.Text;
using OfficeOpenXml;
using System.Text.RegularExpressions;

namespace TRS2._0.Controllers
{
    
    public class ProjectsController : Controller
    {
        private readonly TRSDBContext _context;
        private readonly WorkCalendarService _workCalendarService;
        private readonly ILogger<ProjectsController> _logger;

        public ProjectsController(TRSDBContext context, WorkCalendarService workCalendarService, ILogger<ProjectsController> logger)
        {
            _context = context;
            _workCalendarService = workCalendarService;
            _logger = logger;
        }

        // GET: Projects


        [Route("Proyectos/InitialRedirect")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public IActionResult InitialRedirect()
        {
            // Simplemente redirige a Index sin parámetros
            return RedirectToAction("Index");
        }

        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public IActionResult Index()
        {
            // Obtener todos los años únicos de inicio y fin
            ViewBag.UniqueYears = _context.Projects
                .Where(p => p.St1 == "ABIERTO" &&
                            (p.St2 == "CONCEDIDO" || string.IsNullOrEmpty(p.St2)) &&
                            p.Visible == 1 &&
                            p.Start.HasValue &&
                            p.End.HasValue)
                .Select(p => p.Start.Value.Year)
                .Concat(_context.Projects
                    .Where(p => p.St1 == "ABIERTO" &&
                                (p.St2 == "CONCEDIDO" || string.IsNullOrEmpty(p.St2)) &&
                                p.Visible == 1 &&
                                p.Start.HasValue &&
                                p.End.HasValue)
                    .Select(p => p.End.Value.Year))
                .Distinct()
                .OrderBy(y => y)
                .ToList();

            // Obtener todos los proyectos válidos
            var projects = _context.Projects
                .Where(p => p.St1 == "ABIERTO" &&
                            (p.St2 == "CONCEDIDO" || string.IsNullOrEmpty(p.St2)) &&
                            p.Visible == 1)
                .ToList();

            // Año actual como selección inicial en la vista
            ViewBag.DefaultSelectedYear = DateTime.Now.Year;

            return View(projects);
        }



        // GET: Projects/Details/5
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null || _context.Projects == null)
            {
                return NotFound();
            }

            var project = await _context.Projects
                .Include(p => p.Wps)
                .ThenInclude(wp => wp.Wpxpeople)
                .FirstOrDefaultAsync(p => p.ProjId == id);

            if (project == null)
            {
                return NotFound();
            }

            // Recuperar los nombres completos del PM, PI y FM
            var pm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Pm);
            var pi = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Pi);
            var fm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Fm);

            // Preparar los datos para la vista
            ViewBag.PmFullName = pm != null ? $"{pm.Name} {pm.Surname}" : "No asignado";
            ViewBag.PiFullName = pi != null ? $"{pi.Name} {pi.Surname}" : "No asignado";
            ViewBag.FmFullName = fm != null ? $"{fm.Name} {fm.Surname}" : "No asignado";
            ViewBag.ProjId = id;

            // Calcular los valores distribuidos y los esfuerzos cubiertos para cada WP
            var wpDetails = project.Wps.Select(wp => new
            {
                wp.Id,
                wp.Name,
                wp.Pms,
                Distributed = _context.Projefforts.Where(pe => pe.Wp == wp.Id).Sum(pe => pe.Value),
                Covered = _context.Wpxpeople
                            .Where(wxp => wxp.Wp == wp.Id)
                            .SelectMany(wxp => wxp.Persefforts)
                            .Sum(pe => pe.Value)
            }).ToList();

            // Añadir wpDetails al ViewBag para acceder desde la vista
            ViewBag.WpDetails = wpDetails;
            ViewBag.CurrentProject = project.Acronim;

            return View(project);
        }



        // GET: Projects/Create
        
        public IActionResult Create()
        {
            return View();
        }

        // POST: Projects/Create
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        
        public async Task<IActionResult> Create([Bind("ProjId,SapCode,Acronim,Title,Contract,Start,End,TpsUpc,TpsIcrea,TpsCsic,Pi,Pm,Type,SType,St1,St2,EndReportDate,Visible")] Project project)
        {
            if (ModelState.IsValid)
            {
                _context.Add(project);
                await _context.SaveChangesAsync();
                return RedirectToAction(nameof(Index));
            }
            return View(project);
        }

        // GET: Projects/Edit/5
        
        public async Task<IActionResult> Edit(int? id)
        {
            if (id == null || _context.Projects == null)
            {
                return NotFound();
            }

            var project = await _context.Projects.FindAsync(id);
            if (project == null)
            {
                return NotFound();
            }
            return View(project);
        }

        // POST: Projects/Edit/5
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        
        public async Task<IActionResult> Edit(int id, [Bind("ProjId,SapCode,Acronim,Title,Contract,Start,End,TpsUpc,TpsIcrea,TpsCsic,Pi,Pm,Type,SType,St1,St2,EndReportDate,Visible")] Project project)
        {
            if (id != project.ProjId)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    _context.Update(project);
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!ProjectExists(project.ProjId))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }
                return RedirectToAction(nameof(Index));
            }
            return View(project);
        }

        // GET: Projects/Delete/5
        
        public async Task<IActionResult> Delete(int? id)
        {
            if (id == null || _context.Projects == null)
            {
                return NotFound();
            }

            var project = await _context.Projects
                .FirstOrDefaultAsync(m => m.ProjId == id);
            if (project == null)
            {
                return NotFound();
            }

            return View(project);
        }

        // POST: Projects/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        
        public async Task<IActionResult> DeleteConfirmed(int id)
        {
            if (_context.Projects == null)
            {
                return Problem("Entity set 'TRSDBContext.Projects'  is null.");
            }
            var project = await _context.Projects.FindAsync(id);
            if (project != null)
            {
                _context.Projects.Remove(project);
            }
            
            await _context.SaveChangesAsync();
            return RedirectToAction(nameof(Index));
        }

        private bool ProjectExists(int id)
        {
          return (_context.Projects?.Any(e => e.ProjId == id)).GetValueOrDefault();
        }

        [HttpGet]
        [Route("Projects/EffortPlan/{projId}")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public IActionResult EffortPlan(int projId)
        {
            var project = _context.Projects
                .Include(p => p.Wps)
                .FirstOrDefault(p => p.ProjId == projId);

            if (project == null)
            {
                return NotFound();
            }

            // Comprobación aquí: si no hay WorkPackages, manejar según corresponda
            if (project.Wps == null || !project.Wps.Any())
            {
                
                // Devolver la vista actual con un modelo vacío o con mensaje                
                var emptyModel = new EffortPlanViewModel
                {
                    
                    ProjId = projId,
                    WorkPackages = new List<WorkPackageEffort>() // Lista vacía
                                                                 
                };
                ViewBag.ProjId = projId;
                ViewBag.CurrentProject = project.Acronim;
                return View(emptyModel);
            }

            var startDate = project.Wps.Min(wp => wp.StartDate);
            var endDate = project.Wps.Max(wp => wp.EndDate);
            var effortValues = _context.Projefforts
                .Include(e => e.WpNavigation) // Incluye la relación para asegurar que WpNavigation no sea null
                .Where(e => e.WpNavigation.ProjId == projId)
                .ToList();  // Obtén todos los esfuerzos para este proyecto

            // Crear la estructura del modelo de vista
            var effortPlanViewModel = new EffortPlanViewModel
            {
                ProjId = projId,
                StartDate = startDate,
                EndDate = endDate,
                WorkPackages = project.Wps.Select(wp => new WorkPackageEffort
                {
                    StartDate = wp.StartDate,
                    EndDate = wp.EndDate,
                    WpId = wp.Id,
                    WpName = wp.Name,
                    MonthlyEfforts = Enumerable.Range(0, ((endDate.Year - startDate.Year) * 12) + endDate.Month - startDate.Month + 1)
                                    .Select(offset => new { Month = new DateTime(startDate.Year, startDate.Month, 1).AddMonths(offset), Effort = 0f })
                                    .ToDictionary(me => me.Month, me => me.Effort),
                    TotalEffort = 0 // Inicialmente 0, calcular después si es necesario
                }).ToList()
            };

            foreach (var effort in effortValues)
            {
                var wpEffort = effortPlanViewModel.WorkPackages.FirstOrDefault(wpe => wpe.WpId == effort.WpNavigation.Id);
                if (wpEffort != null)
                {
                    DateTime effortMonth = new DateTime(effort.Month.Year, effort.Month.Month, 1);
                    if (wpEffort.MonthlyEfforts.ContainsKey(effortMonth))
                    {
                        wpEffort.MonthlyEfforts[effortMonth] = (float)effort.Value;
                    }
                }
            }

            foreach (var wpEffort in effortPlanViewModel.WorkPackages)
            {
                // Calcula la suma de los esfuerzos mensuales
                var sumEffort = wpEffort.MonthlyEfforts.Sum(e => e.Value);

                // Redondea el resultado a 2 decimales (o al número de decimales que prefieras)
                wpEffort.TotalEffort = (float)Math.Round(sumEffort, 2);
            }
            ViewBag.ProjId = projId;
            ViewBag.CurrentProject = project.Acronim;

            // Ordenar por nombre y mover "TRAVELS" al final
            effortPlanViewModel.WorkPackages = effortPlanViewModel.WorkPackages
                                      .OrderBy(wp => wp.WpName == "TRAVELS" ? 1 : 0)
                                      .ThenBy(wp => wp.WpName)
                                      .ToList();
            return View(effortPlanViewModel); // Pasa el modelo a la vista
        }


        [HttpGet]
        [Route("Projects/PersonnelSelection/{projId}")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]

        // Método para la selección de personal dentro del contexto de un proyecto específico
        public async Task<IActionResult> PersonnelSelection(int projId)
        {
            var projectDetails = await _context.Projects.FindAsync(projId);
            var allPersonnel = await _context.Personnel.ToListAsync();
            // Recuperar los nombres completos del PM y PI
            var pm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == projectDetails.Pm);
            var pi = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == projectDetails.Pi);
            var fm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == projectDetails.Fm);
            var projectPersonnel = await _context.Projectxpeople
                                                .Where(px => px.ProjId == projId)
                                                .ToListAsync();

            // Primero obtenemos los WP asociados al proyecto
            var projectWpIds = await _context.Wps
                                             .Where(wp => wp.ProjId == projId)
                                             .Select(wp => wp.Id)
                                             .ToListAsync();

            // Luego obtenemos las relaciones de Wpxperson para los WP del proyecto
            var workPackagePersonnel = await _context.Wpxpeople
                                                     .Where(wpx => projectWpIds.Contains(wpx.Wp))
                                                     .ToListAsync();

            var workPackages = await _context.Wps
                                             .Where(wp => projectWpIds.Contains(wp.Id))
                                             .ToListAsync();
            ViewBag.PmFullName = pm != null ? $"{pm.Name} {pm.Surname}" : "No asignado";
            ViewBag.PiFullName = pi != null ? $"{pi.Name} {pi.Surname}" : "No asignado";
            ViewBag.FmFullName = fm != null ? $"{fm.Name} {fm.Surname}" : "No asignado";
            ViewBag.projId = projId;
            ViewBag.CurrentProject = projectDetails.Acronim;
            var viewModel = new ProjectPersonnelViewModel
            {
                ProjectDetails = projectDetails,
                AllPersonnel = allPersonnel,
                ProjectPersonnel = projectPersonnel,
                WorkPackagePersonnel = workPackagePersonnel,
                WorkPackages = workPackages
            };

            return View(viewModel);
        }


        [HttpPost]

        public async Task<IActionResult> AddPersonToProject(int projectId, int personId)
        {
            // Primero, verificar si la persona ya está asociada al proyecto
            var existingAssociation = await _context.Projectxpeople
                                                    .FirstOrDefaultAsync(px => px.ProjId == projectId && px.Person == personId);
            if (existingAssociation != null)
            {
                // La persona ya está asociada al proyecto
                return Json(new { success = false, message = "Person is already associated with the project." });
            }

            // Obtener las fechas del proyecto
            var project = await _context.Projects
                                        .FirstOrDefaultAsync(p => p.ProjId == projectId);
            if (project == null)
            {
                return NotFound();
            }

            // Verificar si la persona tiene un contrato válido en las fechas del proyecto
            var hasValidContract = await _context.Dedications
                                                 .AnyAsync(d => d.PersId == personId &&
                                                                d.Start <= project.EndReportDate &&
                                                                d.End >= project.Start);
            if (!hasValidContract)
            {
                // La persona no tiene un contrato válido en las fechas del proyecto
                return Json(new { success = false, message = "The person does not have a valid contract within the project dates." });
            }

            // Crear una nueva asociación de Projectxperson
            var projectPersonAssociation = new Projectxperson
            {
                ProjId = projectId,
                Person = personId
            };

            // Añadir la nueva asociación al contexto y guardar los cambios
            _context.Projectxpeople.Add(projectPersonAssociation);
            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "Person added to the project successfully." });
        }


        [HttpPost]
        
        public async Task<IActionResult> RemovePersonFromProject(int projectId, int personId)
        {
            // Eliminar la persona del proyecto
            var projectPerson = await _context.Projectxpeople
                                              .FirstOrDefaultAsync(px => px.ProjId == projectId && px.Person == personId);
            if (projectPerson != null)
            {
                _context.Projectxpeople.Remove(projectPerson);
            }

            // Eliminar la persona de todos los WP asociados
            var wpPersonnel = _context.Wpxpeople
                                      .Where(wpx => wpx.Person == personId && wpx.WpNavigation.ProjId == projectId);
            _context.Wpxpeople.RemoveRange(wpPersonnel);

            await _context.SaveChangesAsync();

            return Json(new { success = true });
        }


        [HttpPost]
        
        public async Task<IActionResult> UpdateWorkPackageAssignments([FromBody] List<WpPersonChange> changes)
        {
            
            foreach (var change in changes)
            {
                var wpId = (int)change.WpId;
                var personId = (int)change.PersonId;
                var existingAssignment = await _context.Wpxpeople
                                                      .FirstOrDefaultAsync(wpx => wpx.Wp == wpId && wpx.Person == personId);

                if (existingAssignment == null)
                {
                    // Crear nuevo registro
                    var newAssignment = new Wpxperson { Wp = wpId, Person = personId };
                    _context.Wpxpeople.Add(newAssignment);
                }
                else
                {
                    // Eliminar registro existente
                    _context.Wpxpeople.Remove(existingAssignment);
                }
            }

            await _context.SaveChangesAsync();
            return Json(new { success = true });
        }


        [HttpGet]
        [Route("Projects/PersonnelEffortPlan/{projId}/{wpId?}")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public async Task<IActionResult> PersonnelEffortPlan(int projId, int? wpId = null)
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew(); // Inicia el cronómetro

            ViewBag.projId = projId;     
            

            // Obtener el proyecto
            var project = await _context.Projects.FindAsync(projId);
            ViewBag.CurrentProject = project.Acronim;
            if (project == null)
            {
                return NotFound();
            }
            // Obtener WP del proyecto
            var workPackages = await _context.Wps.Where(wp => wp.ProjId == projId).ToListAsync();

            // Obtener relaciones entre personal y proyecto
            var projectPersonnel = await _context.Projectxpeople.Where(px => px.ProjId == projId).ToListAsync();

            // Obtener IDs de las personas involucradas en el proyecto
            var personIds = projectPersonnel.Select(p => p.Person).Distinct().ToList();

            // Obtener el rango de fechas del proyecto
            var projectStartDate = project.Start;
            DateTime projectEndReportDate = project.EndReportDate;


            // NEW: fin efectivo si algún WP se extiende más allá del EndReportDate
            DateTime? maxWpEndDate = workPackages.Count > 0
                ? workPackages.Max(wp => (DateTime?)wp.EndDate)
                : null;

            DateTime effectiveEndDate = (maxWpEndDate.HasValue && maxWpEndDate.Value > projectEndReportDate)
                ? maxWpEndDate.Value
                : projectEndReportDate;

            // Normaliza a inicio/fin de mes
            DateTime adjustedProjectStartDate = project.Start.HasValue
                ? new DateTime(project.Start.Value.Year, project.Start.Value.Month, 1)
                : DateTime.MinValue;

            DateTime adjustedProjectEndDate = new DateTime(
                effectiveEndDate.Year,
                effectiveEndDate.Month,
                DateTime.DaysInMonth(effectiveEndDate.Year, effectiveEndDate.Month)
            );


            // Recuperar todos los registros relevantes de PersMonthEfforts usando las fechas ajustadas
            var persMonthEfforts = await _context.PersMonthEfforts
                .Where(pme => personIds.Contains(pme.PersonId) &&
                              pme.Month >= adjustedProjectStartDate &&
                              pme.Month <= adjustedProjectEndDate)
                .ToListAsync();

            // Transformar a un diccionario para facilitar el acceso
            var pmValuesByPersonAndMonth = persMonthEfforts
                .GroupBy(pme => pme.PersonId)
                .ToDictionary(
                    group => group.Key,
                    group => group.ToDictionary(
                        pme => $"{pme.Month.Year}-{pme.Month.Month:D2}",
                        pme => pme.Value
                    )
                );

            // Recuperar y sumar los esfuerzos por persona y mes usando las fechas ajustadas
            var totalEffortsByPersonAndMonth = await _context.Persefforts
                .Include(pe => pe.WpxPersonNavigation)
                .Where(pe => personIds.Contains(pe.WpxPersonNavigation.Person) &&
                             pe.Month >= adjustedProjectStartDate && pe.Month <= adjustedProjectEndDate)
                .GroupBy(pe => new { pe.WpxPersonNavigation.Person, Year = pe.Month.Year, Month = pe.Month.Month })
                .Select(group => new {
                    PersonId = group.Key.Person,
                    Year = group.Key.Year,
                    Month = group.Key.Month,
                    TotalEffort = group.Sum(pe => pe.Value)
                })
                .ToListAsync();

            // Transformar a un diccionario para facilitar el acceso
            var totalEffortsByPersonAndMonthDict = totalEffortsByPersonAndMonth
                .GroupBy(e => e.PersonId)
                .ToDictionary(
                    group => group.Key,
                    group => group.ToDictionary(
                        e => $"{e.Year}-{e.Month:D2}",
                        e => e.TotalEffort
                    )
                );
                        

            // Obtener relaciones entre personal y WP
            var wpxPersons = await _context.Wpxpeople.Include(wpx => wpx.PersonNavigation)
                                                     .Include(wpx => wpx.WpNavigation)
                                                     .Where(wpx => workPackages.Select(wp => wp.Id).Contains(wpx.Wp))
                                                     .ToListAsync();

            var wpxPersonIdsListed = wpxPersons.Select(wpx => wpx.Id).ToList();


            // Obtener esfuerzos del personal y mapearlos
            var persefforts = await _context.Persefforts
                                            .Include(pe => pe.WpxPersonNavigation)
                                            .Where(pe => wpxPersonIdsListed.Contains(pe.WpxPerson) &&
                                                         pe.Month >= adjustedProjectStartDate &&
                                                         pe.Month <= adjustedProjectEndDate)
                                            .ToListAsync();


            var projectMonthLocksAllPersons = await _context.ProjectMonthLocks
                    .Where(l => l.ProjectId == projId &&
                                personIds.Contains(l.PersonId) &&
                                ((l.Year > adjustedProjectStartDate.Year || (l.Year == adjustedProjectStartDate.Year && l.Month >= adjustedProjectStartDate.Month)) &&
                                (l.Year < adjustedProjectEndDate.Year || (l.Year == adjustedProjectEndDate.Year && l.Month <= adjustedProjectEndDate.Month))))
                    .ToListAsync();

            // --- Datos para "Work Packages Details" (traspuesto) ---

            var wpIds = workPackages.Select(wp => wp.Id).ToList();

            // Distributed (plan)
            var distributedByWp = await _context.Projefforts
                .Where(pe => wpIds.Contains(pe.Wp))
                .GroupBy(pe => pe.Wp)
                .Select(g => new { WpId = g.Key, Total = g.Sum(x => x.Value) })
                .ToDictionaryAsync(x => x.WpId, x => x.Total);

            // Covered (real) desde persefforts ya cargados
            var coveredByWp = persefforts
                .GroupBy(pe => pe.WpxPersonNavigation.Wp)
                .ToDictionary(g => g.Key, g => g.Sum(x => x.Value));

            // Proyección (sin WP Id)
            var wpDetailsTransposed = workPackages.Select(wp => new
            {
                Name = wp.Name,                                                  // Para el encabezado de columna
                Estimated = wp.Pms,                                              // Antes "Pms"
                Distributed = distributedByWp.TryGetValue(wp.Id, out var d) ? d : 0m,
                CoveredWithPersonnel = coveredByWp.TryGetValue(wp.Id, out var c) ? c : 0m // Antes "Covered"
            })
            // Orden: alfabético y TRAVELS al final
            .OrderBy(x => string.Equals(x.Name, "TRAVELS", StringComparison.OrdinalIgnoreCase) ? 1 : 0)
            .ThenBy(x => string.Equals(x.Name, "TRAVELS", StringComparison.OrdinalIgnoreCase) ? "" : x.Name)
            .ToList();

            ViewBag.WpDetailsTransposed = wpDetailsTransposed;



            if (wpId.HasValue)
            {
                workPackages = workPackages.Where(wp => wp.Id == wpId.Value).ToList();

                wpxPersons = wpxPersons
                    .Where(wpx => wpx.Wp == wpId.Value)
                    .ToList();

                // Obtiene los IDs de WpxPerson para el WP seleccionado
                var wpxPersonIds = wpxPersons.Select(wpx => wpx.Id).ToList();

                // Filtra Persefforts por los IDs de WpxPerson seleccionados
                var filteredPersefforts = persefforts
                    .Where(pe => wpxPersonIds.Contains(pe.WpxPerson))
                    .ToList();

                // Suma los esfuerzos por mes
                var effortSumByMonth = filteredPersefforts
                    .GroupBy(pe => new { Year = pe.Month.Year, Month = pe.Month.Month })
                    .Select(group => new
                    {
                        Year = group.Key.Year,
                        Month = group.Key.Month,
                        TotalEffort = group.Sum(pe => pe.Value)
                    })
                    .OrderBy(x => x.Year).ThenBy(x => x.Month) // Asegura un orden cronológico
                    .ToList();

                // Opcional: Convertir a un diccionario o cualquier otra estructura que prefieras para la vista
                var effortSumByMonthDict = effortSumByMonth.ToDictionary(
                    k => new DateTime(k.Year, k.Month, 1), // Clave como fecha
                    v => v.TotalEffort
                );

                var filteredProjectEfforts = await _context.Projefforts
                    .Where(pe => pe.Wp == wpId.Value)
                    .ToListAsync();

                // Pasa los esfuerzos sumados a la vista

                ViewBag.FilteredProjectEfforts = filteredProjectEfforts;
                ViewBag.EffortSumByMonth = effortSumByMonthDict;


                ViewBag.SelectedWpId = wpId.Value;
            }

            


            // Construir ViewModel
            var viewModel = new PersonnelEffortPlanViewModel
            {
                Project = project,
                ProjectStartDate = adjustedProjectStartDate,   
                ProjectEndDate = adjustedProjectEndDate,
                WorkPackages = workPackages.Select(wp => new WorkPackageInfo
                {
                    WpId = wp.Id,
                    WpName = wp.Name,
                    StartDate = wp.StartDate,
                    EndDate = wp.EndDate,
                    PersonnelEfforts = wpxPersons.Where(wpx => wpx.Wp == wp.Id)
                                         .Select(wpx => new PersonnelEffort
                                         {
                                             PersonId = wpx.Person,
                                             PersonName = wpx.PersonNavigation.Surname + ", " + wpx.PersonNavigation.Name,
                                             Efforts = persefforts.Where(pe => pe.WpxPerson == wpx.Id)
                                                                  .ToDictionary(pe => pe.Month, pe => pe.Value),
                                             EffortId = persefforts.FirstOrDefault(pe => pe.WpxPerson == wpx.Id)?.Code ?? 0
                                         }).OrderBy(pe => pe.PersonName).ToList()
                }).ToList()
            };
            _logger.LogInformation($"Filtrado completo de datos procesado en {stopwatch.ElapsedMilliseconds} ms total");

            stopwatch.Restart(); // Reinicia el cronómetro para esta iteración
            List<PersonnelInfo> personnelInfos = new List<PersonnelInfo>();
            var uniqueMonths = viewModel.GetMonthsForProject();

            foreach (var person in projectPersonnel)
            {
                stopwatch.Restart(); // Reinicia el cronómetro para esta iteración

                

                // Calcular PM y esfuerzos totales por mes
                // Usa los PMs recuperados en lugar de calcularlos de nuevo
                var pmValuesPerMonth = pmValuesByPersonAndMonth.ContainsKey(person.Person)
                                       ? pmValuesByPersonAndMonth[person.Person]
                                       : new Dictionary<string, decimal>();

                // Usa los esfuerzos sumados en lugar de calcularlos de nuevo
                var totalEffortsPerMonth = totalEffortsByPersonAndMonthDict.ContainsKey(person.Person)
                                           ? totalEffortsByPersonAndMonthDict[person.Person]
                                           : new Dictionary<string, decimal>();

                _logger.LogInformation($"Esfuerzos maximos/totales calculados para persona {person.Person} en {stopwatch.ElapsedMilliseconds} ms");

                var personProjectMonthLocks = projectMonthLocksAllPersons
                                                .Where(l => l.PersonId == person.Person)
                                                .ToList();

                
                var monthStatuses = await _workCalendarService.CalculateMonthlyStatusesForPersonWithLists(person.Person, uniqueMonths, totalEffortsPerMonth, pmValuesPerMonth, personProjectMonthLocks);
                _logger.LogInformation($"Estados mensuales calculados para persona {person.Person} en {stopwatch.ElapsedMilliseconds} ms");

                // Añade la info de la persona a la lista
                personnelInfos.Add(new PersonnelInfo
                {
                    PersonId = person.Person,
                    PersonName = "",                     
                    MonthlyStatuses = monthStatuses
                });
            }
            
            stopwatch.Stop(); // Detiene el cronómetro
            _logger.LogInformation($"Información de personal procesada en {stopwatch.ElapsedMilliseconds} ms total");


            ViewBag.PersonnelInfos = personnelInfos;


            return View(viewModel);
        }
               
        


        [HttpPost]
        public async Task<IActionResult> SaveEfforts([FromBody] EffortUpdateModel model)
        {
            if (model == null || model.Efforts == null)
            {
                return Json(new { success = false, message = "No data provided." });
            }

            
            var project = await _context.Projects
                .Include(p => p.Wps)
                .FirstOrDefaultAsync(p => p.ProjId == model.ProjectId);

            List<string> notifications = new List<string>();

            foreach (var effortData in model.Efforts)
            {
                var person = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == effortData.PersonId);
                var wp = await _context.Wps.FirstOrDefaultAsync(w => w.Id == effortData.WpId);
                if (person == null || wp == null)
                {
                    notifications.Add("Person or Work Package not found for provided IDs.");
                    continue;
                }

                string monthKey = effortData.Month.ToString("yyyy-MM");
                

                var wpxPerson = await _context.Wpxpeople.FirstOrDefaultAsync(x => x.Person == effortData.PersonId && x.Wp == effortData.WpId);
                if (wpxPerson != null)
                {
                    var perseffort = await _context.Persefforts.FirstOrDefaultAsync(pe => pe.WpxPerson == wpxPerson.Id && pe.Month == effortData.Month);
                    decimal currentEffort = perseffort?.Value ?? 0m;
                    decimal newEffort = effortData.Effort;

                    var totalEffortsPerMonth = await _workCalendarService.CalculateMonthlyEffortForPersonWithoutCurrentWP(effortData.PersonId, wpxPerson.WpNavigation.Id, effortData.Month.Year, effortData.Month.Month); 
                    var maxPMPerson = await _context.PersMonthEfforts
                        .Where(pme => pme.PersonId == effortData.PersonId && pme.Month.Year == effortData.Month.Year && pme.Month.Month == effortData.Month.Month)
                        .Select(pme => pme.Value)
                        .FirstOrDefaultAsync();
                    bool isOutOfContract = await IsOutOfContractAsync(person.Id, effortData.Month.Year, effortData.Month.Month);

                    if (isOutOfContract)
                    {
                        maxPMPerson = 1.0m;                        
                    }
                    else if (maxPMPerson == null)
                    {
                        notifications.Add($"No PM value found for {person.Name} in WP '{wp.Name}' for {effortData.Month:MMMM yyyy}.");
                        continue;
                    }


                    // Verificar si es el mes de inicio o fin del proyecto y ajustar el maxPM si es necesario
                    DateTime projectStartDate = (DateTime)project.Start;
                    DateTime projectEndDate = project.EndReportDate;
                    DateTime effortMonthStart = new DateTime(effortData.Month.Year, effortData.Month.Month, 1);
                    DateTime effortMonthEnd = new DateTime(effortData.Month.Year, effortData.Month.Month, DateTime.DaysInMonth(effortData.Month.Year, effortData.Month.Month));
                    decimal maxPM = decimal.MaxValue; // Por defecto, no limitar el esfuerzo

                    if (!isOutOfContract && ((effortMonthStart < projectStartDate && effortMonthEnd >= projectStartDate) || (effortMonthStart <= projectEndDate && effortMonthEnd >= projectEndDate)))
                    {
                        maxPMPerson = await _workCalendarService.CalculateAdjustedMonthlyPM(effortData.PersonId, effortData.Month.Year, effortData.Month.Month, projectStartDate, projectEndDate);
                        notifications.Add($"Adjusted PM value for {person.Name} in WP '{wp.Name}' for {effortData.Month:MMMM yyyy} is {maxPMPerson} due to date limitations.");
                    }


                    decimal availableEffort = maxPMPerson - totalEffortsPerMonth;

                    // Condición para manejar la reducción de esfuerzos
                    if (newEffort < currentEffort)
                    {
                        // Permitir reducir el esfuerzo siempre y cuando no resulte en un valor negativo
                        if (newEffort >= 0)
                        {
                            perseffort.Value = newEffort; // Actualiza directamente al nuevo esfuerzo
                        }
                        else
                        {
                            notifications.Add($"Cannot reduce effort to less than 0 for {person.Name} in WP '{wp.Name}' for {effortData.Month:MMMM yyyy}.");
                        }
                    }
                    else
                    { 
                        if (availableEffort <= 0) // Si intentamos aumentar el esfuerzo pero no hay disponibilidad
                        {
                            notifications.Add($"For {person.Name} in WP '{wp.Name}' for {effortData.Month:MMMM yyyy}, there is no available capacity to increase efforts.");
                            continue; // Salta al siguiente esfuerzo sin intentar guardar este cambio
                        }
                        else
                        {
                        
                            decimal effortToSave = Math.Min(newEffort, availableEffort);
                                                        
                            if (newEffort > availableEffort)
                            {
                                decimal overflow = newEffort - availableEffort;                                                             
                                notifications.Add($"For {person.Name} in WP '{wp.Name}' for {effortData.Month:MMMM yyyy}, only {availableEffort} was saved due to availability or project limits. {overflow} could not be saved.");
                            }

                            if (perseffort != null)
                            {
                                perseffort.Value = effortToSave;
                            }
                            else
                            {
                                _context.Persefforts.Add(new Perseffort
                                {
                                    WpxPerson = wpxPerson.Id,
                                    Month = effortData.Month,
                                    Value = effortToSave
                                });
                            }
                        }
                    }
                }
            }

            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "Efforts updated successfully.", notifications = notifications });
        }



        [HttpGet]
        [Route("Projects/GetPersonnelEffortsByPerson/{projId}/{personId}")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public async Task<IActionResult> GetPersonnelEffortsByPerson(int projId, int personId)
        {
            try
            {
                ViewBag.projId = projId;

                // Obtener las fechas de inicio y fin del proyecto especificado
                var project = await _context.Projects
                                            .FirstOrDefaultAsync(p => p.ProjId == projId);
                if (project == null)
                {
                    return NotFound("Proyecto no encontrado.");
                }

                DateTime projectStartDate = project.Start ?? DateTime.MinValue;
                DateTime projectEndReportDate = project.EndReportDate;

                // NEW: calcular fin efectivo con los WPs del proyecto raíz
                DateTime? maxWpEndDate = await _context.Wps
                    .Where(wp => wp.ProjId == projId)
                    .MaxAsync(wp => (DateTime?)wp.EndDate);

                DateTime effectiveEndDate = (maxWpEndDate.HasValue && maxWpEndDate.Value > projectEndReportDate)
                    ? maxWpEndDate.Value
                    : projectEndReportDate;

                // Asegúrate que start no sea null y normaliza a inicio/fin de mes
                DateTime adjustedProjectStartDate = project.Start.HasValue
                    ? new DateTime(project.Start.Value.Year, project.Start.Value.Month, 1)
                    : DateTime.MinValue;

                DateTime adjustedProjectEndDate = new DateTime(
                    effectiveEndDate.Year,
                    effectiveEndDate.Month,
                    DateTime.DaysInMonth(effectiveEndDate.Year, effectiveEndDate.Month)
                );

                // Filtrar WPs basados en la persona, sin importar el proyecto, pero que se solapen con el periodo del proyecto raíz
                var wpxPersons = await _context.Wpxpeople
                                    .Include(wpx => wpx.PersonNavigation)
                                    .Include(wpx => wpx.WpNavigation)
                                        .ThenInclude(wp => wp.Proj)
                                    .Where(wpx => wpx.Person == personId &&
                                                  (wpx.WpNavigation.StartDate <= adjustedProjectEndDate && wpx.WpNavigation.EndDate >= adjustedProjectStartDate))
                                    .ToListAsync();

                // Obtener esfuerzos del personal y mapearlos
                var persefforts = await _context.Persefforts
                                        .Include(pe => pe.WpxPersonNavigation)
                                        .Where(pe => pe.WpxPersonNavigation.Person == personId &&
                                                     pe.Month >= adjustedProjectStartDate &&
                                                     pe.Month <= adjustedProjectEndDate)
                                        .ToListAsync();

                var persMonthEfforts = await _context.PersMonthEfforts
                                        .Where(pme => pme.PersonId == personId &&
                                                      pme.Month >= adjustedProjectStartDate &&
                                                      pme.Month <= adjustedProjectEndDate)
                                        .ToListAsync();


                var pmValuesPerMonth = persMonthEfforts
                                        .ToDictionary(
                                            pme => $"{pme.Month.Year}-{pme.Month.Month:D2}",
                                            pme => pme.Value
                                        );

                var effortsByMonth = await _context.Persefforts
                                        .Include(pe => pe.WpxPersonNavigation)
                                        .Where(pe => pe.WpxPersonNavigation.Person == personId &&
                                                     pe.Month >= adjustedProjectStartDate &&
                                                     pe.Month <= adjustedProjectEndDate)
                                        .GroupBy(pe => new { Year = pe.Month.Year, Month = pe.Month.Month })
                                        .Select(group => new
                                        {
                                            Year = group.Key.Year,
                                            Month = group.Key.Month,
                                            TotalEffort = group.Sum(pe => pe.Value)
                                        })
                                        .ToListAsync();

                // Consulta para obtener los ProjectIds en los que la persona está involucrada y que se solapen con el rango de fechas ajustado
                var personProjectIds = await _context.Wpxpeople
                    .Include(wpx => wpx.WpNavigation)
                    .Where(wpx => wpx.Person == personId &&
                                  wpx.WpNavigation.StartDate <= adjustedProjectEndDate &&
                                  wpx.WpNavigation.EndDate >= adjustedProjectStartDate)
                    .Select(wpx => wpx.WpNavigation.ProjId)
                    .Distinct()
                    .ToListAsync();

                // Utilizar la lista de ProjectIds para filtrar en ProjectMonthLocks
                var projectMonthLocks = await _context.ProjectMonthLocks
                    .Where(l => l.PersonId == personId &&
                                personProjectIds.Contains(l.ProjectId) &&
                                ((l.Year > adjustedProjectStartDate.Year || (l.Year == adjustedProjectStartDate.Year && l.Month >= adjustedProjectStartDate.Month)) &&
                                 (l.Year < adjustedProjectEndDate.Year || (l.Year == adjustedProjectEndDate.Year && l.Month <= adjustedProjectEndDate.Month))))
                    .ToListAsync();

                // Agrupa los bloqueos por mes y luego por proyecto
                var projectLocksByMonth = projectMonthLocks
                    .GroupBy(l => new { l.Year, l.Month })
                    .ToDictionary(
                        group => $"{group.Key.Year}-{group.Key.Month:D2}",
                        group => group.ToDictionary(
                            g => g.ProjectId,
                            g => g.IsLocked
                        )
                    );

                // Calcular el esfuerzo total por mes para la persona
                var totalEffortsPerMonth = new Dictionary<string, decimal>();

                var personnelinfo = new PersonnelInfo
                {
                    PersonId = personId,
                    PersonName = wpxPersons.FirstOrDefault()?.PersonNavigation.Name + " " + wpxPersons.FirstOrDefault()?.PersonNavigation.Surname,
                    MonthlyStatuses = new List<MonthStatus>()
                };

                // Construir ViewModel
                var viewModel = new PersonnelEffortPlanViewModel
                {
                    Project = project,
                    ProjectStartDate = adjustedProjectStartDate,
                    ProjectEndDate = adjustedProjectEndDate,

                    ProjectsPersonnelEfforts = wpxPersons.GroupBy(wpx => wpx.WpNavigation.ProjId)
                                                         .Select(group => new PersonnelEffortPlanViewModel.ProjectPersonnelEffort
                                                         {
                                                             ProjectId = group.Key,
                                                             ProjectName = group.FirstOrDefault()?.WpNavigation?.Proj?.Acronim ?? "",
                                                             WorkPackages = group.Select(wpx => new PersonnelEffortPlanViewModel.WorkPackageInfo
                                                             {
                                                                 WpId = wpx.Wp,
                                                                 WpName = wpx.WpNavigation.Name,
                                                                 StartDate = wpx.WpNavigation.StartDate,
                                                                 EndDate = wpx.WpNavigation.EndDate,
                                                                 PersonnelEfforts = new List<PersonnelEffortPlanViewModel.PersonnelEffort>
                                                                 {
                                                             new PersonnelEffortPlanViewModel.PersonnelEffort
                                                             {

                                                                 PersonId = wpx.Person,
                                                                 PersonName = wpx.PersonNavigation.Name + " " + wpx.PersonNavigation.Surname,
                                                                 // Aquí filtramos los esfuerzos por las fechas del proyecto raíz
                                                                 Efforts = persefforts.Where(pe => pe.WpxPerson == wpx.Id &&
                                                                                           pe.Month >= adjustedProjectStartDate &&
                                                                                           pe.Month <= adjustedProjectEndDate)
                                                                              .ToDictionary(pe => pe.Month, pe => pe.Value),
                                                                 EffortId = persefforts.FirstOrDefault(pe => pe.WpxPerson == wpx.Id)?.Code ?? 0
                                                              }
                            }
                                                             })
                        .OrderBy(wp => GetWpSortKey(wp.WpName).groupKey)    // NEW
                        .ThenBy(wp => GetWpSortKey(wp.WpName).numericKey)   // NEW
                        .ThenBy(wp => GetWpSortKey(wp.WpName).tieBreak)     // NEW
                        .ToList()
                                                         })
                .OrderBy(p => p.ProjectName) // NEW: proyectos por acrónimo A-Z
                .ToList()
                };

                // Calcular los PMs del mes de una sola vez si es posible
                var uniqueMonths = viewModel.GetUniqueMonthsforPersononProject();

                foreach (var month in uniqueMonths)
                {
                    string monthKey = $"{month.Year}-{month.Month:D2}";

                    totalEffortsPerMonth[monthKey] = await _workCalendarService.CalculateMonthlyEffortForPerson(personId, month.Year, month.Month);
                }

                var monthStatuses = await _workCalendarService.CalculateMonthlyStatusesForPersonWithLists(personId, uniqueMonths, totalEffortsPerMonth, pmValuesPerMonth, projectMonthLocks);

                personnelinfo.MonthlyStatuses = monthStatuses;
                ViewBag.TotalEffortsPerMonth = totalEffortsPerMonth;
                ViewBag.PMValuesPerMonth = pmValuesPerMonth;
                ViewBag.PersonnelInfo = personnelinfo;
                ViewBag.ProjectLocksByMonth = projectLocksByMonth;

                var projectMonths = new List<string>();
                DateTime monthstart = adjustedProjectStartDate;

                while (monthstart <= adjustedProjectEndDate)
                {
                    projectMonths.Add($"{monthstart.Year}-{monthstart.Month:D2}");
                    monthstart = monthstart.AddMonths(1);
                }

                ViewBag.ProjectMonths = projectMonths;


                return View(viewModel);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al obtener los esfuerzos del personal para el proyecto.");
                return StatusCode(500, "Ocurrió un error al procesar la solicitud.");
            }
        }

        [HttpGet]
        [Route("Projects/ProjectReport/{projId}")]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public async Task<IActionResult> ProjectReport(int projId)
        {

            ViewBag.projId = projId;

            // Obtener las fechas de inicio y fin del proyecto especificado
            var project = await _context.Projects
                                        .FirstOrDefaultAsync(p => p.ProjId == projId);
            if (project == null)
            {
                return NotFound("Proyecto no encontrado.");
            }
            ViewBag.CurrentProject = project.Acronim;
            DateTime projectStartDate = (DateTime)project.Start;
            DateTime projectEndDate = (DateTime)project.EndReportDate;

            // Asegúrate de que projectStartDate y projectEndDate no sean null
            DateTime adjustedProjectStartDate = project.Start.HasValue
                ? new DateTime(project.Start.Value.Year, project.Start.Value.Month, 1)
                : DateTime.MinValue;

            // Ajustar projectEndDate para que sea el último día del mes de finalización
            DateTime adjustedProjectEndDate = new DateTime(projectEndDate.Year, projectEndDate.Month, DateTime.DaysInMonth(projectEndDate.Year, projectEndDate.Month));

            // Obtener WP del proyecto
            var workPackages = await _context.Wps.Where(wp => wp.ProjId == projId).ToListAsync();

            // Obtener relaciones entre personal y proyecto
            var projectPersonnel = await _context.Projectxpeople.Where(px => px.ProjId == projId).ToListAsync();

            // Obtener IDs de las personas involucradas en el proyecto
            var personIds = projectPersonnel.Select(p => p.Person).Distinct().ToList();

            // Recuperar los nombres completos del PM y PI
            var pm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Pm);
            var pi = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Pi);
            var fm = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == project.Fm);

            // Preparar los datos para la vista
            ViewBag.PmFullName = pm != null ? $"{pm.Name} {pm.Surname}" : "No asignado";
            ViewBag.PiFullName = pi != null ? $"{pi.Name} {pi.Surname}" : "No asignado";
            ViewBag.FmFullName = fm != null ? $"{fm.Name} {fm.Surname}" : "No asignado";
            

            // Calcular los valores distribuidos y los esfuerzos cubiertos para cada WP
            var wpDetails = project.Wps.Select(wp => new
            {
                wp.Id,
                wp.Name,
                wp.Pms,
                Distributed = _context.Projefforts.Where(pe => pe.Wp == wp.Id).Sum(pe => pe.Value),
                Covered = _context.Wpxpeople
                            .Where(wxp => wxp.Wp == wp.Id)
                            .SelectMany(wxp => wxp.Persefforts)
                            .Sum(pe => pe.Value)
            }).ToList();

            
            // Añadir wpDetails al ViewBag para acceder desde la vista
            ViewBag.WpDetails = wpDetails;

            var reportPeriods = _context.ReportPeriods
                .Where(rp => rp.ProjId == projId && rp.StartDate >= adjustedProjectStartDate && rp.EndDate <= adjustedProjectEndDate )
                .ToList();

            var viewmodel = new ReportPeriodViewModel
            {
                Project = project,
                WorkPackages = workPackages,
                ProjectPersonnel = projectPersonnel,
                ReportPeriods = reportPeriods
            };


            return View(viewmodel);
        }

        [HttpGet]
        public IActionResult ReportPeriodForm(int projId)
        {
            
            var viewModel = new ReportPeriodViewModel();

            // Suponiendo que tienes un DbSet<ReportPeriod> en tu contexto llamado ReportPeriods
            viewModel.ReportPeriods = _context.ReportPeriods
                                              .Where(rp => rp.ProjId == projId)
                                              .ToList();

            // Aquí puedes agregar cualquier otra lógica necesaria para preparar tu modelo de vista,
            // por ejemplo, cargar información del proyecto si es necesario
            viewModel.Project = _context.Projects.FirstOrDefault(p => p.ProjId == projId);

            // Si necesitas pasar el ID del proyecto a tu vista parcial para usarlo en tus formularios AJAX, puedes hacerlo de varias maneras,
            // una opción es usando ViewBag o ViewData
            ViewBag.ProjId = projId;

            viewModel.CalculateMonthsList();

            // Retorna la vista parcial junto con el modelo de vista preparado
            return PartialView("_ReportPeriodForm", viewModel);
        }

        [HttpPost]
        public async Task<IActionResult> CalculatePmForDate(int personId, DateTime date)
        {
            var dailyPM = await _workCalendarService.CalculateDailyPM(personId, date);
            
            return Json(new { success = true, pm = dailyPM });
        }


        [HttpPost]
        public async Task<IActionResult> AddReportPeriodByDate(int projId, DateTime startDate, DateTime endDate)
        {
            // Validación: Asegurarse de que startDate y endDate están dentro del rango del proyecto
            var project = await _context.Projects.FindAsync(projId);
            if (project == null)
            {
                return Json(new { success = false, message = "Project not found." });
            }
            if (startDate < project.Start || endDate > project.End)
            {
                return Json(new { success = false, message = "Start or end date is out of the project date range." });
            }
            
            if (startDate > endDate)
            {
                return Json(new { success = false, message = "Start date must be before end date." });
            }

            var reportPeriod = new ReportPeriod
            {
                ProjId = projId,
                StartDate = startDate,
                EndDate = endDate
            };

            _context.ReportPeriods.Add(reportPeriod);
            await _context.SaveChangesAsync();

            return Json(new { success = true });
        }

        [HttpPost]
        public async Task<IActionResult> AddReportPeriodByMonth(int projId, string startMonth, string endMonth)
        {
            try
            {
                // Asumiendo que startMonth y endMonth siguen el patrón "Mx (MonthName Year)"
                var monthYearPattern = new Regex(@"M\d+ \((\w+) (\d{4})\)"); // Ajusta el patrón de ser necesario

                var startMatch = monthYearPattern.Match(startMonth);
                var endMatch = monthYearPattern.Match(endMonth);

                if (!startMatch.Success || !endMatch.Success)
                {
                    return Json(new { success = false, message = "Invalid month format." });
                }

                var cultureInfo = CultureInfo.InvariantCulture;
                var startMonthName = startMatch.Groups[1].Value;
                var startYear = int.Parse(startMatch.Groups[2].Value);
                var endMonthName = endMatch.Groups[1].Value;
                var endYear = int.Parse(endMatch.Groups[2].Value);

                var startDate = DateTime.ParseExact($"01 {startMonthName} {startYear}", "dd MMMM yyyy", cultureInfo);
                var endDate = DateTime.ParseExact($"01 {endMonthName} {endYear}", "dd MMMM yyyy", cultureInfo);

                // Ajustar endDate para que sea el último día del mes seleccionado
                endDate = new DateTime(endDate.Year, endDate.Month, DateTime.DaysInMonth(endDate.Year, endDate.Month));

                // Validación: Asegurarse de que startDate y endDate están dentro del rango del proyecto
                var project = await _context.Projects.FindAsync(projId);
                if (project == null)
                {
                    return Json(new { success = false, message = "Project not found." });
                }
                // Validación: asegurar que el periodo cae dentro de los meses del proyecto
                if (project.Start == null || project.EndReportDate == null)
                {
                    return Json(new { success = false, message = "Project start or end date is not defined." });
                }

                // Primer día del mes de inicio del proyecto
                var projMonthStart = new DateTime(project.Start.Value.Year, project.Start.Value.Month, 1);

                // Último día del mes de fin del proyecto
                var projMonthEnd = new DateTime(
                    project.EndReportDate.Year,
                    project.EndReportDate.Month,
                    DateTime.DaysInMonth(project.EndReportDate.Year, project.EndReportDate.Month)
                );

                // Ahora valida por mes/año (no por día exacto)
                if (startDate < projMonthStart || endDate > projMonthEnd)
                {
                    return Json(new { success = false, message = "Start or end date is out of the project month range." });
                }

                if (startDate > endDate)
                {
                    return Json(new { success = false, message = "Start date must be before end date." });
                }
                // Crear y añadir el nuevo ReportPeriod
                var reportPeriod = new ReportPeriod
                {
                    ProjId = projId,
                    StartDate = startDate,
                    EndDate = endDate
                };

                _context.ReportPeriods.Add(reportPeriod);
                await _context.SaveChangesAsync();

                return Json(new { success = true, message = "Report period added successfully." });
            }
            catch (Exception ex)
            {
                // Manejo de errores (p.ej., formato de fecha incorrecto)
                return Json(new { success = false, message = $"An error occurred: {ex.Message}" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> DeleteReportPeriod(int id)
        {
            var reportPeriod = await _context.ReportPeriods.FindAsync(id);
            if (reportPeriod != null)
            {
                _context.ReportPeriods.Remove(reportPeriod);
                await _context.SaveChangesAsync();
                return Json(new { success = true });
            }

            return Json(new { success = false, message = "Period not found." });
        }


        public async Task<IActionResult> PeriodDetails(int id, int projectId)
        {
            var totalStopwatch = Stopwatch.StartNew();

            try
            {
                var reportPeriodStopwatch = Stopwatch.StartNew();
                var reportPeriod = await _context.ReportPeriods.FindAsync(id);
                reportPeriodStopwatch.Stop();
                Console.WriteLine($"Finding report period took {reportPeriodStopwatch.ElapsedMilliseconds} ms");

                if (reportPeriod == null) return NotFound();

                var workPackagesStopwatch = Stopwatch.StartNew();
                var workPackages = _context.Wps
                    .Include(wp => wp.Wpxpeople)
                        .ThenInclude(wpxp => wpxp.PersonNavigation)
                    .Where(wp => wp.ProjId == projectId &&
                                 wp.StartDate <= reportPeriod.EndDate &&
                                 wp.EndDate >= reportPeriod.StartDate)
                    .ToList();
                workPackagesStopwatch.Stop();
                Console.WriteLine($"Fetching work packages took {workPackagesStopwatch.ElapsedMilliseconds} ms");

                var projectPersonnel = await _context.Projectxpeople.Where(px => px.ProjId == projectId).ToListAsync();
                var personIds = projectPersonnel.Select(p => p.Person).Distinct().ToList();

                var wpxPersonIds = workPackages.SelectMany(wp => wp.Wpxpeople)
                                .Select(wpxp => wpxp.Id)
                                .Distinct()
                                .ToList();

                var totalEffortInProjectByPersonAndMonth = await _context.Persefforts
                        .Where(pe => wpxPersonIds.Contains(pe.WpxPerson) &&
                                     pe.Month >= reportPeriod.StartDate &&
                                     pe.Month <= reportPeriod.EndDate)
                        .Include(pe => pe.WpxPersonNavigation)
                        .GroupBy(pe => new { pe.WpxPersonNavigation.Person, pe.Month.Year, pe.Month.Month })
                        .Select(group => new
                        {
                            PersonId = group.Key.Person,
                            Year = group.Key.Year,
                            Month = group.Key.Month,
                            TotalEffort = group.Sum(pe => pe.Value)
                        })
                        .ToListAsync();

                var totalEffortInProjectByPersonAndMonthDict = totalEffortInProjectByPersonAndMonth
                    .GroupBy(e => e.PersonId)
                    .ToDictionary(
                        group => group.Key,
                        group => group.ToDictionary(
                            e => new DateTime(e.Year, e.Month, 1),
                            e => e.TotalEffort
                        )
                    );

                var persMonthEfforts = await _context.PersMonthEfforts
                    .Where(pme => personIds.Contains(pme.PersonId) &&
                                  pme.Month >= reportPeriod.StartDate &&
                                  pme.Month <= reportPeriod.EndDate)
                    .ToListAsync();

                var pmValuesByPersonAndMonth = persMonthEfforts
                    .GroupBy(pme => pme.PersonId)
                    .ToDictionary(
                        group => group.Key,
                        group => group.ToDictionary(
                            pme => $"{pme.Month.Year}-{pme.Month.Month:D2}",
                            pme => pme.Value
                        )
                    );

                var totalEffortsByPersonAndMonth = await _context.Persefforts
                    .Include(pe => pe.WpxPersonNavigation)
                    .Where(pe => personIds.Contains(pe.WpxPersonNavigation.Person) &&
                                 pe.Month >= reportPeriod.StartDate && pe.Month <= reportPeriod.EndDate)
                    .GroupBy(pe => new { pe.WpxPersonNavigation.Person, Year = pe.Month.Year, Month = pe.Month.Month })
                    .Select(group => new {
                        PersonId = group.Key.Person,
                        Year = group.Key.Year,
                        Month = group.Key.Month,
                        TotalEffort = group.Sum(pe => pe.Value)
                    })
                    .ToListAsync();

                var totalEffortsByPersonAndMonthDict = totalEffortsByPersonAndMonth
                    .GroupBy(e => e.PersonId)
                    .ToDictionary(
                        group => group.Key,
                        group => group.ToDictionary(
                            e => $"{e.Year}-{e.Month:D2}",
                            e => e.TotalEffort
                        )
                    );

                var lockStatuses = await _context.ProjectMonthLocks
                            .Where(l => personIds.Contains(l.PersonId) && l.ProjectId == projectId)
                            .ToListAsync();

                if (!workPackages.Any()) return NotFound("No work packages found for the given period and project.");

                var personDetailsList = new List<PeriodDetailsViewModel.PersonnelDetails>();
                var personsProcessingStopwatch = Stopwatch.StartNew();
                var declaredHoursStopwatch = new Stopwatch();
                var totalHoursStopwatch = new Stopwatch();
                var workingDaysPerMonth = await _workCalendarService.GetWorkingDaysFromDbForRange(reportPeriod.StartDate, reportPeriod.EndDate);
                var months = await _workCalendarService.GenerateMonthList(reportPeriod.StartDate, reportPeriod.EndDate);

                // ─────────────────────────────────────────────────────────────────────────
                // NUEVO: Precargas para ESTADOS de login (INV/RESP) sin N+1
                // ─────────────────────────────────────────────────────────────────────────
                var firstMonth = new DateTime(reportPeriod.StartDate.Year, reportPeriod.StartDate.Month, 1);
                var lastMonth = new DateTime(reportPeriod.EndDate.Year, reportPeriod.EndDate.Month, 1);

                // AffxPersons solapados con el periodo para todas las personas
                var affAll = await _context.AffxPersons
                    .Where(a => personIds.Contains(a.PersonId) &&
                                a.Start <= reportPeriod.EndDate &&
                                a.End >= reportPeriod.StartDate)
                    .ToListAsync();
                var affByPerson = affAll.GroupBy(a => a.PersonId)
                                        .ToDictionary(g => g.Key, g => g.ToList());

                // Posibles responsables por persona/mes (para consultar logins en bloque)
                var candidateResponsibleIds = new HashSet<int>();

                // Cache de Personnel para fallback .Resp (evita hits por persona en FindAsync)
                var peopleRespCache = await _context.Personnel
                                                .Where(p => personIds.Contains(p.Id))
                                                .ToDictionaryAsync(p => p.Id, p => p.Resp);

                foreach (var pid in personIds)
                {
                    foreach (var m in months)
                    {
                        var monthStart = new DateTime(m.Year, m.Month, 1);
                        var monthEnd = monthStart.AddMonths(1).AddDays(-1);

                        int? respId = null;

                        if (affByPerson.TryGetValue(pid, out var affs))
                        {
                            var chosen = affs
                                .Where(a => a.Start <= monthEnd && a.End >= monthStart)
                                .OrderByDescending(a =>
                                {
                                    var s = a.Start > monthStart ? a.Start : monthStart;
                                    var e = a.End < monthEnd ? a.End : monthEnd;
                                    return (e - s).TotalDays;
                                })
                                .FirstOrDefault();

                            if (chosen?.ResponsibleId is int r1 && r1 > 0) respId = r1;
                        }

                        if (!respId.HasValue
    && peopleRespCache.TryGetValue(pid, out var fallbackRespInt)
    && fallbackRespInt > 0)
                        {
                            respId = fallbackRespInt;
                        }

                        if (peopleRespCache.TryGetValue(pid, out var frInt) && frInt > 0)
                            candidateResponsibleIds.Add(frInt);
                    }
                }

                // Sujetos a consultar en UserLoginHistories (investigadores + responsables)
                var subjectIds = personIds.Concat(candidateResponsibleIds).Distinct().ToList();

                var minLoginDate = firstMonth.AddMonths(1);
                var maxLoginDate = lastMonth.AddMonths(2).AddDays(-1);

                var logins = await _context.UserLoginHistories
                    .Where(ulh => subjectIds.Contains(ulh.PersonId) &&
                                  ulh.LoginTime >= minLoginDate &&
                                  ulh.LoginTime <= maxLoginDate)
                    .ToListAsync();

                // (personId, year, month) -> string fecha "dd/MM/yyyy" del último login
                var lastLoginByKey = logins
                    .GroupBy(l => new { l.PersonId, l.LoginTime.Year, l.LoginTime.Month })
                    .ToDictionary(
                        g => (g.Key.PersonId, g.Key.Year, g.Key.Month),
                        g => g.OrderByDescending(x => x.LoginTime)
                              .First().LoginTime.ToString("dd/MM/yyyy", CultureInfo.InvariantCulture)
                    );
                // ─────────────────────────────────────────────────────────────────────────

                foreach (var personId in workPackages.SelectMany(wp => wp.Wpxpeople).Select(wpxp => wpxp.Person).Distinct())
                {
                    var personFetchStopwatch = Stopwatch.StartNew();
                    var person = await _context.Personnel.FirstOrDefaultAsync(p => p.Id == personId);
                    personFetchStopwatch.Stop();
                    Console.WriteLine($"Fetching person {personId} took {personFetchStopwatch.ElapsedMilliseconds} ms");
                    if (person == null) continue;

                    var personLockStatusByMonth = new Dictionary<String, bool>();
                    for (var dt = reportPeriod.StartDate; dt <= reportPeriod.EndDate; dt = dt.AddMonths(1))
                    {
                        var yearMonthKey = $"{dt.Year}-{dt.Month:00}";
                        var isLocked = lockStatuses.Any(l => l.PersonId == personId && l.Year == dt.Year && l.Month == dt.Month && l.IsLocked);
                        personLockStatusByMonth[yearMonthKey] = isLocked;
                    }

                    declaredHoursStopwatch.Start();
                    var declaredHoursResult = await _workCalendarService.GetDeclaredHoursPerMonthForPersonInProyect(personId, reportPeriod.StartDate, reportPeriod.EndDate, projectId);
                    declaredHoursStopwatch.Stop();
                    Console.WriteLine($"Getting declared hours for person {personId} took {declaredHoursStopwatch.ElapsedMilliseconds} ms");
                    declaredHoursStopwatch.Reset();

                    totalHoursStopwatch.Start();
                    var totalHoursResult = await _workCalendarService.CalculateTotalHoursForPersonV2(personId, reportPeriod.StartDate, reportPeriod.EndDate);
                    totalHoursStopwatch.Stop();
                    Console.WriteLine($"Calculating total hours for person {personId} took {totalHoursStopwatch.ElapsedMilliseconds} ms");
                    totalHoursStopwatch.Reset();

                    var outOfContractStatus = await _workCalendarService.IsOutOfContractForMonths(personId, months);

                    var personStatusByMonth = new Dictionary<string, (bool OutOfContract, bool Overloaded)>();
                    var hoursInProject = new Dictionary<DateTime, decimal>();
                    var completionPercentage = new Dictionary<DateTime, decimal>();
                    var totalEffortInProyect = new Dictionary<DateTime, decimal>();

                    foreach (var month in months)
                    {
                        string yearMonthKey = $"{month.Year}-{month.Month:D2}";
                        bool outOfContract = outOfContractStatus.GetValueOrDefault(month, false);

                        totalEffortsByPersonAndMonthDict.TryGetValue(personId, out var effortsDict);
                        decimal totalEffortPercent = effortsDict?.GetValueOrDefault(yearMonthKey, 0) ?? 0;

                        decimal pmMax = pmValuesByPersonAndMonth.TryGetValue(personId, out var pmValues) ? pmValues.GetValueOrDefault(yearMonthKey, 0) : 0;
                        bool overloaded = totalEffortPercent > pmMax;

                        personStatusByMonth[yearMonthKey] = (outOfContract, overloaded);

                        if (totalEffortsByPersonAndMonthDict.TryGetValue(personId, out var effortsForPerson))
                        {
                            if (!effortsForPerson.TryGetValue(yearMonthKey, out totalEffortPercent))
                            {
                                totalEffortPercent = 0;
                            }
                        }
                        else
                        {
                            totalEffortPercent = 0;
                        }

                        var dateKey = new DateTime(month.Year, month.Month, 1);

                        if (!totalHoursResult.TryGetValue(month, out var totalHoursForMonth))
                            totalHoursForMonth = 0;

                        decimal totalEffortForMonth = 0;
                        if (totalEffortInProjectByPersonAndMonthDict.TryGetValue(personId, out var effortByMonth))
                        {
                            effortByMonth.TryGetValue(dateKey, out totalEffortForMonth);
                        }

                        var hoursInProjectForMonth = totalHoursForMonth * totalEffortForMonth;
                        var roundedHoursInProjectForMonth = Math.Round(hoursInProjectForMonth * 2, MidpointRounding.AwayFromZero) / 2;
                        hoursInProject[month] = roundedHoursInProjectForMonth;

                        declaredHoursResult.TryGetValue(month, out var declaredHoursForMonth);
                        decimal percentCompleted = hoursInProjectForMonth > 0
                            ? Math.Round((declaredHoursForMonth / roundedHoursInProjectForMonth) * 100, 2)
                            : 0;
                        completionPercentage[month] = percentCompleted;
                    }

                    // ─────────────────────────────────────────────────────────────────────────
                    // NUEVO: construir LoginStatusByMonth usando diccionarios precargados
                    // ─────────────────────────────────────────────────────────────────────────
                    var loginStatusByMonth = new Dictionary<DateTime, (string InvestigatorDate, string ResponsibleDate)>();

                    foreach (var m in months)
                    {
                        var y = m.Year; var mm = m.Month;

                        var target = new DateTime(y, mm, 1).AddMonths(1);

                        // Investigador
                        lastLoginByKey.TryGetValue((personId, target.Year, target.Month), out var invDateStr);

                        // Responsable: usa affByPerson -> chosen.ResponsibleId; fallback a Personnel.Resp
                        int? respId = null;
                        if (affByPerson.TryGetValue(personId, out var affsForPerson))
                        {
                            var mStart = new DateTime(y, mm, 1);
                            var mEnd = mStart.AddMonths(1).AddDays(-1);

                            var chosen = affsForPerson
                                .Where(a => a.Start <= mEnd && a.End >= mStart)
                                .OrderByDescending(a =>
                                {
                                    var s = a.Start > mStart ? a.Start : mStart;
                                    var e = a.End < mEnd ? a.End : mEnd;
                                    return (e - s).TotalDays;
                                })
                                .FirstOrDefault();

                            if (chosen?.ResponsibleId is int rr && rr > 0) respId = rr;
                        }
                        if (!respId.HasValue
    && peopleRespCache.TryGetValue(personId, out var fallbackRespInt)
    && fallbackRespInt > 0)
                        {
                            respId = fallbackRespInt;
                        }

                        string respDateStr = null;
                        if (respId.HasValue)
                            lastLoginByKey.TryGetValue((respId.Value, target.Year, target.Month), out respDateStr);

                        loginStatusByMonth[m] = (invDateStr, respDateStr);
                    }
                    // ─────────────────────────────────────────────────────────────────────────

                    var personnelDetails = new PeriodDetailsViewModel.PersonnelDetails
                    {
                        Personnel = person,
                        DeclaredHours = declaredHoursResult,
                        TotalHours = totalHoursResult,
                        PersonStatusByMonth = personStatusByMonth,
                        HoursinProyect = hoursInProject,
                        TotalEffortinProyect = totalEffortInProyect,
                        LockStatusByMonth = personLockStatusByMonth,
                        CompletionPercentage = completionPercentage,

                        // NUEVO:
                        LoginStatusByMonth = loginStatusByMonth
                    };

                    personDetailsList.Add(personnelDetails);
                }

                personsProcessingStopwatch.Stop();
                Console.WriteLine($"Processing persons took {personsProcessingStopwatch.ElapsedMilliseconds} ms");

                var model = new PeriodDetailsViewModel
                {
                    ReportPeriod = reportPeriod,
                    WorkPackages = workPackages,
                    Persons = personDetailsList,
                };

                model.CalculateMonths(reportPeriod.StartDate, reportPeriod.EndDate);

                totalStopwatch.Stop();
                Console.WriteLine($"Total execution time of PeriodDetails was {totalStopwatch.ElapsedMilliseconds} ms");
                ViewBag.ProjectId = projectId;
                ViewBag.PeriodId = id;

                var project = await _context.Projects.FirstOrDefaultAsync(p => p.ProjId == projectId);
                if (project == null)
                    return NotFound("Proyecto no encontrado.");

                ViewBag.CurrentProject = project.Acronim;

                return PartialView("_DetallesPeriodo", model);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"An error occurred: {ex.Message}");
                return StatusCode(500, "Internal Server Error. Please try again later.");
            }
        }


        [HttpPost]
        public async Task<IActionResult> Lock([FromBody] LockModel model)
        {
            if (ModelState.IsValid)
            {
                var lockEntry = await _context.ProjectMonthLocks
                    .FirstOrDefaultAsync(l => l.PersonId == model.PersonId && l.ProjectId == model.ProjectId &&
                                              l.Year == model.Year && l.Month == model.Month);

                if (lockEntry == null)
                {
                    // Crear un nuevo registro marcado como bloqueado
                    lockEntry = new ProjectMonthLock
                    {
                        PersonId = model.PersonId,
                        ProjectId = model.ProjectId,
                        Year = model.Year,
                        Month = model.Month,
                        IsLocked = true
                    };
                    _context.ProjectMonthLocks.Add(lockEntry);
                }
                else
                {
                    // Actualizar el registro existente a bloqueado
                    lockEntry.IsLocked = true;
                }

                await _context.SaveChangesAsync();
                return Json(new { success = true, message = "Mes bloqueado exitosamente." });
            }

            return Json(new { success = false, message = "Datos inválidos." });
        }


        [HttpPost]
        public async Task<IActionResult> Unlock([FromBody] LockModel model)
        {
            if (ModelState.IsValid)
            {
                var lockEntry = await _context.ProjectMonthLocks
                    .FirstOrDefaultAsync(l => l.PersonId == model.PersonId && l.ProjectId == model.ProjectId &&
                                              l.Year == model.Year && l.Month == model.Month);

                if (lockEntry == null)
                {
                    // Si no existe, crear un nuevo registro marcado como desbloqueado
                    lockEntry = new ProjectMonthLock
                    {
                        PersonId = model.PersonId,
                        ProjectId = model.ProjectId,
                        Year = model.Year,
                        Month = model.Month,
                        IsLocked = false
                    };
                    _context.ProjectMonthLocks.Add(lockEntry);
                }
                else
                {
                    // Si existe, actualizar el registro a desbloqueado
                    lockEntry.IsLocked = false;
                }

                await _context.SaveChangesAsync();
                return Json(new { success = true, message = "Mes desbloqueado exitosamente." });
            }

            return Json(new { success = false, message = "Datos inválidos." });
        }


        [HttpPost]
        public async Task<IActionResult> ExportPmsperWPtoCSV([FromBody] ExportRequest request)
        {
            try
            {
                if (request == null || request.ProjectId == 0 || string.IsNullOrEmpty(request.StartDate) || string.IsNullOrEmpty(request.EndDate))
                {
                    return BadRequest("Invalid request data.");
                }

                // Convertir las fechas de string a DateTime
                DateTime startDate;
                DateTime endDate;
                if (!DateTime.TryParseExact(request.StartDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out startDate) ||
                    !DateTime.TryParseExact(request.EndDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out endDate))
                {
                    return BadRequest("Invalid date format.");
                }

                var project = await _context.Projects
                    .Include(p => p.Wps)
                    .ThenInclude(wp => wp.Wpxpeople)
                    .ThenInclude(wpxp => wpxp.PersonNavigation)
                    .ThenInclude(person => person.Wpxpeople)
                    .ThenInclude(wpxp => wpxp.Persefforts)
                    .FirstOrDefaultAsync(p => p.ProjId == request.ProjectId);

                if (project == null)
                {
                    return NotFound("Proyecto no encontrado.");
                }

                var csv = new StringBuilder();

                // Generar la cabecera con los meses
                csv.Append("PersonName;WpName");
                var dateList = new List<DateTime>();
                for (var date = startDate; date <= endDate; date = date.AddMonths(1))
                {
                    csv.Append($";{date.ToString("MMM yyyy", CultureInfo.InvariantCulture)}");
                    dateList.Add(date);
                }
                csv.AppendLine();

                // Generar las filas con los esfuerzos
                var personEfforts = new Dictionary<string, Dictionary<string, Dictionary<DateTime, double>>>();

                foreach (var wp in project.Wps)
                {
                    foreach (var wpxperson in wp.Wpxpeople)
                    {
                        var personKey = $"{wpxperson.PersonNavigation.Surname}, {wpxperson.PersonNavigation.Name}";

                        if (!personEfforts.ContainsKey(personKey))
                        {
                            personEfforts[personKey] = new Dictionary<string, Dictionary<DateTime, double>>();
                        }

                        if (!personEfforts[personKey].ContainsKey(wp.Name))
                        {
                            personEfforts[personKey][wp.Name] = new Dictionary<DateTime, double>();
                        }

                        foreach (var perseffort in wpxperson.Persefforts)
                        {
                            if (perseffort.Month >= startDate && perseffort.Month <= endDate)
                            {
                                personEfforts[personKey][wp.Name][perseffort.Month] = (double)perseffort.Value;
                            }
                        }
                    }
                }

                // Ordenar por WpName y luego por Surname
                var orderedPersonEfforts = personEfforts
                    .SelectMany(person => person.Value.Select(wp => new { PersonName = person.Key, WpName = wp.Key, Efforts = wp.Value }))
                    .OrderBy(entry => entry.WpName)
                    .ThenBy(entry => entry.PersonName.Split(',')[0]); // Ordenar por Surname

                foreach (var entry in orderedPersonEfforts)
                {
                    csv.Append($"{entry.PersonName};{entry.WpName}");
                    foreach (var date in dateList)
                    {
                        if (entry.Efforts.ContainsKey(date))
                        {
                            csv.Append($";{entry.Efforts[date].ToString("0.00", new CultureInfo("es-ES"))}");
                        }
                        else
                        {
                            csv.Append(";0");
                        }
                    }
                    csv.AppendLine();
                }

                var utf8WithBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
                var bytes = utf8WithBom.GetBytes(csv.ToString());
                return File(bytes, "text/csv", $"PersonnelEffortPlan_{request.ProjectId}_{DateTime.Now:yyyyMMddHHmmss}.csv");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al generar el CSV de Personnel Effort Plan");
                return StatusCode(500, "Error interno del servidor");
            }
        }


        [HttpPost]
        public async Task<IActionResult> ExportPmsAuditoria([FromBody] ExportRequest request)
        {
            try
            {
                if (request == null || request.ProjectId == 0 || string.IsNullOrEmpty(request.StartDate) || string.IsNullOrEmpty(request.EndDate))
                {
                    return BadRequest("Invalid request data.");
                }

                // Convertir las fechas de string a DateTime
                if (!DateTime.TryParseExact(request.StartDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var startDate) ||
                    !DateTime.TryParseExact(request.EndDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var endDate))
                {
                    return BadRequest("Invalid date format.");
                }

                var project = await _context.Projects
                    .Include(p => p.Wps)
                    .ThenInclude(wp => wp.Wpxpeople)
                    .ThenInclude(wpxp => wpxp.PersonNavigation)
                    .FirstOrDefaultAsync(p => p.ProjId == request.ProjectId);

                if (project == null)
                {
                    return NotFound("Proyecto no encontrado.");
                }

                var csv = new StringBuilder();

                // Generar la cabecera con los meses
                csv.Append("Apellidos, Nombre");
                var dateList = new List<DateTime>();
                for (var date = startDate; date <= endDate; date = date.AddMonths(1))
                {
                    csv.Append($";{date.ToString("MMM yyyy", CultureInfo.InvariantCulture)}");
                    dateList.Add(date);
                }
                csv.AppendLine();

                // Obtener todas las personas del proyecto ordenadas
                var people = project.Wps
                    .SelectMany(wp => wp.Wpxpeople)
                    .Select(wpxp => wpxp.PersonNavigation)
                    .Distinct()
                    .OrderBy(person => person.Surname);

                // Generar las filas con los esfuerzos
                foreach (var person in people)
                {
                    csv.Append(Encoding.UTF8.GetString(Encoding.Default.GetBytes(RemoveAccents(person.Surname) + ", " + RemoveAccents(person.Name))));

                    foreach (var date in dateList)
                    {
                        var year = date.Year;
                        var month = date.Month;

                        // Usar el nuevo método para calcular las horas estimadas
                        var estimatedHours = await _workCalendarService.CalculateEstimatedHoursForPersonInProject(person.Id, request.ProjectId, year, month);

                        // Obtener las horas máximas por mes para calcular el porcentaje
                        var affiliation = _context.AffxPersons
                            .Where(ap => ap.PersonId == person.Id && ap.Start <= date && ap.End >= date)
                            .OrderByDescending(ap => ap.Start)
                            .FirstOrDefault()?.AffId;

                        if (affiliation != null)
                        {
                            var maxHours = _context.AffGlobalHours
                                .FirstOrDefault(h => h.Aff == affiliation && h.Year == year)?.Hours ?? 0;
                            var maxHoursPerMonth = maxHours / 12;

                            // Calcular el porcentaje en base a las horas estimadas
                            var percentage = maxHoursPerMonth > 0 ? estimatedHours / maxHoursPerMonth : 0;
                            csv.Append($";{percentage.ToString("0.00", new CultureInfo("es-ES"))}");

                        }
                        else
                        {
                            csv.Append(";0");
                        }
                    }
                    csv.AppendLine();
                }

                var utf8WithBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
                var bytes = utf8WithBom.GetBytes(csv.ToString());
                return File(bytes, "text/csv", $"PersonnelEffortPlan_{request.ProjectId}_{DateTime.Now:yyyyMMddHHmmss}.csv");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al generar el CSV de Personnel Effort Plan");
                return StatusCode(500, "Error interno del servidor");
            }
        }

        [HttpPost]
        public async Task<IActionResult> ExportPmsAuditoriaByWP([FromBody] ExportRequest request)
        {
            try
            {
                _logger.LogInformation("Inicio de ExportPmsAuditoriaByWP");

                if (request == null || request.ProjectId == 0 || string.IsNullOrEmpty(request.StartDate) || string.IsNullOrEmpty(request.EndDate))
                {
                    _logger.LogWarning("Datos de solicitud inválidos.");
                    return BadRequest("Invalid request data.");
                }

                if (!DateTime.TryParseExact(request.StartDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var startDate) ||
                    !DateTime.TryParseExact(request.EndDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var endDate))
                {
                    _logger.LogWarning("Formato de fecha inválido.");
                    return BadRequest("Invalid date format.");
                }

                var project = await _context.Projects
                    .Include(p => p.Wps)
                        .ThenInclude(wp => wp.Wpxpeople)
                            .ThenInclude(wpx => wpx.PersonNavigation)
                    .FirstOrDefaultAsync(p => p.ProjId == request.ProjectId);

                if (project == null)
                {
                    _logger.LogWarning($"Proyecto no encontrado: {request.ProjectId}");
                    return NotFound("Proyecto no encontrado.");
                }

                var dateList = new List<DateTime>();
                for (var date = startDate; date <= endDate; date = date.AddMonths(1))
                    dateList.Add(date);

                var personPmData = new Dictionary<string, Dictionary<string, Dictionary<DateTime, double>>>();

                foreach (var wp in project.Wps)
                {
                    foreach (var wpx in wp.Wpxpeople)
                    {
                        var person = wpx.PersonNavigation;
                        var personKey = $"{RemoveAccents(person.Surname)}, {RemoveAccents(person.Name)}";

                        if (!personPmData.ContainsKey(personKey))
                            personPmData[personKey] = new Dictionary<string, Dictionary<DateTime, double>>();

                        if (!personPmData[personKey].ContainsKey(wp.Name))
                            personPmData[personKey][wp.Name] = new Dictionary<DateTime, double>();

                        foreach (var date in dateList)
                        {
                            double percentage = 0;
                            try
                            {
                                var year = date.Year;
                                var month = date.Month;

                                _logger.LogInformation($"Procesando {personKey} - {wp.Name} - {date:yyyy-MM}");

                                var estimatedHours = await _workCalendarService.CalculateEstimatedHoursForPersonInWorkPackage(person.Id, wp.Id, year, month);

                                var monthStart = new DateTime(date.Year, date.Month, 1);
                                var monthEnd = monthStart.AddMonths(1).AddDays(-1);

                                var affiliation = _context.AffxPersons
                                    .Where(ap => ap.PersonId == person.Id && ap.End >= monthStart && ap.Start <= monthEnd)
                                    .OrderByDescending(ap => ap.Start)
                                    .FirstOrDefault()?.AffId;


                                if (affiliation != null)
                                {
                                    var maxHours = _context.AffGlobalHours
                                        .FirstOrDefault(h => h.Aff == affiliation && h.Year == year)?.Hours ?? 0;
                                    var maxHoursPerMonth = maxHours / 12m;
                                    double maxHoursPerMonthDouble = (double)maxHoursPerMonth;

                                    percentage = maxHoursPerMonthDouble > 0
                                        ? Math.Round((double)estimatedHours / maxHoursPerMonthDouble, 2)
                                        : 0;
                                }
                                else
                                {
                                    _logger.LogWarning($"Afiliación no encontrada para {personKey} en {date:yyyy-MM}");
                                }
                            }
                            catch (Exception innerEx)
                            {
                                _logger.LogError(innerEx, $"Error interno al calcular porcentaje para {personKey} en {date:yyyy-MM}");
                                percentage = 0;
                            }

                            personPmData[personKey][wp.Name][date] = percentage;
                        }
                    }
                }

                _logger.LogInformation("Construyendo CSV...");

                var csv = new StringBuilder();
                csv.Append("PersonName;WpName");
                foreach (var date in dateList)
                    csv.Append($";{date.ToString("MMM yyyy", CultureInfo.InvariantCulture)}");
                csv.AppendLine();

                var orderedData = personPmData
                    .SelectMany(p => p.Value.Select(wp => new { PersonName = p.Key, WpName = wp.Key, Values = wp.Value }))
                    .OrderBy(x => x.WpName)
                    .ThenBy(x => x.PersonName.Split(',')[0]);

                foreach (var entry in orderedData)
                {
                    csv.Append($"{entry.PersonName};{entry.WpName}");
                    foreach (var date in dateList)
                    {
                        var value = entry.Values.ContainsKey(date) ? entry.Values[date] : 0;
                        csv.Append($";{value.ToString("0.00", new CultureInfo("es-ES"))}");
                    }
                    csv.AppendLine();
                }

                var utf8WithBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
                var bytes = utf8WithBom.GetBytes(csv.ToString());
                _logger.LogInformation("Exportación completada con éxito.");
                return File(bytes, "text/csv", $"PmsAuditByWP_{request.ProjectId}_{DateTime.Now:yyyyMMddHHmmss}.csv");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error general en ExportPmsAuditoriaByWP");
                return StatusCode(500, "Error interno del servidor.");
            }
        }

        // -----------------------------------------------------------------------------------
        // [CHANGE] ExportWorkedDaysToCSV
        // Actualizado el 30/04/2025
        // - Adaptado para usar el nuevo cálculo realista de días trabajados por persona/mes.
        // - Se utilizan horas declaradas y afiliación máxima activa para cada mes.
        // - Exportación a CSV con meses en formato "Jan-2025".
        // - Se mantiene "SIN AFILIACIÓN" cuando no hay datos válidos.
        // -----------------------------------------------------------------------------------

        [HttpPost]
        public async Task<IActionResult> ExportWorkedDaysToCSV([FromBody] ExportRequest model)
        {
            var projectId = model.ProjectId;

            if (!DateTime.TryParse(model.StartDate, out var startDate) || !DateTime.TryParse(model.EndDate, out var endDate))
            {
                return BadRequest("Invalid date format.");
            }

            var periodStart = new DateTime(startDate.Year, startDate.Month, 1);
            var periodEnd = new DateTime(endDate.Year, endDate.Month, DateTime.DaysInMonth(endDate.Year, endDate.Month));

            var project = await _context.Projects
                .Include(p => p.Projectxpeople)
                    .ThenInclude(px => px.PersonNavigation)
                .FirstOrDefaultAsync(p => p.ProjId == projectId);

            if (project == null)
                return NotFound();

            var personnelList = project.Projectxpeople.Select(px => px.PersonNavigation).Distinct().ToList();

            var result = new StringBuilder();

            // Cabecera (versión con mes en texto)
            result.Append("Name");
            var current = periodStart;
            while (current <= periodEnd)
            {
                result.Append($";{current.ToString("MMM-yyyy", CultureInfo.InvariantCulture)}"); // Ej: Jan-2025
                current = current.AddMonths(1);
            }
            result.AppendLine();

            foreach (var person in personnelList.OrderBy(p => p.Surname))
            {
                result.Append($"{person.Surname}, {person.Name}");

                var workedDaysDict = await _workCalendarService.GetWorkedDaysPerMonthForPersonInProject(person.Id, periodStart, periodEnd, projectId);

                current = periodStart;
                while (current <= periodEnd)
                {
                    if (workedDaysDict.TryGetValue(new DateTime(current.Year, current.Month, 1), out var workedDays))
                    {
                        if (workedDays == -1)
                        {
                            result.Append(";SIN AFILIACIÓN");
                        }
                        else
                        {
                            result.Append($";{workedDays.ToString("0.0", new CultureInfo("es-ES"))}");
                        }
                    }
                    else
                    {
                        result.Append(";0.0");
                    }

                    current = current.AddMonths(1);
                }

                result.AppendLine();
            }

            var utf8WithBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
            var bytes = utf8WithBom.GetBytes(result.ToString());

            return File(bytes, "text/csv", $"WorkedDays_{projectId}_{DateTime.Now:yyyyMMdd}.csv");
        }
        
        
        private string RemoveAccents(string text)
        {
            return string.Concat(text.Normalize(NormalizationForm.FormD)
                .Where(ch => CharUnicodeInfo.GetUnicodeCategory(ch) != UnicodeCategory.NonSpacingMark));
        }

        private async Task<bool> IsOutOfContractAsync(int personId, int year, int month)
        {
            var firstDayOfMonth = new DateTime(year, month, 1);

            var lastValidContract = await _context.Dedications
                .Where(d => d.PersId == personId)
                .GroupBy(d => d.End)
                .OrderByDescending(g => g.Key) // ordena por fecha End descendente
                .Select(g => g.OrderByDescending(d => d.Type).FirstOrDefault()) // elige el de mayor Type entre los que comparten fecha
                .FirstOrDefaultAsync();

            if (lastValidContract == null)
                return true;

            return lastValidContract.End < firstDayOfMonth;
        }

        [HttpPost]
        [Authorize(Policy = "ProjectManagerOrAdminPolicy")]
        public async Task<IActionResult> RecalculatePMValue([FromBody] PMUpdateRequest model)
        {
            if (model.Month < 1 || model.Month > 12 || model.Year < 1900)
                return Json(new { success = false, message = "Fecha inválida." });

            var targetDate = new DateTime(model.Year, model.Month, 1);

            var existing = await _context.PersMonthEfforts
                .FirstOrDefaultAsync(p => p.PersonId == model.PersonId && p.Month == targetDate);

            var pmValue = await _workCalendarService.CalculateMonthlyPM(model.PersonId, model.Year, model.Month);

            if (existing != null)
            {
                existing.Value = pmValue;
            }
            else
            {
                _context.PersMonthEfforts.Add(new PersMonthEffort
                {
                    PersonId = model.PersonId,
                    Month = targetDate,
                    Value = pmValue
                });
            }

            await _context.SaveChangesAsync();
            return Json(new { success = true, pm = pmValue });
        }
        






        [HttpPost]
        public async Task<IActionResult> ExportEstimatedWorkedDaysToCSV([FromBody] ExportRequest model)
        {
            var projectId = model.ProjectId;

            if (!DateTime.TryParse(model.StartDate, out var startDate) || !DateTime.TryParse(model.EndDate, out var endDate))
                return BadRequest("Invalid date format.");

            var periodStart = new DateTime(startDate.Year, startDate.Month, 1);
            var periodEnd = new DateTime(endDate.Year, endDate.Month, DateTime.DaysInMonth(endDate.Year, endDate.Month));

            var project = await _context.Projects
                .Include(p => p.Projectxpeople)
                    .ThenInclude(px => px.PersonNavigation)
                .FirstOrDefaultAsync(p => p.ProjId == projectId);

            if (project == null)
                return NotFound();

            var personnelList = project.Projectxpeople
                .Select(px => px.PersonNavigation)
                .Distinct()
                .ToList();

            var result = new StringBuilder();

            // Cabecera con meses en "MMM-yyyy" (Jan-2025)
            result.Append("Name");
            var current = periodStart;
            while (current <= periodEnd)
            {
                result.Append($";{current.ToString("MMM-yyyy", CultureInfo.InvariantCulture)}");
                current = current.AddMonths(1);
            }
            result.AppendLine();

            foreach (var person in personnelList.OrderBy(p => p.Surname))
            {
                result.Append($"{person.Surname}, {person.Name}");

                // NUEVO: días estimados por mes para la persona en ESTE proyecto/rango
                var estimatedDaysDict = await _workCalendarService
                    .GetEstimatedWorkedDaysPerMonthForPersonInProject(person.Id, periodStart, periodEnd, projectId);

                current = periodStart;
                while (current <= periodEnd)
                {
                    if (estimatedDaysDict.TryGetValue(new DateTime(current.Year, current.Month, 1), out var estimatedDays))
                    {
                        if (estimatedDays == -1)
                            result.Append(";SIN AFILIACIÓN");
                        else
                            result.Append($";{estimatedDays.ToString("0.0", new CultureInfo("es-ES"))}");
                    }
                    else
                    {
                        result.Append(";0.0");
                    }

                    current = current.AddMonths(1);
                }

                result.AppendLine();
            }

            var utf8WithBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
            var bytes = utf8WithBom.GetBytes(result.ToString());

            return File(bytes, "text/csv", $"EstimatedWorkedDays_{projectId}_{DateTime.Now:yyyyMMdd}.csv");
        }

        // =================== Helper de orden WP ===================
        // Grupo 0: "WP<number>" (orden por número)
        // Grupo 1: otros WPs (alfabético)
        // Grupo 2: "TRAVELS" (siempre al final)
        private static (int groupKey, int numericKey, string tieBreak) GetWpSortKey(string name)
        {
            if (string.Equals(name, "TRAVELS", StringComparison.OrdinalIgnoreCase))
                return (2, int.MaxValue, "TRAVELS");

            var m = Regex.Match(name ?? "", @"^\s*WP\s*(\d+)\s*$", RegexOptions.IgnoreCase);
            if (m.Success && int.TryParse(m.Groups[1].Value, out var n))
                return (0, n, name ?? "");

            return (1, int.MaxValue - 1, name ?? "");
        }



        public class ExportRequest
        {
            public int ProjectId { get; set; }
            public string StartDate { get; set; }
            public string EndDate { get; set; }
        }

        public class PMUpdateRequest
        {
            public int PersonId { get; set; }
            public int Year { get; set; }
            public int Month { get; set; }
        }

    }


}






----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\TimesheetController.cs -----
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Globalization;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;
using static TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel;
using QuestPDF.Fluent;
using QuestPDF.Infrastructure;
using QuestPDF.Helpers;
using QuestPDF.Previewer;
using System.Drawing;
using Microsoft.CodeAnalysis.Options;
using System.Security.Claims;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.AspNetCore.Authorization;
using System.Linq;
using Microsoft.AspNetCore.Identity;
using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels;





namespace TRS2._0.Controllers
{
    [Authorize]
    public class TimesheetController : Controller
    {
        private readonly ILogger<TimesheetController> _logger;
        private readonly TRSDBContext _context;
        private readonly WorkCalendarService _workCalendarService;
        private readonly UserManager<ApplicationUser> _userManager;

        public TimesheetController(ILogger<TimesheetController> logger, TRSDBContext context, WorkCalendarService workCalendarService, UserManager<ApplicationUser> userManager)
        {
            _logger = logger;
            _context = context;
            _workCalendarService = workCalendarService;
            _userManager = userManager;
        }

        [Authorize(Roles = "Admin, ProjectManager")]
        public async Task<IActionResult> IndexAsync()
        {
            TempData.Remove("SelectedPersonId");
            var tRSDBContext = _context.Personnel.Include(p => p.DepartmentNavigation);
            return View(await tRSDBContext.ToListAsync());
        }

        [Authorize(Roles = "Admin, ProjectManager, Leader, Researcher")]
        public async Task<IActionResult> GetTimeSheetsForPerson(int? personId, int? year, int? month)
        {
            // Obtener usuario autenticado y roles
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            var user = await _context.Users.Include(u => u.Personnel).FirstOrDefaultAsync(u => u.Id == userId);
            var userRoles = await _userManager.GetRolesAsync(user);
            bool isAdminOrPM = userRoles.Contains("Admin") || userRoles.Contains("ProjectManager");
            ViewBag.CanEdit = isAdminOrPM;

            if (!personId.HasValue)
            {
                personId = user?.PersonnelId;
            }

            if (!personId.HasValue)
            {
                _logger.LogError($"No se pudo determinar el personId del usuario {userId}");
                return NotFound();
            }

            int validPersonId = personId.Value;

            // DEBUG: ¿A qué servidor/BD está conectando EF ahora mismo?
            var conn = _context.Database.GetDbConnection();
            _logger.LogInformation("DB DEBUG | DataSource={DataSource} | Database={Database} | ConnStr={ConnStr}",
                conn.DataSource, conn.Database, conn.ConnectionString);


            // Validar si tiene permiso para acceder a esa ficha
            bool isOwner = user?.PersonnelId == validPersonId;
            bool isLeader = userRoles.Contains("Leader");

            if (!isAdminOrPM && !isOwner && !isLeader)
            {
                _logger.LogWarning($"User {userId} tried to view timesheets of personId {validPersonId} without permission.");
                return Forbid();
            }

            // Decide si se permite editar
            ViewBag.AllowEdit = isAdminOrPM || isOwner;


            // Determina el año y mes actual si no se proporcionan
            var currentYear = year ?? DateTime.Now.Year;
            var currentMonth = month ?? DateTime.Now.Month;

            var startDate = new DateTime(currentYear, currentMonth, 1);
            var endDate = startDate.AddMonths(1).AddDays(-1);

            var canAutoFill = await (from pf in _context.Persefforts
                                     join wxp in _context.Wpxpeople on pf.WpxPerson equals wxp.Id
                                     where pf.Value != 0 &&
                                           pf.Month.Year == currentYear &&
                                           pf.Month.Month == currentMonth &&
                                           wxp.Person == validPersonId
                                     group pf by new { wxp.Person, pf.Month } into g
                                     where g.Count() == 1
                                     select g.Key).AnyAsync();

            bool isPastMonth = new DateTime(currentYear, currentMonth, 1) < new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);

            // Obtener el único WpxPerson.Id del mes (para saber el proyecto a chequear)
            var unicoWpxId = await (from pe in _context.Persefforts
                                    join wpx in _context.Wpxpeople on pe.WpxPerson equals wpx.Id
                                    where pe.Value != 0
                                          && pe.Month.Year == currentYear
                                          && pe.Month.Month == currentMonth
                                          && wpx.Person == validPersonId
                                    group wpx by 1 into g
                                    where g.Count() == 1
                                    select g.First().Id)
                                   .FirstOrDefaultAsync();

            bool isLockedForUnique = false;

            if (unicoWpxId != 0)
            {
                // ProjId del único WP
                var projId = await _context.Wpxpeople
                                .Include(x => x.WpNavigation).ThenInclude(wp => wp.Proj)
                                .Where(x => x.Id == unicoWpxId)
                                .Select(x => x.WpNavigation.Proj.ProjId)
                                .FirstOrDefaultAsync();

                // ¿Bloqueado para esa persona-proyecto-mes?
                isLockedForUnique = await _context.ProjectMonthLocks.AnyAsync(l =>
                    l.PersonId == validPersonId &&
                    l.ProjectId == projId &&
                    l.Year == currentYear &&
                    l.Month == currentMonth &&
                    l.IsLocked);
            }

            // Mostrar botón solo si: único WP + mes pasado + NO bloqueado
            ViewBag.ShowAutoFillButton = canAutoFill && isPastMonth && !isLockedForUnique;

            



            // Obtener las bajas de tipo 11 y 12 para el mes actual
            var leaveReductions = await _context.Leaves
                .Where(l => l.PersonId == validPersonId &&
                            l.Day >= startDate &&
                            l.Day <= endDate &&
                            (l.Type == 11 || l.Type == 12) &&
                            l.LeaveReduction > 0 && l.LeaveReduction <= 1)
                .ToDictionaryAsync(l => l.Day, l => l.LeaveReduction);

            // Obtener las horas diarias iniciales con dedicación
            var hoursPerDayWithDedication = await _workCalendarService.CalculateDailyWorkHoursWithDedicationNotRounded(validPersonId, currentYear, currentMonth);

            // Ajustar las horas por día considerando las bajas de tipo 11 y 12 (Parciales)
            foreach (var day in hoursPerDayWithDedication.Keys.ToList())
            {
                if (leaveReductions.TryGetValue(day, out var reduction))
                {
                    // Aplicar la reducción al máximo de horas diarias
                    //hoursPerDayWithDedication[day] = RoundToNearestHalfOrWhole(hoursPerDayWithDedication[day] * (1 - reduction)); // ANTERIOR AL CAMBIO DE DECIMALES
                    hoursPerDayWithDedication[day] = Math.Round(hoursPerDayWithDedication[day] * (1 - reduction), 2);

                }
            }

            // Obtener las bajas y viajes del mes
            var leavesthismonth = await _workCalendarService.GetLeavesForPerson(validPersonId, currentYear, currentMonth);
            // Solo bajas completas para excluir del cálculo
            var leavesForExclusion = leavesthismonth
                .Where(l => (l.Type != 11 && l.Type != 12) || (l.LeaveReduction == null || l.LeaveReduction == 1))
                .ToList();
            var travelsthismonth = await _workCalendarService.GetTravelsForThisMonth(validPersonId, currentYear, currentMonth);

            // Obtener los datos de la persona
            var person = await _context.Personnel.FindAsync(personId);

            if (person == null)
            {
                _logger.LogError($"No se encontró la persona con el ID {personId}");
                return NotFound();
            }

            var maxhoursthismonth = await _workCalendarService.CalculateMaxHoursForPersonInMonth(validPersonId, currentYear, currentMonth);

            // ANTIGUO, SOLO PERSONAS CON WP CON EFFORT//
            //// Obtener WPs para la persona en el rango de fecha especificado
            //var wpxPersons = await _context.Wpxpeople
            //    .Include(wpx => wpx.PersonNavigation)
            //    .Include(wpx => wpx.WpNavigation)
            //        .ThenInclude(wp => wp.Proj)
            //    .Where(wpx => wpx.Person == personId && wpx.WpNavigation.StartDate <= endDate && wpx.WpNavigation.EndDate >= startDate)
            //    .Select(wpx => new
            //    {
            //        WpxPerson = wpx,
            //        Effort = _context.Persefforts
            //            .Where(pe => pe.WpxPerson == wpx.Id && pe.Month >= startDate && pe.Month <= endDate)
            //            .Sum(pe => (decimal?)pe.Value)
            //    })
            //    .Where(wpx => wpx.Effort.HasValue && wpx.Effort.Value > 0)
            //    .Select(wpx => wpx.WpxPerson)
            //    .ToListAsync();

            //NUEVO INCLUYENDO WP SIN EFFORT PERO CON HORAS EN TIMESHEET//
            var allWpxPersons = await _context.Wpxpeople
                .Include(wpx => wpx.PersonNavigation)
                .Include(wpx => wpx.WpNavigation)
                    .ThenInclude(wp => wp.Proj)
                .Where(wpx => wpx.Person == personId && wpx.WpNavigation.StartDate <= endDate && wpx.WpNavigation.EndDate >= startDate)
                .ToListAsync();

            var wpxWithEffort = await _context.Persefforts
                .Where(pe => pe.Month >= startDate && pe.Month <= endDate)
                .Where(pe => allWpxPersons.Select(wpx => wpx.Id).Contains(pe.WpxPerson))
                .GroupBy(pe => pe.WpxPerson)
                .Where(g => g.Sum(pe => pe.Value) > 0)
                .Select(g => g.Key)
                .ToListAsync();

            var wpxWithTimesheet = await _context.Timesheets
                .Where(ts => ts.Day >= startDate && ts.Day <= endDate && ts.Hours > 0)
                .Where(ts => allWpxPersons.Select(wpx => wpx.Id).Contains(ts.WpxPersonId))
                .Select(ts => ts.WpxPersonId)
                .Distinct()
                .ToListAsync();

            var wpxToShow = allWpxPersons
                .Where(wpx => wpxWithEffort.Contains(wpx.Id) || wpxWithTimesheet.Contains(wpx.Id))
                .ToList();

            // Obtener Timesheets para la persona en el rango de fecha especificado
            var timesheets = await _context.Timesheets
                .Where(ts => wpxToShow.Select(wpx => wpx.Id).Contains(ts.WpxPersonId) && ts.Day >= startDate && ts.Day <= endDate)
                .ToListAsync();

            var hoursUsed = timesheets.Sum(ts => ts.Hours);

            // Obtener días festivos nacionales y locales
            var holidays = await _workCalendarService.GetHolidaysForMonth(currentYear, currentMonth);

            // Obtener los esfuerzos del personal y mapearlos
            var persefforts = await _context.Persefforts
                                    .Include(pe => pe.WpxPersonNavigation)
                                    .Where(pe => pe.WpxPersonNavigation.Person == personId && pe.Month >= startDate && pe.Month <= endDate)
                                    .ToListAsync();

            var totalefforts = persefforts.Sum(pe => pe.Value);


            // Calcular las horas totales trabajadas excluyendo los días con bajas y festivos
            var totalWorkHours = hoursPerDayWithDedication
    .Where(entry => !leavesForExclusion.Any(leave => leave.Day == entry.Key) && !holidays.Contains(entry.Key))
    .Sum(entry => entry.Value);





            decimal percentageUsed = totalWorkHours > 0 ? hoursUsed / totalWorkHours * 100 : 0;

            // Agrupar horas de timesheets por día
            var totalWorkHoursWithDedication = timesheets
                .GroupBy(ts => ts.Day)
                .ToDictionary(
                    group => group.Key,
                    group => group.Sum(ts => ts.Hours)
                );

            // Obtener los IDs de los proyectos
            var projectIds = wpxToShow.Select(wpx => wpx.WpNavigation.ProjId).Distinct().ToList();

            // Obtener los estados de bloqueo para esos proyectos en el mes y año específicos
            var projectLocks = await _context.ProjectMonthLocks
                .Where(l => projectIds.Contains(l.ProjectId) &&
                            l.Year == currentYear &&
                            l.Month == currentMonth)
                .ToListAsync();

            var estimatedHoursByWpxId = new Dictionary<int, decimal>();

            foreach (var wpx in wpxToShow)
            {
                var hours = await _workCalendarService.CalculateEstimatedHoursForPersonInWorkPackage(validPersonId, wpx.Wp, currentYear, currentMonth);
                estimatedHoursByWpxId[wpx.Id] = hours;
            }

            var workPackagesList = new List<WorkPackageInfoTS>();

            foreach (var wpx in wpxToShow)
            {
                var effort = persefforts.FirstOrDefault(pe => pe.WpxPerson == wpx.Id && pe.Month.Year == currentYear && pe.Month.Month == currentMonth)?.Value ?? 0;

                decimal estimatedHours;
                if (await _workCalendarService.HasNoContractDaysAsync(validPersonId, currentYear, currentMonth))
                {
                    var maxByAffiliation = await _workCalendarService.CalculateMaxHoursByAffiliationOnlyAsync(validPersonId, currentYear, currentMonth);
                    estimatedHours = Math.Round(maxByAffiliation * effort, 2);
                }
                else
                {
                    estimatedHours = Math.Round(maxhoursthismonth * effort, 2);
                }

                var isLocked = projectLocks.Any(l => l.ProjectId == wpx.WpNavigation.ProjId && l.PersonId == personId && (l.IsLocked == true));

                workPackagesList.Add(new WorkPackageInfoTS
                {
                    WpId = wpx.Wp,
                    WpName = wpx.WpNavigation.Name,
                    WpTitle = wpx.WpNavigation.Title,
                    ProjectName = wpx.WpNavigation.Proj.Acronim,
                    ProjectSAPCode = wpx.WpNavigation.Proj.SapCode,
                    ProjectId = wpx.WpNavigation.Proj.ProjId,
                    IsLocked = isLocked,
                    Effort = effort,
                    EstimatedHours = estimatedHours,
                    Timesheets = timesheets.Where(ts => ts.WpxPersonId == wpx.Id).ToList()
                });
            }

            // Preparación del ViewModel
            var viewModel = new TimesheetViewModel
            {
                Person = person,
                CurrentYear = currentYear,
                CurrentMonth = currentMonth,
                LeavesthisMonth = leavesthismonth,
                TravelsthisMonth = travelsthismonth,
                HoursPerDay = hoursPerDayWithDedication,
                HoursPerDayWithDedication = hoursPerDayWithDedication,
                TotalHours = totalWorkHours,
                TotalHoursWithDedication = totalWorkHoursWithDedication,
                Holidays = holidays,
                MonthDays = Enumerable.Range(1, DateTime.DaysInMonth(currentYear, currentMonth)).Select(day => new DateTime(currentYear, currentMonth, day)).ToList(),
                WorkPackages = workPackagesList,
                HoursUsed = hoursUsed
            };

            ViewBag.PercentageUsed = percentageUsed.ToString("0.0", CultureInfo.InvariantCulture);

            return View(viewModel);
        }

        [Authorize(Roles = "Admin, ProjectManager, User, Researcher")]
        public async Task<TimesheetViewModel> GetTimesheetDataForPerson(int personId, int year, int month, int project)
        {
            // Determina el año y mes actual si no se proporcionan
            var currentYear = year;
            var currentMonth = month;

            var startDate = new DateTime(currentYear, currentMonth, 1);
            var endDate = startDate.AddMonths(1).AddDays(-1);

            // Obtener bajas de tipo 11 y 12 con LeaveReduction para el mes y persona
            var leaveReductions = await _context.Leaves
                .Where(l => l.PersonId == personId &&
                            l.Day >= startDate &&
                            l.Day <= endDate &&
                            (l.Type == 11 || l.Type == 12) &&
                            l.LeaveReduction > 0 && l.LeaveReduction <= 1)
                .ToDictionaryAsync(l => l.Day, l => l.LeaveReduction);

            // Calcular horas diarias iniciales con la dedicación
            var hoursPerDayWithDedication = await _workCalendarService.CalculateDailyWorkHoursWithDedicationNotRounded(personId, currentYear, currentMonth);

            // Ajustar las horas por día considerando las bajas de tipo 11 y 12
            foreach (var day in hoursPerDayWithDedication.Keys.ToList())
            {
                if (leaveReductions.TryGetValue(day, out var reduction))
                {
                    // Aplicar la reducción al máximo de horas diarias
                    //hoursPerDayWithDedication[day] = RoundToNearestHalfOrWhole(hoursPerDayWithDedication[day] * (1 - reduction)); //ANTERIOR AL CAMBIO DE DECIMALES
                    hoursPerDayWithDedication[day] = Math.Round(hoursPerDayWithDedication[day] * (1 - reduction), 2);

                }
            }

            // Resto del código permanece igual
            var leavesthismonth = await _workCalendarService.GetLeavesForPerson(personId, currentYear, currentMonth);
            var travelsthismonth = await _workCalendarService.GetTravelsForThisMonth(personId, currentYear, currentMonth);
            var person = await _context.Personnel.FindAsync(personId);

            if (person == null)
            {
                _logger.LogError($"No se encontró la persona con el ID {personId}");
            }

            var wpxPersons = await _context.Wpxpeople
                .Include(wpx => wpx.PersonNavigation)
                .Include(wpx => wpx.WpNavigation)
                .ThenInclude(wp => wp.Proj)
                .Where(wpx => wpx.Person == personId && wpx.WpNavigation.ProjId == project && wpx.WpNavigation.StartDate <= endDate && wpx.WpNavigation.EndDate >= startDate)
                .Select(wpx => new
                {
                    WpxPerson = wpx,
                    Effort = _context.Persefforts
                        .Where(pe => pe.WpxPerson == wpx.Id && pe.Month >= startDate && pe.Month <= endDate)
                        .Sum(pe => (decimal?)pe.Value)
                })
                .Where(wpx => wpx.Effort.HasValue && wpx.Effort.Value > 0)
                .Select(wpx => wpx.WpxPerson)
                .ToListAsync();

            var projectdata = await _context.Projects.FindAsync(project);

            var timesheets = await _context.Timesheets
                        .Include(ts => ts.WpxPersonNavigation)
                        .ThenInclude(wpx => wpx.WpNavigation)
                        .Where(ts => ts.WpxPersonNavigation.Person == personId &&
                                     ts.Day >= startDate && ts.Day <= endDate &&
                                     ts.WpxPersonNavigation.WpNavigation.ProjId == project)
                        .ToListAsync();

            var hoursUsed = timesheets.Sum(ts => ts.Hours);

            var holidays = await _workCalendarService.GetHolidaysForMonth(currentYear, currentMonth);

            var persefforts = await _context.Persefforts
                                    .Include(pe => pe.WpxPersonNavigation)
                                    .Where(pe => pe.WpxPersonNavigation.Person == personId && pe.Month >= startDate && pe.Month <= endDate)
                                    .ToListAsync();

            var affiliations = await _context.AffxPersons
                                .Where(ap => ap.PersonId == personId && ap.Start <= startDate.AddMonths(1).AddDays(-1) && ap.End >= startDate)
                                .Select(ap => ap.AffId)
                                .Distinct()
                                .ToListAsync();

            var affHoursList = await _context.AffHours
                                .Where(ah => affiliations.Contains(ah.AffId) && ah.StartDate <= startDate.AddMonths(1).AddDays(-1) && ah.EndDate >= startDate)
                                .ToListAsync();

            var maxHours = affHoursList.Max(ah => ah.Hours);

            var ResponsiblePerson = _context.Personnel
                                        .Where(r => r.Id == person.Resp)
                                        .Select(r => r.Name + " " + r.Surname)
                                        .FirstOrDefault();

            var totalWorkHours = hoursPerDayWithDedication
                .Where(entry => !leavesthismonth.Any(leave => leave.Day == entry.Key && leave.Type != 11 && leave.Type != 12) && !holidays.Contains(entry.Key))
                .Sum(entry => entry.Value);

            decimal percentageUsed = totalWorkHours > 0 ? hoursUsed / totalWorkHours * 100 : 0;

            var totalWorkHoursWithDedication = timesheets
                    .GroupBy(ts => ts.Day)
                    .ToDictionary(
                        group => group.Key,
                        group => group.Sum(ts => ts.Hours)
                    );
            var hoursForOtherProjects = new Dictionary<DateTime, decimal>();
            decimal totalHoursForOtherProjects = 0;

            foreach (var day in hoursPerDayWithDedication.Keys)
            {
                // Excluir si el día es festivo, está de baja (distinta de tipo 11/12) o está de vacaciones
                bool isHoliday = holidays.Contains(day);
                bool isLeave = leavesthismonth.Any(leave => leave.Day == day && leave.Type != 11 && leave.Type != 12);

                if (isHoliday || isLeave)
                {
                    hoursForOtherProjects[day] = 0;
                    continue;
                }

                var maxHoursForDay = hoursPerDayWithDedication[day];
                if (maxHoursForDay > 0)
                {
                    var assignedHours = totalWorkHoursWithDedication.ContainsKey(day) ? totalWorkHoursWithDedication[day] : 0;
                    var otherProjectHours = maxHoursForDay - assignedHours;
                    hoursForOtherProjects[day] = otherProjectHours;
                    totalHoursForOtherProjects += otherProjectHours;
                }
                else
                {
                    hoursForOtherProjects[day] = 0;
                }
            }

            var viewModel = new TimesheetViewModel
            {
                Person = person,
                Responsible = ResponsiblePerson,
                ProjectData = projectdata,
                CurrentYear = currentYear,
                CurrentMonth = currentMonth,
                LeavesthisMonth = leavesthismonth,
                TravelsthisMonth = travelsthismonth,
                HoursPerDay = hoursPerDayWithDedication,
                HoursPerDayWithDedication = hoursPerDayWithDedication,
                TotalHours = totalWorkHours,
                TotalHoursWithDedication = totalWorkHoursWithDedication,
                Holidays = holidays,
                AffiliationHours = maxHours,
                MonthDays = Enumerable.Range(1, DateTime.DaysInMonth(currentYear, currentMonth)).Select(day => new DateTime(currentYear, currentMonth, day)).ToList(),
                WorkPackages = wpxPersons.Select(wpx =>
                {
                    var effort = persefforts.FirstOrDefault(pe => pe.WpxPerson == wpx.Id && pe.Month.Year == currentYear && pe.Month.Month == currentMonth)?.Value ?? 0;
                    //var estimatedHours = RoundToNearestHalfOrWhole((hoursPerDayWithDedication.Values.Sum()) * effort); //ANTERIOR AL CAMBIO DE DECIMALES
                    var estimatedHours = Math.Round((hoursPerDayWithDedication.Values.Sum()) * effort, 2);


                    return new WorkPackageInfoTS
                    {
                        WpId = wpx.Wp,
                        WpName = wpx.WpNavigation.Name,
                        WpTitle = wpx.WpNavigation.Title,
                        ProjectName = wpx.WpNavigation.Proj.Acronim,
                        ProjectSAPCode = wpx.WpNavigation.Proj.SapCode,
                        ProjectId = wpx.WpNavigation.Proj.ProjId,
                        Effort = effort,
                        EstimatedHours = estimatedHours,
                        Timesheets = timesheets.Where(ts => ts.WpxPersonId == wpx.Id).ToList()
                    };
                }).ToList(),
                HoursUsed = hoursUsed,
                HoursForOtherProjects = hoursForOtherProjects,
                TotalHoursForOtherProjects = totalHoursForOtherProjects // Añadir la suma total de horas para otros proyectos
            };

            ViewBag.PercentageUsed = percentageUsed.ToString("0.0", CultureInfo.InvariantCulture);

            return viewModel;
        }


        [HttpPost]
        public async Task<IActionResult> SaveTimesheetHours([FromBody] TimesheetUpdateModel model)
        {
            if (model.TimesheetDataList == null || !model.TimesheetDataList.Any())
            {
                return Json(new { success = false, message = "No data provided." });
            }

            foreach (var item in model.TimesheetDataList)
            {
                // Buscar el WpxPersonId usando el PersonId y WpId
                var wpxPerson = await _context.Wpxpeople
                    .FirstOrDefaultAsync(wpx => wpx.Person == item.PersonId && wpx.Wp == item.WpId);

                if (wpxPerson == null)
                {
                    // No se encontró la relación WpxPerson, posiblemente registrar en el log o manejar el error
                    continue; // Pasar al siguiente item en la lista
                }

                // Ahora que tienes el WpxPersonId, busca o crea la entrada de Timesheet correspondiente
                var timesheetEntry = await _context.Timesheets
                    .FirstOrDefaultAsync(ts => ts.WpxPersonId == wpxPerson.Id && ts.Day == item.Day);

                if (timesheetEntry != null)
                {
                    // Si existe, actualiza las horas
                    timesheetEntry.Hours = item.Hours;
                }
                else
                {
                    // Si no existe, crea una nueva entrada de Timesheet
                    _context.Timesheets.Add(new Timesheet
                    {
                        WpxPersonId = wpxPerson.Id,
                        Day = item.Day,
                        Hours = item.Hours
                    });
                }
            }

            await _context.SaveChangesAsync();
            return Json(new { success = true, message = "Timesheets updated successfully." });
        }


        [HttpGet]
        public async Task<IActionResult> ExportTimesheetToPdf(int personId, int year, int month, int project)
        {
            QuestPDF.Settings.License = LicenseType.Community;
            var model = await GetTimesheetDataForPerson(personId, year, month, project);
            var totalhours = model.TotalHours;
            var totalhoursworkedonproject = model.WorkPackages.Sum(wp => wp.Timesheets.Sum(ts => ts.Hours));
            var totaldaysWorkedOnProject = (totalhoursworkedonproject / model.AffiliationHours) * 1;

            decimal roundedtotalHours = Math.Round(totalhours * 2, MidpointRounding.AwayFromZero) / 2;
            decimal roundedtotalHoursWorkedOnProject = Math.Round(totalhoursworkedonproject * 2, MidpointRounding.AwayFromZero) / 2;

            var document = Document.Create(document =>
            {
                document.Page(page =>
                {

                    page.Margin(30);
                    page.Size(PageSizes.A4.Landscape());

                    page.Header().ShowOnce().Row(row =>
                    {
                        var logoPath = Path.Combine(Directory.GetCurrentDirectory(), "Resources", "logo.png");
                        byte[] logoBytes = System.IO.File.ReadAllBytes(logoPath);
                        row.ConstantItem(140).Height(60).Image(logoBytes);


                        row.RelativeItem().Column(col =>
                        {
                            var monthName = new DateTime(year, month, 1).ToString("MMMM", CultureInfo.CreateSpecificCulture("en"));
                            col.Item().AlignCenter().Text($"{model.Person.Name} {model.Person.Surname} Timesheet").Bold().FontSize(14);
                            col.Item().AlignCenter().Text($"{monthName} {year}").FontSize(12);
                            col.Item().AlignCenter().Text($"{model.ProjectData.Contract} - {model.ProjectData.Acronim}").Bold().FontSize(14);
                        });

                        row.ConstantItem(180).Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#004488") // Changed to dark blue
                            .AlignCenter().Text("Hours worked");

                            col.Item().Background("#004488").Border(1) // Background and border changed to dark blue
                            .BorderColor("#004488").AlignCenter()
                            .Text("Total hours worked on project").FontColor("#fff");

                            col.Item().Border(1).BorderColor("#004488"). // Border changed to dark blue
                            AlignCenter().Text("Total days worked on project");
                        });

                        row.ConstantItem(100).Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#004488") // Changed to dark blue
                            .AlignCenter().Text($"{roundedtotalHours}");

                            col.Item().Background("#004488").Border(1) // Background and border changed to dark blue
                            .BorderColor("#004488").AlignCenter()
                            .Text($"{roundedtotalHoursWorkedOnProject}").FontColor("#fff");

                            col.Item().Border(1).BorderColor("#004488"). // Border changed to dark blue
                            AlignCenter().Text($"{totaldaysWorkedOnProject}");
                        });

                    });

                    page.Content().PaddingVertical(10).Column(col1 =>
                    {
                        col1.Item().Column(col2 =>
                        {
                            col2.Item().Text("Personnel Data").Underline().Bold();

                            col2.Item().Text(txt =>
                            {
                                txt.Span("Name of Beneficiary: ").SemiBold().FontSize(10);
                                txt.Span("BARCELONA SUPERCOMPUTING CENTER - CENTRO NACIONAL DE SUPERCOMPUTACIÓN").FontSize(10);
                            });

                            col2.Item().Text(txt =>
                            {
                                txt.Span("Name of staff member: ").SemiBold().FontSize(10);
                                txt.Span($"{model.Person.Name} {model.Person.Surname}").FontSize(10);
                            });

                            col2.Item().Text(txt =>
                            {
                                txt.Span("Job Title: ").SemiBold().FontSize(10);
                                txt.Span($"{model.Person.Category}").FontSize(10);
                            });

                        });

                        col1.Item().LineHorizontal(0.5f);

                        col1.Item().Table(tabla =>
                        {
                            // Definición dinámica de las columnas según el mes
                            tabla.ColumnsDefinition(columns =>
                            {
                                columns.RelativeColumn(3); // Para "Proyecto"
                                                           // Agrega una columna por cada día del mes
                                var daysInMonth = DateTime.DaysInMonth(year, month);
                                for (int day = 1; day <= daysInMonth; day++)
                                {
                                    columns.RelativeColumn(); // Una columna por día
                                }
                                columns.RelativeColumn(); // Additional column for "Total"
                            });

                            // Encabezado de la tabla
                            tabla.Header(header =>
                            {
                                // Primera columna fija
                                header.Cell().Background("#0055A4").Padding(2).AlignCenter().Text("Work Packages").Bold().FontColor("#fff").FontSize(10);

                                // Columnas para cada día del mes
                                var daysInMonth = DateTime.DaysInMonth(year, month);
                                for (int day = 1; day <= daysInMonth; day++)
                                {
                                    var date = new DateTime(year, month, day);
                                    var dayAbbreviation = date.ToString("ddd", CultureInfo.CreateSpecificCulture("en")); // Obtiene la abreviatura del día en inglés
                                    header.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text($"{dayAbbreviation} {day:00}").ExtraBold().FontColor("#fff").FontSize(8);
                                }
                                // Add "Total" column header
                                header.Cell().Background("#0055A4").Padding(2).AlignMiddle().AlignCenter().Text("Total").Bold().FontColor("#FFFFFF").FontSize(8);
                            });


                            foreach (var wp in model.WorkPackages)
                            {

                                // For each work package, add a new cell for the WP name
                                tabla.Cell().Border(1).BorderColor("#00BFFF").AlignCenter().Text($"{wp.WpName} - {wp.WpTitle}").Bold().FontSize(8);

                                // Then, for each day of the month, add a new cell with either the timesheet entry hours or "0"
                                foreach (var day in Enumerable.Range(1, DateTime.DaysInMonth(year, month)).Select(day => new DateTime(year, month, day)))
                                {
                                    var date = new DateTime(year, month, day.Day);
                                    var timesheetEntry = wp.Timesheets.FirstOrDefault(ts => ts.Day.Date == date);
                                    var isWeekend = day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday;
                                    var leave = model.LeavesthisMonth.FirstOrDefault(l => l.Day.Date == day.Date);
                                    var hasTravel = model.TravelsthisMonth.Any(t => day.Date >= t.StartDate && day.Date <= t.EndDate);
                                    var isFuture = day.Date > DateTime.Now.Date;
                                    var isHoliday = model.Holidays.Any(h => h.Date == day.Date);

                                    var cellBackground = "#FFFFFF";

                                    // 1) Festivo nacional: mayor prioridad
                                    if (isHoliday)
                                    {
                                        cellBackground = "#008000"; // National Holidays
                                    }
                                    // 2) Fin de semana: segunda prioridad (pisa leave/vacaciones y viajes)
                                    else if (isWeekend)
                                    {
                                        cellBackground = "#6c757d"; // Weekend (gris)
                                    }
                                    // 3) Ausencias (solo si no es festivo ni finde)
                                    else if (leave != null)
                                    {
                                        switch (leave.Type)
                                        {
                                            case 1:
                                                cellBackground = "#FFA07A"; // Absence
                                                break;
                                            case 2:
                                                cellBackground = "#ADD8E6"; // Vacation
                                                break;
                                            case 3:
                                                cellBackground = "#800080"; // Out of Contract
                                                break;
                                        }
                                    }
                                    // 4) Viajes (si no es futuro y no se pintó antes)
                                    else if (hasTravel && !isFuture)
                                    {
                                        cellBackground = "#FF69B4"; // Travel Days
                                    }
                                    // 5) Futuro (solo si nada anterior aplicó)
                                    else if (isFuture)
                                    {
                                        cellBackground = "#6c757d"; // Gris para futuro
                                    }

                                    // Directly add cells for each day within the same iteration that adds the work package name
                                    tabla.Cell().Background(cellBackground).Border(1).BorderColor("#00BFFF").AlignMiddle().AlignCenter().Text(timesheetEntry?.Hours.ToString("0.#") ?? "0").Bold().FontSize(8);
                                }

                                // Calculate the total hours for this WP and add a cell for it
                                var totalHours = wp.Timesheets.Sum(ts => ts.Hours);
                                tabla.Cell().Border(1).BorderColor("#00BFFF").AlignMiddle().AlignCenter().Text(totalHours.ToString("0.#")).Bold().FontSize(8);

                            }

                            // Fila de "Total" al final
                            tabla.Footer(footer =>
                            {
                                footer.Cell().ColumnSpan((uint)DateTime.DaysInMonth(year, month) + 2).BorderHorizontal(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignMiddle().AlignCenter().Text("Total Hours worked on project").Bold().FontColor("#FFFFFF").FontSize(8);
                                footer.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text("").FontColor("#FFFFFF").FontSize(8);
                                for (int day = 1; day <= DateTime.DaysInMonth(year, month); day++)
                                {
                                    var totalHoursForDay = model.WorkPackages.Sum(wp => wp.Timesheets.FirstOrDefault(ts => ts.Day.Day == day)?.Hours ?? 0);
                                    decimal roundedtotalHoursForDay = Math.Round(totalHoursForDay * 2, MidpointRounding.AwayFromZero) / 2;
                                    footer.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text($"{roundedtotalHoursForDay}").ExtraBold().FontColor("#FFFFFF").FontSize(8);
                                }

                                footer.Cell().Padding(2).AlignMiddle().AlignCenter()
    .Text($"{roundedtotalHoursWorkedOnProject}")
    .FontColor("#FFFFFF").Bold().FontSize(7);

                            });

                        });

                        col1.Item().LineHorizontal(0.5f);
                        if (1 == 1)
                        {
                            col1.Item().Background(Colors.Grey.Lighten3).Padding(10)
                            .Column(column =>
                            {
                                column.Item().AlignCenter().Text("Travels").Bold().FontSize(14);
                                column.Spacing(5);

                                // Inicia la definición de la nueva tabla para "Travels"
                                column.Item().Table(table =>
                                {
                                    // Definición de columnas
                                    table.ColumnsDefinition(columns =>
                                    {
                                        columns.RelativeColumn(); // Liq Id
                                        columns.RelativeColumn(); // Project
                                        columns.RelativeColumn(); // Dedication
                                        columns.RelativeColumn(); // StartDate
                                        columns.RelativeColumn(); // EndDate
                                    });

                                    // Encabezados de la tabla
                                    table.Header(header =>
                                    {
                                        header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Liq Id").FontColor("#fff").FontSize(10);
                                        header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Project").FontColor("#fff").FontSize(10);
                                        header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Dedication").FontColor("#fff").FontSize(10);
                                        header.Cell().Background("#004488").Padding(2).AlignCenter().Text("StartDate").FontColor("#fff").FontSize(10);
                                        header.Cell().Background("#004488").Padding(2).AlignCenter().Text("EndDate").FontColor("#fff").FontSize(10);
                                    });


                                    foreach (var travel in model.TravelsthisMonth)
                                    {
                                        table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.LiqId}").FontSize(8);
                                        table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.ProjectSAPCode} - {travel.ProjectAcronimo}").FontSize(8);
                                        table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.Dedication:0.0}%").FontSize(8);
                                        table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.StartDate:dd/MM/yyyy}").FontSize(8);
                                        table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.EndDate:dd/MM/yyyy}").FontSize(8);
                                    }
                                });
                            });

                            col1.Spacing(10);
                        }

                    });




                    page.Footer().Row(footer =>
                    {
                        // Cuadro de firma para el Responsable
                        footer.RelativeItem().Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#000000") // Borde del cuadro de firma
                            .Height(80) // Altura del cuadro de firma
                            .Padding(5) // Espaciado interno
                            .Column(innerCol =>
                            {

                                innerCol.Item().Row(row =>
                                {
                                    row.RelativeItem().Text("Date, name and signature of manager/supervisor:").FontSize(10);
                                    // Asume que tienes una variable para el nombre del manager/supervisor
                                    row.ConstantItem(100).AlignRight().Text($"{model.Responsible}").FontSize(10);
                                });
                            });
                        });

                        // Número de página en el centro
                        footer.RelativeItem().AlignBottom().AlignCenter().Text(text =>
                        {
                            text.Span("Página ").FontSize(10);
                            text.CurrentPageNumber().FontSize(10);
                            text.Span(" de ").FontSize(10);
                            text.TotalPages().FontSize(10);
                        });

                        // Cuadro de firma para el Investigador
                        footer.RelativeItem().Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#000000") // Borde del cuadro de firma
                            .Height(80) // Altura del cuadro de firma
                            .Padding(5) // Espaciado interno
                            .Column(innerCol =>
                            {

                                innerCol.Item().Row(row =>
                                {
                                    row.RelativeItem().Text("Date and signature of staff member:").FontSize(10);
                                    // Asume que model.Person contiene el nombre de la persona de la timesheet
                                    // y usas DateTime.Now para la fecha actual
                                    row.ConstantItem(100).AlignRight().Text($"{model.Person.Name} {model.Person.Surname}, {DateTime.Now:dd/MM/yyyy}").FontSize(10);
                                });
                            });
                        });
                    });
                });


            });

            using var stream = new MemoryStream();
            //document.ShowInPreviewer();

            document.GeneratePdf(stream);
            stream.Seek(0, SeekOrigin.Begin);

            var pdfFileName = $"Timesheet_{personId}_{year}_{month}.pdf";
            return File(stream.ToArray(), "application/pdf", pdfFileName);
        }






        [HttpGet]
        public async Task<IActionResult> ExportTimesheetToPdf2(int personId, int year, int month, int project, string manualDate = null, string manualCode = null)
        {
            QuestPDF.Settings.License = LicenseType.Professional;
            TextStyle.Default.FontFamily("Arial");
            DateTime? selectedDate = null;
            if (!string.IsNullOrEmpty(manualDate))
            {
                selectedDate = DateTime.ParseExact(manualDate, "yyyy-MM-dd", CultureInfo.InvariantCulture);
            }
            var lastLoginDateInvestigator = await GetLastLoginDateForNextMonth(personId, year, month);
            var model = await GetTimesheetDataForPerson(personId, year, month, project);


            // --- Responsable histórico para el periodo de la timesheet ---
            var monthStart = new DateTime(year, month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            // Tramos de afiliación que se solapan con el mes de la TS
            var affLines = await _context.AffxPersons
                .Where(a => a.PersonId == personId && a.Start <= monthEnd && a.End >= monthStart)
                .ToListAsync();

            Personnel responsible = null;
            int responsibleId = 0;

            if (affLines.Any())
            {
                // Elegimos el tramo con MAYOR INTERSECCIÓN de días con el mes
                var chosen = affLines
                    .OrderByDescending(a =>
                    {
                        var s = a.Start > monthStart ? a.Start : monthStart;
                        var e = a.End < monthEnd ? a.End : monthEnd;
                        return (e - s).TotalDays;
                    })
                    .First();

                if (chosen.ResponsibleId.HasValue && chosen.ResponsibleId.Value > 0)
                {
                    responsible = await _context.Personnel.FindAsync(chosen.ResponsibleId.Value);
                }
            }

            if (responsible == null)
            {
                // Fallback al responsable actual en Personnel si no hay histórico
                responsible = await _context.Personnel.FindAsync(model.Person.Resp);
            }

            responsibleId = responsible?.Id ?? 0;

            // Sobrescribe lo que imprime el PDF en la firma del manager
            model.Responsible = responsible != null
                ? $"{responsible.Name} {responsible.Surname}"
                : "N/A";

            // Usar este responsable para la fecha de firma (último login)
            var lastLoginDateResponsible = responsibleId != 0
                ? await GetLastLoginDateForNextMonth(responsibleId, year, month)
                : null;



            var totalhours = model.TotalHours;
            var totalhoursworkedonproject = model.WorkPackages.Sum(wp => wp.Timesheets.Sum(ts => ts.Hours));
            // Actualización del cálculo de días trabajados en el proyecto para incluir decimales
            var totaldaysWorkedOnProject = Math.Round(totalhoursworkedonproject / model.AffiliationHours, 1, MidpointRounding.AwayFromZero);
            //CAMBIOS ANTES DE DECIMAL
            //decimal roundedtotalHours = Math.Round(totalhours * 2, MidpointRounding.AwayFromZero) / 2;
            //decimal roundedtotalHoursWorkedOnProject = Math.Round(totalhoursworkedonproject * 2, MidpointRounding.AwayFromZero) / 2;

            decimal roundedtotalHours = Math.Round(totalhours, 1, MidpointRounding.AwayFromZero);
            decimal roundedtotalHoursWorkedOnProject = Math.Round(totalhoursworkedonproject, 1, MidpointRounding.AwayFromZero);


            DateTime? finalDateInvestigator = null;
            DateTime? finalDateResponsible = null;

            if (!string.IsNullOrEmpty(lastLoginDateInvestigator))
            {
                finalDateInvestigator = DateTime.Parse(lastLoginDateInvestigator);
            }
            else if (selectedDate.HasValue)
            {
                finalDateInvestigator = selectedDate;
            }

            if (!string.IsNullOrEmpty(lastLoginDateResponsible))
            {
                finalDateResponsible = DateTime.Parse(lastLoginDateResponsible);
            }
            else if (selectedDate.HasValue)
            {
                finalDateResponsible = selectedDate;
            }

            var document = Document.Create(document =>
            {
                document.Page(page =>
                {
                    page.Margin(30);
                    page.Size(PageSizes.A4.Landscape());

                    page.Header().ShowOnce().Row(row =>
                    {
                        var logoPath = Path.Combine(Directory.GetCurrentDirectory(), "Resources", "logo.png");
                        byte[] logoBytes = System.IO.File.ReadAllBytes(logoPath);
                        row.ConstantItem(140).Height(60).Image(logoBytes);


                        row.RelativeItem().Column(col =>
                        {
                            var monthName = new DateTime(year, month, 1).ToString("MMMM", CultureInfo.CreateSpecificCulture("en"));
                            col.Item().AlignCenter().Text($"{model.Person.Name} {model.Person.Surname} Timesheet").Bold().FontSize(12);
                            col.Item().AlignCenter().Text($"{monthName} {year}").FontSize(10);
                            string refText = string.IsNullOrEmpty(manualCode)
                                            ? $"REF: {model.ProjectData.Contract} - {model.ProjectData.Acronim}"
                                            : $"REF: {model.ProjectData.Contract} / {manualCode} - {model.ProjectData.Acronim}";

                            col.Item().AlignCenter().Text(refText).Bold().FontSize(12);

                            col.Item().AlignCenter().Text($"{model.ProjectData.Title}").FontSize(10);
                        });

                        row.ConstantItem(180).Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#004488") // Changed to dark blue
                            .AlignCenter().Text("Hours worked");

                            col.Item().Background("#004488").Border(1) // Background and border changed to dark blue
                            .BorderColor("#004488").AlignCenter()
                            .Text("Total hours worked on project").FontColor("#fff");

                            col.Item().Border(1).BorderColor("#004488"). // Border changed to dark blue
                            AlignCenter().Text("Total days worked on project");
                        });

                        row.ConstantItem(100).Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#004488") // Changed to dark blue
                            .AlignCenter().Text($"{roundedtotalHours:0.0}");

                            col.Item().Background("#004488").Border(1) // Background and border changed to dark blue
                            .BorderColor("#004488").AlignCenter()
                            .Text($"{roundedtotalHoursWorkedOnProject}").FontColor("#fff");

                            col.Item().Border(1).BorderColor("#004488"). // Border changed to dark blue
                            AlignCenter().Text($"{totaldaysWorkedOnProject}");
                        });
                    });
                    page.Content().Column(contentColumn =>
                    {
                        contentColumn.Item().PaddingVertical(10).Row(mainRow =>
                        {
                            mainRow.RelativeItem().Column(col1 =>
                            {
                                col1.Item().Column(col2 =>
                                {
                                    col2.Item().Text("Personnel Data").Underline().Bold();

                                    col2.Item().Text(txt =>
                                    {
                                        txt.Span("Name of Beneficiary: ").SemiBold().FontSize(10);
                                        txt.Span("BARCELONA SUPERCOMPUTING CENTER - CENTRO NACIONAL DE SUPERCOMPUTACIÓN").FontSize(10);
                                    });

                                    col2.Item().Text(txt =>
                                    {
                                        txt.Span("Name of staff member: ").SemiBold().FontSize(10);
                                        txt.Span($"{model.Person.Name} {model.Person.Surname}").FontSize(10);
                                    });

                                    col2.Item().Text(txt =>
                                    {
                                        txt.Span("Job Title: ").SemiBold().FontSize(10);
                                        txt.Span($"{model.Person.Category}").FontSize(10);
                                    });
                                });

                                col1.Item().LineHorizontal(0.5f);

                                col1.Item().Table(tabla =>
                                {
                                    tabla.ColumnsDefinition(columns =>
                                    {
                                        columns.RelativeColumn(3); // Para "Proyecto"
                                        var daysInMonth = DateTime.DaysInMonth(year, month);
                                        for (int day = 1; day <= daysInMonth; day++)
                                        {
                                            columns.RelativeColumn(); // Una columna por día
                                        }
                                        columns.ConstantColumn(35); // Additional column for "Total"
                                    });

                                    // Encabezado de la tabla
                                    tabla.Header(header =>
                                    {
                                        header.Cell().Background("#0055A4").Padding(2).AlignCenter().Text("Work Packages").Bold().FontColor("#FFFFFF").FontSize(10);

                                        var daysInMonth = DateTime.DaysInMonth(year, month);
                                        for (int day = 1; day <= daysInMonth; day++)
                                        {
                                            var date = new DateTime(year, month, day);
                                            var dayAbbreviation = date.ToString("ddd", CultureInfo.CreateSpecificCulture("en"));
                                            header.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text($"{dayAbbreviation} {day:00}").ExtraBold().FontColor("#FFFFFF").FontSize(8);
                                        }
                                        header.Cell().Background("#0055A4").Padding(2).AlignMiddle().AlignCenter().Text("Total").Bold().FontColor("#FFFFFF").FontSize(8);
                                    });

                                    foreach (var wp in model.WorkPackages)
                                    {
                                        tabla.Cell().Border(1).BorderColor("#00BFFF").AlignCenter().Text($"{wp.WpName}").Bold().FontSize(8);

                                        foreach (var day in Enumerable.Range(1, DateTime.DaysInMonth(year, month)).Select(day => new DateTime(year, month, day)))
                                        {
                                            var date = new DateTime(year, month, day.Day);
                                            var timesheetEntry = wp.Timesheets.FirstOrDefault(ts => ts.Day.Date == date);
                                            var isWeekend = day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday;
                                            var leave = model.LeavesthisMonth.FirstOrDefault(l => l.Day.Date == day.Date);
                                            var hasTravel = model.TravelsthisMonth.Any(t => day.Date >= t.StartDate && day.Date <= t.EndDate);
                                            var isFuture = day.Date > DateTime.Now.Date;
                                            var isHoliday = model.Holidays.Any(h => h.Date == day.Date);

                                            var cellBackground = "#FFFFFF";

                                            // 1) Festivo nacional: mayor prioridad
                                            if (isHoliday)
                                            {
                                                cellBackground = "#008000"; // National Holidays
                                            }
                                            // 2) Fin de semana: segunda prioridad (pisa leave/vacaciones y viajes)
                                            else if (isWeekend)
                                            {
                                                cellBackground = "#6c757d"; // Weekend (gris)
                                            }
                                            // 3) Ausencias (solo si no es festivo ni finde)
                                            else if (leave != null)
                                            {
                                                switch (leave.Type)
                                                {
                                                    case 1:
                                                        cellBackground = "#FFA07A"; // Absence
                                                        break;
                                                    case 2:
                                                        cellBackground = "#ADD8E6"; // Vacation
                                                        break;
                                                    case 3:
                                                        cellBackground = "#800080"; // Out of Contract
                                                        break;
                                                }
                                            }
                                            // 4) Viajes (si no es futuro y no se pintó antes)
                                            else if (hasTravel && !isFuture)
                                            {
                                                cellBackground = "#FF69B4"; // Travel Days
                                            }
                                            // 5) Futuro (solo si nada anterior aplicó)
                                            else if (isFuture)
                                            {
                                                cellBackground = "#6c757d"; // Gris para futuro
                                            }

                                            tabla.Cell().Background(cellBackground).Border(1).BorderColor("#00BFFF").AlignMiddle().AlignCenter().Text(timesheetEntry?.Hours.ToString("0.#") ?? "0").Bold().FontSize(8);
                                        }

                                        var totalHours = wp.Timesheets.Sum(ts => ts.Hours);
                                        tabla.Cell().Border(1).BorderColor("#00BFFF").AlignMiddle().AlignCenter().Text(totalHours.ToString("0.#")).Bold().FontSize(8);
                                    }

                                    tabla.Footer(footer =>
                                    {
                                        // Fila "Total Hours" con borde inferior azul
                                        footer.Cell().BorderVertical(1).BorderColor("#00BFFF").BorderBottom(1).Background("#0055A4").Padding(2).AlignCenter().Text("Total Hours").FontColor("#FFFFFF").FontSize(8);
                                        for (int day = 1; day <= DateTime.DaysInMonth(year, month); day++)
                                        {
                                            var totalHoursForDay = model.WorkPackages.Sum(wp => wp.Timesheets.FirstOrDefault(ts => ts.Day.Day == day)?.Hours ?? 0);
                                            //decimal roundedtotalHoursForDay = Math.Round(totalHoursForDay * 2, MidpointRounding.AwayFromZero) / 2; //CAMBIOS ANTES DE DECIMAL
                                            decimal roundedtotalHoursForDay = Math.Round(totalHoursForDay, 1, MidpointRounding.AwayFromZero);

                                            footer.Cell().BorderVertical(1).BorderColor("#00BFFF").BorderBottom(1).Background("#0055A4").Padding(2).AlignCenter().Text($"{roundedtotalHoursForDay}").ExtraBold().FontColor("#FFFFFF").FontSize(8);
                                        }
                                        footer.Cell().BorderBottom(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text($"{roundedtotalHoursWorkedOnProject}").ExtraBold().FontColor("#FFFFFF").Bold().FontSize(8);

                                        // Nueva fila "Other Projects"
                                        footer.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#0055A4").Padding(2).AlignCenter().Text("Other Projects").FontColor("#FFFFFF").FontSize(8);
                                        for (int day = 1; day <= DateTime.DaysInMonth(year, month); day++)
                                        {
                                            var date = new DateTime(year, month, day);
                                            var otherProjectHoursForDay = model.HoursForOtherProjects.ContainsKey(date) ? model.HoursForOtherProjects[date] : 0;
                                            var isHolidayOrLeave = model.Holidays.Any(h => h.Date == date) || model.LeavesthisMonth.Any(l => l.Day == date);
                                            decimal roundedOtherProjectHoursForDay = isHolidayOrLeave ? 0 : Math.Round(otherProjectHoursForDay, 1, MidpointRounding.AwayFromZero);
                                            footer.Cell().BorderVertical(1).BorderColor("#00BFFF").Background("#D3D3D3").Padding(2).AlignCenter().Text($"{roundedOtherProjectHoursForDay:0.#}").ExtraBold().FontColor("#000000").FontSize(8);
                                        }
                                        footer.Cell().Background("#D3D3D3").Padding(2).AlignCenter().Text($"{model.TotalHoursForOtherProjects:0.#}").ExtraBold().FontColor("#000000").Bold().FontSize(8);
                                    });

                                });


                                // Puedes continuar con más contenido si es necesario
                            });                 

                        });

                        contentColumn.Item().PaddingVertical(10).Row(legendRow =>
                        {
                            // Leyenda de Work Packages en la mitad izquierda
                            legendRow.RelativeItem().Column(legendWpCol =>
                            {
                                legendWpCol.Item().Text("Work Packages Title").Bold().Underline().FontSize(10);

                                foreach (var wp in model.WorkPackages)
                                {
                                    legendWpCol.Item().PaddingVertical(1).Row(row =>
                                    {
                                        row.RelativeItem().Text($"{wp.WpName} - {wp.WpTitle}").FontSize(8);
                                    });
                                }
                            });

                            // Leyenda de Colores y Tabla "Travels" en la mitad derecha
                            legendRow.RelativeItem().Column(legendColorTravelsCol =>
                            {
                                // Leyenda de colores
                                legendColorTravelsCol.Item().Border(1).BorderColor("#000").Padding(5).Column(col =>
                                {
                                    col.Item().AlignCenter().Text("Legend").Bold().FontSize(10);

                                    var colors = new Dictionary<string, string>
                                                {
                                                    { "#FFA07A", "Absence" },
                                                    { "#ADD8E6", "Vacation" },
                                                    { "#800080", "Out of Contract" },
                                                    { "#FF69B4", "Travel Days" },
                                                    { "#008000", "National Holidays" }
                                                };

                                    col.Item().Row(row =>
                                    {
                                        foreach (var color in colors)
                                        {
                                            row.RelativeItem().Row(colorRow =>
                                            {
                                                colorRow.AutoItem().MaxHeight(10).MaxWidth(20).Background(color.Key).Border(1).BorderColor("#000").Width(10);
                                                colorRow.RelativeItem().PaddingLeft(2).Text(color.Value).FontSize(8);
                                            });
                                        }
                                    });
                                });
                                legendColorTravelsCol.Spacing(5); 
                                // Tabla "Travels" debajo de la leyenda de colores
                                legendColorTravelsCol.Item().Background(Colors.Grey.Lighten3).Padding(10).Column(column =>
                                {
                                    column.Item().AlignCenter().Text("Travels").Bold().FontSize(10);
                                    column.Spacing(5);

                                    // Inicia la definición de la tabla para "Travels"
                                    column.Item().Table(table =>
                                    {
                                        // Definición de columnas
                                        table.ColumnsDefinition(columns =>
                                        {
                                            columns.RelativeColumn(); // Liq Id
                                            columns.RelativeColumn(); // Project
                                            columns.RelativeColumn(); // Dedication
                                            columns.RelativeColumn(); // StartDate
                                            columns.RelativeColumn(); // EndDate
                                        });

                                        // Encabezados de la tabla
                                        table.Header(header =>
                                        {
                                            header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Liq Id").FontColor("#fff").FontSize(8);
                                            header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Project").FontColor("#fff").FontSize(8);
                                            header.Cell().Background("#004488").Padding(2).AlignCenter().Text("Dedication").FontColor("#fff").FontSize(8);
                                            header.Cell().Background("#004488").Padding(2).AlignCenter().Text("StartDate").FontColor("#fff").FontSize(8);
                                            header.Cell().Background("#004488").Padding(2).AlignCenter().Text("EndDate").FontColor("#fff").FontSize(8);
                                        });

                                        // Añadiendo filas de ejemplo
                                        //for (int i = 1; i <= 4; i++)
                                        //{
                                        //    table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"Liq-{i}").FontSize(8);
                                        //    table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"Project-{i}").FontSize(8);
                                        //    table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{i * 10.0}%").FontSize(8);
                                        //    table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"2024-01-{i:02}").FontSize(8);
                                        //    table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"2024-01-{i + 1:02}").FontSize(8);
                                        //}

                                        //Filas de la tabla con los datos de viaje
                                        foreach (var travel in model.TravelsthisMonth)
                                        {
                                            table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.LiqId}").FontSize(8);
                                            table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.ProjectAcronimo}").FontSize(8);
                                            table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.Dedication:0.0}%").FontSize(8);
                                            table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.StartDate:dd/MM/yyyy}").FontSize(8);
                                            table.Cell().BorderHorizontal(1).BorderColor("#00BFFF").AlignCenter().Text($"{travel.EndDate:dd/MM/yyyy}").FontSize(8);
                                        }
                                    });
                                });
                            });
                        });
                    });
                    page.Footer().Row(footer =>
                    {
                        // Cuadro de firma para el Responsable
                        footer.RelativeItem().Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#000000") // Borde del cuadro de firma
                            .Height(80) // Altura del cuadro de firma
                            .Padding(5) // Espaciado interno
                            .Column(innerCol =>
                            {

                                innerCol.Item().Row(row =>
                                {
                                    row.RelativeItem().Text("Date, name and signature of manager/supervisor:").FontSize(10);
                                    // Asume que tienes una variable para el nombre del manager/supervisor
                                    row.ConstantItem(100).AlignRight().Text($"{model.Responsible}, {finalDateResponsible:dd/MM/yyyy}").FontSize(10);
                                });
                            });
                        });

                        // Número de página en el centro
                        footer.RelativeItem().AlignBottom().AlignCenter().Text(text =>
                        {
                            text.Span("Página ").FontSize(10);
                            text.CurrentPageNumber().FontSize(10);
                            text.Span(" de ").FontSize(10);
                            text.TotalPages().FontSize(10);
                        });

                        // Cuadro de firma para el Investigador
                        footer.RelativeItem().Column(col =>
                        {
                            col.Item().Border(1).BorderColor("#000000") // Borde del cuadro de firma
                            .Height(80) // Altura del cuadro de firma
                            .Padding(5) // Espaciado interno
                            .Column(innerCol =>
                            {

                                innerCol.Item().Row(row =>
                                {
                                    row.RelativeItem().Text("Date, name and signature of staff member:").FontSize(10);
                                    // Asume que model.Person contiene el nombre de la persona de la timesheet
                                    // y usas DateTime.Now para la fecha actual                                    
                                    row.ConstantItem(100).AlignRight().Text($"{model.Person.Name} {model.Person.Surname}, {finalDateInvestigator:dd/MM/yyyy}").FontSize(10);

                                });
                            });
                        });
                    });
                });
            });

            using var stream = new MemoryStream();
            //document.ShowInPreviewer(); // Remover esta línea si se quiere generar directamente el PDF sin previsualización

            document.GeneratePdf(stream); // Descomentar para generar el PDF
            stream.Seek(0, SeekOrigin.Begin);

            var pdfFileName = $"Timesheet_{model.Person.Surname},{model.Person.Name}_{year}_{month}.pdf";
            return File(stream.ToArray(), "application/pdf", pdfFileName);
        }

        // Método auxiliar para redondear al entero o .5 más cercano
        // MÉTODO INACTIVO - SE COMENTA TRAS EL CAMBIO A DECIMALES COMPLETOS EN HORAS
        //private decimal RoundToNearestHalfOrWhole(decimal value)
        //{
        //    // Multiplicar por 2, redondear al entero más cercano y dividir por 2
        //    return Math.Round(value * 2, MidpointRounding.AwayFromZero) / 2;
        //}
        public async Task<string> GetLastLoginDateForPerson(int personId, int year, int month)
        {
            var lastLogin = await _context.UserLoginHistories
                .Where(x => x.PersonId == personId && x.LoginTime.Year == year && x.LoginTime.Month == month)
                .OrderByDescending(x => x.LoginTime)
                .Select(x => x.LoginTime)
                .FirstOrDefaultAsync();

            return lastLogin != default ? lastLogin.ToString("dd/MM/yyyy", CultureInfo.InvariantCulture) : string.Empty;
        }

        public async Task<string> GetLastLoginDateForNextMonth(int personId, int year, int month)
        {
            // Calcular el siguiente mes y el año correspondiente
            month++;
            if (month > 12)
            {
                month = 1;
                year++;
            }

            var lastLogin = await _context.UserLoginHistories
                .Where(x => x.PersonId == personId && x.LoginTime.Year == year && x.LoginTime.Month == month)
                .OrderByDescending(x => x.LoginTime)
                .Select(x => x.LoginTime)
                .FirstOrDefaultAsync();

            return lastLogin != default ? lastLogin.ToString("dd/MM/yyyy", CultureInfo.InvariantCulture) : string.Empty;
        }

        [HttpPost]
        public async Task<IActionResult> AutoFillTimesheetForPersonAndMonth([FromBody] AutoFillRequest model)
        {
            if (model == null || model.PersonId <= 0)
                return Json(new { success = false, message = "Petición inválida." });

            var monthStart = new DateTime(model.TargetMonth.Year, model.TargetMonth.Month, 1);

            // Verificamos si cumple condiciones para poder autocompletar
            var cumpleCondiciones = await (from pf in _context.Persefforts
                                           join wxp in _context.Wpxpeople on pf.WpxPerson equals wxp.Id
                                           where pf.Value != 0 &&
                                                 pf.Month.Year == monthStart.Year &&
                                                 pf.Month.Month == monthStart.Month &&
                                                 wxp.Person == model.PersonId
                                           group pf by new { wxp.Person, pf.Month } into g
                                           where g.Count() == 1
                                           select g.Key).AnyAsync();

            bool esMesPasado = monthStart < new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);

            if (!cumpleCondiciones || !esMesPasado)
            {
                return Json(new
                {
                    success = false,
                    message = $"No se puede ejecutar el proceso. Verifica que el mes sea pasado y que la persona tenga effort en un único WP en ese mes."
                });
            }

            try
            {
                await _workCalendarService.AutoFillTimesheetForPersonAndMonthAsync(model.PersonId, monthStart);
                return Json(new { success = true, message = "Timesheet completado correctamente." });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = $"Error: {ex.Message}" });
            }
        }

        public class AutoFillRequest
        {
            public int PersonId { get; set; }
            public DateTime TargetMonth { get; set; }
        }

    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\ToolsController.cs -----
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Globalization;
using TRS2._0.Models.DataModels;
using TRS2._0.Models.ViewModels;
using TRS2._0.Services;
using static TRS2._0.Models.ViewModels.GlobalHoursViewModel;

namespace TRS2._0.Controllers
{
    public class ToolsController : Controller
    {

        private readonly TRSDBContext _context;
        private readonly WorkCalendarService _calendarService;

        public ToolsController(TRSDBContext context, WorkCalendarService calendarService)
        {
            _context = context;
            _calendarService = calendarService;
        }
        public async Task<IActionResult> GlobalHours(int? year)
        {
            int selectedYear = year ?? DateTime.Now.Year;

            // Precarga personas con contrato ese año
            var personIdsWithContract = await _context.Dedications
                .Where(d => d.Start != null && d.End != null &&
                            d.Start <= new DateTime(selectedYear, 12, 31) &&
                            d.End >= new DateTime(selectedYear, 1, 1))
                .Select(d => d.PersId)
                .Distinct()
                .ToListAsync();

            var persons = await _context.Personnel
                .Where(p => personIdsWithContract.Contains(p.Id))
                .Include(p => p.DepartmentNavigation)
                .Include(p => p.AffxPersons)
                    .ThenInclude(ap => ap.Affiliation)
                .ToListAsync();

            var allLeaves = await _context.Leaves
                .Where(l => l.Day.Year == selectedYear)
                .ToListAsync();

            var allHolidays = await _context.NationalHolidays
                .Where(h => h.Date.Year == selectedYear)
                .ToListAsync();

            var dailyHoursCache = await _calendarService
                .PreloadDailyWorkHoursWithDedicationAsync(persons.Select(p => p.Id).ToList(), selectedYear);

            var tasks = persons.OrderBy(p => p.Surname).ThenBy(p => p.Name).Select(async person =>
            {
                var entry = new GlobalHoursEntry
                {
                    PersonName = $"{person.Surname}, {person.Name}",
                    Department = person.DepartmentNavigation?.Name ?? "",
                    Group = person.PersonnelGroup.HasValue
                        ? _context.Personnelgroups.FirstOrDefault(pg => pg.Id == person.PersonnelGroup)?.GroupName ?? ""
                        : "",
                    MonthlyHours = new Dictionary<string, decimal>()
                };

                for (int m = 1; m <= 12; m++)
                {
                    var total = _calendarService.CalculateGlobalHoursFromCache(
                        person.Id, selectedYear, m,
                        dailyHoursCache, allLeaves, allHolidays);

                    entry.MonthlyHours.Add(
                        CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m),
                        total
                    );
                }

                return entry;
            });

            var entries = (await Task.WhenAll(tasks)).ToList();

            var viewModel = new ToolsViewModel
            {
                Year = selectedYear,
                GlobalHours = new GlobalHoursViewModel
                {
                    Entries = entries
                }
            };

            return View("GlobalHours", viewModel);
        }


        public async Task<IActionResult> GlobalEffort(int? year)
        {
            int selectedYear = year ?? DateTime.Now.Year;

            // Precarga personas con contrato ese año
            var personIdsWithContract = await _context.Dedications
                .Where(d => d.Start != null && d.End != null &&
                            d.Start <= new DateTime(selectedYear, 12, 31) &&
                            d.End >= new DateTime(selectedYear, 1, 1))
                .Select(d => d.PersId)
                .Distinct()
                .ToListAsync();

            var persons = await _context.Personnel
                .Where(p => personIdsWithContract.Contains(p.Id))
                .Include(p => p.DepartmentNavigation)
                .Include(p => p.AffxPersons)
                    .ThenInclude(ap => ap.Affiliation)
                .ToListAsync();

            var allPersMonthEfforts = await _context.PersMonthEfforts
                .Where(pme => pme.Month.Year == selectedYear)
                .ToListAsync();

            var allPersefforts = await _context.Persefforts
                .Where(pe => pe.Month.Year == selectedYear)
                .Include(pe => pe.WpxPersonNavigation)
                .ToListAsync();

            var tasks = persons.OrderBy(p => p.Surname).ThenBy(p => p.Name).Select(async person =>
            {
                var entry = new GlobalEffortEntry
                {
                    PersonId = person.Id,
                    PersonName = $"{person.Surname}, {person.Name}",
                    Department = person.DepartmentNavigation?.Name ?? "",
                    Group = person.PersonnelGroup.HasValue
                        ? _context.Personnelgroups.FirstOrDefault(pg => pg.Id == person.PersonnelGroup)?.GroupName ?? ""
                        : "",
                    MonthlyEffortSummary = new Dictionary<string, string>()
                };

                for (int m = 1; m <= 12; m++)
                {
                    string monthKey = CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m);

                    decimal assigned = allPersefforts
                        .Where(pe => pe.WpxPersonNavigation.Person == person.Id &&
                                     pe.Month.Year == selectedYear &&
                                     pe.Month.Month == m)
                        .Sum(pe => pe.Value);

                    decimal max = allPersMonthEfforts
                        .Where(pme => pme.PersonId == person.Id &&
                                      pme.Month.Year == selectedYear &&
                                      pme.Month.Month == m)
                        .Select(pme => pme.Value)
                        .FirstOrDefault();

                    entry.MonthlyEffortSummary[monthKey] = $"{assigned:0.00} | {max:0.00}";
                }

                return entry;
            });

            var entries = (await Task.WhenAll(tasks)).ToList();

            var viewModel = new ToolsViewModel
            {
                Year = selectedYear,
                GlobalEffort = new GlobalEffortViewModel
                {
                    Entries = entries
                }
            };

            return View("GlobalEffort", viewModel);
        }

        [HttpGet]
        [Route("Tools/GetPersonEffortBreakdown")]
        public async Task<IActionResult> GetPersonEffortBreakdown(int personId, int year)
        {
            var raw = await _context.Persefforts
                .Where(pe => pe.Month.Year == year &&
                             pe.WpxPersonNavigation.Person == personId)
                .Include(pe => pe.WpxPersonNavigation)
                    .ThenInclude(wpp => wpp.WpNavigation)
                        .ThenInclude(wp => wp.Proj)
                .Select(pe => new
                {
                    Month = pe.Month.Month,
                    Value = pe.Value,
                    ProjectAcronim = pe.WpxPersonNavigation.WpNavigation.Proj != null
                ? pe.WpxPersonNavigation.WpNavigation.Proj.Acronim
                : "",
                    // ⬇️ Mostrar SIEMPRE el Name del WP
                    WpName = pe.WpxPersonNavigation.WpNavigation.Name
                })
                .ToListAsync();

            var rows = raw
                .GroupBy(r => new { r.ProjectAcronim, r.WpName })
                .Select(g => new PersonEffortFlatRow
                {
                    ProjectAcronym = g.Key.ProjectAcronim ?? "",
                    WpName = g.Key.WpName ?? "",
                    MonthValues = g.GroupBy(x => x.Month)
                                   .ToDictionary(mg => mg.Key, mg => mg.Sum(x => x.Value))
                })
                .OrderBy(r => r.ProjectAcronym)
                .ThenBy(r => r.WpName)
                .ToList();

            return Json(new { rows });
        }


        public class PersonEffortFlatRow
        {
            public string ProjectAcronym { get; set; } = "";
            public string WpName { get; set; } = "";
            // Mes -> Valor
            public Dictionary<int, decimal> MonthValues { get; set; } = new();
        }

    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Controllers\WpsController.cs -----
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TRS2._0.Models;
using TRS2._0.Models.DataModels;

namespace TRS2._0.Controllers
{
        
    public class WpsController : Controller
    {
        private readonly TRSDBContext _context;

        public WpsController(TRSDBContext context)
        {
            _context = context;
        }

        // GET: Wps
        public async Task<IActionResult> Index()
        {
            var tRSDBContext = _context.Wps.Include(w => w.Proj);
            return View(await tRSDBContext.ToListAsync());
        }

        // GET: Wps/Details/5
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null || _context.Wps == null)
            {
                return NotFound();
            }

            var wp = await _context.Wps
                .Include(w => w.Proj)
                .FirstOrDefaultAsync(m => m.Id == id);
            if (wp == null)
            {
                return NotFound();
            }

            return View(wp);
        }

        // GET: Wps/Create
        public IActionResult Create()
        {
            ViewData["ProjId"] = new SelectList(_context.Projects, "ProjId", "ProjId");
            return View();
        }
                

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] Wp wp)
        {
            if (ModelState.IsValid)
            {
                try
                {
                    _context.Add(wp);
                    await _context.SaveChangesAsync();
                    return Json(new { success = true, message = "WP creado con éxito." });
                }
                catch (Exception ex)
                {
                    // Log the exception details here using your preferred logging framework
                    return Json(new { success = false, message = "Error al guardar los datos." });
                }
            }
            else
            {
                var errorMessages = ModelState.Values.SelectMany(v => v.Errors.Select(e => e.ErrorMessage));
                return Json(new { success = false, message = "Error en los datos proporcionados.", errors = errorMessages });
            }
        }
        // GET: Wps/Edit/5
        public async Task<IActionResult> Edit(int? id)
        {
            if (id == null || _context.Wps == null)
            {
                return NotFound();
            }

            var wp = await _context.Wps.FindAsync(id);
            if (wp == null)
            {
                return NotFound();
            }
            ViewData["ProjId"] = new SelectList(_context.Projects, "ProjId", "ProjId", wp.ProjId);
            return View(wp);
        }

        // POST: Wps/Edit/5
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        
        public async Task<IActionResult> Edit(int id, [Bind("Id,ProjId,Name,Title,StartDate,EndDate,Pms")] Wp wp)
        {
            if (id != wp.Id)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    _context.Update(wp);
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!WpExists(wp.Id))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }
                return RedirectToAction(nameof(Index));
            }
            ViewData["ProjId"] = new SelectList(_context.Projects, "ProjId", "ProjId", wp.ProjId);
            return View(wp);
        }

        [HttpPost]
        public async Task<IActionResult> UpdateWp(Wp updatedWp)
        {
            if (!ModelState.IsValid || updatedWp == null)
                return Json(new { success = false, message = "Datos inválidos." });

            var existingWp = await _context.Wps.FindAsync(updatedWp.Id);
            if (existingWp == null)
                return Json(new { success = false, message = "WP no encontrado." });

            // Reparsea PMS desde el formulario por si llegó con coma o miles
            var pmsRaw = Request.Form["Pms"].ToString();
            if (!string.IsNullOrEmpty(pmsRaw))
            {
                var s = pmsRaw.Trim().Replace(" ", "");
                int li = Math.Max(s.LastIndexOf(','), s.LastIndexOf('.'));
                if (li >= 0)
                {
                    char dec = s[li];
                    char other = dec == ',' ? '.' : ',';
                    s = s.Replace(other.ToString(), "");
                    if (dec == ',') s = s.Replace(',', '.');
                }
                else
                {
                    s = s.Replace(',', '.'); // sólo coma => decimal
                }

                if (decimal.TryParse(s, NumberStyles.Number, CultureInfo.InvariantCulture, out var pmsParsed))
                    updatedWp.Pms = (float)pmsParsed;
            }

            // --- Normalización a primer día de mes (comparación por MES) ---
            DateTime OldStartM = new DateTime(existingWp.StartDate.Year, existingWp.StartDate.Month, 1);
            DateTime OldEndM = new DateTime(existingWp.EndDate.Year, existingWp.EndDate.Month, 1);

            DateTime NewStartM = new DateTime(updatedWp.StartDate.Year, updatedWp.StartDate.Month, 1);
            DateTime NewEndM = new DateTime(updatedWp.EndDate.Year, updatedWp.EndDate.Month, 1);

            // Acortamos?
            bool shortensFront = NewStartM > OldStartM;
            bool shortensBack = NewEndM < OldEndM;

            // Si no hay acortamiento, no hay bloqueo por efforts fuera de rango
            List<object> conflicts = new();

            if (shortensFront || shortensBack)
            {
                var proj = await _context.Projects
                    .Where(p => p.ProjId == existingWp.ProjId)
                    .Select(p => new { p.ProjId, p.Acronim })
                    .FirstOrDefaultAsync();

                // Para que EF lo traduzca bien, trabajamos con año/mes como constantes
                int oldStartY = OldStartM.Year, oldStartM = OldStartM.Month;
                int oldEndY = OldEndM.Year, oldEndM = OldEndM.Month;
                int newStartY = NewStartM.Year, newStartM = NewStartM.Month;
                int newEndY = NewEndM.Year, newEndM = NewEndM.Month;

                // Helper inline para comparar por mes en SQL:
                // (y1, m1) < (y2, m2)  ->  y1 < y2 OR (y1==y2 AND m1<m2)
                // (y1, m1) > (y2, m2)  ->  y1 > y2 OR (y1==y2 AND m1>m2)

                var removedAll = await (
                    from c in _context.Wpxpeople
                    where c.Wp == existingWp.Id
                    join e in _context.Persefforts on c.Id equals e.WpxPerson
                    join per in _context.Personnel on c.Person equals per.Id
                    where
                        (
                            (shortensFront && (
                                // e.Month < NewStartM  AND e.Month >= OldStartM
                                (e.Month.Year < newStartY ||
                                 (e.Month.Year == newStartY && e.Month.Month < newStartM))
                                &&
                                (e.Month.Year > oldStartY ||
                                 (e.Month.Year == oldStartY && e.Month.Month >= oldStartM))
                            ))
                            ||
                            (shortensBack && (
                                // e.Month > NewEndM AND e.Month <= OldEndM
                                (e.Month.Year > newEndY ||
                                 (e.Month.Year == newEndY && e.Month.Month > newEndM))
                                &&
                                (e.Month.Year < oldEndY ||
                                 (e.Month.Year == oldEndY && e.Month.Month <= oldEndM))
                            ))
                        )
                        && e.Value > 0m
                    select new
                    {
                        e.Month,
                        e.Value,
                        PersonId = per.Id,
                        FirstName = per.Name,
                        LastName = per.Surname
                    })
                    .OrderBy(x => x.Month)
                    .ThenBy(x => x.LastName)
                    .ThenBy(x => x.FirstName)
                    .ToListAsync();

                if (removedAll.Any())
                {
                    foreach (var r in removedAll)
                    {
                        conflicts.Add(new
                        {
                            Project = proj?.Acronim,
                            Wp = existingWp.Name,
                            Month = new DateTime(r.Month.Year, r.Month.Month, 1).ToString("yyyy-MM-01"),
                            PersonId = r.PersonId,
                            Person = $"{r.FirstName} {r.LastName}",
                            Value = r.Value
                        });
                    }

                    var msg =
                        "No puedes modificar este WP porque existen efforts que quedarían fuera del nuevo rango. " +
                        "Retira o reubica primero estos efforts y vuelve a intentarlo.";

                    return Json(new
                    {
                        success = false,
                        message = msg,
                        wp = new
                        {
                            Project = proj?.Acronim,
                            Wp = existingWp.Name,
                            OldStart = OldStartM.ToString("yyyy-MM-01"),
                            OldEnd = OldEndM.ToString("yyyy-MM-01"),
                            NewStart = NewStartM.ToString("yyyy-MM-01"),
                            NewEnd = NewEndM.ToString("yyyy-MM-01")
                        },
                        conflicts
                    });
                }
            }


            // Si llegamos aquí, no hay conflictos => aplicar cambios
            existingWp.Name = updatedWp.Name;
            existingWp.Title = updatedWp.Title;
            existingWp.StartDate = updatedWp.StartDate;
            existingWp.EndDate = updatedWp.EndDate;
            existingWp.Pms = updatedWp.Pms;

            _context.Update(existingWp);
            await _context.SaveChangesAsync();

            return Json(new { success = true, message = "WP actualizado con éxito." });
        }

        // Helper
        private static DateTime FirstDayOfMonth(DateTime dt)
            => new DateTime(dt.Year, dt.Month, 1);





        // GET: Wps/Delete/5
        [HttpPost]
        public async Task<IActionResult> DeleteWp(int Id)
        {
            var wpToDelete = await _context.Wps.FindAsync(Id);
            if (wpToDelete != null)
            {
                _context.Wps.Remove(wpToDelete);
                await _context.SaveChangesAsync();
                return Json(new { success = true, message = "WP eliminado con éxito." });
            }
            else
            {
                return Json(new { success = false, message = "WP no encontrado." });
            }
        }
            

        private bool WpExists(int id)
        {
          return (_context.Wps?.Any(e => e.Id == id)).GetValueOrDefault();
        }

        [HttpPost]
        public async Task<IActionResult> SaveEfforts([FromBody] data Misdatos)
        {
            // Validar si el WP existe
            var workPackage = await _context.Wps.FindAsync(Misdatos.wpId);
            if (workPackage == null)
            {
                return Json(new { success = false, message = "Work Package not found." });
            }

            // Convertir las fechas y esfuerzos a un formato utilizable
            var effortsData = Misdatos.efforts.Select(e => new
            {
                Date = DateTime.ParseExact(e.Key, "yyyy-MM-dd", CultureInfo.InvariantCulture),
                Effort = float.Parse(e.Value, CultureInfo.InvariantCulture)
            }).ToList();

            // Lógica para guardar o actualizar los esfuerzos
            foreach (var effortData in effortsData)
            {
                // Verificar si existe un esfuerzo para esa fecha
                var existingEffort = await _context.Projefforts
                    .FirstOrDefaultAsync(pe => pe.Wp == Misdatos.wpId && pe.Month == effortData.Date);

                if (existingEffort != null)
                {
                    // Si existe, actualiza el valor
                    existingEffort.Value = (decimal)effortData.Effort;
                    _context.Projefforts.Update(existingEffort);
                }
                else
                {
                    // Si no existe, crea uno nuevo
                    var newEffort = new Projeffort
                    {
                        Wp = Misdatos.wpId,
                        Month = effortData.Date,
                        Value = (decimal)effortData.Effort
                    };
                    _context.Projefforts.Add(newEffort);
                }
            }

            try
            {
                // Guardar cambios en la base de datos
                await _context.SaveChangesAsync();
                return Json(new { success = true, message = "Efforts saved successfully." });
            }
            catch (Exception ex)
            {
                // Manejar errores de la base de datos aquí
                return Json(new { success = false, message = ex.Message });
            }
        }

        [HttpPost]
        public async Task<IActionResult> SaveAllEfforts([FromBody] ProjectEffortUpdateModel model)
        {
            if (model == null || model.Efforts == null || !model.Efforts.Any())
            {
                return Json(new { success = false, message = "No data provided." });
            }

            foreach (var effortData in model.Efforts)
            {
                // Asumiendo que 'effortData.Month' es un string en formato "YYYY-MM-DD"
                var effortDate = DateTime.ParseExact(effortData.Month, "yyyy-MM-dd", CultureInfo.InvariantCulture);

                var existingEffort = await _context.Projefforts
                    .FirstOrDefaultAsync(pe => pe.Wp == effortData.WpId && pe.Month == effortDate);

                if (existingEffort != null)
                {
                    existingEffort.Value = effortData.Value;
                    _context.Projefforts.Update(existingEffort);
                }
                else
                {
                    var newEffort = new Projeffort
                    {
                        Wp = effortData.WpId,
                        Month = effortDate, // Usa la fecha parseada aquí
                        Value = effortData.Value
                    };
                    _context.Projefforts.Add(newEffort);
                }
            }

            try
            {
                await _context.SaveChangesAsync();
                return Json(new { success = true, message = "All efforts saved successfully." });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "An error occurred: " + ex.Message });
            }
        }



    }
}



