=== BUNDLE: Views (20251113_094855) ===
----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\_ViewImports.cshtml -----
@using TRS2._0
@using TRS2._0.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\_ViewStart.cshtml -----
@{
    Layout = "_Layout";
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ChangePassword.cshtml -----
@model TRS2._0.Models.ViewModels.ChangePasswordViewModel
@{
    ViewData["Title"] = "Change Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Change Your Password</h4>
                </div>
                <div class="card-body">
                    <form asp-action="ChangePassword" method="post">
                        <div asp-validation-summary="All" class="text-danger mb-3"></div>

                        <div class="mb-3">
                            <label asp-for="OldPassword" class="form-label">Current Password</label>
                            <input asp-for="OldPassword" class="form-control" type="password" />
                            <span asp-validation-for="OldPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewPassword" class="form-label">New Password</label>
                            <input asp-for="NewPassword" class="form-control" type="password" />
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Confirm New Password</label>
                            <input asp-for="ConfirmPassword" class="form-control" type="password" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ChangePasswordConfirmation.cshtml -----
@{
    ViewData["Title"] = "Password Changed";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Changed</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
            transition: background 0.3s;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }
    </style>
</head>
<body>
    <div class="confirmation-container">
        <h3 class="mb-3 text-success"><i class="fas fa-check-circle"></i> Password changed</h3>
        <p class="text-muted">Your password has been successfully updated.</p>
        <p>You can continue using the platform with your new credentials.</p>

        <a href="/" class="btn btn-primary mt-3 w-100">Return to home</a>
    </div>
</body>
</html>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ForgotPassword.cshtml -----
@model TRS2._0.Models.ViewModels.ForgotPasswordViewModel

@{
    ViewData["Title"] = "Forgot Password";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recover Password</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forgot-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-control {
            border-radius: 5px;
        }

        .btn-warning {
            background: #ffa502;
            border: none;
            transition: background 0.3s;
        }

            .btn-warning:hover {
                background: #e69602;
            }
    </style>
</head>
<body>
    <div class="forgot-container">
        <h3 class="mb-3">Recover your password</h3>
        <p class="text-muted">Enter the email address associated with your account</p>

        <form asp-action="ForgotPassword" asp-controller="Account" method="post">
            <div class="mb-3 text-start">
                <label asp-for="Email" class="form-label">Email</label>
                <input asp-for="Email" class="form-control" placeholder="e.g., jsmith@bsc.es" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-warning w-100 mt-3">Send Reset Link</button>

            <div class="text-danger mt-3">
                @Html.ValidationSummary(true)
            </div>
        </form>

        <div class="alert alert-info mt-4 text-start">
            <strong>What happens next?</strong>
            <ul class="mb-0">
                <li>If your email exists in our system, you'll receive a link to reset your password.</li>
                <li>This link will expire after a certain time for security reasons.</li>
                <li>If you don’t receive anything, check your spam folder or contact <a href="mailto:iss@bsc.es">iss@bsc.es</a>.</li>
            </ul>
        </div>

        <p class="mt-3"><a asp-action="Login" asp-controller="Account">Back to login</a></p>
    </div>
</body>
</html>





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ForgotPasswordConfirmation.cshtml -----
@{
    ViewData["Title"] = "Password Reset Email Sent";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Sent</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }
    </style>
</head>
<body>
    <div class="confirmation-container">
        <h3 class="text-success"><i class="fas fa-envelope-open-text"></i> Email Sent</h3>
        <p class="text-muted">If this email exists in our system, a reset link has been sent to it.</p>
        <p>Please check your inbox and follow the instructions to reset your password.</p>

        <a href="/Account/Login" class="btn btn-primary mt-3 w-100">Back to Login</a>
    </div>
</body>
</html>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\Login.cshtml -----
@model TRS2._0.Models.ViewModels.LoginViewModel

@{
    ViewData["Title"] = "Login";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-control {
            border-radius: 5px;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
            transition: background 0.3s;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }

        .form-text-link {
            font-size: 0.9rem;
        }

            .form-text-link a {
                text-decoration: none;
            }

                .form-text-link a:hover {
                    text-decoration: underline;
                }
    </style>
</head>
<body>
    <div class="auth-container">
        <h4 class="mb-3">Welcome</h4>
        <p class="mb-4 text-muted">Access your account</p>

        <form asp-action="Login" method="post">
            <div class="form-group">
                <label asp-for="BSCID">Username</label>
                <input asp-for="BSCID" class="form-control" />
                <span asp-validation-for="BSCID" class="text-danger"></span>
            </div>

            <div class="form-group mt-3">
                <label asp-for="Password">Password</label>
                <div class="input-group">
                    <input asp-for="Password" class="form-control" type="password" id="passwordField" />
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()" title="Show/Hide Password">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Password" class="text-danger"></span>
            </div>

            <div class="form-check mt-3 text-start">
                <input asp-for="RememberMe" class="form-check-input" />
                <label asp-for="RememberMe" class="form-check-label">Remember me</label>
            </div>

            <div class="form-text-link text-end mt-2">
                <a asp-action="ForgotPassword" asp-controller="Account">Forgot your password?</a>
            </div>

            <button type="submit" class="btn btn-primary mt-3 w-100">Log in</button>

            <div class="text-danger mt-3">
                @Html.ValidationSummary(true)
            </div>
        </form>

        <div class="mt-3 form-text-link">
            Don't have an account? <a asp-action="Register" asp-controller="Account">Register</a>
        </div>

        <div class="alert alert-info mt-4 text-start">
            <strong>Having trouble logging in?</strong><br />
            - Make sure to <strong>copy and paste</strong> your password to avoid typos.<br />
            - Try opening the site in a <strong>private/incognito window</strong>.<br />
            - Still having issues? Contact us at <a href="mailto:iss@bsc.es">iss@bsc.es</a>.
        </div>
    </div>

    <script>
        function togglePassword() {
            const input = document.getElementById("passwordField");
            const icon = event.currentTarget.querySelector("i");
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }
    </script>
</body>
</html>





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\Register.cshtml -----
@model TRS2._0.Models.ViewModels.RegisterViewModel

@{
    ViewData["Title"] = "Register";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .register-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-control {
            border-radius: 5px;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
            transition: background 0.3s;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }
    </style>
</head>
<body>
    <div class="register-container">
        <h3 class="mb-3">Create your account</h3>
        <p class="text-muted">Use your BSC ID (not your email address)</p>

        <form method="post" asp-action="Register" asp-controller="Account">
            <div class="mb-3 text-start">
                <label class="form-label" for="BSCID">BSC ID</label>
                <input asp-for="BSCID" class="form-control" placeholder="e.g., jsmith" />
                <span asp-validation-for="BSCID" class="text-danger"></span>
                <div class="form-text">This is the same ID you use to access the <strong>Intranet</strong>.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">Register</button>

            <div class="text-danger mt-3">
                @Html.ValidationSummary(true)
            </div>
        </form>

        <p class="mt-4">
            Already have an account?
            <a asp-action="Login" asp-controller="Account">Log in</a>
        </p>
    </div>
</body>
</html>






----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\RegisterConfirmation.cshtml -----
@{
    ViewData["Title"] = "Account Created";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Created</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }
    </style>
</head>
<body>
    <div class="confirmation-container">
        <h3 class="text-success"><i class="fas fa-user-check"></i> Account Created</h3>
        <p class="text-muted">Your account has been successfully created and your login details have been sent to your email.</p>
        <p>Please check your inbox (and spam folder just in case).</p>

        <a href="/Account/Login" class="btn btn-primary mt-3 w-100">Go to Login</a>
    </div>
</body>
</html>





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ResetPassword.cshtml -----
@model TRS2._0.Models.ViewModels.ResetPasswordViewModel

@{
    ViewData["Title"] = "Reset Password";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Your Password</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reset-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-control {
            border-radius: 5px;
        }

        .btn-success {
            background: #28a745;
            border: none;
            transition: background 0.3s;
        }

            .btn-success:hover {
                background: #218838;
            }
    </style>
</head>
<body>
    <div class="reset-container">
        <h3 class="mb-3">Reset your password</h3>
        <p class="text-muted">Enter your email and new password</p>

        <form asp-action="ResetPassword" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Code" />

            <div class="mb-3 text-start">
                <label asp-for="Email" class="form-label">Email</label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>

            <div class="mb-3 text-start">
                <label asp-for="Password" class="form-label">New Password</label>
                <input asp-for="Password" class="form-control" type="password" />
                <span asp-validation-for="Password" class="text-danger"></span>
            </div>

            <div class="mb-3 text-start">
                <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                <input asp-for="ConfirmPassword" class="form-control" type="password" />
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-success w-100 mt-3">Reset Password</button>

            <div class="text-danger mt-3">
                @Html.ValidationSummary(true)
            </div>
        </form>

        <div class="alert alert-info mt-4 text-start">
            <strong>Need help?</strong>
            <ul class="mb-0">
                <li>Your new password must meet the platform's security requirements.</li>
                <li>If the reset link expired, go back to <a asp-action="ForgotPassword" asp-controller="Account">Forgot Password</a> and try again.</li>
                <li>Contact <a href="mailto:iss@bsc.es">iss@bsc.es</a> if problems persist.</li>
            </ul>
        </div>

        <p class="mt-3"><a asp-action="Login" asp-controller="Account">Back to login</a></p>
    </div>
</body>
</html>





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Account\ResetPasswordConfirmation.cshtml -----
@{
    ViewData["Title"] = "Password Reset Confirmation";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Successfully Reset</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(to right, darkblue, #2575fc);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .btn-primary {
            background: #2575fc;
            border: none;
            transition: background 0.3s;
        }

            .btn-primary:hover {
                background: #1a5ac6;
            }
    </style>
</head>
<body>
    <div class="confirmation-container">
        <h3 class="mb-3 text-success"><i class="fas fa-check-circle"></i> Password reset</h3>
        <p class="text-muted">Your password has been successfully updated.</p>
        <p>You can now log in with your new password.</p>

        <a asp-action="Login" asp-controller="Account" class="btn btn-primary mt-3 w-100">Go to Login</a>
    </div>
</body>
</html>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Admin\_DailyPMValuesList.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.DailyPMValue>

<table class="table">
    <thead>
        <tr>
            <th>Año</th>
            <th>Mes</th>
            <th>Días Laborables</th>
            <th>Valor PM por Día</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Year</td>
                <td>@item.Month</td>
                <td>@item.WorkableDays</td>
                <td>@item.PmPerDay</td>
            </tr>
        }
    </tbody>
</table>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Admin\AjustarOverloadManual.cshtml -----
@{
    ViewData["Title"] = "Ajustar Overload Manual";
    var persons = ViewBag.Persons as List<SelectListItem>;
}

<h2 class="text-center mb-4">Ajustar Overload Manualmente</h2>

@if (!string.IsNullOrEmpty(ViewBag.Message))
{
    <div class="alert alert-info">@Html.Raw(ViewBag.Message)</div>
}

<form asp-action="AjustarOverloadManual" method="post" class="row g-3">
    <div class="col-md-6 position-relative">
        <label for="personSearchInput" class="form-label">Buscar Persona</label>
        <input type="text" id="personSearchInput" class="form-control" placeholder="Nombre o Apellido" autocomplete="off" required />
        <input type="hidden" id="personId" name="personId" />
        <div id="personSearchResults" class="list-group position-absolute w-100" style="z-index: 9999;"></div>
    </div>

    <div class="col-md-3">
        <label for="year" class="form-label">Año</label>
        <input type="number" name="year" id="year" class="form-control" value="@DateTime.Now.Year" required />
    </div>

    <div class="col-md-3">
        <label for="month" class="form-label">Mes</label>
        <select name="month" id="month" class="form-select" required>
            <option value="">-- Mes --</option>
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m">@m.ToString("D2")</option>
            }
        </select>
    </div>

    <div class="col-12">
        <button type="submit" class="btn btn-primary w-100">Ajustar Overload</button>
    </div>
</form>

<hr class="my-4" />

<h4>🔁 Ajustar automáticamente todos los overloads desde una fecha</h4>

<form asp-action="LanzarAjusteDesdeFecha" method="post" class="row g-3 align-items-end">
    <div class="col-md-6">
        <label for="fechaInicio" class="form-label">Fecha de inicio</label>
        <input type="date" id="fechaInicio" name="fechaInicio" class="form-control" value="2025-01-01" required />
    </div>
    <div class="col-md-6">
        <button type="submit" class="btn btn-danger w-100">Lanzar ajuste global desde esta fecha</button>
        <div id="globalSpinner" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Procesando ajuste global...</span>
            </div>
            <div>Procesando ajuste global, por favor espera...</div>
        </div>
    </div>
</form>

@if (TempData["GlobalAjusteMensaje"] != null)
{
    <div class="alert alert-warning">@TempData["GlobalAjusteMensaje"]</div>
}

@section Scripts {
    <script>
        document.getElementById("personSearchInput").addEventListener("input", async function () {
            const query = this.value.trim();
            const resultsDiv = document.getElementById("personSearchResults");
            resultsDiv.innerHTML = "";

            if (query.length < 2) return;

            const response = await fetch(`/Admin/SearchPersonByName?query=${encodeURIComponent(query)}`);
            const results = await response.json();

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item disabled">No encontrado</div>';
                return;
            }

            results.forEach(p => {
                const item = document.createElement("button");
                item.type = "button";
                item.className = "list-group-item list-group-item-action";
                item.textContent = `${p.name} ${p.surname}`;
                item.onclick = function () {
                    document.getElementById("personSearchInput").value = `${p.name} ${p.surname}`;
                    document.getElementById("personId").value = p.id;
                    resultsDiv.innerHTML = "";
                };
                resultsDiv.appendChild(item);
            });
        });

        // Mostrar spinner al enviar el formulario global
        document.querySelector('form[action$="LanzarAjusteDesdeFecha"]').addEventListener('submit', function () {
            document.getElementById('globalSpinner').style.display = 'block';
        });
    </script>
}





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Admin\Index.cshtml -----
@model TRS2._0.Models.ViewModels.AdminIndexViewModel

@{
    ViewData["Title"] = "Admin Dashboard";
}

<h1 class="text-center my-4">Admin Dashboard</h1>

<div class="container">

    <form asp-action="RunDataLoadNow" asp-controller="Admin" method="post">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-play"></i> Ejecutar Carga Ahora
        </button>
    </form>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-tasks"></i> Estado de Procesos de Carga de Datos</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Proceso</th>
                            <th>Hora de Ejecución</th>
                            <th>Estado</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.ProcessLogs)
                        {
                            <tr class="@(log.Status == "Exitoso" ? "table-success" : log.Status == "Advertencias" ? "table-warning" : "table-danger")">
                                <td>@log.ProcessName</td>
                                <td>@log.ExecutionTime.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    <span class="badge @(log.Status == "Exitoso" ? "bg-success" : log.Status == "Advertencias" ? "bg-warning text-dark" : "bg-danger")">
                                        @log.Status
                                    </span>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.LogMessage))
                                    {
                                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#logDetailsModal" onclick="showLogDetails('@log.LogMessage.Replace("\n", "<br>")')">
                                            <i class="fas fa-info-circle"></i> Ver Detalles
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Sin detalles</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Detalles -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logDetailsModalLabel">Detalles del Proceso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="logDetailsContent"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <h3>Reset User Password</h3>

    <div class="mb-2 d-flex flex-column flex-md-row gap-2 align-items-md-center">
        <input type="text" class="form-control" id="userSearchBox" placeholder="Buscar usuario por nombre..." oninput="filterUserSelect()" />
        <select name="userId" id="userSelect" class="form-control">
            @foreach (var user in Model.Users.OrderBy(u => u.Text))
            {
                <option value="@user.Value">@user.Text</option>
            }
        </select>
    </div>

    <button type="submit" form="resetPasswordForm" class="btn btn-warning">Reset Password</button>

    <form id="resetPasswordForm"></form>

    <div id="resetResult" class="mt-2 text-info"></div>
    <div id="passwordContainer" class="mt-2" style="display: none;">
        <label><strong>New password:</strong></label>
        <div class="input-group">
            <input type="text" id="generatedPassword" class="form-control" readonly>
            <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()">📋 Copy</button>
        </div>
    </div>



    <!-- Primera fila: Trabajos Automatizados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Trabajos Automatizados</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap">
                        <h4>Orden: Proyectos, Grupos de Personal, Personal, Lideres, Dedicaciones y Afiliaciones, Carga de Out of Contract Liquidaciones, Bajas y Vacaciones, Generacion PM Mensuales </h4>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaProyectos')">Proyectos</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaGruposPersonas')">Grupos de Personas</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaPersonal')">Carga de Personal</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaLideres')">Líderes</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/CargaAfiliacionesYDedicaciones')">Afiliaciones y Dedicaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/Liquidaciones')">Liquidaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/ProcesaLiquidaciones')">Procesar Liquidaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/ProcesoLiquidacionesAvd')">Procesar Liquidaciones Adv</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/UpdateLeaveTable')">Ausencias y Vacaciones</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/Carga')">PMs Mensuales</button>      
                        <button class="btn btn-success m-2" onclick="triggerJob('/AdjustGlobalEffort')">Ajuste de Effort Global</button>
                        <button class="btn btn-success m-2" onclick="triggerJob('/OutOfContractLoad')">Out of Contract</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda fila: Visor de Logs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4>Visor de Logs</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="logFileSelect" class="form-label">Seleccionar Archivo de Log:</label>
                        <select id="logFileSelect" class="form-select" onchange="loadLogFile()">
                            <option value="">Cargando archivos de log...</option>
                        </select>
                    </div>
                    <div id="logContent" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa;">
                        <p>Seleccione un archivo de log para visualizar su contenido...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera fila: Cargar Excel y Generar PM -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h4>Seleccionar Carpeta para Cargar Excel</h4>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <button id="selectFolderButton" class="btn btn-primary">Seleccionar Carpeta</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h4>Generar Valores PM Mes/Año</h4>
                </div>
                <div class="card-body">
                    <form asp-action="GeneratePMValues" method="post" class="row g-3">
                        <div class="col-md-6">
                            <label for="year" class="form-label">Año</label>
                            <input type="number" name="year" class="form-control" placeholder="Year" required />
                        </div>
                        <div class="col-md-6">
                            <label for="month" class="form-label">Mes</label>
                            <input type="number" name="month" class="form-control" placeholder="Month" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Generar</button>
                        </div>
                    </form>
                </div>

                <div class="card h-100">
                    <div class="card-header bg-warning text-white">
                        <h4>Generar Valores PM Año</h4>
                    </div>
                    <div class="card-body">
                        <form asp-action="GenerateYearlyPMValues" method="post" class="row g-3">
                            <div class="col-md-6">
                                <label for="year" class="form-label">Año</label>
                                <input type="number" name="year" class="form-control" placeholder="Year" required />
                            </div>                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100">Generar</button>
                            </div>
                        </form>
                    </div>
            </div>
        </div>
    </div>

    <!-- Cuarta fila: Valores PM Diarios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Valores PM Diarios</h4>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Año</th>
                                <th>Mes</th>
                                <th>Días Laborables</th>
                                <th>PM por Día</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var pm in Model.DailyPMValues.OrderBy(pm => pm.Year).ThenBy(pm => pm.Month))
                            {
                                <tr>
                                    <td>@pm.Year</td>
                                    <td>@pm.Month</td>
                                    <td>@pm.WorkableDays</td>
                                    <td>@pm.PmPerDay</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quinta fila: Calcular PM Diario y Mensual -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light text-dark">
                    <h4>Calcular PM Diario</h4>
                </div>
                <div class="card-body">
                    <form asp-action="CalculateDailyPM" method="post" class="row g-3">
                        <div class="col-8">
                            <label for="personId" class="form-label">Persona</label>
                            <select name="personId" class="form-select" required>
                                @foreach (var person in Model.People)
                                {
                                    <option value="@person.Value">@person.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="date" class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Calcular</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light text-dark">
                    <h4>Calcular PM Mensual</h4>
                </div>
                <div class="card-body">
                    <form asp-action="CalculateMonthlyPM" method="post" class="row g-3">
                        <div class="col-8">
                            <label for="personId" class="form-label">Persona</label>
                            <select name="personId" class="form-select" required>
                                @foreach (var person in Model.People)
                                {
                                    <option value="@person.Value">@person.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="date" class="form-label">Mes</label>
                            <input type="month" name="date" class="form-control" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">Calcular</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sexta fila: Gestionar Roles -->
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h4>Gestionar Roles de Usuario</h4>
                    </div>
                    <div class="card-body">
                        <input type="text" id="userSearchInput" class="form-control mb-2" placeholder="Buscar usuario por nombre..." autocomplete="off" />
                        <div id="userSearchResults" class="list-group position-absolute" style="z-index: 9999;"></div>
                        <div id="userRoleFormContainer" class="mt-3" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <form id="fixRolesForm" method="post" asp-action="FixUsersWithoutRole">
            <button type="submit" class="btn btn-warning">
                🛠 Arreglar usuarios sin rol
            </button>
        </form>

        <div id="fixRolesResult" style="margin-top: 10px;"></div>


    <!-- Séptima fila: Ajuste de Esfuerzo -->
    <div class="container">
        <h3 class="text-center">Ajuste de Esfuerzo</h3>
        <form id="effort-adjustment-form">
            <div class="form-group">
                <label for="project-select">Proyecto:</label>
                <select id="project-select" class="form-control" onchange="loadWorkPackages()">
                    <option value="">Seleccione un proyecto</option>
                </select>
            </div>
            <div class="form-group">
                <label for="wp-select">Paquete de Trabajo:</label>
                <select id="wp-select" class="form-control" onchange="loadPersons()" disabled>
                    <option value="">Seleccione un paquete de trabajo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="person-select">Persona:</label>
                <select id="person-select" class="form-control" disabled>
                    <option value="">Seleccione una persona</option>
                </select>
            </div>
            <div class="form-group">
                <label for="month-input">Mes:</label>
                <input type="month" id="month-input" class="form-control" />
            </div>
            <button type="button" class="btn btn-primary" onclick="adjustEffort()">Ajustar Esfuerzo</button>
        </form>
    </div>

    <!-- Octava fila: Ajustar Timesheets por Rango de Fechas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>Ajustar Timesheets por Rango de Fechas</h4>
                </div>
                <div class="card-body">
                    <form id="adjust-timesheets-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Fecha de Inicio</label>
                                <input type="month" id="startDate" name="startDate" class="form-control" required>                                
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Fecha de Fin</label>
                                <input type="month" id="endDate" name="endDate" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <button type="button" id="submitAdjustTimesheets" class="btn btn-primary w-100">
                                    Ejecutar Proceso
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4>Ajustar Timesheet de una Persona y Mes</h4>
            </div>
            <div class="card-body">
                <form id="fill-person-timesheet-form">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="personSearchInput" class="form-label">Buscar Persona</label>
                            <input type="text" id="personSearchInput" class="form-control" placeholder="Nombre o Apellidos" autocomplete="off" />
                            <input type="hidden" id="selectedPersonId" />
                            <div id="personSearchResults" class="list-group position-absolute" style="z-index: 9999;"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="targetMonth" class="form-label">Mes</label>
                            <input type="month" id="targetMonth" class="form-control" required />
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-primary w-100" onclick="runPersonMonthTimesheet()">Ejecutar Proceso</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>


    <!-- Novena fila: Generar Informe de Ajustes de Timesheets -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Generar Informe de Ajustes de Timesheets</h4>
                </div>
                <div class="card-body">
                    <form id="generateReportForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="reportStartDate" class="form-label">Fecha de Inicio</label>
                                <input type="month" id="reportStartDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="reportEndDate" class="form-label">Fecha de Fin</label>
                                <input type="month" id="reportEndDate" name="endDate" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <button type="button" id="downloadReportBtn" class="btn btn-success w-100">
                                    Descargar Informe
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h4>Prueba de Envío de Recordatorio Timesheet (Prueba individual por correo)</h4>
        </div>
        <div class="card-body">
            <form asp-action="SendTimesheetReminderTest" method="post" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Correo de la persona:</label>
                    <input type="email" name="email" class="form-control" placeholder="ejemplo@bsc.es" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tipo de recordatorio:</label>
                    <select class="form-select" name="firstWeek">
                        <option value="true">Primera semana del mes (completo + históricos)</option>
                        <option value="false">Semanas siguientes (solo mes anterior si incompleto)</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-warning w-100">
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>


@section Scripts {
    <script>
        // Cargar lista de archivos de logs al iniciar la página
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/Admin/GetLogFiles')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const logFileSelect = document.getElementById('logFileSelect');
                    logFileSelect.innerHTML = ''; // Limpia opciones anteriores
                    if (data.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No hay archivos disponibles';
                        logFileSelect.appendChild(option);
                    } else {
                        data.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file;
                            option.textContent = file;
                            logFileSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    alert(`Error al cargar archivos de log: ${error.message}`);
                });
        });

        // Cargar contenido del archivo seleccionado
        function loadLogFile() {
            const selectedFile = document.getElementById('logFileSelect').value;
            fetch(`/Admin/GetLogFileContent?fileName=${selectedFile}`)
                .then(response => response.text())
                .then(content => {
                    document.getElementById('logContent').innerText = content;
                });

            // Actualización en tiempo real
            setInterval(() => {
                fetch(`/Admin/GetLogFileContent?fileName=${selectedFile}`)
                    .then(response => response.text())
                    .then(content => {
                        document.getElementById('logContent').innerText = content;
                    });
            }, 5000); // Actualiza cada 5 segundos
        }

        // Ejecutar un trabajo
        function triggerJob(endpoint) {
            fetch(endpoint, { method: 'GET' })
                .then(response => response.text())
                .then(message => alert(message))
                .catch(error => alert(`Error triggering job: ${error.message}`));
        }

        // Selección de carpeta para carga de Excel
        document.getElementById('selectFolderButton').addEventListener('click', function () {
            var input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.directory = true;
            input.multiple = true;
            input.addEventListener('change', function (event) {
                var files = event.target.files;
                var folderPath = files[0].webkitRelativePath.split('/')[0];
                fetch('/Admin/ProcessFolder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderPath: folderPath })
                }).then(response => response.json())
                    .then(data => console.log(data));
            });
            input.click();
        });

        async function loadProjects() {
            const response = await fetch('/Admin/GetProjects');
            const projects = await response.json();
            const select = document.getElementById('project-select');
            projects.sort((a, b) => a.acronim.localeCompare(b.acronim)); // Orden alfabético
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.projId;
                option.textContent = project.acronim;
                select.appendChild(option);
            });
        }

        async function loadWorkPackages() {
            const projectId = document.getElementById('project-select').value;
            if (!projectId) return;

            const response = await fetch(`/Admin/GetWorkPackages?projectId=${projectId}`);
            const workPackages = await response.json();
            const select = document.getElementById('wp-select');
            select.innerHTML = '<option value="">Seleccione un paquete de trabajo</option>';
            workPackages.sort((a, b) => a.name.localeCompare(b.name)); // Orden alfabético
            workPackages.forEach(wp => {
                const option = document.createElement('option');
                option.value = wp.id;
                option.textContent = wp.name;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        async function loadPersons() {
            const wpId = document.getElementById('wp-select').value;
            if (!wpId) return;

            const response = await fetch(`/Admin/GetPersonsInWorkPackage?wpId=${wpId}`);
            const persons = await response.json();
            const select = document.getElementById('person-select');
            select.innerHTML = '<option value="">Seleccione una persona</option>';
            persons.sort((a, b) => a.surname.localeCompare(b.surname)); // Orden alfabético por apellido
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person.person;
                option.textContent = `${person.surname}, ${person.name}`;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        async function adjustEffort() {
            const wpId = parseInt(document.getElementById('wp-select').value);
            const personId = parseInt(document.getElementById('person-select').value);
            const month = document.getElementById('month-input').value;

            if (!wpId || !personId || !month) {
                alert('Por favor, complete todos los campos.');
                return;
            }

            // Convertimos el mes al formato esperado por el backend
            const formattedMonth = `${month}-01T00:00:00`;

            const response = await fetch('/Admin/AdjustEffort', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wpId, personId, month: formattedMonth })
            });

            const result = await response.json();
            alert(result.message);
        }

            document.getElementById('submitAdjustTimesheets').addEventListener('click', async function () {
                const startDateInput = document.getElementById('startDate').value;
                const endDateInput = document.getElementById('endDate').value;
                console.log(startDateInput, endDateInput);
                if (!startDateInput || !endDateInput) {
                    alert('Por favor, complete las fechas de inicio y fin.');
                    return;
                }

                // Convertir los valores del campo "month" a fechas completas
                const startDate = new Date(startDateInput + '-01'); // Añadir el día para crear una fecha válida
                const endDate = new Date(endDateInput + '-01'); // Igual que arriba
                console.log(startDate, endDate);
                const response = await fetch('/Admin/AutoFillTimesheetsByDateRange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    })
                });

                const result = await response.json();
                alert(result.message);
            });


        document.getElementById('downloadReportBtn').addEventListener('click', async function () {
            const startDateInput = document.getElementById('reportStartDate').value;
            const endDateInput = document.getElementById('reportEndDate').value;

            console.log(startDateInput, endDateInput);

            if (!startDateInput || !endDateInput) {
                alert('Por favor, complete las fechas de inicio y fin.');
                return;
            }

            // Convertir los valores del campo "month" a fechas completas
            const startDate = new Date(startDateInput + '-01'); // Agregar el día para crear una fecha válida
            const endDate = new Date(endDateInput + '-01'); // Mismo proceso

            console.log("Fechas procesadas:", startDate, endDate);

            try {
                const response = await fetch('/Admin/GenerateAdjustmentReport', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al generar el informe.');
                }

                // Convertir la respuesta en un Blob y descargar el archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Ajustes_Timesheets.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();

                console.log("Informe descargado exitosamente.");
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al descargar el informe.');
            }
        });
                    
            function copyPassword() {
                var passwordInput = document.getElementById("generatedPassword");
                passwordInput.select();
                passwordInput.setSelectionRange(0, 99999); // Mobile support
                document.execCommand("copy");
                alert("Password copied to clipboard!");
            }

            $("#resetPasswordForm").submit(function (e) {
                e.preventDefault();
                var userId = $("#userSelect").val();
                $.post('/Account/AdminResetPassword', { userId: userId }, function (data) {
                    $("#resetResult").text(data.message);
                    if (data.success) {
                        $("#resetResult").removeClass("text-danger").addClass("text-success");
                    } else {
                        $("#resetResult").removeClass("text-success").addClass("text-danger");
                    }

                    if (data.password) {
                        $("#passwordContainer").show();
                        $("#generatedPassword").val(data.password); // ✅ esto pone el valor correcto
                    } else {
                        $("#passwordContainer").hide();
                        $("#generatedPassword").val(''); // ✅ limpia el campo anterior
                    }
                });
            });
        function showLogDetails(message) {
            document.getElementById("logDetailsContent").innerHTML = message;
        }

        document.addEventListener('DOMContentLoaded', loadProjects);

            document.getElementById("personSearchInput").addEventListener("input", async function () {
                const query = this.value.trim();
                const resultsDiv = document.getElementById("personSearchResults");
                resultsDiv.innerHTML = "";

                if (query.length < 2) return;

                const response = await fetch(`/Admin/SearchPersonByName?query=${encodeURIComponent(query)}`);
                const results = await response.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="list-group-item disabled">No encontrado</div>';
                    return;
                }

                results.forEach(p => {
                    const item = document.createElement("button");
                    item.type = "button";
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = `${p.name} ${p.surname}`;
                    item.onclick = function () {
                        document.getElementById("personSearchInput").value = `${p.name} ${p.surname}`;
                        document.getElementById("selectedPersonId").value = p.id;
                        resultsDiv.innerHTML = "";
                    };
                    resultsDiv.appendChild(item);
                });
            });

            async function runPersonMonthTimesheet() {
                const personId = document.getElementById("selectedPersonId").value;
                const month = document.getElementById("targetMonth").value;

                if (!personId || !month) {
                    alert("Por favor selecciona una persona válida y un mes.");
                    return;
                }

                const response = await fetch('/Admin/AutoFillTimesheetForPersonAndMonth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        personId: parseInt(personId),
                        targetMonth: `${month}-01T00:00:00`
                    })
                });

                const result = await response.json();
                alert(result.message);
            }

                        document.getElementById("userSearchInput").addEventListener("input", async function () {
                const query = this.value.trim();
                const resultsDiv = document.getElementById("userSearchResults");
                resultsDiv.innerHTML = "";

                if (query.length < 2) return;

                const response = await fetch(`/Admin/SearchUserByName?query=${encodeURIComponent(query)}`);
                const results = await response.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="list-group-item disabled">No encontrado</div>';
                    return;
                }

                results.forEach(user => {
                    const item = document.createElement("button");
                    item.type = "button";
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = user.userName;
                    item.onclick = () => {
                        resultsDiv.innerHTML = "";
                        document.getElementById("userSearchInput").value = user.userName;
                        renderRoleForm(user);
                    };
                    resultsDiv.appendChild(item);
                });
            });

            function renderRoleForm(user) {
                const roles = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Roles));
                const container = document.getElementById("userRoleFormContainer");
                container.innerHTML = `
                    <form method="post" action="/Admin/AssignRole" class="d-flex align-items-center flex-wrap gap-2">
                        <input type="hidden" name="userId" value="${user.id}" />
                        <label class="me-2"><strong>${user.userName}</strong></label>
                        <select name="role" class="form-select mx-2">
                            ${roles.map(r => `<option value="${r.value}">${r.text}</option>`).join('')}
                        </select>
                        <button type="submit" class="btn btn-primary">Asignar</button>
                    </form>
                `;
                container.style.display = "block";
            }

                        function filterUserSelect() {
                const input = document.getElementById('userSearchBox').value.toLowerCase();
                const select = document.getElementById('userSelect');
                const options = select.options;

                for (let i = 0; i < options.length; i++) {
                    const text = options[i].text.toLowerCase();
                    options[i].style.display = text.includes(input) ? 'block' : 'none';
                }

                // Selecciona el primer visible por comodidad
                const visibleOption = Array.from(options).find(o => o.style.display !== 'none');
                if (visibleOption) {
                    select.value = visibleOption.value;
                }
            }

                document.getElementById('fixRolesForm').addEventListener('submit', function (e) {
                e.preventDefault();
                fetch('@Url.Action("FixUsersWithoutRole", "Admin")', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('fixRolesResult');
                    resultDiv.innerText = data.message;
                    resultDiv.className = data.success ? "alert alert-success" : "alert alert-danger";
                });
            });
    </script>
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Admin\RemindersWeeklyDryRunView.cshtml -----
@model List<TRS2._0.Services.ReminderService.ReminderCandidate>
@{
    Layout = "_Layout"; // o el layout que uses
    var target = (string)ViewBag.TargetMonth;
    bool useCap = (bool)ViewBag.UseAssignmentCap;
    string replyTo = (string?)ViewBag.ReplyTo ?? "(no configurado)";
    string q = (string)ViewBag.Query;
    int year = (int)ViewBag.Year;
    int month = (int)ViewBag.Month;

    int total = Model.Count;
    int will = Model.Count(x => x.WillSend);
    int wont = total - will;
}

<div class="container mt-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <h3 class="mb-3">Dry-run Recordatorio Semanal — @target</h3>
        <div class="mb-3">
            <span class="badge rounded-pill text-bg-primary me-2">Total: @total</span>
            <span class="badge rounded-pill text-bg-success me-2">Enviaría: @will</span>
            <span class="badge rounded-pill text-bg-secondary">No enviaría: @wont</span>
        </div>
    </div>

    <div class="alert alert-info py-2">
        <div><strong>Reply-To:</strong> @replyTo</div>
        <div><strong>UseAssignmentCap:</strong> @useCap</div>
    </div>

    <form class="row g-2 mb-3" method="get" action="/Admin/RemindersWeeklyDryRunView">
        <div class="col-md-2">
            <label class="form-label">Año</label>
            <input type="number" class="form-control" name="year" value="@year" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Mes</label>
            <input type="number" class="form-control" name="month" value="@month" min="1" max="12" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Buscar (nombre/email)</label>
            <input type="text" class="form-control" name="q" value="@q" placeholder="Ej. ana@bsc.es" />
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary me-2" type="submit">Refrescar</button>
            <a class="btn btn-outline-secondary" href="/Admin/RemindersWeeklyDryRunView">Limpiar</a>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="min-width:220px">Persona</th>
                    <th style="min-width:260px">Email</th>
                    <th class="text-end">Declaradas (h)</th>
                    <th class="text-end">Requeridas Base (h)</th>
                    <th class="text-end">Asignación</th>
                    <th class="text-end">Umbral (h)</th>
                    <th class="text-center">¿Enviaría?</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model)
                {
                    var rowClass = r.WillSend ? "table-warning" : "";
                    <tr class="@rowClass">
                        <td>@r.PersonName (@r.PersonId)</td>
                        <td><a href="mailto:@r.Email">@r.Email</a></td>
                        <td class="text-end">@r.DeclaredHours</td>
                        <td class="text-end">@r.RequiredBaseHours</td>
                        <td class="text-end">
                            @string.Format("{0:P0}", r.AssignedFraction == 0 && !useCap ? 1 : r.AssignedFraction)
                        </td>
                        <td class="text-end">@r.RequiredThresholdHours</td>
                        <td class="text-center">
                            @if (r.WillSend)
                            {
                                <span class="badge text-bg-warning">Sí</span>
                            }
                            else
                            {
                                <span class="badge text-bg-secondary">No</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-light">
                <tr>
                    <th colspan="2">Totales</th>
                    <th class="text-end">@Model.Sum(x => x.DeclaredHours)</th>
                    <th class="text-end">@Model.Sum(x => x.RequiredBaseHours)</th>
                    <th class="text-end">—</th>
                    <th class="text-end">@Model.Sum(x => x.RequiredThresholdHours)</th>
                    <th class="text-center">
                        <span class="badge text-bg-success">Enviaría: @will</span>
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="small text-muted">
        <em>Las filas resaltadas indican candidatos a los que se <strong>enviaría</strong> el recordatorio.</em>
    </div>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Home\Index.cshtml -----
@{
    ViewData["Title"] = "Time Recording System (TRS)";
}

<!-- Improved Landing Page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to TRS</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css">
    <style>
        body {
            background: #002147; /* Corporate dark blue */
            color: white;
            text-align: center;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .hero {
            max-width: 700px;
            padding: 20px;
        }

        .btn-custom {
            background: #0056b3;
            color: white;
            padding: 12px 24px;
            font-size: 18px;
            border-radius: 5px;
            transition: background 0.3s;
        }

            .btn-custom:hover {
                background: #004494;
            }
    </style>
</head>
<body>
    <div class="hero">
        <h1>Welcome to TRS</h1>
        <p class="lead">Time Recording System - Track and manage your working hours efficiently.</p>
        @if (!User.Identity.IsAuthenticated)
        {
            <a href="/Account/Login" class="btn btn-custom">Log In</a>
        }
    </div>
</body>
</html>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Home\Privacy.cshtml -----
@{
    ViewData["Title"] = "Privacy Policy";
}
<h1>@ViewData["Title"]</h1>

<p>Use this page to detail your site's privacy policy.</p>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Home\Welcome.cshtml -----
@{
    ViewData["Title"] = "Welcome";
    Layout = "_LayoutSidebar";
}

<div class="text-center mt-5">
    <h1 class="display-4">Welcome to TRS 3.0</h1>
    <p class="lead">This is a preview of the new sidebar layout using Bootstrap 5.3.</p>
    <p>Use the navigation menu on the left to access different sections of the system.</p>
</div>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Leader\EffortSummary.cshtml -----
@using System.Globalization
@model TRS2._0.Models.ViewModels.LeaderEffortViewModel
@{
    ViewData["Title"] = "Leader Effort Summary";
    var months = Enumerable.Range(1, 12).ToList();
}

<div class="container-fluid px-4">
    <h2 class="text-center mb-4">Effort Summary - @Model.Year</h2>
</div>


<div class="d-flex justify-content-between align-items-center mb-3 px-4">
    <form method="get" asp-action="EffortSummary" class="d-inline-flex">
        <select name="year" onchange="this.form.submit()" class="form-select me-2">
            @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
            {
                <option value="@y" selected="@(y == Model.Year)">@y</option>
            }
        </select>
    </form>
    <a class="btn btn-outline-primary mb-2" href="@Url.Action("ExportEffortSummaryToCsv", "Leader", new { year = Model.Year })">
        <i class="bi bi-download"></i> Export to CSV
    </a>
    <div class="d-flex align-items-center w-75 gap-2">
        <button id="toggleAllBtn" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-arrows-collapse"></i> Expandir/Contraer todo
        </button>

        <input type="text" id="personSearch" class="form-control w-75" placeholder="Buscar persona por nombre o apellidos..." />
    </div>

</div>


<div class="container-fluid px-4">
    @foreach (var person in Model.People)
    {
        var personId = person.PersonId;
        var collapseId = $"collapsePerson_{personId}";

        <div class="card mb-2 person-card" data-person-name="@($"{person.FullName}".ToLower())">
            <div class="card-header custom-blue text-white"
                 style="cursor:pointer"
                 onclick="toggleCollapse('@collapseId')">
                @person.FullName
            </div>
            <div id="@collapseId" class="collapse">
                <div class="card-body">
                    @foreach (var project in person.Efforts.OrderBy(e => e.Project))
                    {
                        var projectCollapseId = $"collapseProject_{personId}_{project.Project.Replace(" ", "_")}";

                        <div class="mb-2">
                            <div class="bg-light p-2 border"
                                 style="cursor:pointer"
                                 onclick="toggleCollapse('@projectCollapseId')">
                                <strong>@project.Project</strong>
                            </div>

                            <div id="@projectCollapseId" class="collapse">
                                <table class="table table-bordered table-sm mt-2">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>WP</th>
                                            @for (int m = 1; m <= 12; m++)
                                            {
                                                <th>@CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m)</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var wp in project.SubEfforts)
                                        {
                                            <tr>
                                                <td>@wp.WP</td>
                                                @for (int m = 1; m <= 12; m++)
                                                {
                                                    <td>@(wp.MonthlyEffort.ContainsKey(m) ? wp.MonthlyEffort[m].ToString("F2") : "0.00")</td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>



@section Scripts {
    <script>
        function toggleDetails(rowId) {
            const rows = document.querySelectorAll(`[data-parent="${rowId}"]`);
            rows.forEach(r => {
                r.style.display = r.style.display === "none" ? "table-row" : "none";
            });
        }
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(trigger => {
            trigger.addEventListener('click', function () {
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                if (target.classList.contains('show')) {
                    bootstrap.Collapse.getInstance(target)?.hide();
                } else {
                    new bootstrap.Collapse(target, { toggle: true });
                }
            });
        });
        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const bsCollapse = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
            bsCollapse.toggle();
        }
        document.getElementById('personSearch').addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const cards = document.querySelectorAll('.person-card');

            cards.forEach(card => {
                const name = card.getAttribute('data-person-name');
                if (name.includes(searchValue)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
            document.getElementById('toggleAllBtn').addEventListener('click', function () {
            const collapses = document.querySelectorAll('.collapse');
            const allExpanded = [...collapses].every(c => c.classList.contains('show'));

            collapses.forEach(el => {
                const instance = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
                if (allExpanded) {
                    instance.hide();
                } else {
                    instance.show();
                }
            });
        });
    </script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>

    <style>
        .custom-blue {
            background-color: #004085; /* ejemplo: el azul real del título */
            color: white;
        }

    </style>
}




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Leader\GlobalEffortSummary.cshtml -----
@using System.Globalization
@model TRS2._0.Models.ViewModels.LeaderGlobalEffortViewModel

@{
    ViewData["Title"] = "Global Effort Summary";
    var monthNames = Enumerable.Range(1, 12)
        .Select(m => CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m))
        .ToList();
}

<div class="container-fluid mt-3">
    <h2 class="text-center fw-bold">
        Global Effort Summary — @Model.Year
    </h2>

    <div class="d-flex justify-content-center align-items-center gap-3 mt-3 flex-wrap">
        <form method="get" asp-action="GlobalEffortSummary" class="d-inline-flex align-items-center gap-2">
            <label class="fw-semibold">Año</label>
            <select name="year" onchange="this.form.submit()" class="form-select">
                @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
                {
                    <option value="@y" selected="@(y == Model.Year)">@y</option>
                }
            </select>
        </form>

        <input type="text" id="searchByPerson" class="form-control bg-white text-dark"
               placeholder="Buscar por apellido o nombre..." style="max-width: 280px;" />

        <button class="btn btn-success" onclick="downloadCSV()">
            <i class="bi bi-download"></i> Export CSV
        </button>
    </div>

    <div class="table-responsive scrollable-table-container mt-4">
        <table class="table table-bordered table-hover table-sm global-effort-table">
            <thead class="thead-dark">
                <tr>
                    <th>Person</th>
                    @foreach (var m in monthNames)
                    {
                        <th>@m</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var person in Model.People)
                {
                    var surname = person.FullName.Split(',').FirstOrDefault()?.Trim().ToLower() ?? "";
                    <tr data-personid="@person.PersonId"
                        data-name="@person.FullName.ToLower()"
                        data-surname="@surname">
                        <td class="fw-bold sticky-person">@person.FullName</td>

                        @for (int m = 1; m <= 12; m++)
                        {
                            // Deconstrucción para evitar depender de nombres del ValueTuple
                            var tuple = person.MonthlyEffort.ContainsKey(m)
                            ? person.MonthlyEffort[m]
                            : (0m, 0m);

                            var assigned = tuple.Item1; // era Registered
                            var maximum = tuple.Item2; // Max, si el nombre se conserva

                            string cssClass;
                            if (assigned == maximum)
                                cssClass = "effort-match";
                            else if (assigned > maximum)
                                cssClass = "effort-over";
                            else
                                cssClass = "effort-under";

                            <td class="@cssClass">
                                @assigned.ToString("0.##", CultureInfo.InvariantCulture) | @maximum.ToString("0.##", CultureInfo.InvariantCulture)
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // --- Buscador por apellido/nombre ---
        document.getElementById('searchByPerson').addEventListener('input', function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('.global-effort-table tbody tr').forEach(row => {
                const surname = row.getAttribute('data-surname') || '';
                const fullname = row.getAttribute('data-name') || '';
                const visible = surname.includes(search) || fullname.includes(search);
                row.style.display = visible ? '' : 'none';
            });
        });

        // --- Exportación CSV ---
        function downloadCSV() {
            let csvBody = "";
            const headerRow = [];
            document.querySelectorAll(".global-effort-table thead th")
                .forEach((th) => headerRow.push(th.innerText.trim()));
            csvBody += headerRow.join(";") + "\r\n";

            document.querySelectorAll(".global-effort-table tbody tr")
                .forEach(row => {
                    if (row.style.display === 'none') return; // respetar filtro
                    const cols = row.querySelectorAll("td");
                    const rowData = [];
                    cols.forEach((td, idx) => {
                        let value = td.innerText.trim();
                        if (idx > 0 && value.includes("|")) {
                            const parts = value.split("|").map(p => p.trim());
                            value = parts.map(v => v.replace(/\./g, ",")).join(" | ");
                        }
                        value = value.replace(/(\r\n|\n|\r)/gm, "");
                        rowData.push(value);
                    });
                    csvBody += rowData.join(";") + "\r\n";
                });

            const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csvBody);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Global_Effort_Summary.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    <style>
        .scrollable-table-container {
            overflow: auto;
            max-height: 1000px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: #fff;
        }

        .global-effort-table th,
        .global-effort-table td {
            box-sizing: border-box;
            border-right: 1px solid #dee2e6;
            min-width: 100px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            font-size: 0.95rem;
        }

        /* Cabecera fija */
        .global-effort-table thead th {
            position: sticky;
            top: 0;
            background-color: #003366;
            color: white;
            z-index: 20;
            text-align: center;
            height: 55px;
            font-weight: 600;
            font-size: 1rem;
        }

        /* Primera columna fija (Persona) */
        .global-effort-table td.sticky-person,
        .global-effort-table th:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 25;
            width: 320px; /* ← aumentado para nombres largos */
            min-width: 320px;
            max-width: 320px;
            text-align: left;
            padding-left: 14px;
            white-space: normal; /* permite salto de línea */
            word-wrap: break-word;
        }

        /* Cabecera de la primera columna igual que las demás */
        .global-effort-table thead th:first-child {
            background-color: #003366;
            color: white;
            text-align: left;
            padding-left: 14px;
            z-index: 30;
        }

        /* Alternancia de filas */
        .global-effort-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        /* Colores condicionales */
        .global-effort-table td.effort-match {
            background-color: #d4edda !important; /* verde claro */
            color: #155724 !important;
            font-weight: 600;
        }

        .global-effort-table td.effort-over {
            background-color: #fff3cd !important; /* amarillo claro */
            color: #856404 !important;
            font-weight: 600;
        }

        .global-effort-table td.effort-under {
            background-color: #d1ecf1 !important; /* azul claro */
            color: #0c5460 !important;
            font-weight: 600;
        }
    </style>

}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Leader\GlobalEffortSummary2.cshtml -----
@model TRS2._0.Models.ViewModels.LeaderGlobalEffortViewModel

@{
    ViewData["Title"] = "Global Effort Summary";
}

<div class="container-fluid px-4">
    <h2 class="text-center mb-4">Global Effort Summary - @Model.Year</h2>
</div>

<div class="d-flex justify-content-between align-items-center mb-3 px-4">
    <form method="get" asp-action="GlobalEffortSummary" class="d-inline-flex">
        <select name="year" onchange="this.form.submit()" class="form-select me-2">
            @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
            {
                <option value="@y" selected="@(y == Model.Year)">@y</option>
            }
        </select>
    </form>
    <a class="btn btn-outline-primary" href="@Url.Action("ExportGlobalEffortToCsv", "Leader", new { year = Model.Year })">
        <i class="bi bi-download"></i> Export to CSV
    </a>
    <div class="d-flex align-items-center w-75 gap-2">
        <button id="toggleAllBtn" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-arrows-collapse"></i> Expandir/Contraer todo
        </button>

        <input type="text" id="personSearch" class="form-control w-75" placeholder="Buscar persona por nombre o apellidos..." />
    </div>
</div>

<div class="container-fluid px-4">
    @foreach (var person in Model.People)
    {
        var collapseId = $"collapse_{person.PersonId}";
        <div class="card mb-2 person-card" data-person-name="@person.FullName.ToLower()">
            <div class="card-header custom-blue text-white" style="cursor:pointer" onclick="toggleCollapse('@collapseId')">
                @person.FullName
            </div>
            <div id="@collapseId" class="collapse">
                <div class="card-body table-responsive">
                    <table class="table table-bordered table-sm text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>Mes</th>
                                <th>Effort</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int m = 1; m <= 12; m++)
                            {
                                var data = person.MonthlyEffort[m];
                                string background = "";
                                string color = "";

                                if (data.Assigned > data.Max)
                                {
                                    background = "#fffacd"; // amarillo claro
                                    color = "#b8860b"; // amarillo oscuro
                                }
                                else if (data.Assigned == data.Max)
                                {
                                    background = "#e6ffe6"; // verde claro
                                    color = "darkgreen"; // verde oscuro
                                }
                                else
                                {
                                    background = "#e6f3ff"; // azul muy claro
                                    color = "#00008b"; // azul oscuro
                                }

                                <tr>
                                    <td>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</td>
                                    <td style="background-color:@background; color:@color; font-weight:bold">
                                        @data.Assigned.ToString("0.##") | @data.Max.ToString("0.##")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const bsCollapse = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
            bsCollapse.toggle();
        }

        document.getElementById('personSearch').addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const cards = document.querySelectorAll('.person-card');
            cards.forEach(card => {
                const name = card.getAttribute('data-person-name');
                card.style.display = name.includes(searchValue) ? '' : 'none';
            });
        });
            document.getElementById('toggleAllBtn').addEventListener('click', function () {
            const collapses = document.querySelectorAll('.collapse');
            const allExpanded = [...collapses].every(c => c.classList.contains('show'));

            collapses.forEach(el => {
                const instance = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
                if (allExpanded) {
                    instance.hide();
                } else {
                    instance.show();
                }
            });
        });
    </script>

    <style>
        .custom-blue {
            background-color: #004085;
            color: white;
        }
    </style>
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Leader\TimesheetOverview.cshtml -----
@model TRS2._0.Models.ViewModels.LeaderTimesheetOverviewViewModel
@{
    ViewData["Title"] = "Timesheet Overview";
}
<div class="container-fluid px-4">
    <h2 class="text-center mb-4">Timesheet Overview - @Model.Year</h2>
</div>

<div class="d-flex justify-content-between align-items-center mb-3 px-4">
    <form method="get" asp-action="TimesheetOverview" class="d-inline-flex">
        <select name="year" onchange="this.form.submit()" class="form-select me-2">
            @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
            {
                <option value="@y" selected="@(y == Model.Year)">@y</option>
            }
        </select>
    </form>
    <a class="btn btn-outline-primary mb-2" href="@Url.Action("ExportTimesheetOverviewToCsv", "Leader", new { year = Model.Year })">
        <i class="bi bi-download"></i> Export to CSV
    </a>
    
    <div class="d-flex align-items-center w-75 gap-2">
        <button id="toggleAllBtn" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-arrows-collapse"></i> Expandir/Contraer todo
        </button>

        <input type="text" id="personSearch" class="form-control w-75" placeholder="Buscar persona por nombre o apellidos..." />
    </div>

</div>

<div class="container-fluid px-4">
    @foreach (var person in Model.People)
    {
        var collapseId = $"collapse_{person.PersonId}";
        <div class="card mb-2 person-card" data-person-name="@person.FullName.ToLower()">
            <div class="card-header custom-blue text-white" style="cursor:pointer" onclick="toggleCollapse('@collapseId')">
                @person.FullName
            </div>
            <div id="@collapseId" class="collapse">
                <div class="card-body table-responsive">
                    <table class="table table-bordered table-sm text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>Mes</th>
                                <th>Horas</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int m = 1; m <= 12; m++)
                            {
                                var data = person.MonthlyHours[m];
                                var background = data.Registered == data.Max ? "style='background-color:#e6ffe6; color:darkgreen; font-weight:bold'" : "";
                                <tr>
                                    <td>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</td>
                                    <td @Html.Raw(background)>
                                        <a href="@Url.Action("GetTimeSheetsForPerson", "Timesheet", new { personId = person.PersonId, year = Model.Year, month = m })" style="text-decoration:none; color:inherit;">
                                            @data.Registered.ToString("0.##") | @data.Max.ToString("0.##")
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const bsCollapse = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
            bsCollapse.toggle();
        }

        document.getElementById('personSearch').addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const cards = document.querySelectorAll('.person-card');
            cards.forEach(card => {
                const name = card.getAttribute('data-person-name');
                card.style.display = name.includes(searchValue) ? '' : 'none';
            });
        });
            document.getElementById('toggleAllBtn').addEventListener('click', function () {
            const collapses = document.querySelectorAll('.collapse');
            const allExpanded = [...collapses].every(c => c.classList.contains('show'));

            collapses.forEach(el => {
                const instance = bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
                if (allExpanded) {
                    instance.hide();
                } else {
                    instance.show();
                }
            });
        });
    </script>
    <style>
        .custom-blue {
            background-color: #004085;
            color: white;
        }
    </style>
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Calendar.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Personnel>


@{
    ViewData["Title"] = "Calendar";
    var selectedPersonId = ViewBag.SelectedPersonId;    
}

<h2>Calendar</h2>

<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h2>Person Selection</h2>

            <!-- Dropdown para seleccionar personal -->
            <select id="personnelSelect" class="form-control">
                <option value="">Please select a person from the list below:</option>
                @foreach (var person in Model)
                {
                    <option value="@person.Id">@person.Name @person.Surname</option>
                }
            </select>

            <!-- Barra de búsqueda -->
            <p>Or start typing here the name of the person:</p>
            <input type="text" id="searchTerm" class="form-control" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <!-- Resultados de búsqueda -->
            <div id="searchResults"></div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h2>Person Details</h2>
            <div id="personDetails" class="card">
                <!-- Aquí se cargarán los detalles del personal -->
            </div>
        </div>
    </div>
</div>
<hr />




<div id="calendar"></div>

<div class="modal fade" id="event-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="event-index">
                <form class="form-horizontal">
                    <div class="form-group row">
                        <label for="event-name" class="col-sm-4 control-label">Name</label>
                        <div class="col-sm-8">
                            <input id="event-name" name="event-name" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="event-location" class="col-sm-4 control-label">Location</label>
                        <div class="col-sm-8">
                            <input id="event-location" name="event-location" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="min-date" class="col-sm-4 control-label">Dates</label>
                        <div class="col-sm-8">
                            <div class="input-group input-daterange" data-provide="datepicker">
                                <input id="min-date" name="event-start-date" type="text" class="form-control">
                                <div class="input-group-prepend input-group-append">
                                    <div class="input-group-text">to</div>
                                </div>
                                <input name="event-end-date" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>
<div id="context-menu">
</div>

<div id="calendar"></div>



<div class="calendar-legend">
    <div class="legend-item"><span class="color-box" style="background-color: darkorange;"></span> Leave</div>
    <div class="legend-item"><span class="color-box" style="background-color: lightblue;"></span> Personal Holiday</div>
    <div class="legend-item"><span class="color-box" style="background-color: red;"></span> No Contract Period</div>
    <div class="legend-item"><span class="color-box" style="background-color: pink;"></span> Travel</div>
    <div class="legend-item"><span class="color-box" style="background-color: lightcoral;"></span> Partial Leave</div>
    <div class="legend-item"><span class="color-box" style="background-color: green;"></span> National Holiday</div>
</div>



@section Scripts {
        
    <!-- Aquí puedes incluir scripts para manejar el calendario -->
        <script>

        var calendar;

        document.addEventListener('DOMContentLoaded', function () {
          var calendarEl = document.getElementById('calendar');
          calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'es',          // ← NEW
            firstDay: 1,           // ← NEW (lunes)
            multiMonthMinWidth: 200,
            initialView: 'multiMonthYear',
            height: 'auto'
          });
          calendar.render();
        });


                function loadCalendarEvents(personId) {
            if (typeof calendar !== 'undefined') {
                $.ajax({
                    url: '/Personnels/GetLeaveEvents',
                    type: 'GET',
                    data: { personId: personId },
                    success: function (events) {
                        console.log("Total de eventos recibidos:", events.length);

                        // Elimina todos los eventos previos
                        calendar.getEvents().forEach(function (event) {
                            event.remove();
                        });

                        // 🧠 Versión optimizada: añadir eventos de golpe
                        calendar.addEventSource(events);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error al cargar eventos:", status, error);
                    }
                });
            }
        }

        document.getElementById('personnelSelect').addEventListener('change', function () {
            var personId = this.value;
            fetchPersonDetails(personId);
            loadCalendarEvents(personId);
        });

        function filterPersonnel() {
            var searchTerm = document.getElementById('searchTerm').value;

            $.ajax({
                url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result';
                        personDiv.textContent = person.name + ' ' + person.surname;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            // Marcar el resultado seleccionado como activo y limpiar los demás
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');

                            fetchPersonDetails(person.id);
                            loadCalendarEvents(person.id);
                        };

                        resultsDiv.appendChild(personDiv);                        
                    });
                }
            });
        }

        function fetchPersonDetails(personId) {
            $.ajax({
                url: '@Url.Action("GetPersonDetails", "Personnels")',
                data: { id: personId },
                success: function (response) {
                    var detailsDiv = document.getElementById('personDetails');
                    var searchTermInput = document.getElementById('searchTerm');
                    detailsDiv.innerHTML = '';
                    if (response.success) {
                        var data = response.data;                        
                        // Asignar el nombre completo de la persona al campo de búsqueda
                        searchTermInput.value = data.fullName || '';
                        detailsDiv.innerHTML = '<div class="card-body">' +
                            '<h5 class="card-title">' + (data.fullName || '') + '</h5>' +
                            '<p> </p>' +
                            '<p><span class="card-detail-label">Affiliation:</span> ' + (data.affiliation || '') + '</p>' +
                            '<p><span class="card-detail-label">Department:</span> ' + (data.departmentName || '') + '</p>' +
                            '<p><span class="card-detail-label">Group:</span> ' + (data.personnelGroupName || '') + '</p>' +
                            '<p><span class="card-detail-label">Group Leader:</span> ' + (data.responsiblePerson || '') + '</p>' +
                            '<p><span class="card-detail-label">Contract Start:</span> ' + (data.startDate || '') + '</p>' +
                            '<p><span class="card-detail-label">Contract End:</span> ' + (data.endDate || '') + '</p>'

                        '</div>';
                    } else {
                        // Manejar el caso en que la persona no se encontró
                        detailsDiv.innerHTML = '<p>Person details not found.</p>';
                    }
                }
            });
            // Ocultar la lista de resultados
            document.getElementById('searchResults').style.display = 'none';
        }


        document.getElementById('searchResults').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                fetchPersonDetails(personId);
            }
        });
        // Mostrar la lista de resultados cuando el campo de búsqueda recibe el foco
        document.getElementById('searchTerm').addEventListener('focus', function () {
            document.getElementById('searchResults').style.display = 'block';
        });

        </script>
}

<style>
    .person-result {
        cursor: pointer;
        padding: 5px;
    }

        .person-result:hover {
            background-color: #eee;
        }

        .person-result.active {
            background-color: #4c87c6;
        }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    #searchResults {
        max-height: 200px; /* Ajusta esto según tus necesidades */
        overflow-y: auto;
        display: none; /* Inicialmente oculto */
    }
    
    
        .calendar-legend .legend-item {
        margin-right: 10px;
        display: inline-block;
    }

    .calendar-legend {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 15px;
    }

    .color-box {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 5px;
    }
    
    h2 {
        text-align: center;
        font-weight: bold;
    }

</style>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Create.cshtml -----
@model TRS2._0.Models.DataModels.Personnel

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Personnel</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Id" class="control-label"></label>
                <input asp-for="Id" class="form-control" />
                <span asp-validation-for="Id" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="BscId" class="control-label"></label>
                <input asp-for="BscId" class="form-control" />
                <span asp-validation-for="BscId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Surname" class="control-label"></label>
                <input asp-for="Surname" class="form-control" />
                <span asp-validation-for="Surname" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Department" class="control-label"></label>
                <select asp-for="Department" class ="form-control" asp-items="ViewBag.Department"></select>
            </div>
            <div class="form-group">
                <label asp-for="Affiliation" class="control-label"></label>
                <input asp-for="Affiliation" class="form-control" />
                <span asp-validation-for="Affiliation" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="StartDate" class="control-label"></label>
                <input asp-for="StartDate" class="form-control" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndDate" class="control-label"></label>
                <input asp-for="EndDate" class="form-control" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Category" class="control-label"></label>
                <input asp-for="Category" class="form-control" />
                <span asp-validation-for="Category" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Resp" class="control-label"></label>
                <input asp-for="Resp" class="form-control" />
                <span asp-validation-for="Resp" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="PersonnelGroup" class="control-label"></label>
                <input asp-for="PersonnelGroup" class="form-control" />
                <span asp-validation-for="PersonnelGroup" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Email" class="control-label"></label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="A3code" class="control-label"></label>
                <input asp-for="A3code" class="form-control" />
                <span asp-validation-for="A3code" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Dedication.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Personnel>


@{
    ViewData["Title"] = "Dedication";
    var selectedPersonId = ViewBag.SelectedPersonId;
}

<h2>Dedication</h2>

<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h2>Person Selection</h2>

            <!-- Dropdown para seleccionar personal -->
            <select id="personnelSelect" class="form-control">
                <option value="">Please select a person from the list below:</option>
                @foreach (var person in Model)
                {
                    <option value="@person.Id">@person.Name @person.Surname</option>
                }
            </select>

            <!-- Barra de búsqueda -->
            <p>Or start typing here the name of the person:</p>
            <input type="text" id="searchTerm" class="form-control" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <!-- Resultados de búsqueda -->
            <div id="searchResults"></div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h2>Person Details</h2>
            <div id="personDetails" class="card">
                <!-- Aquí se cargarán los detalles del personal -->
            </div>
        </div>
    </div>
</div>
<hr />

<div id="dedicationTableContainer">
    <!-- Tabla de dedicación se cargará aquí -->
</div>



@section Scripts{

    <script>
    document.getElementById('personnelSelect').addEventListener('change', function () {
            var personId = this.value;
            fetchPersonDetails(personId);
            loadDedicationData(personId);
        });
    
    function filterPersonnel() {
                var searchTerm = document.getElementById('searchTerm').value;

                $.ajax({
                    url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result';
                        personDiv.textContent = person.name + ' ' + person.surname;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            // Marcar el resultado seleccionado como activo y limpiar los demás
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');

                            fetchPersonDetails(person.id);
                            loadDedicationData(person.id);
                        };

                        resultsDiv.appendChild(personDiv);
                    });
                }
            });
    }
        function fetchPersonDetails(personId) {
                $.ajax({
                    url: '@Url.Action("GetPersonDetails", "Personnels")',
                    data: { id: personId },
                    success: function (response) {
                        var detailsDiv = document.getElementById('personDetails');
                        var searchTermInput = document.getElementById('searchTerm');
                        detailsDiv.innerHTML = '';
                        if (response.success) {
                            var data = response.data;
                            // Asignar el nombre completo de la persona al campo de búsqueda
                            searchTermInput.value = data.fullName || '';
                            detailsDiv.innerHTML = '<div class="card-body">' +
                                '<h5 class="card-title">' + (data.fullName || '') + '</h5>' +
                                '<p> </p>' +
                                '<p><span class="card-detail-label">Affiliation:</span> ' + (data.affiliation || '') + '</p>' +
                                '<p><span class="card-detail-label">Department:</span> ' + (data.departmentName || '') + '</p>' +
                                '<p><span class="card-detail-label">Group:</span> ' + (data.personnelGroupName || '') + '</p>' +
                                '<p><span class="card-detail-label">Group Leader:</span> ' + (data.responsiblePerson || '') + '</p>' +
                                '<p><span class="card-detail-label">Contract Start:</span> ' + (data.startDate || '') + '</p>' +
                                '<p><span class="card-detail-label">Contract End:</span> ' + (data.endDate || '') + '</p>'
                                '</div>';
                        } else {
                            // Manejar el caso en que la persona no se encontró
                            detailsDiv.innerHTML = '<p>Person details not found.</p>';
                    }
                }
            });
            // Ocultar la lista de resultados
            document.getElementById('searchResults').style.display = 'none';
        }

        document.getElementById('searchResults').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                fetchPersonDetails(personId);
            }
        });
        // Mostrar la lista de resultados cuando el campo de búsqueda recibe el foco
        document.getElementById('searchTerm').addEventListener('focus', function () {
            document.getElementById('searchResults').style.display = 'block';
        });

        function loadDedicationData(personId) {
            $.ajax({
                url: '@Url.Action("GetDedicationData", "Personnels")',
                data: { personId: personId },
                success: function (data) {                    
                    var tableHtml = '<table class="table table-bordered">';
                    tableHtml += '<thead class="thead-light"><tr>';
                    tableHtml += '<th style="font-weight: bold; text-align: center;">#</th>';
                    tableHtml += '<th style="font-weight: bold; text-align: center;">Start Date</th>';
                    tableHtml += '<th style="font-weight: bold; text-align: center;">End Date</th>';
                    tableHtml += '<th style="font-weight: bold; text-align: center;">Dedication</th>';
                    tableHtml += '<th style="font-weight: bold; text-align: center;">Actions</th>';
                    tableHtml += '</tr></thead>';
                    tableHtml += '<tbody>';

                    data.forEach(function (item, index) {
                        tableHtml += '<tr id="row-' + item.id + '">'; // Añade un ID único a cada fila
                        tableHtml += `<td style="text-align: center;">${index + 1}</td>`;
                        tableHtml += `<td style="text-align: center;"><input type='date' value='${item.startDate}' class='form-control' style='width: 100%;'/></td>`;
                        tableHtml += `<td style="text-align: center;"><input type='date' value='${item.endDate}' class='form-control' style='width: 100%;'/></td>`;
                        tableHtml += `<td style="text-align: center;"><input type='text' value='${Math.round(item.dedicationValue)}' class='form-control' style='width: 100%;'/></td>`;
                        tableHtml += `<td style="text-align: center;"><button class="btn btn-primary btn-sm" onclick="updateDedication(${item.id},${item.pId})">Update</button>`;
                        tableHtml += `<span class="mx-2">|</span>`;
                        tableHtml += `<button class="btn btn-danger btn-sm" onclick="removeDedication(${item.id},${item.pId})">Remove</button></td>`;
                        tableHtml += '</tr>';
                    });
                    // Agregar la fila en blanco al final
                    var nextIndex = data.length + 1; // El índice de la nueva fila
                    tableHtml += '<tr id="new-row">';
                    tableHtml += `<td style="text-align: center;">${nextIndex}</td>`;
                    tableHtml += `<td><input type='date' class='form-control' style='width: 100%;'/></td>`;
                    tableHtml += `<td><input type='date' class='form-control' style='width: 100%;'/></td>`;
                    tableHtml += `<td><input type='text' class='form-control' style='width: 100%;'/></td>`;
                    tableHtml += `<td style="text-align: center;"><button class="btn btn-success btn-sm" onclick="addDedication(${personId})">Add</button></td>`;
                    tableHtml += '</tr>';
                    tableHtml += '</tbody></table>';
                    $('#dedicationTableContainer').html(tableHtml);
                },
                error: function (error) {
                    console.error("Error loading dedication data", error);
                }
            });
        }
                
        function updateDedication(id, pId) {
            // Recuperar los datos de los inputs en la fila correspondiente
            var row = $('#row-' + id); // Selecciona la fila por ID
            var startDate = row.find("input[type='date']").eq(0).val();
            var endDate = row.find("input[type='date']").eq(1).val();
            var dedication = row.find("input[type='text']").val();

            // Llamar a la acción del controlador para actualizar
            $.ajax({
                url: '@Url.Action("UpdateDedication", "Personnels")',
                type: 'POST',
                data: {
                    id: id,
                    startDate: startDate,
                    endDate: endDate,
                    dedication: parseFloat(dedication)
                },
                success: function (response) {
                    alert(response.message);
                    loadDedicationData(pId);
                    
                },
                error: function (error) {
                    // Manejar error
                }
            });
        }

        function removeDedication(id,piD) {
            // Llamar a la acción del controlador para eliminar
            $.ajax({
                url: '@Url.Action("RemoveDedication", "Personnels")',
                type: 'POST',
                data: { id: id },
                success: function (response) {
                    alert(response.message);
                    loadDedicationData(piD);
                    // Recargar la tabla o mostrar mensaje de éxito
                },
                error: function (error) {
                    // Manejar error
                }
            });
        }


        function addDedication(personId) {
            var row = $('#new-row');
            var startDate = row.find("input[type='date']").eq(0).val();
            var endDate = row.find("input[type='date']").eq(1).val();
            var dedication = row.find("input[type='text']").val();

            // Verificar que las fechas y la dedicación no estén vacías
            if (!startDate || !endDate || !dedication) {
                alert('Please fill in all fields.');
                return;
            }

            // Llamar a la acción del controlador para agregar una nueva dedicación
            $.ajax({
                url: '@Url.Action("AddDedication", "Personnels")',
                type: 'POST',
                data: {
                    personId: personId,
                    startDate: startDate,
                    endDate: endDate,
                    dedication: parseFloat(dedication)
                },
                success: function (response) {
                    alert(response.message);
                    if (response.success) {
                        loadDedicationData(personId); // Recargar la tabla
                    }
                },
                error: function (error) {
                    // Manejar el error
                    console.error("Error adding dedication", error);
                }
            });
        }
</script>
}

<style>
    .person-result {
        cursor: pointer;
        padding: 5px;
    }

        .person-result:hover {
            background-color: #eee;
        }

        .person-result.active {
            background-color: #4c87c6;
        }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    #searchResults {
        max-height: 200px; /* Ajusta esto según tus necesidades */
        overflow-y: auto;
        display: none; /* Inicialmente oculto */
    }

    
   
    /* Estilos para la tabla */
    .table {
        width: 100%;
        border-collapse: collapse; /* Para bordes más definidos */
        margin-bottom: 1rem; /* Espaciado debajo de la tabla */
    }

        .table th, .table td {
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }

        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody + tbody {
            border-top: 2px solid #dee2e6;
        }

        .table-sm th,
        .table-sm td {
            padding: 0.3rem;
        }

    h2 {
        text-align: center;
        font-weight: bold;
    }
</style>


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Delete.cshtml -----
@model TRS2._0.Models.DataModels.Personnel

@{
    ViewData["Title"] = "Delete";
}

<h1>Delete</h1>

<h3>Are you sure you want to delete this?</h3>
<div>
    <h4>Personnel</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.BscId)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.BscId)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Surname)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Surname)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Affiliation)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Affiliation)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.StartDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.StartDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.EndDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.EndDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Category)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Category)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Resp)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Resp)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.PersonnelGroup)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.PersonnelGroup)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Email)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Email)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.A3code)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.A3code)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.DepartmentNavigation)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.DepartmentNavigation.Id)
        </dd>
    </dl>
    
    <form asp-action="Delete">
        <input type="hidden" asp-for="Id" />
        <input type="submit" value="Delete" class="btn btn-danger" /> |
        <a asp-action="Index">Back to List</a>
    </form>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Details.cshtml -----
@model TRS2._0.Models.DataModels.Personnel

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Personnel</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.BscId)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.BscId)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Surname)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Surname)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Affiliation)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Affiliation)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.StartDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.StartDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.EndDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.EndDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Category)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Category)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Resp)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Resp)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.PersonnelGroup)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.PersonnelGroup)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Email)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Email)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.A3code)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.A3code)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.DepartmentNavigation)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.DepartmentNavigation.Id)
        </dd>
    </dl>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Edit.cshtml -----
@model TRS2._0.Models.DataModels.Personnel

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Personnel</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            <div class="form-group">
                <label asp-for="BscId" class="control-label"></label>
                <input asp-for="BscId" class="form-control" />
                <span asp-validation-for="BscId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Surname" class="control-label"></label>
                <input asp-for="Surname" class="form-control" />
                <span asp-validation-for="Surname" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Department" class="control-label"></label>
                <select asp-for="Department" class="form-control" asp-items="ViewBag.Department"></select>
                <span asp-validation-for="Department" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Affiliation" class="control-label"></label>
                <input asp-for="Affiliation" class="form-control" />
                <span asp-validation-for="Affiliation" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="StartDate" class="control-label"></label>
                <input asp-for="StartDate" class="form-control" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndDate" class="control-label"></label>
                <input asp-for="EndDate" class="form-control" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Category" class="control-label"></label>
                <input asp-for="Category" class="form-control" />
                <span asp-validation-for="Category" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Resp" class="control-label"></label>
                <input asp-for="Resp" class="form-control" />
                <span asp-validation-for="Resp" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="PersonnelGroup" class="control-label"></label>
                <input asp-for="PersonnelGroup" class="form-control" />
                <span asp-validation-for="PersonnelGroup" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Email" class="control-label"></label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="A3code" class="control-label"></label>
                <input asp-for="A3code" class="form-control" />
                <span asp-validation-for="A3code" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Index.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Personnel>

@{
    ViewData["Title"] = "Personnel Selection";
}

<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h2>Person Selection</h2>

            <!-- Contenedor para seleccionar personal -->
            <div id="personnelSelectContainer" class="custom-select">
                <div id="personnelSelectHeader" class="person-result" data-person-id="">
                    <span>Please select a person from the list below:</span>
                </div>
                <div id="personnelSelect" class="search-results-container" style="display: none;">
                    @foreach (var person in Model)
                    {
                        <div class="person-result" data-person-id="@person.Id">
                            <span>@person.Name @person.Surname</span> <span class="badge bg-primary">@person.DepartmentNavigation.Name</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Barra de búsqueda -->
            <p>Or start typing here the name of the person:</p>
            <input type="text" id="searchTerm" class="form-control" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <!-- Resultados de búsqueda -->
            <div id="searchResults" class="search-results-container">
            </div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h2>Person Details</h2>
            <div id="personDetails" class="card">
                <!-- Aquí se cargarán los detalles del personal -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('personnelSelectHeader').addEventListener('click', function () {
            var personnelSelect = document.getElementById('personnelSelect');
            if (personnelSelect.style.display === 'none' || personnelSelect.style.display === '') {
                personnelSelect.style.display = 'block';
            } else {
                personnelSelect.style.display = 'none';
            }
        });

        document.getElementById('personnelSelect').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                fetchPersonDetails(personId);
            }
        });

        function filterPersonnel() {
            var searchTerm = document.getElementById('searchTerm').value;

            $.ajax({
                url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result';
                        personDiv.innerHTML = `<span>${person.name} ${person.surname}</span> <span class="badge bg-primary">${person.departmentName || 'N/A'}</span>`;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');
                            fetchPersonDetails(person.id);
                        };

                        resultsDiv.appendChild(personDiv);
                    });
                }
            });
        }

        function fetchPersonDetails(personId) {
            $.ajax({
                url: '@Url.Action("GetPersonDetails", "Personnels")',
                data: { id: personId },
                success: function (response) {
                    var detailsDiv = document.getElementById('personDetails');
                    var searchTermInput = document.getElementById('searchTerm');
                    detailsDiv.innerHTML = '';
                    if (response.success) {
                        var data = response.data;
                        // Asignar el nombre completo de la persona al campo de búsqueda
                        searchTermInput.value = data.fullName || '';
                        detailsDiv.innerHTML = '<div class="card-body">' +
                            '<h5 class="card-title">' + (data.fullName || '') + '</h5>' +
                            '<p> </p>' +
                            '<p><span class="card-detail-label">Affiliation:</span> ' + (data.affiliation || '') + '</p>' +
                            '<p><span class="card-detail-label">Department:</span> ' + (data.departmentName || '') + '</p>' +
                            '<p><span class="card-detail-label">Group:</span> ' + (data.personnelGroupName || '') + '</p>' +
                            '<p><span class="card-detail-label">Group Leader:</span> ' + (data.responsiblePerson || '') + '</p>' +
                            '<p><span class="card-detail-label">Contract Start:</span> ' + (data.startDate || '') + '</p>' +
                            '<p><span class="card-detail-label">Contract End:</span> ' + (data.endDate || '') + '</p>'

                        '</div>';
                    } else {
                        // Manejar el caso en que la persona no se encontró
                        detailsDiv.innerHTML = '<p>Person details not found.</p>';
                    }
                }
            });
            // Ocultar la lista de resultados
            document.getElementById('searchResults').style.display = 'none';
        }

        document.getElementById('searchResults').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                fetchPersonDetails(personId);
            }
        });

        // Mostrar la lista de resultados cuando el campo de búsqueda recibe el foco
        document.getElementById('searchTerm').addEventListener('focus', function () {
            document.getElementById('searchResults').style.display = 'block';
        });

        // Cerrar la lista de resultados cuando se hace clic fuera de ella
        document.addEventListener('click', function (event) {
            var personnelSelect = document.getElementById('personnelSelect');
            var personnelSelectHeader = document.getElementById('personnelSelectHeader');
            if (!personnelSelect.contains(event.target) && event.target !== personnelSelectHeader) {
                personnelSelect.style.display = 'none';
            }
        });
    </script>
}

<style>
    .person-result {
        cursor: pointer;
        padding: 5px;
    }

        .person-result:hover {
            background-color: #eee;
        }

        .person-result.active {
            background-color: #4c87c6;
        }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    #searchResults {
        max-height: 200px; /* Ajusta esto según tus necesidades */
        overflow-y: auto;
        display: none; /* Inicialmente oculto */
    }

    .custom-select {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        padding: 10px;
        border-radius: 8px;
    }

    .search-results-container {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 5px;
        background-color: #fff;
        margin-top: 10px;
    }

    .person-result {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.3s;
    }

        .person-result:hover {
            background-color: #f1f1f1;
        }

        .person-result.active {
            background-color: #4c87c6;
            color: white;
        }

    .badge {
        padding: 5px 10px;
        border-radius: 5px;
        color: white;
    }

    .bg-primary {
        background-color: #007bff;
    }
</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\LoginLog.cshtml -----
@using System.Globalization
@model TRS2._0.Models.ViewModels.LoginLogViewModel

@{
    ViewData["Title"] = "Login Log";
}

<div class="container-fluid mt-3">
    <h2 class="text-center fw-bold">
        Login Log — @Model.Year
        <div class="d-flex justify-content-center align-items-center gap-3 mt-2">
            <a class="btn btn-primary" asp-action="LoginLog" asp-route-year="@(Model.Year - 1)">
                ← @(@Model.Year - 1)
            </a>
            <span class="btn btn-outline-dark disabled">@Model.Year</span>
            <a class="btn btn-primary" asp-action="LoginLog" asp-route-year="@(Model.Year + 1)">
                @(@Model.Year + 1) →
            </a>
            <input type="text" id="searchByPerson" class="form-control bg-white text-dark"
                   placeholder="Search by surname..." style="max-width: 250px;" />
            <button class="btn btn-success" onclick="downloadCSV()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
    </h2>

    <div class="table-responsive scrollable-table-container mt-4">
        <table class="table table-bordered table-hover table-sm global-hours-table">
            <thead class="thead-dark">
                <tr>
                    <th>Person</th>
                    <th>Department</th>
                    <th>Group</th>
                    <th>Email</th>
                    @foreach (var month in Model.Entries.First().MonthlyFirstLogin.Keys)
                    {
                        <th>@month</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.Entries)
                {
                    <tr data-name="@row.PersonName.ToLower()" data-surname="@row.PersonName.Split(',')[0].Trim().ToLower()">
                        <td class="fw-bold">@row.PersonName</td>
                        <td>@row.Department</td>
                        <td title="@row.Group">@row.Group</td>
                        <td>@row.Email</td>
                        @foreach (var val in row.MonthlyFirstLogin.Values)
                        {
                            <td>@val</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Filtro por apellido/nombre
        document.getElementById('searchByPerson').addEventListener('input', function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('.global-hours-table tbody tr').forEach(row => {
                const surname = row.getAttribute('data-surname');
                const fullname = row.getAttribute('data-name');
                const visible = surname.includes(search) || fullname.includes(search);
                row.style.display = visible ? '' : 'none';
            });
        });

        // Export CSV (separador ; y coma decimal cuando aplique)
        function downloadCSV() {
            let csvBody = "";

            const headerRow = ["Person", "Department", "Group", "Email"];
            document.querySelectorAll(".global-hours-table thead th")
                .forEach((th, index) => {
                    if (index >= 4) headerRow.push(th.innerText.trim());
                });
            csvBody += headerRow.join(";") + "\r\n";

            document.querySelectorAll(".global-hours-table tbody tr").forEach(row => {
                const cols = row.querySelectorAll("td");
                const rowData = [];
                cols.forEach((td) => {
                    let value = td.innerText.trim();
                    value = value.replace(/(\r\n|\n|\r)/gm, "");
                    rowData.push(value);
                });
                csvBody += rowData.join(";") + "\r\n";
            });

            const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csvBody);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Login_Log.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
}

<style>
    .global-hours-table th,
    .global-hours-table td {
        box-sizing: border-box;
        border-right: 1px solid #dee2e6;
    }

    .scrollable-table-container {
        overflow: auto;
        max-height: 1000px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    .global-hours-table thead th {
        position: sticky;
        top: 0;
        background-color: #003366;
        color: white;
        z-index: 20;
        text-align: center;
        vertical-align: middle;
        height: 50px;
    }

    .global-hours-table td,
    .global-hours-table th {
        min-width: 100px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }

        /* 1: Person */
        .global-hours-table th:first-child,
        .global-hours-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 15;
            width: 220px;
            min-width: 220px;
            max-width: 220px;
        }

        /* 2: Department */
        .global-hours-table th:nth-child(2),
        .global-hours-table td:nth-child(2) {
            position: sticky;
            left: 220px;
            background-color: #f8f9fa;
            z-index: 15;
            width: 180px;
            min-width: 180px;
            max-width: 180px;
        }

        /* 3: Group */
        .global-hours-table th:nth-child(3),
        .global-hours-table td:nth-child(3) {
            position: sticky;
            left: 400px;
            background-color: #f8f9fa;
            z-index: 15;
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 4: Email */
        .global-hours-table th:nth-child(4),
        .global-hours-table td:nth-child(4) {
            position: sticky;
            left: 700px; /* 220 + 180 + 300 */
            background-color: #f8f9fa;
            z-index: 15;
            width: 280px;
            min-width: 280px;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    .global-hours-table thead th:first-child,
    .global-hours-table thead th:nth-child(2),
    .global-hours-table thead th:nth-child(3),
    .global-hours-table thead th:nth-child(4) {
        background-color: #003366;
        color: white;
        z-index: 25;
    }

    .global-hours-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }
</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\PendingTravels.cshtml -----
@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Pending Travels";
}

<h2 class="text-center my-4">Pending Travels</h2>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <table class="table table-hover table-bordered shadow">
                <thead class="thead-dark">
                    <tr>
                        <th>Code</th>
                        <th>Person</th>
                        <th style="width: 120px;">Start Date</th>
                        <th style="width: 120px;">End Date</th>
                        <th>Project 1</th>
                        <th>Dedication 1</th>
                        <th>Project 2</th>
                        <th>Dedication 2</th>
                        <th>Destiny</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Code</td>
                            <td>@item.PersonName</td>
                            <td>@item.StartDate</td>
                            <td>@item.EndDate</td>
                            <td>@item.Project1</td>
                            <td>@item.Dedication1</td>
                            <td>@item.Project2</td>
                            <td>@item.Dedication2</td>
                            <td>@item.Destiny</td>
                            <td class="font-weight-bold" style="color: @(item.Status == "Pending" ? "orange" : item.Status == "Approved" ? "green" : "red")">
                                @item.Status
                            </td>
                            <td>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-success btn-sm mx-1" onclick="approveTravel('@item.Code')">Approve</button>
                                    <button class="btn btn-danger btn-sm mx-1" onclick="cancelTravel('@item.Code')">Cancel</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function approveTravel(travelId) {
            if (confirm('Are you sure you want to approve this travel?')) {
                $.post('@Url.Action("ApproveTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    location.reload();
                });
            }
        }

        function cancelTravel(travelId) {
            if (confirm('Are you sure you want to cancel this travel?')) {
                $.post('@Url.Action("CancelTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    location.reload();
                });
            }
        }
    </script>
}




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Personnels\Travels.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Personnel>

@{
    ViewData["Title"] = "Travels";
    var selectedPersonId = ViewBag.SelectedPersonId;
}

<h2 class="text-center my-4">Travel Management</h2>

<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h3 class="text-primary">Select a Person</h3>
            <select id="personnelSelect" class="form-control mb-3">
                <option value="">Select a person from the list</option>
                @foreach (var person in Model)
                {
                    <option value="@person.Id">@person.Name @person.Surname</option>
                }
            </select>

            <p class="text-secondary">Or search for a name:</p>
            <input type="text" id="searchTerm" class="form-control mb-2" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <div id="searchResults" class="border rounded p-2 bg-light"></div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h3 class="text-primary">Person Details</h3>
            <div id="personDetails" class="card bg-light shadow-sm p-3">
                <!-- Aquí se cargarán los detalles del personal -->
                <p class="text-muted text-center">Select a person to view details</p>
            </div>
        </div>
    </div>
</div>

<hr />

<div id="travelsTableContainer" class="mt-4">
    <!-- Tabla de viajes se cargará aquí -->
</div>

@section Scripts {
    <script>
        document.getElementById('personnelSelect').addEventListener('change', function () {
            var personId = this.value;
            fetchPersonDetails(personId);
            loadTravelData(personId);
        });

        function filterPersonnel() {
            var searchTerm = document.getElementById('searchTerm').value;

            $.ajax({
                url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    if (!data || data.length === 0) {
                        resultsDiv.innerHTML = '<p>No matches found.</p>';
                        return;
                    }

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result shadow-sm p-2 mb-2 bg-white rounded';
                        personDiv.textContent = `${person.name} ${person.surname}`;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');

                            fetchPersonDetails(person.id);
                            loadTravelData(person.id);
                        };

                        resultsDiv.appendChild(personDiv);
                    });

                    resultsDiv.style.display = 'block'; // Mostrar resultados
                },
                error: function (error) {
                    console.error("Error in filterPersonnel:", error);
                }
            });
        }

        function fetchPersonDetails(personId) {
            $.ajax({
                url: '@Url.Action("GetPersonDetails", "Personnels")',
                data: { id: personId },
                success: function (response) {
                    var detailsDiv = document.getElementById('personDetails');
                    detailsDiv.innerHTML = '';
                    if (response.success) {
                        var data = response.data;
                        detailsDiv.innerHTML = '<div class="card-body">' +
                            `<h5 class="card-title">${data.fullName || ''}</h5>` +
                            `<p><span class="card-detail-label">Affiliation:</span> ${data.affiliation || ''}</p>` +
                            `<p><span class="card-detail-label">Department:</span> ${data.departmentName || ''}</p>` +
                            `<p><span class="card-detail-label">Group:</span> ${data.personnelGroupName || ''}</p>` +
                            `<p><span class="card-detail-label">Group Leader:</span> ${data.responsiblePerson || ''}</p>` +
                            `<p><span class="card-detail-label">Contract Start:</span> ${data.startDate || ''}</p>` +
                            `<p><span class="card-detail-label">Contract End:</span> ${data.endDate || ''}</p>` +
                            '</div>';
                    } else {
                        detailsDiv.innerHTML = '<p class="text-danger text-center">Person details not found.</p>';
                    }
                },
                error: function (error) {
                    console.error("Error in fetchPersonDetails:", error);
                }
            });
            document.getElementById('searchResults').style.display = 'none';
        }

        function loadTravelData(personId) {
            $.ajax({
                url: '@Url.Action("GetTravelData", "Personnels")',
                data: { personId: personId },
                success: function (response) {
                    if (!response.success) {
                        alert(response.message);
                        return;
                    }

                    var data = response.data;
                    var tableHtml = '<table class="table table-hover table-bordered shadow">';
                    tableHtml += '<thead class="thead-dark"><tr>';
                    tableHtml += '<th>#</th>';
                    tableHtml += '<th>Code</th>';
                    tableHtml += '<th>Start Date</th>';
                    tableHtml += '<th>End Date</th>';
                    tableHtml += '<th>Project 1</th>';
                    tableHtml += '<th>Dedication 1</th>';
                    tableHtml += '<th>Project 2</th>';
                    tableHtml += '<th>Dedication 2</th>';
                    tableHtml += '<th>Status</th>';
                    tableHtml += '<th>Actions</th>';
                    tableHtml += '</tr></thead>';
                    tableHtml += '<tbody>';

                    data.forEach(function (item, index) {
                        tableHtml += '<tr>';
                        tableHtml += `<td>${index + 1}</td>`;
                        tableHtml += `<td>${item.code}</td>`;
                        tableHtml += `<td>${item.startDate.split('T')[0]}</td>`;
                        tableHtml += `<td>${item.endDate.split('T')[0]}</td>`;
                        tableHtml += `<td>${item.project1 || ''}</td>`;
                        tableHtml += `<td>${item.dedication1 || ''}</td>`;
                        tableHtml += `<td>${item.project2 || ''}</td>`;
                        tableHtml += `<td>${item.dedication2 || ''}</td>`;
                        tableHtml += `<td class="${item.status === "Approved" ? 'text-success' : 'text-danger'}">${item.status}</td>`;

                        if (item.status === "Pending") {
                            tableHtml += `<td><button class="btn btn-success btn-sm mx-1" onclick="approveTravel('${item.code}')">Approve</button>`;
                            tableHtml += `<button class="btn btn-danger btn-sm mx-1" onclick="cancelTravel('${item.code}')">Cancel</button></td>`;
                        } else if (item.status === "Approved") {
                            tableHtml += `<td><button class="btn btn-danger btn-sm mx-1" onclick="cancelTravel('${item.code}')">Cancel</button></td>`;
                        } else {
                            tableHtml += '<td></td>';
                        }

                        tableHtml += '</tr>';
                    });

                    tableHtml += '</tbody></table>';
                    $('#travelsTableContainer').html(tableHtml);
                },
                error: function (error) {
                    console.error("Error loading travel data", error);
                }
            });
        }

        function approveTravel(travelId) {
            if (confirm('Are you sure you want to approve this travel?')) {
                $.post('@Url.Action("ApproveTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    var personId = $('#personnelSelect').val();
                    loadTravelData(personId);
                });
            }
        }

        function cancelTravel(travelId) {
            if (confirm('Are you sure you want to cancel this travel?')) {
                $.post('@Url.Action("CancelTravel", "Personnels")', { id: travelId }, function (response) {
                    alert(response.message);
                    var personId = $('#personnelSelect').val();
                    loadTravelData(personId);
                });
            }
        }
    </script>
}


<style>
    /* General styles */
    h2, h3 {
        font-weight: bold;
        text-align: center;
    }

    .text-primary {
        color: #007bff;
    }

    .text-secondary {
        color: #6c757d;
    }

    .text-success {
        color: #28a745;
        font-weight: bold;
    }

    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }

    .text-muted {
        color: #6c757d;
    }

    /* Search results container */
    #searchResults {
        max-height: 200px; 
        overflow-y: auto;
        background-color: #f8f9fa; 
        border: 1px solid #ddd; 
        border-radius: 5px; 
        padding: 10px;
        display: none;
    }

    .person-result {
        cursor: pointer;
        padding: 5px 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
    }

    .person-result:hover {
        background-color: #007bff;
        color: white;
    }

    .person-result.active {
        background-color: #0056b3;
        color: white;
    }

    /* Card styles */
    .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: none;
        background: linear-gradient(145deg, #ffffff, #e6e6e6);
        border-radius: 8px;
    }

    .card-body {
        padding: 20px;
    }

    .card-title {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .card-detail-label {
        font-weight: bold;
    }

    /* Table styles */
    .table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    .table th {
        background-color: #343a40;
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 14px;
    }

    .table td {
        text-align: center;
        padding: 8px;
        vertical-align: middle;
        font-size: 13px;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    .table-bordered {
        border: 1px solid #ddd;
    }

    .table-bordered td, .table-bordered th {
        border: 1px solid #ddd;
    }

    /* Button styles */
    .btn {
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.3s ease-in-out;
    }

    .btn-success {
        background-color: #28a745;
        border: none;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        border: none;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
        color: white;
    }

    .btn-sm {
        font-size: 11px;
    }

    /* Enhanced hover effect for buttons */
    .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Container spacing */
    .container {
        padding: 20px;
    }

    /* Highlighted table row */
    .table tbody tr td {
        transition: background-color 0.3s ease-in-out;
    }

    .table tbody tr:hover td {
        background-color: #f8f9fa;
    }

    
    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .card-title {
            font-size: 1.2rem;
        }

        .btn {
            font-size: 10px;
            padding: 4px 8px;
        }

        .table th, .table td {
            font-size: 12px;
        }
    }
</style>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\ProjectManager\Index.cshtml -----
@model TRS2._0.Models.ViewModels.ProjectManager.ProjectManagerViewModel

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Cargar Archivos de Esfuerzo</h2>
        </div>
        <div class="card-body">
            <form asp-controller="ProjectManager" asp-action="UploadAndProcessFiles" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <input type="file" name="files" multiple class="form-control" required />
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-upload"></i> Subir y Procesar
                </button>
            </form>
        </div>
    </div>

    @if (Model.ProcessedEntries.Count > 0)
    {
        <div class="card shadow mt-4">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0"><i class="bi bi-check-circle"></i> Procesados Correctamente</h3>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Archivo</th>
                            <th>Persona</th>
                            <th>Proyecto</th>
                            <th>Mes</th>
                            <th>Paquete</th>
                            <th>Horas Totales</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var entry in Model.ProcessedEntries)
                        {
                            <tr>
                                <td>@entry.FileName</td>
                                <td>@entry.PersonName</td>
                                <td>@entry.ProjectName</td>
                                <td>@entry.Month</td>
                                <td>@entry.WorkPackageName</td>
                                <td>@entry.TotalHours</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (Model.Errors.Count > 0)
    {
        <div class="card shadow mt-4">
            <div class="card-header bg-danger text-white">
                <h3 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Errores en el Procesamiento</h3>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-hover">
                    <thead class="table-danger">
                        <tr>
                            <th>Archivo</th>
                            <th>Persona</th>
                            <th>Proyecto</th>
                            <th>Mes</th>
                            <th>Paquete</th>
                            <th>Error</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var error in Model.Errors)
                        {
                            <tr>
                                <td>@error.FileName</td>
                                <td>@error.PersonName</td>
                                <td>@error.ProjectName</td>
                                <td>@error.Month</td>
                                <td>@error.WorkPackageName</td>
                                <td>@error.ErrorMessage</td>
                                <td>
                                    <form asp-action="MarkErrorAsResolved" asp-controller="ProjectManager" method="post">
                                        <input type="hidden" name="id" value="@error.Id" />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-check-lg"></i> Corregido
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>







----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\ProjectManager\ReportError.cshtml -----
@model TRS2._0.Models.ViewModels.ReportErrorViewModel

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-warning text-dark">
            <h2 class="mb-0"><i class="bi bi-exclamation-circle"></i> Reportar un Error</h2>
        </div>
        <div class="card-body">

            <!-- ✅ Mensajes de Éxito/Error -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
                </div>
            }

            <form asp-controller="ProjectManager" asp-action="SubmitErrorReport" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label asp-for="Title" class="form-label"></label>
                    <input asp-for="Title" class="form-control" required />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="4" required></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Attachment" class="form-label"></label>
                    <input asp-for="Attachment" type="file" class="form-control" />
                </div>

                <button type="submit" class="btn btn-warning">
                    <i class="bi bi-send"></i> Enviar Reporte
                </button>
            </form>
        </div>
    </div>
</div>





----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\_PersonnelEffortPlanPartial.cshtml -----
@model TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel
@using System.Globalization

<table class="table table-bordered table-striped table-hover">
    <thead class="thead-dark">
        <tr>
            <th>Project</th>
            <th>Person</th>
            <th>WP</th>
            @foreach (var month in Model.GetUniqueMonths())
            {
                <th>@month.ToString("MMM yyyy") (M @Model.GetMonthIndex(month))</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var projectEffort in Model.ProjectsPersonnelEfforts)
        {
            foreach (var wp in projectEffort.WorkPackages)
            {
                foreach (var personnelEffort in wp.PersonnelEfforts)
                {
                    <tr>
                        <td>@projectEffort.ProjectName</td>
                        <td>@personnelEffort.PersonName</td>
                        <td>@wp.WpName</td>
                        @foreach (var month in Model.UniqueMonths)
                        {
                            <td class="@(!wp.ActiveMonths.Contains(month) ? "bg-dark" : "effort-cell")">
                                @if (wp.ActiveMonths.Contains(month))
                                {
                                    decimal effortValue = 0;
                                    personnelEffort.Efforts.TryGetValue(month, out effortValue);
                                    <input type="text" class="form-control input-effort"
                                           value="@effortValue.ToString("0.00", CultureInfo.InvariantCulture)"
                                           data-personid="@personnelEffort.PersonId"
                                           data-wpid="@wp.WpId"
                                           data-effort-id="@personnelEffort.EffortId"
                                           data-month="@month.ToString("yyyy-MM-dd")"
                                           data-original-value="@effortValue.ToString("0.00", CultureInfo.InvariantCulture)" />
                                }
                                else
                                {
                                    <!-- Celda bloqueada sin contenido -->
                                }
                            </td>
                        }
                    </tr>
                }
            }
        }
    </tbody>
</table>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\Create.cshtml -----
@model TRS2._0.Models.DataModels.Project

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Project</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="SapCode" class="control-label"></label>
                <input asp-for="SapCode" class="form-control" />
                <span asp-validation-for="SapCode" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Acronim" class="control-label"></label>
                <input asp-for="Acronim" class="form-control" />
                <span asp-validation-for="Acronim" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Contract" class="control-label"></label>
                <input asp-for="Contract" class="form-control" />
                <span asp-validation-for="Contract" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Start" class="control-label"></label>
                <input asp-for="Start" class="form-control" />
                <span asp-validation-for="Start" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="End" class="control-label"></label>
                <input asp-for="End" class="form-control" />
                <span asp-validation-for="End" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsUpc" class="control-label"></label>
                <input asp-for="TpsUpc" class="form-control" />
                <span asp-validation-for="TpsUpc" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsIcrea" class="control-label"></label>
                <input asp-for="TpsIcrea" class="form-control" />
                <span asp-validation-for="TpsIcrea" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsCsic" class="control-label"></label>
                <input asp-for="TpsCsic" class="form-control" />
                <span asp-validation-for="TpsCsic" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pi" class="control-label"></label>
                <input asp-for="Pi" class="form-control" />
                <span asp-validation-for="Pi" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pm" class="control-label"></label>
                <input asp-for="Pm" class="form-control" />
                <span asp-validation-for="Pm" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Type" class="control-label"></label>
                <input asp-for="Type" class="form-control" />
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="SType" class="control-label"></label>
                <input asp-for="SType" class="form-control" />
                <span asp-validation-for="SType" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="St1" class="control-label"></label>
                <input asp-for="St1" class="form-control" />
                <span asp-validation-for="St1" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="St2" class="control-label"></label>
                <input asp-for="St2" class="form-control" />
                <span asp-validation-for="St2" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndReportDate" class="control-label"></label>
                <input asp-for="EndReportDate" class="form-control" />
                <span asp-validation-for="EndReportDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Visible" class="control-label"></label>
                <input asp-for="Visible" class="form-control" />
                <span asp-validation-for="Visible" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\Delete.cshtml -----
@model TRS2._0.Models.DataModels.Project

@{
    ViewData["Title"] = "Delete";
}

<h1>Delete</h1>

<h3>Are you sure you want to delete this?</h3>
<div>
    <h4>Project</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.SapCode)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.SapCode)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Acronim)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Acronim)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Contract)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Contract)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Start)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Start)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.End)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.End)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.TpsUpc)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.TpsUpc)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.TpsIcrea)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.TpsIcrea)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.TpsCsic)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.TpsCsic)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Pi)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Pi)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Pm)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Pm)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Type)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Type)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.SType)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.SType)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.St1)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.St1)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.St2)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.St2)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.EndReportDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.EndReportDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Visible)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Visible)
        </dd>
    </dl>
    
    <form asp-action="Delete">
        <input type="hidden" asp-for="ProjId" />
        <input type="submit" value="Delete" class="btn btn-danger" /> |
        <a asp-action="Index">Back to List</a>
    </form>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\Details.cshtml -----
@model TRS2._0.Models.DataModels.Project



@{
    ViewData["Title"] = "Details";
    // Inicializa las sumas de las columnas
    decimal totalEstimated = 0;
    decimal totalDistributed = 0;
    decimal totalCovered = 0;
    // Asume valores predeterminados o maneja el caso de null según sea necesario
    var startProject = Model.Start ?? DateTime.Today; // Usar la fecha actual como valor por defecto
    var endProject = Model.End ?? DateTime.Today; // Usar la fecha actual como valor por defecto
     var monthsList = new List<string>();
    if (Model.Start.HasValue && Model.End.HasValue)
    {
        // Ahora que sabemos que startProject y endProject tienen valores, procedemos con el cálculo
        startProject = Model.Start.Value;
        endProject = Model.End.Value;

       

        int monthsCount = ((endProject.Year - startProject.Year) * 12) + endProject.Month - startProject.Month + 1;

        for (int i = 0; i < monthsCount; i++)
        {
            string monthName = startProject.AddMonths(i).ToString("MMMM yyyy", System.Globalization.CultureInfo.InvariantCulture);
            monthsList.Add($"M{i + 1} ({monthName})");
        }

        // Asegúrate de usar monthsList para llenar los selectores como se mostró anteriormente
    }
}

<div class="container mt-3">
    <div class="row">
        <!-- Encapsula los detalles del proyecto en una tarjeta -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                Project Details
                </div>
                    <div class="card-body">
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Acronym</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Acronim)</dd>
                        </div>                        
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Title</dt>
                            <dd class="col-sm-8">@Html.DisplayFor(model => model.Title)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Contract</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Contract)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Start Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.Start.HasValue ? Model.Start.Value.ToString("dd-MM-yyyy") : string.Empty)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">End Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.End.HasValue ? Model.End.Value.ToString("dd-MM-yyyy") : string.Empty)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Investigator</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PiFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Finance Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.FmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Type</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Type)</dd>
                        </div>
                    </dl>
                    
                    <!-- Tarjeta para Third Parties -->
                    <div class="card mt-4">
                        <div style="text-align: center; background-color: black; color: white; font-size: 24px; font-weight: bold;">
                            Third Parties
                        </div>

                        <div class="card-body">
                            <div class="row">
                                <!-- Cada tick en su propia columna dentro de esta fila -->
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="upcCheck" disabled @((Model.TpsUpc == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="upcCheck">UPC</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="icreaCheck" disabled @((Model.TpsIcrea == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="icreaCheck">ICREA</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="csicCheck" disabled @((Model.TpsCsic == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="csicCheck">CSIC</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     </div>
            </div>
    </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Work Packages Details
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="text-align: center; background-color: black; color: white;">Name</th>
                                <th style="text-align: center; background-color: black; color: white;">Estimated</th>
                                <th style="text-align: center; background-color: black; color: white;">Distributed</th>
                                <th style="text-align: center; background-color: black; color: white;">Covered with Personnel</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var wp in ViewBag.WpDetails)
                            {
                                // Calcula las sumas de las columnas
                                totalEstimated += Convert.ToDecimal(wp.Pms);
                                totalDistributed += Convert.ToDecimal(wp.Distributed);
                                totalCovered += Convert.ToDecimal(wp.Covered);

                                // Determina la clase para la fila según las condiciones
                                string rowClass = "";
                                string textStyle = "";
                                if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed == wp.Covered)
                                {
                                    rowClass = "table-success"; // Fondo verde claro
                                    textStyle = "text-success font-weight-bold"; // Texto verde oscuro y en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) != wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else
                                {
                                    rowClass = "table-light"; // Fondo amarillo claro
                                                              // No se aplica una clase de texto específica aquí; se manejará individualmente
                                }

                                <tr class="@rowClass">
                                    <td class="centered">@wp.Name</td>
                                    <td class="centered">@wp.Pms</td>
                                    <td class="centered">@wp.Distributed</td>
                                    <td class="centered">@wp.Covered</td>
                                </tr>
                            }
                            <!-- Fila de Total -->
                            <tr class="table-primary">
                                <th style="text-align: center; background-color: black; color: white;">Total</th>
                                <td class="centered bold">@totalEstimated</td>
                                <td class="centered bold">@totalDistributed</td>
                                <td class="centered bold">@totalCovered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>
<hr />



    <h3 class="text-center my-style">Work Packages Design</h3>

    <table class="table">
        <thead>
            <tr>
                <th class="text-center">Name</th>
                <th class="text-center">Title</th>
                <th class="text-center">Start Date</th>
                <th class="text-center">End Date</th>
                <th class="text-center w-8">Pms</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var wp in Model.Wps
                        .OrderBy(w => w.Name.Equals("Travels", StringComparison.OrdinalIgnoreCase) ? "ZZZZZZ" : w.Name.ToUpper()))
            {
                <tr>
                    <!-- Campos de Texto y Fecha -->
                    <td class="text-center">
                        <span class="editable" id="wpName_@wp.Id">@wp.Name</span>
                        <input type="text" class="edit-field form-control" id="editWpName_@wp.Id" value="@wp.Name" style="display: none;" />
                    </td>
                    <td class="text-center">
                        <span class="editable" id="wpTitle_@wp.Id">@wp.Title</span>
                        <input type="text" class="edit-field form-control" id="editWpTitle_@wp.Id" value="@wp.Title" style="display: none;" />
                    </td>
                    <td class="text-center">
                        <span class="editable" id="wpStartDate_@wp.Id">@wp.StartDate.ToShortDateString()</span>
                        <input type="date" class="edit-field form-control" id="editWpStartDate_@wp.Id" value="@wp.StartDate.ToString("yyyy-MM-dd")" style="display: none;" />
                    </td>
                    <td class="text-center">
                        <span class="editable" id="wpEndDate_@wp.Id">@wp.EndDate.ToShortDateString()</span>
                        <input type="date" class="edit-field form-control" id="editWpEndDate_@wp.Id" value="@wp.EndDate.ToString("yyyy-MM-dd")" style="display: none;" />
                    </td>
                    <td class="text-center">
                        <span class="editable" id="wpPms_@wp.Id">@wp.Pms</span>
                        <input type="number" step="0.01" inputmode="decimal" class="edit-field form-control" id="editWpPms_@wp.Id" value="@wp.Pms" style="display:none;" />

                    </td>
                    <!-- Botones -->
                    <td class="text-center">
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary edit-link custom-edit-btn me-2" onclick="editWp(@wp.Id)">Edit</button>
                            <button type="button" class="btn btn-danger delete-link custom-delete-btn me-2" onclick="deleteWp(@wp.Id)">Delete</button>

                            <button type="button" class="btn btn-success update-link custom-update-btn me-2" style="display: none;" onclick="updateWp(@wp.Id)">Update</button>
                            <button type="button" class="btn btn-secondary cancel-link custom-cancel-btn me-2" style="display: none;" onclick="cancelEdit(@wp.Id)">Cancel</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
        <!-- Entradas para nuevo WP -->
        <tfoot>
            <tr>
                <td><input type="text" class="form-control" id="newWpName" placeholder="Name" /></td>
                <td><input type="text" class="form-control" id="newWpTitle" placeholder="Title" /></td>
                <!-- StartDate Selector -->
                <td>
                    <select class="form-control" id="newWpStartDate">
                        @foreach (var month in monthsList)
                        {
                            <option value="@month">@month</option>
                        }
                    </select>
                </td>
                <!-- EndDate Selector -->
                <td>
                    <select class="form-control" id="newWpEndDate">
                        @foreach (var month in monthsList)
                        {
                            <option value="@month">@month</option>
                        }
                    </select>
                </td>                
                <td><input type="number" class="form-control" id="newWpPms" placeholder="Pms" /></td>
                <td class="text-center"><button onclick="addNewWp()" class="btn btn-primary custom-add-btn">Add</button></td>
            </tr>
        </tfoot>
    </table>

</div>

<script>
// Variables para las fechas de inicio y fin del proyecto
        var projectStartDateString = '@(Model.Start.HasValue ? Model.Start.Value.ToString("yyyy-MM-dd") : "")';
    var projectEndDateString = '@(Model.End.HasValue ? Model.End.Value.ToString("yyyy-MM-dd") : "")';


    var projectStartDate = projectStartDateString ? new Date(projectStartDateString) : null;
    var projectEndDate = projectEndDateString ? new Date(projectEndDateString) : null;

    if (projectStartDate && projectEndDate) {
        // Asegúrate de que este código se ejecuta solo si projectStartDate y projectEndDate son objetos Date válidos.
        console.log(projectStartDate.getMonth()); // Ahora esto debería funcionar sin errores.
    } else {
        console.log("Las fechas de inicio o fin del proyecto no están definidas.");
    }


    function addNewWp() {
        var startMonthIndex = document.getElementById('newWpStartDate').selectedIndex;
        var endMonthIndex = document.getElementById('newWpEndDate').selectedIndex;

        // Calcular las fechas reales basadas en los índices seleccionados
        var calculatedStartDate = new Date(projectStartDate);
        calculatedStartDate.setMonth(projectStartDate.getMonth() + startMonthIndex);

        var calculatedEndDate = new Date(projectStartDate);
        calculatedEndDate.setMonth(projectStartDate.getMonth() + endMonthIndex);

        // Asegurarse de que la fecha de fin no sea anterior a la fecha de inicio
        if (calculatedEndDate < calculatedStartDate) {
            alert("La fecha de fin no puede ser anterior a la fecha de inicio.");
            return;
        }

        // Formatear las fechas para su envío
        var formattedStartDate = calculatedStartDate.toISOString().split('T')[0];
        var formattedEndDate = calculatedEndDate.toISOString().split('T')[0];

        var data = {
            ProjId: @Model.ProjId,
            Name: document.getElementById('newWpName').value,
            Title: document.getElementById('newWpTitle').value,
            StartDate: formattedStartDate,
            EndDate: formattedEndDate,
            Pms: document.getElementById('newWpPms').value
        };

        // Proceder con la solicitud AJAX como antes
        $.ajax({
            type: 'POST',
            url: '@Url.Action("Create", "Wps")',
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    alert("WP añadido con éxito");
                    location.reload();
                } else {
                    alert("Error al añadir WP");
                }
            },
            error: function () {
                alert("Error en la solicitud AJAX");
            }
        });
    }


    function editWp(wpId) {
        // Ocultar los elementos span y mostrar los campos de entrada
        document.getElementById('wpName_' + wpId).style.display = 'none';
        document.getElementById('editWpName_' + wpId).style.display = 'inline';

        document.getElementById('wpTitle_' + wpId).style.display = 'none';
        document.getElementById('editWpTitle_' + wpId).style.display = 'inline';

        document.getElementById('wpStartDate_' + wpId).style.display = 'none';
        document.getElementById('editWpStartDate_' + wpId).style.display = 'inline';

        document.getElementById('wpEndDate_' + wpId).style.display = 'none';
        document.getElementById('editWpEndDate_' + wpId).style.display = 'inline';

        document.getElementById('wpPms_' + wpId).style.display = 'none';
        document.getElementById('editWpPms_' + wpId).style.display = 'inline';

        // Ocultar botón de editar y eliminar, mostrar actualizar y cancelar
        var parentCell = document.getElementById('wpName_' + wpId).parentNode.parentNode;
        parentCell.querySelector('.edit-link').style.display = 'none';
        parentCell.querySelector('.delete-link').style.display = 'none';
        parentCell.querySelector('.update-link').style.display = 'inline';
        parentCell.querySelector('.cancel-link').style.display = 'inline';
    }

        function normalizeDecimal(input) {
      let s = (input || '').toString().trim().replace(/\s+/g, '');

      if (s.includes(',') && s.includes('.')) {
        // El último separador que aparezca lo tratamos como decimal; el otro, miles
        const lastComma = s.lastIndexOf(',');
        const lastDot = s.lastIndexOf('.');
        if (lastComma > lastDot) {
          s = s.replace(/\./g, '').replace(',', '.'); // miles . => fuera, decimal , => .
        } else {
          s = s.replace(/,/g, ''); // miles , => fuera (decimal . ya está)
        }
      } else if (s.includes(',')) {
        s = s.replace(',', '.'); // sólo coma => decimal
      }
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function updateWp(wpId) {
      const pmsRaw = document.getElementById('editWpPms_' + wpId).value;
      const pms = normalizeDecimal(pmsRaw);
      if (pms === null) {
        alert('PMS no válido');
        return;
      }

      var updatedData = {
        Id: wpId,
        Name: document.getElementById('editWpName_' + wpId).value,
        Title: document.getElementById('editWpTitle_' + wpId).value,
        StartDate: document.getElementById('editWpStartDate_' + wpId).value, // yyyy-MM-dd
        EndDate: document.getElementById('editWpEndDate_' + wpId).value,     // yyyy-MM-dd
        Pms: pms // número con punto decimal
      };

      $.ajax({
        type: 'POST',
        url: '@Url.Action("UpdateWp", "Wps")',
        data: updatedData, // form-urlencoded
        success: function (response) {
          if (response.success) location.reload();
          else alert(response.message || 'Error al actualizar el WP');
        },
        error: function () { alert('Error en la solicitud AJAX'); }
      });
    }

function deleteWp(wpId) {
        wpId = parseInt(wpId, 10); // Convierte wpId a un número si no lo es
        console.log("WP ID:", wpId);
        // Enviar solicitud AJAX al servidor
        $.ajax({
            type: 'POST',
            url: '/Wps/DeleteWp/' + wpId,  // Asegúrate de que la URL y el nombre del controlador sean correctos
            success: function (response) {
                if (response.success) {
                    alert('WP eliminado con éxito');
                    // Aquí puedes actualizar la interfaz de usuario según sea necesario
                    location.reload(); // Recarga la página
                    // Por ejemplo, eliminar la fila de la tabla
                } else {
                    alert('Error al eliminar el WP');
                }
            },
            error: function () {
                alert('Error en la solicitud AJAX');
            }
        });
    }

function cancelEdit(wpId) {
        // Ocultar los campos de entrada y mostrar los elementos span
        document.getElementById('wpName_' + wpId).style.display = 'inline';
        document.getElementById('editWpName_' + wpId).style.display = 'none';

        document.getElementById('wpTitle_' + wpId).style.display = 'inline';
        document.getElementById('editWpTitle_' + wpId).style.display = 'none';

        document.getElementById('wpStartDate_' + wpId).style.display = 'inline';
        document.getElementById('editWpStartDate_' + wpId).style.display = 'none';

        document.getElementById('wpEndDate_' + wpId).style.display = 'inline';
        document.getElementById('editWpEndDate_' + wpId).style.display = 'none';

        document.getElementById('wpPms_' + wpId).style.display = 'inline';
        document.getElementById('editWpPms_' + wpId).style.display = 'none';

        // Ocultar botón de actualizar y cancelar, mostrar editar y eliminar
        var parentCell = document.getElementById('wpName_' + wpId).parentNode.parentNode;
        parentCell.querySelector('.edit-link').style.display = 'inline';
        parentCell.querySelector('.delete-link').style.display = 'inline';
        parentCell.querySelector('.update-link').style.display = 'none';
        parentCell.querySelector('.cancel-link').style.display = 'none';
    }
    

    document.body.classList.add("with-fixed-menu");



</script>

<style>
    .fixed-top-menu {
        position: fixed;
        top: 50px;
        left: 0;
        width: 100%;
        z-index: 1040; /* Asegúrate de que el menú esté por encima de otros elementos */
        background-color: #fff; /* O cualquier color de fondo que desees */
        box-shadow: 0 2px 4px rgba(0,0,0,.1); /* Opcional: para añadir una sombra y dar sensación de profundidad */
    }

    .vertical-separator {
        border-left: 1px solid #dee2e6;
        height: 100%;
        display: inline-block;
        margin: 0 5px; /* Ajusta el margen según tus necesidades */
    }

    /* Añade un relleno al cuerpo para evitar que el contenido se esconda detrás del menú fijo */
    body.with-fixed-menu {
        padding-top: 0px; /* Ajusta este valor según la altura de tu menú */
    }

    .details-content {
        padding-top: 80px; /* o lo que sea necesario */
    }

    body {
        padding-top: 0px; /* Ajusta según la altura de tu menú */
    }

    .card-header {
        font-size: 24px; /* Aumenta el tamaño del texto */
        font-weight: bold; /* Texto en negrita */
        text-align: center; /* Texto centrado */
    }

    .form-check-input:checked {
        background-color: #005A9C; /* Un azul oscuro para coincidir con el tema */
        border-color: #005A9C;
    }

    .form-check-label {
        font-weight: bold; /* Hacer el texto más notable */
    }

    .centered {
        text-align: center;
    }

    .bold {
        font-weight: bold;
    }

    .table-header-black {
        text-align: center;
        background-color: black;
        color: white;
    }

    .custom-delete-btn {
        background-color: darkred; 
        border-color: darkred; 
    }

    .custom-cancel-btn {
        background-color:goldenrod; 
        border-color: goldenrod; 
    }

    .custom-add-btn{
        background-color: #007bff;
        border-color: #007bff;
    }

    .custom-update-btn{
        background-color: #28a745; 
        border-color: #28a745;}

    .custom-edit-btn{
        background-color: #007bff; 
        border-color: #007bff;}

    .my-style {
        font-size: 2.5rem; /* Ajusta el tamaño de la fuente */
        font-weight: bold;
        color: #0056b3; /* Cambia al color que prefieras */
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* Añade una ligera sombra */
    }

    
    .detail-item:not(:last-child) {
        border-bottom: 1px solid #dee2e6; /* Color de la línea */
        padding-bottom: 5px; /* Espaciado debajo del texto antes de la línea */
        margin-bottom: 5px; /* Espaciado después de la línea */
    }



</style>







----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\Edit.cshtml -----
@model TRS2._0.Models.DataModels.Project

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Project</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="ProjId" />
            <div class="form-group">
                <label asp-for="SapCode" class="control-label"></label>
                <input asp-for="SapCode" class="form-control" />
                <span asp-validation-for="SapCode" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Acronim" class="control-label"></label>
                <input asp-for="Acronim" class="form-control" />
                <span asp-validation-for="Acronim" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Contract" class="control-label"></label>
                <input asp-for="Contract" class="form-control" />
                <span asp-validation-for="Contract" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Start" class="control-label"></label>
                <input asp-for="Start" class="form-control" />
                <span asp-validation-for="Start" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="End" class="control-label"></label>
                <input asp-for="End" class="form-control" />
                <span asp-validation-for="End" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsUpc" class="control-label"></label>
                <input asp-for="TpsUpc" class="form-control" />
                <span asp-validation-for="TpsUpc" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsIcrea" class="control-label"></label>
                <input asp-for="TpsIcrea" class="form-control" />
                <span asp-validation-for="TpsIcrea" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="TpsCsic" class="control-label"></label>
                <input asp-for="TpsCsic" class="form-control" />
                <span asp-validation-for="TpsCsic" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pi" class="control-label"></label>
                <input asp-for="Pi" class="form-control" />
                <span asp-validation-for="Pi" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pm" class="control-label"></label>
                <input asp-for="Pm" class="form-control" />
                <span asp-validation-for="Pm" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Type" class="control-label"></label>
                <input asp-for="Type" class="form-control" />
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="SType" class="control-label"></label>
                <input asp-for="SType" class="form-control" />
                <span asp-validation-for="SType" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="St1" class="control-label"></label>
                <input asp-for="St1" class="form-control" />
                <span asp-validation-for="St1" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="St2" class="control-label"></label>
                <input asp-for="St2" class="form-control" />
                <span asp-validation-for="St2" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndReportDate" class="control-label"></label>
                <input asp-for="EndReportDate" class="form-control" />
                <span asp-validation-for="EndReportDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Visible" class="control-label"></label>
                <input asp-for="Visible" class="form-control" />
                <span asp-validation-for="Visible" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\EffortPlan.cshtml -----
@model TRS2._0.Models.ViewModels.EffortPlanViewModel

@{
    ViewData["Title"] = "Effort Plan";
}

<div class="container-fluid my-custom-container">
    <h2 class="effort-plan-title">
        Effort Plan
        <hr class="title-divider">
        <div class="action-buttons">
            <button class="btn btn-primary distribute-linearly-all">Lineal All</button>
            <button class="btn btn-success save-all">Save All</button>
            <button class="btn btn-warning clear-all">Clear All</button>
            <button id="exportCsvButton" class="btn btn-secondary btn-sm">Export Effort Plan into CSV</button>
        </div>
        <div id="savingIndicator" style="display: none;">Guardando...</div>
    </h2>

@if (Model.WorkPackages.Any())
{
    <div class="scrollable-table-container">
            <table class="table table-bordered table-striped table-hover main-effort-plan-table">
            <thead class="thead-dark">
                <tr>
                        <th>
                            <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center">Effort Target</div>
                            <div style="text-align: center">Total Effort</div>
                        </th>
                    <th>Actions</th>
                    <th>WP</th>
                        @foreach (var month in Model.GetMonthsInRange())
                        {
                            <th>
                                <div class="month-year-header">          
                                    
                                    <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center">@month.ToString("MMM").Substring(0, 1).ToUpper()@month.ToString("MMM").Substring(1).ToLower()</div>
                                    <div style="text-align: center">@month.ToString("yyyy")</div>
                                </div>
                            </th>
                        }

                </tr>
            </thead>
            <tbody>
                @foreach (var wp in Model.WorkPackages)
                {
                        // Calcular el Effort Target una vez para este WP
                        var effortTargetForThisWp = wp.getPMs(wp.WpId);
                    <tr>
                        <td class="@(wp.TotalEffort != wp.getPMs(wp.WpId) ? "effort-mismatch" : "effort-match")">

                                <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center">@wp.getPMs(wp.WpId)</div>
                                <div style="text-align: center">@wp.TotalEffort</div>
                        </td>
                        <td>
                            <div class="button-container">
                                <button data-wpid="@wp.WpId" class="btn btn-success save-effort">Save</button>
                                <span class="vertical-bar">|</span>
                                <button data-wpid="@wp.WpId" class="btn btn-info distribute-linearly">Lineal</button>
                                    <span class="vertical-bar">|</span>
                                    <button data-wpid="@wp.WpId" class="btn btn-warning clear-line">Clear</button>

                            </div>
                        </td>

                        <td>@wp.WpName</td>
                        @foreach (var month in Model.GetMonthsInRange())
                        {
                            <td class="@(wp.IsValidMonth(month) ? "effort-cell" : "bg-dark")">
                                @if (wp.IsValidMonth(month))
                                {
                                        <input type="text" class="form-control input-effort" value="@wp.MonthlyEfforts.GetValueOrDefault(month, 0)" data-wpid="@wp.WpId" data-month="@month" data-wptarget="@effortTargetForThisWp" />
                                }
                                else
                                {
                                    <!-- Celda bloqueada sin contenido -->
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>            
    </div>
}
else
{
    
<p>No hay paquetes de trabajo para este proyecto.</p>
}
</div>
<style>
    .input-effort {
        width: 100%;
        min-width: 60px;
        text-align: center;
        line-height: 22px; /* Ajusta esto según la altura de tus input */
        height: 40px; /* Asegúrate de que la altura del input sea adecuada */
        padding: 0 12px; /* Elimina el padding vertical */
        box-sizing: border-box;
    }

    .effort-cell {
        min-width: 60px; /* Igual al mínimo ancho del input */
        padding: 0; /* Elimina el relleno para permitir que el input llene la celda */
        text-align: center; /* Centra el texto */
    }

    .person-name-column {
        font-weight: bold;
        width: 250px; /* Ajusta este valor según tus necesidades */
        white-space: nowrap; /* Evita que el texto se envuelva a la siguiente línea */
        overflow: hidden; /* Oculta el texto que exceda el ancho de la celda */
        text-overflow: ellipsis; /* Añade puntos suspensivos si el texto es demasiado largo */
    }

    .scrollable-table-container {
        overflow-y: auto;
        max-height: 800px; /* Aumenta este valor para mostrar más filas */
    }

    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Estilo para la cabecera de la primera y segunda columna */
    .table th:first-child, .table th:nth-child(2) {
        position: sticky;
        left: 0; /* Para la primera columna */
        z-index: 11; /* Asegurarse de que está por encima del resto */
        background-color: var(--blue-dark); /* Color de fondo oscuro */
        text-align: center;
        vertical-align: middle;
    }

    .table th:nth-child(2) {
        left: 150px; /* Ajusta este valor al ancho de tu primera columna */
        z-index: 11;
    }

    /* Estilos para las celdas de cuerpo en la primera y segunda columna */
    .table td:first-child, .table td:nth-child(2) {
        position: sticky;
        left: 0; /* Para la primera columna */
        background-color: white; /* Fondo blanco para las celdas del cuerpo */
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    .table td:nth-child(2) {
        left: 150px; /* Ajusta este valor al ancho de tu primera columna */
        z-index: 10;
    }

    /* Ajustes para el ancho de las columnas fijas */
    .table th:first-child, .table td:first-child {
        min-width: 150px; /* o el ancho que necesites */
        max-width: 150px;
    }

    .table th:nth-child(2), .table td:nth-child(2) {
        min-width: 300px; /* o el ancho que necesites */
        max-width: 300px;
    }

    /* Ajustar bordes para celdas adyacentes */
    .table td:nth-child(3), .table th:nth-child(3) {
        border-left: 2px solid #dee2e6; /* Asegúrate de que el color del borde coincida con el estilo de tu tabla */
    }

    /* Estilo para la cabecera de la tercera columna */
    .table th:nth-child(3) {
        position: sticky;
        left: 450px; /* Ajusta este valor a la suma del ancho de tus dos primeras columnas */
        z-index: 11; /* Asegúrate de que esté por encima del resto */
        background-color: var(--blue-dark); /* Color de fondo oscuro */
        text-align: center;
        vertical-align: middle;
    }

    /* Estilos para las celdas de cuerpo en la tercera columna */
    .table td:nth-child(3) {
        position: sticky;
        left: 450px; /* Ajusta este valor a la suma del ancho de tus dos primeras columnas */
        background-color: white; /* Fondo blanco para las celdas del cuerpo */
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    /* Ajustes para el ancho de las columnas fijas */
    .table th:nth-child(3), .table td:nth-child(3) {
        min-width: 100px; /* o el ancho que necesites */
        max-width: 100px;
    }

    /* Ajustar bordes para celdas adyacentes */
    .table td:nth-child(4), .table th:nth-child(4) {
        border-left: 2px solid #dee2e6; /* Asegúrate de que el color del borde coincida con el estilo de tu tabla */
    }

    h2 {
        text-align: center;
        font-weight: bold;

    }

    .effort-match {
        background-color: #90ee90; /* Verde claro */
        color: darkgreen; /* Verde oscuro para ambos valores */
        font-weight: bold;
        text-align: center;
    }

    .effort-mismatch {
        background-color: #ffcccc; /* Rojo claro */
        color: darkred; /* Rojo oscuro para ambos valores */
        font-weight: bold;
        text-align: center;
    }

    .effort-target {
        color: black; /* Negro para effort target */
    }

    .vertical-bar {
        margin: 2px; /* Ajusta el espaciado horizontal alrededor de la barra */
        color: #333; /* Ajusta el color de la barra */
    }

    .button-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .my-custom-container {
        margin-left: auto;
        margin-right: auto;
        padding-left: 15px;
        padding-right: 15px;
    }

    .distribute-linearly-all, .save-all {
        margin-left: 10px; /* Espacio entre el título y los botones */
    }

    .btn {
        margin: 5px; /* Añade margen alrededor de los botones para mejor separación */
    }

    .table td, .table th {
        height: 50px; /* Ajusta según necesites */
        vertical-align: middle; /* Centra el contenido verticalmente */
    }

    .effort-plan-title {
        text-align: center;
        display: block; /* Asegura que el <h2> se maneje como un bloque */
        position: relative; /* Para posicionar correctamente los elementos internos */
    }

    .title-divider {
        border-top: 2px solid white; /* Línea divisoria blanca */
        width: 30%; /* Ajusta el ancho según necesites */
        margin: 0 auto 10px; /* Centra la línea y añade espacio debajo */
    }

    .action-buttons {
        display: inline-block; /* Coloca los botones en línea */
        margin: 0 auto; /* Centra los botones horizontalmente */
    }

        .action-buttons .btn {
            margin: 0 5px; /* Espacio entre botones */
        }

    .month-year-header {
        text-align: center;
    }
    



</style>

@section Scripts {
    <script>        
        // Script para manejar la lógica de guardar los esfuerzos
        document.querySelectorAll('.save-effort').forEach(button => {
            button.addEventListener('click', function () {
                var wpid = this.getAttribute('data-wpid');
                var inputs = document.querySelectorAll(`.input-effort[data-wpid="${wpid}"]`);
                var efforts = {};

                inputs.forEach(input => {
                    var dateString = input.getAttribute('data-month');
                    var stringValue = input.value.replace(',', '.'); // Reemplazar comas por puntos
                    var value = parseFloat(stringValue);
                    if (!isNaN(value)) {
                        var formattedDate = formatDateTimeString(dateString);                        
                        if (formattedDate) {
                            efforts[formattedDate] = value.toString();
                        }
                    }
                });

                var dataToSend = {
                    wpId: parseInt(wpid, 10),
                    efforts: efforts
                };

                fetch('/Wps/SaveEfforts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                })
                    .then(response => response.json())
                    .then(data => {
                        location.reload();
                    })
                    .catch(error => {
                        // Manejar el error aquí
                    });
            });
        });



        document.querySelectorAll('.distribute-linearly').forEach(button => {
            button.addEventListener('click', function () {
                var wpid = this.getAttribute('data-wpid');
                var inputs = document.querySelectorAll(`.input-effort[data-wpid="${wpid}"]`);
                var effortTarget = parseFloat(inputs[0].getAttribute('data-wptarget'));
                var activeInputs = Array.from(inputs).filter(input => input.parentElement.classList.contains('effort-cell'));
                var activeInputsCount = activeInputs.length;

                if (activeInputsCount === 0) return; // Prevenir división por cero.

                var effortPerMonth = effortTarget / activeInputsCount;
                // La suma inicial de esfuerzos distribuidos se establece en 0.
                var sumDistributedEffort = 0;

                activeInputs.forEach((input, index) => {
                    if (index < activeInputsCount - 1) {
                        input.value = effortPerMonth.toFixed(2);
                        // Acumula el esfuerzo distribuido para los primeros N-1 inputs.
                        sumDistributedEffort += parseFloat(input.value);
                    }
                });

                // El último input ajusta la diferencia para que el total sea exactamente igual al Effort Target.
                var lastInputEffort = effortTarget - sumDistributedEffort;
                activeInputs[activeInputsCount - 1].value = lastInputEffort.toFixed(2);
            });
        });






        document.querySelector('.distribute-linearly-all').addEventListener('click', function () {
            let uniqueWpIds = new Set(); // Crear un conjunto para almacenar wpid únicos

            // Primero, recopilar todos los wpid únicos
            document.querySelectorAll('.input-effort[data-wpid]').forEach(input => {
                uniqueWpIds.add(input.getAttribute('data-wpid'));
            });

            // Luego, iterar sobre cada wpid único para aplicar la distribución lineal
            uniqueWpIds.forEach(wpid => {
                let inputs = document.querySelectorAll(`.input-effort[data-wpid="${wpid}"]`);
                let effortTarget = parseFloat(inputs[0].getAttribute('data-wptarget')); // Asegúrate de convertir a número
                let activeInputs = Array.from(inputs).filter(input => input.parentElement.classList.contains('effort-cell'));
                let activeInputsCount = activeInputs.length;

                if (activeInputsCount === 0) return; // Prevenir división por cero.

                let effortPerMonth = effortTarget / activeInputsCount;
                let sumDistributedEffort = 0;

                // Distribuye el esfuerzo a todos menos el último input, acumulando el total distribuido
                activeInputs.forEach((input, index) => {
                    if (index < activeInputsCount - 1) {
                        input.value = effortPerMonth.toFixed(2);
                        sumDistributedEffort += parseFloat(input.value);
                    }
                });

                // Ajusta el último input para compensar cualquier diferencia
                let lastInputEffort = effortTarget - sumDistributedEffort;
                activeInputs[activeInputsCount - 1].value = lastInputEffort.toFixed(2);
            });
        });



        document.querySelector('.save-all').addEventListener('click', function () {
            // Mostrar el indicador de guardado
            document.getElementById('savingIndicator').style.display = 'block';

            var allEfforts = [];

            document.querySelectorAll('.input-effort').forEach(input => {
                var wpid = parseInt(input.getAttribute('data-wpid'), 10);
                var dateString = input.getAttribute('data-month');
                var effort = parseFloat(input.value.replace(',', '.'));
                var formattedDate = formatDateTimeString(dateString); // Asegúrate de que esta función está definida correctamente

                if (!isNaN(effort) && formattedDate) { // Verificación adicional para la fecha formateada
                    allEfforts.push({
                        WpId: wpid,
                        Month: formattedDate,
                        Value: effort
                    });
                }
            });

            // Realizar la solicitud fetch
            fetch('/Wps/SaveAllEfforts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ Efforts: allEfforts })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data saved successfully:', data);
                    location.reload(); // Recargar la página después de guardar
                })
                .catch(error => {
                    console.error('Error saving data:', error);
                })
                .finally(() => {
                    // Ocultar el indicador de guardado independientemente del resultado
                    document.getElementById('savingIndicator').style.display = 'none';
                });
        });


        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('.clear-all').addEventListener('click', function () {
                document.querySelectorAll('.input-effort').forEach(input => {
                    input.value = '0'; // Coloca un 0 en todos los inputs
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.clear-line').forEach(button => {
                button.addEventListener('click', function () {
                    var wpid = this.getAttribute('data-wpid');
                    document.querySelectorAll(`.input-effort[data-wpid="${wpid}"]`).forEach(input => {
                        input.value = '0';
                    });
                });
            });
        });



        function formatDateTimeString(dateTimeStr) {
            var parts = dateTimeStr.split(' ');
            if (parts.length === 2) {
                var dateParts = parts[0].split('/');
                if (dateParts.length === 3) {
                    var year = dateParts[2];
                    var month = dateParts[1];
                    var day = dateParts[0];
                    return `${year}-${month}-${day}`;
                }
            }
            return null;
        }

        document.getElementById('exportCsvButton').addEventListener('click', function () {
            var csvContent = "data:text/csv;charset=utf-8,";
            var rows = document.querySelectorAll('.main-effort-plan-table tr');

            rows.forEach(function (row, rowIndex) {
                var cols = row.querySelectorAll('th, td');
                var rowData = [];
                cols.forEach(function (col, colIndex) {
                    // Excluir la columna "Actions" (segunda columna)
                    if (colIndex !== 1) {
                        var input = col.querySelector('input');
                        if (input) {
                            rowData.push(input.value.replace(/(\r\n|\n|\r)/gm, "").trim());
                        } else {
                            rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim());
                        }
                    }
                });
                csvContent += rowData.join(";") + "\r\n";
            });

            var encodedUri = 'data:text/csv;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(csvContent)));
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "effort_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>

}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\GetPersonnelEffortsByPerson.cshtml -----
@model TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel
@using System.Globalization
@using TRS2._0.Models.DataModels

@{
    string personName = Model.ProjectsPersonnelEfforts.FirstOrDefault()?.WorkPackages.FirstOrDefault()?.PersonnelEfforts.FirstOrDefault()?.PersonName ?? "Selected Person";
}

<div class="container-fluid">
    <h2>Personnel Effort Plan for @personName
        <div style="display: block; margin-top: 5px;">
            <button id="saveAllButton" class="btn btn-primary btn-sm">Save All</button>
            <button id="exportPersonCsvButton" class="btn btn-secondary btn-sm" style="margin-left: 8px;">Export into CSV</button>
        </div>

    </h2>
    <div class="table-responsive">
        <div class="scrollable-table-container">
            <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Project</th>
                        <th>Person</th>
                        <th>WP</th>
                        @foreach (var monthKey in ViewBag.ProjectMonths)
                        {
                            var parsedMonth = DateTime.Parse(monthKey + "-01");
                            var personId = Model.ProjectsPersonnelEfforts.First().WorkPackages.First().PersonnelEfforts.First().PersonId;
                            <th style="text-align:center;">
                                @parsedMonth.ToString("MMM yyyy", CultureInfo.CreateSpecificCulture("es-ES"))
                                <button class="refresh-btn"
                                        data-month="@monthKey"
                                        data-personid="@personId"
                                        style="border:none; background:none; padding:0; margin-left:4px; cursor:pointer;"
                                        title="Recalcular PM">
                                    <i class="bi bi-arrow-repeat" style="font-size: 0.9em; color:white;"></i>
                                </button>
                            </th>
                        }
                    </tr>
                    <tr>
                        <!-- Espacios para las primeras tres columnas que no tienen PMs -->
                        <th>
                            <div><span style="height: 10px; width: 10px; background-color: lightgreen; display: inline-block;"></span> Equal Effort</div>
                            <div><span style="height: 10px; width: 10px; background-color: yellow; display: inline-block;"></span> Exceeds Target</div>
                            <div><span style="height: 10px; width: 10px; background-color: lightblue; display: inline-block;"></span> Below Target</div>
                        </th>
                        <th>
                            <div style="border-bottom: 1px solid white; margin-bottom: 2px; text-align: center; font-weight: bold">TOTAL EFFORT</div>
                            <div style="border-bottom: 1px solid white;text-align: center; font-weight: bold;">ACTUAL EFFORT</div>
                            <div style="text-align: center; font-weight: bold;">AVAILABLE</div>
                        </th>
                        <th></th>
                        <!-- Calcula y muestra los PMs disponibles para cada mes -->
                        @foreach (var monthKey in ViewBag.ProjectMonths)
                        {
                            // Redondear los valores a dos decimales para comparación y visualización
                            var totalEffort = Math.Round(ViewBag.TotalEffortsPerMonth.ContainsKey(monthKey) ? ViewBag.TotalEffortsPerMonth[monthKey] : 0.00M, 2);
                            // Asegúrate de que pmValue sea 0 si no hay un valor correspondiente en PMValuesPerMonth para el monthKey
                            var pmValue = Math.Round(ViewBag.PMValuesPerMonth.ContainsKey(monthKey) ? ViewBag.PMValuesPerMonth[monthKey] : 0.00M, 2);
                            var dispValue = pmValue - totalEffort; // Calcula el disponible
                            var dispColor = dispValue > 0 ? "#90EE90" : dispValue == 0 ? "yellow" : "yellow"; // Decide el color
                            // Determinar el color basado en la comparación
                            var color = totalEffort > pmValue ? "yellow" :
                            totalEffort < pmValue ? "lightblue" : "lightgreen";

                            <th>
                                <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center; color: @color">@pmValue</div>
                                <div style="text-align: center; color: @color">@totalEffort</div>
                                <div style="border-top: 1px solid white">
                                <!-- Muestra el disponible y su color -->
                                <div style="text-align: center; color: @color">@dispValue</div>
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var projectEffort in Model.ProjectsPersonnelEfforts)
                    {
                        foreach (var wp in projectEffort.WorkPackages)
                        {
                            
                            foreach (var personnelEffort in wp.PersonnelEfforts)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("PersonnelEffortPlan", "Projects", new { projId = projectEffort.ProjectId })">@projectEffort.ProjectName</a>
                                    </td>
                                    <td>@personnelEffort.PersonName</td>
                                    <td>
                                        <a href="@Url.Action("PersonnelEffortPlan", "Projects", new { projId = projectEffort.ProjectId, wpId = wp.WpId })">@wp.WpName</a>
                                    </td>
                                    @foreach (var monthStatus in ViewBag.PersonnelInfo.MonthlyStatuses)
                                    {
                                        var cellClass = "effort-cell";
                                        var cellStyle = "";
                                        var isProjectLockedThisMonth = ViewBag.ProjectLocksByMonth.ContainsKey(monthStatus.Month.ToString("yyyy-MM")) &&
                                        ViewBag.ProjectLocksByMonth[monthStatus.Month.ToString("yyyy-MM")].ContainsKey(projectEffort.ProjectId) &&
                                        ViewBag.ProjectLocksByMonth[monthStatus.Month.ToString("yyyy-MM")][projectEffort.ProjectId];
                                        
                                        bool hasGradient = !string.IsNullOrEmpty(monthStatus.Gradient);
                                        
                                        var projectIdsInMonthTravel = ProjectIdsinTravels(monthStatus.TravelDetails);

                                        bool hasMultipleProjectsTravel = projectIdsInMonthTravel.Count > 1;
                                        bool currentProjectHasTravel = projectIdsInMonthTravel.Contains(projectEffort.ProjectId);

                                        // Primero maneja los estados Out of Contract y Overloaded, que tienen prioridad
                                        switch (monthStatus.Status)
                                        {
                                            case 1:
                                                cellClass += " out-of-contract";
                                                cellStyle = "background-color: red;";
                                                break;

                                            case 2:
                                                cellClass += " overload";
                                                cellStyle = "background-color: yellow;";
                                                break;
                                        }

                                        // ✅ SOLO APLICA VIAJES Y GRADIENTE SI Status != 1 y != 2
                                        if (monthStatus.Status != 1 && monthStatus.Status != 2)
                                        {
                                            if (HasOutsideTravel(monthStatus.TravelDetails, projectEffort.ProjectId))
                                            {
                                                cellStyle = hasGradient
                                                ? $"background-image: {monthStatus.Gradient}, hotpink;"
                                                : "background-color: hotpink;";
                                            }

                                            if (HasInsideTravel(monthStatus.TravelDetails, projectEffort.ProjectId))
                                            {
                                                cellStyle = hasGradient
                                                ? $"background-image: {monthStatus.Gradient}, darkgreen;"
                                                : "background-color: darkgreen;";
                                            }

                                            if (string.IsNullOrEmpty(cellStyle) && hasGradient)
                                            {
                                                cellStyle = $"background-image: {monthStatus.Gradient};";
                                            }
                                        }


                                        <td class="@cellClass" style="@cellStyle">
                                            @if (monthStatus.Month >= wp.StartDate && monthStatus.Month <= wp.EndDate)
                                            {
                                                @if (!isProjectLockedThisMonth)
                                                {
                                                    <input type="text" class="form-control input-effort"
                                                           value="@((personnelEffort.Efforts.ContainsKey(monthStatus.Month)) ? (personnelEffort.Efforts[monthStatus.Month] == 0 ? "0" : personnelEffort.Efforts[monthStatus.Month].ToString("0.00")) : "0")"
                                                           data-personid="@personnelEffort.PersonId"
                                                           data-wpid="@wp.WpId"
                                                           data-month="@monthStatus.Month.ToString("yyyy-MM-dd")"
                                                           data-original-value="@((personnelEffort.Efforts.ContainsKey(monthStatus.Month)) ? (personnelEffort.Efforts[monthStatus.Month] == 0 ? "0.00" : personnelEffort.Efforts[monthStatus.Month].ToString("0.00")) : "0")" />
                                                }
                                                else
                                                {
                                                    <span style="text-align:center; font-weight:bold; display:block;">@((personnelEffort.Efforts.ContainsKey(monthStatus.Month)) ? (personnelEffort.Efforts[monthStatus.Month] == 0 ? "0" : personnelEffort.Efforts[monthStatus.Month].ToString("0.00")) : "0")</span>
                                                }
                                            }
                                            else
                                            {
                                                <span style="background-color:black; display:block; height:100%;"></span>
                                            }
                                        </td>

                                    }

                                </tr>
                            }
                        }
                    }
                </tbody>

            </table>
        </div>
    </div>
    <hr> <!-- Línea divisoria -->
    <div class="legend" style="display: flex; justify-content: space-around; padding: 10px;">
        <div><span style="height: 20px; width: 20px; background-color: lightsalmon; display: inline-block;"></span> Leave</div>
        <div><span style="height: 20px; width: 20px; background-color: lightblue; display: inline-block;"></span> Holiday</div>
        <div><span style="height: 20px; width: 20px; background-color: yellow; display: inline-block;"></span> Overload</div>
        <div><span style="height: 20px; width: 20px; background-color: red; display: inline-block;"></span> Out of Contract</div>
        <div><span style="height: 20px; width: 20px; background-color: purple; display: inline-block;"></span> No Contract Period</div>
        <div><span style="height: 20px; width: 20px; background-color: darkgreen; display: inline-block;"></span> Inside Travel</div>
        <div><span style="height: 20px; width: 20px; background-color: hotpink; display: inline-block;"></span> Outside Travel</div>        
    </div>

</div>

<script>

    document.getElementById('saveAllButton').addEventListener('click', async function () { 
        var changedEfforts = [];    
        
        var projectId = '@ViewBag.projId';
        document.querySelectorAll('.input-effort').forEach(input => {
            var originalValue = input.getAttribute('data-original-value'); // Sin parseFloat aquí
            // Reemplaza la coma por punto y convierte a número flotante
            var originalValueFloat = parseFloat(originalValue.replace(',', '.'));
            originalValueFloat = originalValueFloat.toFixed(2);
            var currentValue = parseFloat(input.value.replace(',', '.')).toFixed(2); // Redondeo a 2 decimales
            var formattedDate = formatDateTimeStringForModelBinding(input.getAttribute('data-month'));
            console.log(originalValueFloat, currentValue);

            if (currentValue !== originalValueFloat) { // Verifica si el valor ha cambiado

                changedEfforts.push({

                    PersonId: parseInt(input.getAttribute('data-personid'), 10),
                    WpId: parseInt(input.getAttribute('data-wpid'), 10),
                    Month: formattedDate,
                    Effort: currentValue
                });
                
            }
        });

        if (changedEfforts.length > 0) {
            try {
                // Realiza la solicitud POST utilizando fetch con async/await
                const response = await fetch('@Url.Action("SaveEfforts", "Projects")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ Efforts: changedEfforts, ProjectId: projectId })
                });

                if (!response.ok) { // Verifica si la respuesta no fue exitosa
                    throw new Error('Network response was not ok');
                }

                const data = await response.json(); // Espera a obtener la respuesta JSON

                if (data.success) {
                    if (data.notifications && data.notifications.length > 0) {
                        alert(data.notifications.join('\n'));
                    }
                    alert('Efforts saved successfully');
                    window.location.href = window.location.href.split('?')[0] + '?upd=' + new Date().getTime();
                } else {
                    // Manejo de errores específicos del servidor o lógica de negocio
                    alert('There was an error saving the efforts');
                }
            } catch (error) {
                // Manejo de errores de red o de respuesta
                console.error('Error:', error);
                alert('There was an error processing your request');
            }
        } else {
            alert('No changes to save');
        }
    });


    function formatDateTimeStringForModelBinding(dateString) {
        var date = new Date(dateString);
        var year = date.getFullYear();
        var month = (date.getMonth() + 1).toString().padStart(2, '0'); // Meses van de 0 a 11, así que añade 1
        var day = date.getDate().toString().padStart(2, '0');

        return `${year}-${month}-${day}`;
    }

    // Función para guardar todos los esfuerzos de una persona
    document.querySelectorAll('.wp-link').forEach(link => {
        link.addEventListener('click', function (event) {
            event.preventDefault();
            var wpid = this.getAttribute('data-wpid');
            var projId = '@ViewBag.projId'; // Asegúrate de que ViewBag.projId esté disponible
            window.location.href = '/Projects/PersonnelEffortPlan/' + projId + '/' + wpid;
        });
    });

        document.getElementById('exportPersonCsvButton').addEventListener('click', function () {
        var csvContent = '';
        var header = ['Project', 'Person', 'WP'];

        // Construye cabecera con meses
        const monthHeaders = Array.from(document.querySelectorAll('.table thead tr:nth-child(1) th')).slice(3);
        header.push(...monthHeaders.map(th => th.innerText.trim()));
        csvContent += header.join(';') + '\r\n';

        // Filas
        document.querySelectorAll('.table tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            let rowData = [];

            for (let i = 0; i < cells.length; i++) {
                let value = '';
                const input = cells[i].querySelector('input');
                if (input) {
                    value = input.value.trim();
                } else {
                    value = cells[i].innerText.trim();
                }

                // Cambiar punto decimal por coma si es numérico
                if (!isNaN(value) && value.includes('.')) {
                    value = value.replace('.', ',');
                }

                rowData.push(value);
            }

            csvContent += rowData.join(';') + '\r\n';
        });

        const encodedUri = 'data:text/csv;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(csvContent)));
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
            const rawName = '@personName';
    const sanitizedName = rawName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '_');
    link.setAttribute('download', `Personnel_Effort_Plan_${sanitizedName}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

        document.querySelectorAll('.refresh-btn').forEach(button => {
        button.addEventListener('click', async function () {
            const personId = parseInt(this.dataset.personid, 10);
            const monthKey = this.dataset.month;

            if (!personId || !monthKey || !monthKey.includes("-")) {
                alert("Parámetros inválidos para el cálculo de PM.");
                return;
            }

            const [yearStr, monthStr] = monthKey.split("-");
            const year = parseInt(yearStr, 10);
            const month = parseInt(monthStr, 10);

            if (!year || !month || month < 1 || month > 12) {
                alert("Fecha inválida.");
                return;
            }

            try {
                const response = await fetch('/Projects/RecalculatePMValue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ personId, year, month })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`PM actualizado a: ${data.pm}`);
                    location.reload();
                } else {
                    alert('Error al recalcular el PM: ' + data.message);
                }
            } catch (err) {
                alert('Error inesperado al comunicar con el servidor.');
            }
        });
    });




</script>
    

<style>
    .input-effort {
        width: 100%;
        min-width: 60px;
        text-align: center;
    }

    .effort-cell {
        min-width: 60px;
        padding: 0;
        text-align: center;
    }

    .person-name-column {
        font-weight: bold;
        width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .scrollable-table-container {
        overflow-y: auto;
        max-height: 800px;
    }

    /* Encabezado fila 1: Project, Person, WP... */
    .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        z-index: 12;
        background-color: var(--blue-dark);
        color: white;
        text-align: center;
        vertical-align: middle;
    }

    /* Encabezado fila 2: leyendas de PMs, Total, etc. */
    .table thead tr:nth-child(2) th {
        position: sticky;
        top: 50px; /* Altura de la primera fila, ajústalo si cambia */
        z-index: 11;
        background-color: var(--blue-dark);
        color: white;
        text-align: center;
        vertical-align: middle;
    }

    /* Columnas fijas - Primera columna */
    .table th:first-child,
    .table td:first-child {
        position: sticky;
        left: 0;
        min-width: 200px;
        max-width: 200px;
        background-color: white;
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    /* Segunda columna */
    .table th:nth-child(2),
    .table td:nth-child(2) {
        position: sticky;
        left: 200px;
        min-width: 250px;
        max-width: 250px;
        background-color: white;
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    /* Tercera columna */
    .table th:nth-child(3),
    .table td:nth-child(3) {
        position: sticky;
        left: 450px;
        min-width: 100px;
        max-width: 100px;
        background-color: white;
        z-index: 10;
        text-align: center;
        vertical-align: middle;
        border-left: 2px solid #dee2e6;
    }

    /* Intersecciones: encabezado fila 2 + columnas fijas */
    .table thead tr:nth-child(2) th:nth-child(1),
    .table thead tr:nth-child(2) th:nth-child(2),
    .table thead tr:nth-child(2) th:nth-child(3) {
        z-index: 13;
    }

    /* Asegura que las celdas posteriores a WP tengan un borde visual */
    .table td:nth-child(4),
    .table th:nth-child(4) {
        border-left: 2px solid #dee2e6;
    }

    h2 {
        text-align: center;
        font-weight: bold;
    }

    /* Intersecciones: encabezado fila 1 + columnas fijas */
    .table thead tr:nth-child(1) th:nth-child(1),
    .table thead tr:nth-child(1) th:nth-child(2),
    .table thead tr:nth-child(1) th:nth-child(3) {
        z-index: 14;
    }
</style>

@functions {
    public bool HasInsideTravel(List<TravelDetails> travelDetails, int currentProjectId)
    {
        return travelDetails.Any(td => td.ProjId == currentProjectId);
    }

    public bool HasOutsideTravel(List<TravelDetails> travelDetails, int currentProjectId)
    {
        return travelDetails.Any(td => td.ProjId != currentProjectId);
    }

    public List<int> ProjectIdsinTravels(List<TravelDetails> travelDetails)
    {
        return travelDetails.Select(td => td.ProjId).Distinct().ToList();
    }
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\Index.cshtml -----
@model List<TRS2._0.Models.DataModels.Project>

<h1 class="text-center my-style">
    Projects <span id="selectedYearTitle">(@ViewBag.DefaultSelectedYear)</span>
</h1>

<div class="filter-container d-flex justify-content-center align-items-center mb-4" style="gap: 20px;">
    <div>
        <label for="yearDropdown" class="form-label">Year:</label>
        <select id="yearDropdown" class="form-select">
            <option value="">All</option>
            @foreach (var year in ViewBag.UniqueYears)
            {
                var isSelected = (int)year == (int)ViewBag.DefaultSelectedYear ? "selected" : "";
                @Html.Raw($"<option value=\"{year}\" {isSelected}>{year}</option>")
            }
        </select>
    </div>
    <div>
        <label for="searchByName" class="form-label">Name:</label>
        <input type="text" id="searchByName" class="form-control" placeholder="Search...">
    </div>
    <div>
        <label for="filterByType" class="form-label">Type:</label>
        <select id="filterByType" class="form-select">
            <option value="">All</option>
            @foreach (var type in Model.Select(p => p.Type).Distinct())
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
</div>

<div class="projects-container d-flex flex-wrap justify-content-around">
    @foreach (var type in Model.Select(p => p.Type).Distinct())
    {
        <div class="project-column m-2" data-type="@type" style="flex: 0 1 45%; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.1);">
            <h2 class="text-center mt-3">@type</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model
                        .Where(p => p.Type == type &&
                                    p.St1 == "ABIERTO" &&
                                    (p.St2 == "CONCEDIDO" || string.IsNullOrEmpty(p.St2)) &&
                                    p.Visible == 1)
                        .OrderBy(p => p.Acronim))
                    {
                        <tr data-name="@item.Acronim"
                            data-start="@item.Start.Value.Year"
                            data-end="@item.EndReportDate.Year">
                            <td>
                                <a asp-action="Details" asp-route-id="@item.ProjId">@item.Acronim</a>
                            </td>
                            <td>@item.Start.Value.Year - @item.End.Value.Year</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchByNameInput = document.getElementById('searchByName');
        const filterByTypeSelect = document.getElementById('filterByType');
        const yearDropdown = document.getElementById('yearDropdown');

            function filterProjects() {
        const searchQuery = searchByNameInput.value.toLowerCase();
        const selectedType = filterByTypeSelect.value;
        const selectedYear = yearDropdown.value;

        document.querySelectorAll('.project-column').forEach(column => {
            const type = column.getAttribute('data-type');
            let matchesType = !selectedType || selectedType === type;

            const rows = column.querySelectorAll('tbody tr');
            let hasVisibleRows = false;

            rows.forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                const start = parseInt(row.getAttribute('data-start'));
                const end = parseInt(row.getAttribute('data-end'));

                const matchesSearch = name.includes(searchQuery);
                const matchesYear = !selectedYear || (start <= selectedYear && end >= selectedYear);

                const isVisible = matchesSearch && matchesYear;

                row.style.display = isVisible ? '' : 'none';
                if (isVisible) hasVisibleRows = true;
            });

            column.style.display = matchesType && hasVisibleRows ? '' : 'none';
        });

        document.getElementById('selectedYearTitle').textContent = selectedYear ? `(${selectedYear})` : '(All)';
    }


        searchByNameInput.addEventListener('input', filterProjects);
        filterByTypeSelect.addEventListener('change', filterProjects);
        yearDropdown.addEventListener('change', filterProjects);

        // Aplicar filtro inicial
        filterProjects();

            // Reiniciar el valor visual del dropdown para que búsquedas actúen sobre todos
    yearDropdown.value = "";
    });
</script>

<style>
    .filter-container {
        margin: 20px 0;
    }

    .projects-container {
        margin: 0 15px;
        gap: 20px;
    }

    .project-column {
        flex: 1 1 45%;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .filter-container > div {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .form-select, .form-control {
        width: auto;
    }

    .my-style {
        font-size: 2.5rem;
        font-weight: bold;
        color: #0056b3;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\PersonnelEffortPlan.cshtml -----
@model TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel
@using System.Globalization
@using TRS2._0.Models.DataModels
@using static TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <!-- Otros elementos del head -->
</head>

@{
    ViewData["Title"] = "Personnel Effort Plan";
    var personnelInfosList = ViewBag.PersonnelInfos as List<PersonnelInfo>;
    var wpDetailsT = ViewBag.WpDetailsTransposed as IEnumerable<dynamic>;
}

<div class="container-fluid">
    <h2>Personnel Effort Plan for @Model.Project.Acronim Proyect
        <div style="display: block; margin-top: 5px;">
            <button id="saveAllButton" class="btn btn-primary btn-sm">Save All</button>
            <button id="exportCsvButton" class="btn btn-secondary btn-sm">Export into CSV</button>

        </div>
    </h2>    
    <div class="table-responsive main-effort-plan-table">
        @if (Model.WorkPackages.Any())
        {
            <div class="scrollable-table-container">
                <table id="effortPlanTable" class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>
                            @Model.Project.Acronim
                            
                        </th>
                        <th>WP</th>
                            @foreach (var month in Model.GetMonthsForProject())
                        {
                            <th>
                                    <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center">@month.ToString("MMM").Substring(0, 1).ToUpper()@month.ToString("MMM").Substring(1).ToLower()</div>
                                    <div style="text-align: center">@month.ToString("yyyy")</div>
                                    <div style="text-align: center">(M @Model.GetMonthIndex(month))</div>
                                </th>
                        }
                    </tr>
                </thead>
                    <tbody>

                        @foreach (var wp in Model.WorkPackages)
                        {
                            foreach (var personnelEffort in wp.PersonnelEfforts)
                            {
                                var personnelInfo = personnelInfosList.FirstOrDefault(pi => pi.PersonId == personnelEffort.PersonId);                                
                                <tr>
                                    <td>
                                        <a href="/Projects/GetPersonnelEffortsByPerson/@ViewBag.projId/@personnelEffort.PersonId" class="person-link" target="_blank" data-personid="@personnelEffort.PersonId">@personnelEffort.PersonName</a>
                                    </td>
                                    <td>
                                        <a href="/Projects/PersonnelEffortPlan/@ViewBag.projId/@wp.WpId" class="wp-link" target="_blank" data-wpid="@wp.WpId">@wp.WpName</a>
                                    </td>


                                    @foreach (var month in Model.GetMonthsForProject())
                                    {
                                        var monthStatus = personnelInfo?.MonthlyStatuses.FirstOrDefault(ms => ms.Month == month);
                                        var cellClass = "effort-cell"; // Clase por defecto
                                        var cellStyle = ""; // Estilo por defecto
                                        var isLocked = monthStatus?.IsLocked ?? false; // Chequea si el mes está bloqueado

                                        if (monthStatus != null)
                                        {
                                            List<string> gradientColors = new List<string>();

                                            // Añade el gradiente existente si hay uno
                                            if (monthStatus.Status == 3 && !string.IsNullOrEmpty(monthStatus.Gradient))
                                            {
                                                // Primero, quita el prefijo y sufijo del gradiente completo
                                                var gradientWithoutWrapper = monthStatus.Gradient
                                                .Replace("linear-gradient(to right, ", "")
                                                .Replace(");", "");

                                                // Luego, divide por coma para obtener los colores individuales
                                                var colors = gradientWithoutWrapper.Split(',');

                                                // Ahora, limpia cada color individualmente
                                                var cleanedColors = colors.Select(color => color.Trim().TrimEnd(new char[] { ')' }));

                                                // Finalmente, agrega los colores limpios a la lista de gradientColors
                                                gradientColors.AddRange(cleanedColors);
                                            }


                                            switch (monthStatus.Status)
                                            {
                                                case 1:
                                                    cellClass += " out-of-contract";
                                                    cellStyle = "background-color: red;";
                                                    break;
                                                case 2:
                                                    cellClass += " overload";
                                                    cellStyle = "background-color: yellow;";
                                                    break;

                                                case 3: // Estado normal con posible gradiente
                                                                                                      
                                                    break;

                                                case 4:                                                    
                                                    var currentProjId = ViewBag.projId;
                                                    // Comprueba si hay viajes asociados al proyecto actual
                                                    var hasCurrentProjectTravel = monthStatus.UniqueProjIds.Contains(currentProjId);
                                                    var hasOtherProjectTravel = monthStatus.UniqueProjIds.Any(id => id != currentProjId);
                                                    var totalUniqueProjects = monthStatus.UniqueProjIds.Count;                                                    

                                                    if (hasCurrentProjectTravel)
                                                    {
                                                        gradientColors.Add("darkgreen"); // Añade verde oscuro para viajes al proyecto actual
                                                    }
                                                    if (hasOtherProjectTravel)
                                                    {
                                                        gradientColors.Add("hotpink"); // Añade rosa para viajes a otros proyectos
                                                    }
                                                    
                                                    break;
                                                    // Construye el estilo del gradiente solo si hay colores en la lista
                                                                                                 
                                            }

                                            // 🔧 CAMBIO: protección extra — evita aplicar gradientes si ya se asignó overload o out-of-contract
                                            if (monthStatus.Status == 1 || monthStatus.Status == 2)
                                            {
                                                gradientColors.Clear(); // Borra gradientes para evitar sobrescribir el color rojo o amarillo
                                            }
                                            if (monthStatus.Status != 1 && monthStatus.Status != 2)
                                            {                                                                                  
                                                if (gradientColors.Count == 1)
                                                {
                                                    // Si solo hay un color, usa background-color para un fondo sólido de ese color
                                                    cellStyle = $"background-color: {gradientColors.First()};";
                                                }
                                                else if (gradientColors.Count > 1)
                                                {
                                                    // Si hay más de un color, construye un gradiente
                                                    cellStyle = $"background-image: linear-gradient(to right, {String.Join(", ", gradientColors)});";
                                                }
                                                else
                                                {
                                                    // Aquí puedes manejar los casos predeterminados para cuando no hay gradientes ni condiciones especiales
                                                    // Por ejemplo, podrías establecer un color de fondo predeterminado o dejarlo vacío si no es necesario
                                                    cellStyle = ""; // Ajusta esto según sea necesario
                                                }
                                            }
                                        }

                                        // Determina si el mes actual está activo para este WP
                                        var isActiveMonth = wp.ActiveMonths.Contains(month);
                                        // Intenta obtener el valor del esfuerzo, o usa 0.00 si no está presente
                                        var effortValue = personnelEffort.Efforts.ContainsKey(month) ? personnelEffort.Efforts[month] : 0.00M;

                                        <td class="@cellClass" style="@cellStyle">
                                            @if (month >= wp.StartDate && month <= wp.EndDate)
                                            {
                                                @if (isActiveMonth && !isLocked) // Permite edición solo si el mes está activo y no está bloqueado
                                                {
                                                    <input type="text" class="form-control input-effort"
                                                           value="@(effortValue == 0 ? "0" : effortValue.ToString("0.00", CultureInfo.InvariantCulture))"
                                                           data-personid="@personnelEffort.PersonId"
                                                           data-wpid="@wp.WpId"
                                                           data-month="@month.ToString("yyyy-MM-dd")"
                                                           data-original-value="@(effortValue == 0 ? "0.00" : effortValue.ToString("0.00", CultureInfo.InvariantCulture))" />
                                                }
                                                else
                                                {
                                                    <span style="display: block; text-align: center; text-size-adjust:auto; font-weight: bold;">
                                                        @(effortValue == 0 ? "0" : effortValue.ToString("0.00", CultureInfo.InvariantCulture))
                                                    </span>
                                                    // Muestra el valor como texto si está bloqueado o no es un mes activo
                                                }
                                            }
                                            else
                                            {
                                                <span style="background-color:black; display:block; height:100%;"></span>
                                            }
                                        </td>

                                    }
                                </tr>
                            }
                        }

                    </tbody>

            </table>
            </div>
            <hr> <!-- Línea divisoria -->
            <div class="legend" style="display: flex; justify-content: space-around; padding: 10px;">
                <div><span style="height: 20px; width: 20px; background-color: darkorange; display: inline-block;"></span> Leave</div>
                <div><span style="height: 20px; width: 20px; background-color: lightblue; display: inline-block;"></span> Holiday</div>
                <div><span style="height: 20px; width: 20px; background-color: yellow; display: inline-block;"></span> Overload</div>
                <div><span style="height: 20px; width: 20px; background-color: red; display: inline-block;"></span> Out of Contract</div>
                <div><span style="height: 20px; width: 20px; background-color: purple; display: inline-block;"></span> No Contract Period</div>
                <div><span style="height: 20px; width: 20px; background-color: darkgreen; display: inline-block;"></span> Inside Travel</div>
                <div><span style="height: 20px; width: 20px; background-color: hotpink; display: inline-block;"></span> Outside Travel</div>
            </div>
            <hr>

            @if (wpDetailsT != null && wpDetailsT.Any())
            {
                <hr />
                <h2 class="mt-3 mb-2">Work Packages Details</h2>

                <div class="table-responsive transposed-wrapper" style="overflow-x:auto;">
                    <table class="table table-bordered table-striped table-hover transposed-wp-details">
                        <thead class="thead-dark">
                            <tr>
                                <th class="sticky-left" style="min-width:220px"></th>
                                @foreach (var wp in wpDetailsT)
                                {
                                    <th class="text-center">@wp.Name</th>
                                }
                                <th class="total-header">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="sticky-left"><strong>Estimated</strong></td>
                                @{
                                    decimal totalEstimated = 0m;
                                }
                                @foreach (var wp in wpDetailsT)
                                {
                                    decimal val = (decimal)wp.Estimated;
                                    totalEstimated += val;
                                    <td class="text-center">@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", val)</td>
                                }
                                <td class="total-cell"><strong>@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", totalEstimated)</strong></td>
                            </tr>

                            <tr>
                                <td class="sticky-left"><strong>Distributed</strong></td>
                                @{
                                    decimal totalDistributed = 0m;
                                }
                                @foreach (var wp in wpDetailsT)
                                {
                                    decimal val = (decimal)wp.Distributed;
                                    totalDistributed += val;
                                    <td class="text-center">@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", val)</td>
                                }
                                <td class="total-cell"><strong>@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", totalDistributed)</strong></td>
                            </tr>

                            <tr>
                                <td class="sticky-left"><strong>Covered with Personnel</strong></td>
                                @{
                                    decimal totalCovered = 0m;
                                }
                                @foreach (var wp in wpDetailsT)
                                {
                                    decimal val = (decimal)wp.CoveredWithPersonnel;
                                    totalCovered += val;
                                    <td class="text-center">@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", val)</td>
                                }
                                <td class="total-cell"><strong>@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.00}", totalCovered)</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
}
else
{
    <p>No active work packages for this project.</p>
}
    </div> 
    <hr>
    @if (ViewBag.SelectedWpId != null && ViewBag.EffortSumByMonth != null && ViewBag.FilteredProjectEfforts != null)
    {
        var selectedWpId = ViewBag.SelectedWpId;
        var effortSumByMonth = ViewBag.EffortSumByMonth as Dictionary<DateTime, decimal>;
        var filteredProjectEfforts = ViewBag.FilteredProjectEfforts as List<Projeffort>;
        var months = effortSumByMonth.Keys.OrderBy(d => d).ToList();
        var wpName = Model.WorkPackages.FirstOrDefault(wp => wp.WpId == selectedWpId)?.WpName;
        <div class="table-responsive effort-balance-table-container">
            <table class="table table-striped table-dark effort-balance-table">
                <thead class="thead-dark">
                    <tr>
                        <th><div style="vertical-align: middle">Effort vs Plan Balance</div></th>
                        @foreach (var month in months)
                        {
                            <th>
                                <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center">@month.ToString("MMM").Substring(0, 1).ToUpper()@month.ToString("MMM").Substring(1).ToLower()</div>
                                <div style="text-align: center">@month.ToString("yyyy")</div>
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>

                    <tr>
                        <td>@wpName - Total</td>
                        @foreach (var month in months)
                        {
                            <td>@(effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month].ToString("0.00") : "0.00")</td>
                        }
                    </tr>


                    <tr>
                        <td>@wpName - Cumulative</td>
                        @{
                            decimal cumulativeTotal = 0;
                        }
                        @foreach (var month in months)
                        {
                            cumulativeTotal += effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                            <td>@cumulativeTotal.ToString("0.00")</td>
                        }
                    </tr>


                    <tr>
                        <td>@wpName - Balance</td>
                        @foreach (var month in months)
                        {
                            var planEffort = filteredProjectEfforts.FirstOrDefault(pe => pe.Month == month)?.Value ?? 0;
                            var realEffort = effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                            var balance = realEffort - planEffort ;
                            <td style="@(balance < 0 ? "color: yellow;" : "")">@balance.ToString("0.00")</td>
                        }
                    </tr>


                    <tr>
                        <td>@wpName - Cumulative Balance</td>
                        @{
                            decimal cumulativeBalance = 0;
                        }
                        @foreach (var month in months)
                        {
                            var planEffort = filteredProjectEfforts.FirstOrDefault(pe => pe.Month == month)?.Value ?? 0;
                            var realEffort = effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                            var balance = realEffort - planEffort ;
                            cumulativeBalance += balance;
                            <td style="@(cumulativeBalance < 0 ? "color: yellow;" : "")">@cumulativeBalance.ToString("0.00")</td>
                        }
                    </tr>
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.getElementById('saveAllButton').addEventListener('click', async function () { // Marca esta función como async
            var changedEfforts = [];
            var availableEfforts = @Html.Raw(Json.Serialize(ViewBag.AvailableEfforts));
            var projectId = '@ViewBag.projId'; 
            document.querySelectorAll('.input-effort').forEach(input => {
                var originalValue = input.getAttribute('data-original-value');
                var currentValue = parseFloat(input.value.replace(',', '.')).toFixed(2);
                console.log(originalValue, currentValue);
                var formattedDate = formatDateTimeStringForModelBinding(input.getAttribute('data-month'));

                if (currentValue !== originalValue) {
                    changedEfforts.push({
                        PersonId: parseInt(input.getAttribute('data-personid'), 10),
                        WpId: parseInt(input.getAttribute('data-wpid'), 10),
                        Month: formattedDate,
                        Effort: currentValue
                    });
                }
            });

            if (changedEfforts.length > 0) {
                try {
                    // Utiliza await para esperar a que la promesa de fetch se resuelva
                    const response = await fetch('@Url.Action("SaveEfforts", "Projects")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ Efforts: changedEfforts, ProjectId: projectId })
                    });

                    const data = await response.json(); // Espera a obtener la respuesta JSON

                    if (data.success) {                        
                        if (data.notifications && data.notifications.length > 0) {
                            alert(data.notifications.join('\n'));
                        }
                        alert('Efforts saved successfully');
                        window.location.href = window.location.href.split('?')[0] + '?upd=' + new Date().getTime();
                    } else {
                        alert('There was an error saving the efforts');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('There was an error processing your request');
                }
            } else {
                alert('No changes to save');
            }
        });



        function formatDateTimeStringForModelBinding(dateString) {
            var date = new Date(dateString);
            var year = date.getFullYear();
            var month = (date.getMonth() + 1).toString().padStart(2, '0'); // Meses van de 0 a 11, así que añade 1
            var day = date.getDate().toString().padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        document.querySelectorAll('.wp-link').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                var wpid = this.getAttribute('data-wpid');
                var projId = '@ViewBag.projId'; // Asegúrate de que ViewBag.projId esté disponible
                window.location.href = '/Projects/PersonnelEffortPlan/' + projId + '/' + wpid;
            });
        });

        document.querySelectorAll('.person-link').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                var personId = this.getAttribute('data-personid');
                var projId = '@ViewBag.projId'; // Asegúrate de que ViewBag.projId esté disponible
                window.location.href = '/Projects/GetPersonnelEffortsByPerson/' + projId + '/' + personId;
            });
        });


        document.getElementById('exportCsvButton').addEventListener('click', function () {
            var csvBody = ""; // Aquí se construye el contenido real del CSV

            // Construir manualmente los encabezados
            var headerRow = ["Personal", "WP"];
            document.querySelectorAll('.main-effort-plan-table thead th').forEach(th => {
                const divs = th.querySelectorAll("div");
                let headerText = "";

                if (divs.length === 3) {
                    const month = divs[0].innerText.trim();
                    const year = divs[1].innerText.trim();
                    const index = divs[2].innerText.trim();
                    headerText = `${month} ${year} ${index}`;
                }

                if (headerText) {
                    headerRow.push(headerText);
                }
            });

            csvBody += headerRow.join(";") + "\r\n";

            // Recorrer las filas del cuerpo
            var rows = document.querySelectorAll('.main-effort-plan-table table tbody tr');

            rows.forEach(function (row) {
                var cols = row.querySelectorAll('td');
                var rowData = [];
                cols.forEach(function (col) {
                    var input = col.querySelector('input');
                    let value = "";

                    if (input) {
                        value = input.value.replace(/(\r\n|\n|\r)/gm, "").trim();
                    } else {
                        value = col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim();
                    }

                    // Convertir punto decimal a coma si es numérico
                    if (!isNaN(value) && value.includes(".")) {
                        value = value.replace(".", ",");
                    }

                    rowData.push(value);
                });
                csvBody += rowData.join(";") + "\r\n";
            });

            // Codificación del contenido final sin que se mezcle con la cabecera
            var encodedUri = 'data:text/csv;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(csvBody)));
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "personnel_effort_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });



        $(document).ready(function () {
            var table = $('#effortPlanTable tbody');
            var rows = table.find('tr').get();

            rows.sort(function (a, b) {
                var personA = $(a).find('td').eq(0).text().toUpperCase();
                var personB = $(b).find('td').eq(0).text().toUpperCase();
                var wpA = $(a).find('td').eq(1).text().toUpperCase().trim();
                var wpB = $(b).find('td').eq(1).text().toUpperCase().trim();

                if (personA < personB) return -1;
                if (personA > personB) return 1;
                console.log(wpA);
                console.log(wpB);
                if (wpA === 'TRAVELS') {
                    console.log('Bajo Fila');
                    return 1;
                }
                if (wpB === 'TRAVELS') { 
                    console.log('Subo Fila');
                return -1;
                }
                if (wpA < wpB) return -1;
                if (wpA > wpB) return 1;

                return 0;
            });

            $.each(rows, function (index, row) {
                table.append(row);
            });
        });

    

    </script>
}

<style>
    .main-effort-plan-table .input-effort {
        width: 100%; /* Asegura que el input ocupe toda la celda */
        min-width: 60px; /* Ajusta el mínimo ancho para mostrar tres caracteres */
        text-align: center; /* Centra el texto */
    }

    .main-effort-plan-table .effort-cell {
        min-width: 80px; /* Igual al mínimo ancho del input */
        
        text-align: center; /* Centra el texto */
    }

    .main-effort-plan-table .person-name-column {
        font-weight: bold;
        width: 250px; /* Ajusta este valor según tus necesidades */
        white-space: nowrap; /* Evita que el texto se envuelva a la siguiente línea */
        overflow: hidden; /* Oculta el texto que exceda el ancho de la celda */
        text-overflow: ellipsis; /* Añade puntos suspensivos si el texto es demasiado largo */

    }

    .main-effort-plan-table .scrollable-table-container {
        overflow-y: auto;
        max-height: 800px; /* Aumenta este valor para mostrar más filas */
    }

    .main-effort-plan-table .table thead th {
        position: sticky;
        top: 0;        
        z-index: 10;
    }

    /* Estilo para la cabecera de la primera y segunda columna */
    .main-effort-plan-table .table th:first-child, .main-effort-plan-table .table th:nth-child(2) {
        position: sticky;
        left: 0; /* Para la primera columna */
        z-index: 11; /* Asegurarse de que está por encima del resto */
        background-color: var(--blue-dark); /* Color de fondo oscuro */
        text-align: center;
        vertical-align: middle;
    }

    .main-effort-plan-table .table th:nth-child(2) {
        left: 250px; /* Ajusta este valor al ancho de tu primera columna */
        z-index: 11;
    }

    /* Estilos para las celdas de cuerpo en la primera y segunda columna */
    .main-effort-plan-table .table td:first-child, .main-effort-plan-table .table td:nth-child(2) {
        position: sticky;
        left: 0; /* Para la primera columna */
        background-color: white; /* Fondo blanco para las celdas del cuerpo */
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    .main-effort-plan-table .table td:nth-child(2) {
        left: 250px; /* Ajusta este valor al ancho de tu primera columna */
        z-index: 10;
    }

    /* Ajustes para el ancho de las columnas fijas */
    .main-effort-plan-table .table th:first-child, .main-effort-plan-table .table td:first-child {
        min-width: 250px; /* o el ancho que necesites */
        max-width: 250px;
    }

    .main-effort-plan-table .table th:nth-child(2), .main-effort-plan-table .table td:nth-child(2) {
        min-width: 100px; /* o el ancho que necesites */
        max-width: 100px;
    }

    /* Ajustar bordes para celdas adyacentes */
    .main-effort-plan-table .table td:nth-child(3), .main-effort-plan-table .table th:nth-child(3) {
        border-left: 2px solid #dee2e6; /* Asegúrate de que el color del borde coincida con el estilo de tu tabla */
    }

    h2 {
        text-align: center;
        font-weight: bold;
    }

    .main-effort-plan-table .bg-dark-gray {
        background-color: #6c757d !important; /* Gris oscuro, puedes ajustar el color según tus necesidades */
        min-width: 60px; /* Ajusta el mínimo ancho para mostrar tres caracteres */
        text-align: center; /* Centra el texto */
    }

    .effort-balance-table-container .table-dark,
    .effort-balance-table-container .table-dark th,
    .effort-balance-table-container .table-dark td,
    .effort-balance-table-container .table-dark thead th {
        
        color: white; /* Texto en color blanco */
    }

    /* Asegúrate de que los estilos de encabezado específicamente sean aplicados */
    .effort-balance-table-container .thead-dark th {
        background-color: black; /* Fondo oscuro para encabezados */
        color: white; /* Texto en color blanco */
    }

    .effort-balance-table-container .table td:first-child,
    .effort-balance-table-container .table th:first-child {
        white-space: nowrap; /* Evita saltos de línea */
        overflow: hidden; /* Oculta el texto que excede el ancho de la celda */
        text-overflow: ellipsis; /* Añade puntos suspensivos si el texto es demasiado largo */
        text-align: center; /* Centra el texto horizontalmente */
        font-weight: bold; /* Texto en negrita */
    }

    .container-fluid {
        margin-top: 10px; /* Ajusta este valor según necesites */
    }

    .transposed-wp-details th:first-child,
    .transposed-wp-details td:first-child {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .transposed-wp-details th, .transposed-wp-details td {
        vertical-align: middle;
        white-space: nowrap;
    }

    .transposed-wp-details .sticky-left {
        position: sticky;
        left: 0;
        z-index: 2;
        background: white; /* Evita traslucir celdas debajo */
    }

    .transposed-wp-details .sticky-right {
        position: sticky;
        right: 0;
        z-index: 2;
        background: white;
        box-shadow: -4px 0 6px -4px rgba(0,0,0,0.2); /* Separador visual a la derecha */
    }

    /* Si el thead va a ser también pegajoso al hacer scroll vertical en el contenedor: */
    .transposed-wrapper .thead-dark th {
        position: sticky;
        top: 0;
        z-index: 3;
    }

    .total-header {
        background-color: #343a40 !important;
        color: white !important;
        text-align: center;
    }

    .total-cell {
        background-color: #d6d8d9 !important; /* gris claro */
        font-weight: bold;
        text-align: center;
    }
</style>

        @functions {
    public bool HasInsideTravel(List<TravelDetails> travelDetails, int currentProjectId)
    {
        return travelDetails.Any(td => td.ProjId == currentProjectId);
    }

    public bool HasOutsideTravel(List<TravelDetails> travelDetails, int currentProjectId)
    {
        return travelDetails.Any(td => td.ProjId != currentProjectId);
    }

    public List<int> ProjectIdsinTravels(List<TravelDetails> travelDetails)
    {
        return travelDetails.Select(td => td.ProjId).Distinct().ToList();
    }
}


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\PersonnelSelection.cshtml -----
@model TRS2._0.Models.ViewModels.ProjectPersonnelViewModel

@{
    ViewData["Title"] = "Personnel Selection";
    var orderedWorkPackages = Model.WorkPackages
        .OrderBy(wp => wp.Name.Equals("travels", StringComparison.OrdinalIgnoreCase))
        .ThenBy(wp => wp.Name)
        .ToList();
}

<div class="container mt-3">
    <div class="row">
        <!-- Detalles del proyecto -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">Project Details</div>
                <div class="card-body">
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Acronym</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Acronim)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Title</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Title)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Contract</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Contract)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Start Date</dt>
                        <dd class="col-sm-8">@(Model.ProjectDetails.Start?.ToString("dd-MM-yyyy") ?? string.Empty)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">End Date</dt>
                        <dd class="col-sm-8">@(Model.ProjectDetails.End?.ToString("dd-MM-yyyy") ?? string.Empty)</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Project Investigator</dt>
                        <dd class="col-sm-8">@ViewBag.PiFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Project Manager</dt>
                        <dd class="col-sm-8">@ViewBag.PmFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Finance Manager</dt>
                        <dd class="col-sm-8">@ViewBag.FmFullName</dd>
                    </dl>
                    <dl class="row detail-item">
                        <dt class="col-sm-4 text-sm-right">Type</dt>
                        <dd class="col-sm-8">@Html.DisplayFor(model => model.ProjectDetails.Type)</dd>
                    </dl>

                    <div class="card mt-4">
                        <div class="card-header">Third Parties</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="upcCheck" disabled @(Model.ProjectDetails.TpsUpc == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="upcCheck">UPC</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="icreaCheck" disabled @(Model.ProjectDetails.TpsIcrea == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="icreaCheck">ICREA</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="csicCheck" disabled @(Model.ProjectDetails.TpsCsic == 1 ? "checked" : "")>
                                        <label class="form-check-label" for="csicCheck">CSIC</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Selección de personal -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header text-center">Person Selection</div>
                <div class="card-body">
                    <select id="personnelSelect" class="form-control mb-2">
                        <option value="">Please select a person from the list below:</option>
                        @foreach (var person in Model.AllPersonnel.OrderBy(p => p.Surname).ThenBy(p => p.Name))
                        {
                            <option value="@person.Id">@person.Surname, @person.Name</option>
                        }
                    </select>
                    <p class="mb-1">Or start typing here the name of the person:</p>
                    <input type="text" id="searchTerm" class="form-control mb-2" placeholder="Start typing..." onkeyup="filterPersonnel()" />
                    <div id="searchResults" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <hr />
                <div class="card mt-3">
                    <div class="card-header text-center">Person Details</div>
                    <div id="personDetails" class="card-body"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr />
<h3 class="text-center my-style">Personnel in Work Packages</h3>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="project-personnel-wrapper">
                <table class="table table-bordered sticky-table">
                    <thead>
                        <tr>
                            <th class="sticky-header sticky-col name-column">People involved in @Model.ProjectDetails.Acronim project</th>
                            @foreach (var wp in orderedWorkPackages)
                            {
                                <th class="sticky-header wp-column">@wp.Name</th>
                            }
                            <th class="sticky-header action-column">
                                <button id="updateAllButton" class="btn btn-success" onclick="updateAll()">Update All</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var person in Model.ProjectPersonnel.Select(px => px.PersonNavigation).OrderBy(p => p.Surname))
                        {
                            <tr>
                                <td class="name-column sticky-col">@($"{person.Surname}, {person.Name}")</td>
                                @foreach (var wp in orderedWorkPackages)
                                {
                                    bool isAssigned = Model.WorkPackagePersonnel.Any(wpx => wpx.Wp == wp.Id && wpx.Person == person.Id);
                                    <td class="wp-column">
                                        <input class="wp-checkbox" type="checkbox"
                                        @(isAssigned ? "checked" : "")
                                               data-checked-original="@(isAssigned ? "true" : "false")"
                                               data-wp-id="@wp.Id"
                                               data-person-id="@person.Id" />
                                    </td>
                                }
                                <td class="action-column">
                                    <button onclick="removeFromProject(@person.Id)" class="btn btn-danger">Remove</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>






    @section Scripts {
        <script>
            document.getElementById('personnelSelect').addEventListener('change', function () {
                var personId = this.value;
                fetchPersonDetails(personId);
            });

                function filterPersonnel() {
                    var searchTerm = document.getElementById('searchTerm').value;

                    $.ajax({
                        url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                        data: { searchTerm: searchTerm },
                        success: function (data) {
                            var resultsDiv = document.getElementById('searchResults');
                            resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                            // Asume que el servidor ya limita los resultados a 10
                            data.forEach(function (person, index) {
                                if (index < 10) { // Esta comprobación es redundante si el servidor limita los resultados
                                    var personDiv = document.createElement('div');
                                    personDiv.className = 'person-result';
                                    personDiv.textContent = person.name + ' ' + person.surname;
                                    personDiv.setAttribute('data-person-id', person.id);

                                    personDiv.onclick = function () {
                                        // Marcar el resultado seleccionado como activo y limpiar los demás
                                        document.querySelectorAll('.person-result').forEach(function (el) {
                                            el.classList.remove('active');
                                        });
                                        this.classList.add('active');

                                        fetchPersonDetails(person.id);
                                    };

                                    resultsDiv.appendChild(personDiv);
                                }
                            });
                        }
                    });
                    document.getElementById('searchResults').style.display = 'block';
                }

                function fetchPersonDetails(personId) {
                    $.ajax({
                        url: '@Url.Action("GetPersonDetails", "Personnels")',
                        data: { id: personId },
                        success: function (response) {
                            var detailsDiv = document.getElementById('personDetails');
                            detailsDiv.innerHTML = '';
                            if (response.success) {
                                var data = response.data;
                                detailsDiv.innerHTML = `<div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.5em;">${data.fullName || ''}</h5>
                                    <p><span class="card-detail-label">Affiliation:</span> ${data.affiliation || ''}</p>
                                    <p><span class="card-detail-label">Department:</span> ${data.departmentName || ''}</p>
                                    <p><span class="card-detail-label">Group:</span> ${data.personnelGroupName || ''}</p>
                                    <p><span class="card-detail-label">Group Leader:</span> ${data.responsiblePerson || ''}</p>
                                    <p><span class="card-detail-label">Category:</span> ${data.category || ''}</p>
                                    <p><span class="card-detail-label">Contract Start:</span> ${data.startDate || ''}</p>
                                    <p><span class="card-detail-label">Contract End:</span> ${data.endDate || ''}</p>
                                                    <div class="text-align: center">
                                        <button onclick="addToProject(${personId})" class="btn btn-primary" style="margin-right: 50px;">Add to Project</button>
                                        <!-- El botón de Eliminar se añadirá aquí, condicionalmente -->
                                    </div>
                                </div>`;
                            } else {
                                detailsDiv.innerHTML = '<p>Person details not found.</p>';
                            }
                        }
                    });
                }


            function addToProject(personId) {
                var projectId = @Model.ProjectDetails.ProjId;
                $.ajax({
                    url: '@Url.Action("AddPersonToProject", "Projects")', // Asegúrate de que este endpoint y el nombre del controlador son correctos
                    type: 'POST',
                    data: { projectId: projectId, personId: personId },
                    success: function (response) {
                        if (response.success) {
                            // Aquí puedes agregar una notificación o actualizar la vista como necesites
                            alert(response.message);
                            location.reload();
                        } else {
                        alert(response.message);
                        }
                    }
                });
            }

            function removeFromProject(personId) {
                var projectId = @Model.ProjectDetails.ProjId;
                if (confirm("Are you sure you want to remove this person from the project?")) {
                    $.ajax({
                        url: '@Url.Action("RemovePersonFromProject", "Projects")', // Cambia el nombre del controlador y la acción según tu configuración
                        type: 'POST',
                        data: { projectId: projectId, personId: personId },
                        success: function (response) {
                            if (response.success) {
                                alert("Person removed from the project successfully.");
                                location.reload();
                            } else {
                                alert("There was a problem removing the person from the project.");
                            }
                        }
                    });
                }
            }

            function updateAll() {
                var changes = [];
                document.querySelectorAll('.wp-checkbox').forEach(function (checkbox) {
                    var originalState = checkbox.getAttribute('data-checked-original') === 'true';
                    if (checkbox.checked !== originalState) {
                        changes.push({
                            WpId: parseInt(checkbox.getAttribute('data-wp-id')),
                            PersonId: parseInt(checkbox.getAttribute('data-person-id'))
                        });
                    }
                });

                // Envía esta lista al controlador
                $.ajax({
                    url: '@Url.Action("UpdateWorkPackageAssignments", "Projects")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(changes),
                    success: function (response) {
                        // Procesar la respuesta
                        if (response.success) {
                            alert("Work package assignments updated successfully.");
                            location.reload();
                        } else {
                            alert("There was a problem updating the assignments.");
                        }
                    },
                    error: function (error) {
                        // Manejar el error
                        alert("An error occurred while updating the assignments.");
                    }
                });
            }

                document.addEventListener('click', function (event) {
                    var searchResults = document.getElementById('searchResults');
                    var searchTerm = document.getElementById('searchTerm');
                    if (!searchResults.contains(event.target) && !searchTerm.contains(event.target)) {
                        searchResults.style.display = 'none'; // Contraer la lista
                    }
                });

                document.getElementById('searchResults').addEventListener('click', function (event) {
                    if (event.target && event.target.matches('div.person-result')) {
                        var personName = event.target.textContent;
                        var personnelSelect = document.getElementById('personnelSelect');
                        // Actualiza el selector con el nombre de la persona seleccionada
                        personnelSelect.value = '';
                        personnelSelect.options[personnelSelect.options.length] = new Option(personName, event.target.getAttribute('data-person-id'), true, true);
                        // Contraer la lista después de seleccionar una persona
                        document.getElementById('searchResults').style.display = 'none';
                        // Opcional: Llama a fetchPersonDetails si necesitas cargar detalles en la tarjeta de detalles
                        fetchPersonDetails(event.target.getAttribute('data-person-id'));
                    }
                });

                
        </script>
    }

<style>
     .project-personnel-wrapper {
         max-height: 600px;
         overflow: auto;
         border: 1px solid #ccc;
         position: relative;
         background-color: white;
     }

     .sticky-table {
         border-collapse: separate;
         border-spacing: 0;
         width: max-content;
         min-width: 100%;
     }

         .sticky-table th,
         .sticky-table td {
             min-width: 120px;
             padding: 8px;
             text-align: center;
             border: 1px solid #dee2e6;
             background-color: white;
         }

         .sticky-table .sticky-header {
             position: sticky;
             top: 0;
             background-color: var(--blue-dark);
             color: white;
             z-index: 10;
         }

         .sticky-table .sticky-col {
             position: sticky;
             left: 0;
             background-color: #f8f9fa;
             z-index: 9;
         }

         .sticky-table .sticky-header.sticky-col {
             z-index: 11;
             background-color: #003366;
             color: white;
         }

     .name-column {
         min-width: 200px;
         max-width: 250px;
         font-weight: bold;
     }

     .wp-column {
         min-width: 60px;
         max-width: 80px;
     }

     .action-column {
         min-width: 100px;
         background-color: #f8f9fa;
     }

     .wp-checkbox {
         width: 25px;
         height: 25px;
         cursor: pointer;
         margin: auto;
         display: block;
     }

     .card-header {
         background-color: #005A9C;
         color: #FFFFFF;
         text-align: center;
         font-weight: bold;
         font-size: 24px;
     }

     .my-style {
         font-size: 2.5rem;
         font-weight: bold;
         color: #0056b3;
         text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
     }

     .detail-item:not(:last-child) {
         border-bottom: 1px solid #dee2e6;
         padding-bottom: 5px;
         margin-bottom: 5px;
     }
</style>











----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Projects\ProjectReport.cshtml -----
@model TRS2._0.Models.ViewModels.ReportPeriodViewModel

@{
    ViewData["Title"] = "ProjectReport";
    // Inicializa las sumas de las columnas
    decimal totalEstimated = 0;
    decimal totalDistributed = 0;
    decimal totalCovered = 0;
    // Asume valores predeterminados o maneja el caso de null según sea necesario
    var startProject = Model.Project.Start ?? DateTime.Today; // Usar la fecha actual como valor por defecto
    var endProject = Model.Project.EndReportDate; // Usar la fecha actual como valor por defecto    
    int index = 1; // Inicializa el contador
    
}
<script src="~/lib/jquery/dist/jquery.min.js"></script>




<div class="container mt-3">
    <div class="row">
        <!-- Encapsula los detalles del proyecto en una tarjeta -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    Project Details
                </div>
                <div class="card-body">
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Acronym</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Acronim)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Title</dt>
                            <dd class="col-sm-8">@Html.DisplayFor(model => model.Project.Title)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Contract</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Contract)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Start Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.Project.Start.HasValue ? Model.Project.Start.Value.ToString("dd-MM-yyyy") : string.Empty)</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">End Date</dt>
                            <dd class="col-sm-8 d-inline-block">@(Model.Project.EndReportDate.ToString("dd-MM-yyyy"))</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Investigator</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PiFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Project Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.PmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Finance Manager</dt>
                            <dd class="col-sm-8 d-inline-block">@ViewBag.FmFullName</dd>
                        </div>
                    </dl>
                    <dl class="row detail-item">
                        <div class="row detail-item">
                            <dt class="col-sm-4 text-sm-right">Type</dt>
                            <dd class="col-sm-8 d-inline-block">@Html.DisplayFor(model => model.Project.Type)</dd>
                        </div>
                    </dl>

                    <!-- Tarjeta para Third Parties -->
                    <div class="card mt-4">
                        <div style="text-align: center; background-color: black; color: white; font-size: 24px; font-weight: bold;">
                            Third Parties
                        </div>

                        <div class="card-body">
                            <div class="row">
                                <!-- Cada tick en su propia columna dentro de esta fila -->
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="upcCheck" disabled @((Model.Project.TpsUpc == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="upcCheck">UPC</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="icreaCheck" disabled @((Model.Project.TpsIcrea == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="icreaCheck">ICREA</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="csicCheck" disabled @((Model.Project.TpsCsic == 1) ? "checked" : "")>
                                        <label class="form-check-label" for="csicCheck">CSIC</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header" style="text-align: center;">
                    Work Packages Details
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="text-align: center; background-color: black; color: white;">Name</th>
                                <th style="text-align: center; background-color: black; color: white;">Estimated</th>
                                <th style="text-align: center; background-color: black; color: white;">Distributed</th>
                                <th style="text-align: center; background-color: black; color: white;">Covered with Personnel</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var wp in ViewBag.WpDetails)
                            {
                                // Calcula las sumas de las columnas
                                totalEstimated += Convert.ToDecimal(wp.Pms);
                                totalDistributed += Convert.ToDecimal(wp.Distributed);
                                totalCovered += Convert.ToDecimal(wp.Covered);

                                // Determina la clase para la fila según las condiciones
                                string rowClass = "";
                                string textStyle = "";
                                if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed == wp.Covered)
                                {
                                    rowClass = "table-success"; // Fondo verde claro
                                    textStyle = "text-success font-weight-bold"; // Texto verde oscuro y en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) == wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else if (Convert.ToDecimal(wp.Pms) != wp.Distributed && wp.Distributed != wp.Covered && Convert.ToDecimal(wp.Pms) != wp.Covered)
                                {
                                    rowClass = "table-warning"; // Fondo naranja claro
                                    textStyle = "font-weight-bold"; // Todo en negrita
                                }
                                else
                                {
                                    rowClass = "table-light"; // Fondo amarillo claro
                                                              // No se aplica una clase de texto específica aquí; se manejará individualmente
                                }

                                <tr class="@rowClass">
                                    <td class="centered" style="text-align: center;">@wp.Name</td>
                                    <td class="centered" style="text-align: center;">@wp.Pms</td>
                                    <td class="centered" style="text-align: center;">@wp.Distributed</td>
                                    <td class="centered" style="text-align: center;">@wp.Covered</td>
                                </tr>
                            }
                            <!-- Fila de Total -->
                            <tr class="table-primary">
                                <th style="text-align: center; background-color: black; color: white;">Total</th>
                                <td class="centered bold" style="text-align: center;">@totalEstimated</td>
                                <td class="centered bold" style="text-align: center;">@totalDistributed</td>
                                <td class="centered bold" style="text-align: center;">@totalCovered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>
    <hr />
<div class="container mt-3">
    @if (Model.ReportPeriods.Any())
    {
        <div class="card mt-4">
            <div class="card-header" style="text-align: center; background-color: black; color: white;">
                Report Periods Details
            </div>
            <div class="card-body">
                    <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: center; background-color: black; color: white;">Reporting Period</th>
                            <th style="text-align: center; background-color: black; color: white;">Period Date</th>
                            <th style="text-align: center; background-color: black; color: white;">Period in Months</th>
                            <th style="text-align: center; background-color: black; color: white;">Actions</th>
                        </tr>
                    </thead>
                    @foreach (var reportPeriod in Model.ReportPeriods)
                    {
                        int startMonth = ((reportPeriod.StartDate.Year - Model.Project.Start.Value.Year) * 12) + reportPeriod.StartDate.Month - Model.Project.Start.Value.Month + 1;
                        int endMonth = ((reportPeriod.EndDate.Year - Model.Project.Start.Value.Year) * 12) + reportPeriod.EndDate.Month - Model.Project.Start.Value.Month + 1;
                        <tr>
                            <td class="periodo" data-periodo-id="@reportPeriod.Id" style="text-align: center;" data-index="@index">
                                <button type="button" class="btn btn-primary btn-block font-weight-bold">@($"P {index}")</button>
                            </td>
                            <td style="text-align: center;">@reportPeriod.StartDate.ToString("dd-MM-yyyy") / @reportPeriod.EndDate.ToString("dd-MM-yyyy")</td>
                            <td style="text-align: center;">M @startMonth / M @endMonth</td>
                            <td style="text-align: center;">
                                <button type="button" class="btn btn-danger" onclick="deleteReportPeriod(@reportPeriod.Id)">Delete</button>
                            </td>
                        </tr>
                        index++;
                    }
                </table>
            </div>
        </div>
        <hr />
    }else{
        <div class="alert alert-warning" role="alert">
            No report periods have been added yet.
        </div>
    }
        <div class="text-center my-3">
    <div id="reportPeriodsSection"></div>
    <button type="button" class="btn btn-primary" id="addReportPeriodBtn" onclick="loadReportPeriodForm()">Add Reporting Periods</button>
    <button type="button" class="btn btn-secondary" id="cancelReportPeriodBtn" onclick="cancelReportPeriodForm()" style="display:none;">Cancel</button>
            <div class="card mt-4">
                <div class="card-header bg-dark text-white text-center">
                    Export Options
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4 d-flex align-items-center">
                            <label for="manualDate" class="mb-0 mr-2 font-weight-bold">Manual Date:</label>
                            <input type="date" id="manualDate" class="form-control ml-2" />
                        </div>

                        <div class="col-md-4 d-flex align-items-center">
                            <label for="manualCode" class="mb-0 ml-3 mr-2 font-weight-bold">Manual Code:</label>
                            <input type="text" id="manualCode" class="form-control ml-2"/>
                        </div>
                    </div>


                    <div class="row text-center">
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportDeclaredHoursBtn" onclick="exportDeclaredHoursToCSV()" style="display:none;">
                                Export Declared Hours
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportEstimatedHoursBtn" onclick="exportEstimatedHoursToCSV()" style="display:none;">
                                Export Estimated Hours
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMsBtn" onclick="exportPMsToCSV()" style="display:none;">
                                Export PMs
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforWPToCSV" onclick="exportPMSforWPToCSV()" style="display:none;">
                                Export PMs per WP
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforAuditoria" onclick="exportPMSforAuditoriaToCSV()" style="display:none;">
                                Export Audit PMs
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportPMSforWPToCSVBtn" onclick="exportPMSAuditByWPToCSV()" style="display:none;">
                                Export Audit PMs per WP
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button" class="btn btn-success btn-block btn-smaller-text" id="exportWorkedDaysBtn" onclick="exportWorkedDaysToCSV()" style="display:none;">
                                Export Worked Days
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="button"
                                    class="btn btn-success btn-block btn-smaller-text"
                                    id="exportEstimatedDaysBtn"
                                    onclick="exportEstimatedWorkedDaysToCSV()"
                                    style="display:none;">
                                Export Estimated Days
                            </button>
                        </div>
                    </div>
                </div>
            </div>
</div>





</div>
</div>
<div id="detallesPeriodoContainer" class="table-container-period"></div>


<script>
      // Helper para limpiar textos de celdas (quita botones/etiquetas UI)
    function cleanCellText(col) {
        // Texto plano sin saltos
        let txt = col.innerText.replace(/(\r\n|\n|\r)/gm, ' ').trim();

        // Quitar etiquetas/botones habituales
        txt = txt
          .replace(/\b(Lock All|Reopen All|Lock|Reopen|Timesheet)\b/gi, '')
          .replace(/\s{2,}/g, ' ') // espacios dobles
          .trim();

        return txt;
    }


    $(document).ready(function () {
        $(document).on('click', '.periodo', function () {
            var periodoId = $(this).data('periodo-id');
            var projectId = @ViewBag.projId;
            var startDate = $(this).closest('tr').find('td:nth-child(2)').text().split(' / ')[0];
            var endDate = $(this).closest('tr').find('td:nth-child(2)').text().split(' / ')[1];

            $.ajax({
                url: '/Projects/PeriodDetails',
                data: { id: periodoId, projectId: projectId },
                success: function (data) {
                    $('#detallesPeriodoContainer').html(data);
                    $('#detallesPeriodoContainer').show();
                    // $('#exportHoursBtn').show(); // Mostrar el botón de exportar horas
                    $('#exportPMsBtn').show(); // Mostrar el botón de exportar PMs
                    $('#exportPMSforWPToCSV').show(); // Mostrar el botón de exportar PMs por WP
                    $('#exportPMSforAuditoria').show(); // Mostrar el botón de exportar PMs Auditoria
                    $('#exportDeclaredHoursBtn').show(); // Mostrar el botón de exportar horas declaradas
                    $('#exportEstimatedHoursBtn').show(); // Mostrar el botón de exportar horas estimadas
                    $('#exportPMSforWPToCSVBtn').show(); // Mostrar el botón de exportar PMs Auditoria por WP
                    $('#exportWorkedDaysBtn').show(); //Mostrar el botón de exportar días trabajados
                    $('#exportEstimatedDaysBtn').show(); // Mostrar el botón de exportar días estimados


                    // Guardar las fechas del periodo seleccionado
                    $('#exportPMSforWPToCSV').data('start-date', startDate);
                    $('#exportPMSforWPToCSV').data('end-date', endDate);
                }
            });
        });
    });




    function loadReportPeriodForm() {
        $.ajax({
            url: '@Url.Action("ReportPeriodForm", "Projects", new { projId = ViewBag.projId })',
            type: 'GET',
            success: function (result) {
                $('#reportPeriodsSection').html(result);
                $('#addReportPeriodBtn').hide(); // Oculta el botón de añadir
                $('#cancelReportPeriodBtn').show(); // Muestra el botón de cancelar
            }
        });
    }

    function cancelReportPeriodForm() {
        $('#reportPeriodsSection').html(''); // Limpia la sección de la vista parcial
        $('#cancelReportPeriodBtn').hide(); // Oculta el botón de cancelar
        $('#addReportPeriodBtn').show(); // Muestra nuevamente el botón de "Add Reporting Periods"
    }

    function deleteReportPeriod(id) {
        if (confirm('Are you sure you want to delete this period?')) {
            $.post('/Projects/DeleteReportPeriod', { id: id }, function (data) {
                if (data.success) {
                    alert('Report period deleted successfully.');
                    // Actualizar la vista o recargar la página aquí si es necesario
                    location.reload();
                } else {
                    alert(data.message || 'An error occurred.');
                }
            });
        }
    }   

    function exportHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var declaredHours = col.getAttribute('data-declared-hours');
                var hoursInProject = col.getAttribute('data-hours-in-project');
                if (declaredHours && hoursInProject) {
                    rowData.push(`${declaredHours.replace('.', ',')} | ${hoursInProject.replace('.', ',')}`);
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_periodo.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

      function exportDeclaredHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col, colIdx) {
                var declaredHours = col.getAttribute('data-declared-hours');

                if (declaredHours) {
                    // Si hay atributo con el dato limpio, úsalo
                    rowData.push(declaredHours.replace('.', ','));
                } else {
                    // Si no, limpiamos el texto de la celda (quitando Lock/Reopen/etc.)
                    var txt = cleanCellText(col);

                    // Si quieres, limita la primera columna a “Nombre Apellidos” sin más adornos:
                    // if (colIdx === 0) { ... }  // opcional si en la primera columna es donde salen esos botones

                    rowData.push(txt.replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_declaradas.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportEstimatedHoursToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var hoursInProject = col.getAttribute('data-hours-in-project');
                if (hoursInProject) {
                    rowData.push(hoursInProject.replace('.', ','));
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "horas_estimadas.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function exportPMsToCSV() {
        var csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        var rows = document.querySelectorAll('#detallesPeriodoContainer table tr');

        rows.forEach(function (row) {
            var cols = row.querySelectorAll('th, td');
            var rowData = [];
            cols.forEach(function (col) {
                var totalEffort = col.getAttribute('data-total-effort');
                if (totalEffort) {
                    rowData.push(totalEffort.replace('.', ','));
                } else {
                    rowData.push(col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim().replace('.', ','));
                }
            });
            csvContent += rowData.join(";") + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "PMs_periodo.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function exportPMSforWPToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsperWPtoCSV", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsPerWP_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }

    function exportPMSforAuditoriaToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsAuditoria", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsAuditoria_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }  
    
    function exportPMSAuditByWPToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        // Verificar los valores antes de enviarlos
        console.log("Project ID:", projectId);
        console.log("Start Date (ISO):", startDateISO);
        console.log("End Date (ISO):", endDateISO);

        fetch('@Url.Action("ExportPmsAuditoriaByWP", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ProjectId: projectId, StartDate: startDateISO, EndDate: endDateISO })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `PMsAuditByWP_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error:', error));
    }

        function exportWorkedDaysToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir las fechas al formato ISO 8601 (yyyy-MM-dd)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        fetch('@Url.Action("ExportWorkedDaysToCSV", "Projects")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ProjectId: projectId,
                StartDate: startDateISO,
                EndDate: endDateISO
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `WorkedDays_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => console.error('Error exporting Worked Days:', error));
    }

        function exportEstimatedWorkedDaysToCSV() {
        var projectId = @ViewBag.projId;
        var startDate = $('#exportPMSforWPToCSV').data('start-date');
        var endDate = $('#exportPMSforWPToCSV').data('end-date');

        // Convertir dd-MM-yyyy → yyyy-MM-dd (ISO)
        var startDateISO = new Date(startDate.split('-').reverse().join('-')).toISOString().split('T')[0];
        var endDateISO   = new Date(endDate.split('-').reverse().join('-')).toISOString().split('T')[0];

        fetch('@Url.Action("ExportEstimatedWorkedDaysToCSV", "Projects")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ProjectId: projectId,
                StartDate: startDateISO,
                EndDate: endDateISO
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.blob();
        })
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `EstimatedWorkedDays_${projectId}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => console.error('Error exporting Estimated Worked Days:', error));
    }


</script>



    <style>
        .periodo {
            cursor: pointer; /* Cambia el cursor a una mano para indicar que es clicable */
            color: blue; /* Cambia el color del texto a azul */
            text-decoration: none; /* Asegura que inicialmente no esté subrayado */
        }

            .periodo:hover {
                text-decoration: underline; /* Subraya el texto al pasar el ratón por encima */
            }

        .table-hover tbody tr:hover {
            background-color: #f5f5f5; /* Cambia este color según tus preferencias */
        }

    .table-container-period {
        max-width: 1600px;
        margin: 0 auto; /* Centra la tabla horizontalmente */
    }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    .card-header {
        background-color: #005A9C; /* Azul oscuro, ajusta el código de color según tu logo */
        color: #FFFFFF; /* Blanco */
        text-align: center;
        font-weight: bold;
        /* Otros estilos que desees mantener, como el padding, etc. */
    }

    .wp-checkbox {
        width: 25px; /* Tamaño del checkbox */
        height: 25px; /* Tamaño del checkbox */
        cursor: pointer; /* Cambia el cursor a mano al pasar sobre el checkbox */
        margin: auto; /* Centra el checkbox en la celda */
    }
    
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 2; /* Asegura que el encabezado se mantenga sobre el contenido desplazable */
    }

    .sticky-name-header {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 4; /* Asegura que la cabecera fija esté sobre el contenido desplazable */
    }

    .card-header {
        font-size: 24px; /* Aumenta el tamaño del texto */
        font-weight: bold; /* Texto en negrita */
        text-align: center; /* Texto centrado */
    }

    .my-style {
        font-size: 2.5rem; /* Ajusta el tamaño de la fuente */
        font-weight: bold;
        color: #0056b3; /* Cambia al color que prefieras */
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* Añade una ligera sombra */
    }

    .btn-smaller-text {
        font-size: 0.85rem; /* Reduce un poco el tamaño del texto */
        padding-left: 10px;
        padding-right: 10px;
        white-space: nowrap; /* Evita el salto de línea */
    }

    #manualDate {
        min-width: 150px;
    }

    .card-header {
        font-size: 20px;
    }

    .btn-block {
        white-space: nowrap;
    }
    </style>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_DetallesPeriodo.cshtml -----
@model TRS2._0.Models.ViewModels.PeriodDetailsViewModel
@using System.Globalization

<div class="table-wrapper-custom table-responsive mx-3 mb-4">
    <table class="table table-bordered table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th class="nombre-columna text-center sticky-header sticky-col align-middle">
                    <div>Nombre</div>

                    <!-- Botones principales -->
                    <div class="d-flex justify-content-center gap-2 mt-2 mb-1 flex-wrap">
                        <button id="lockAllButton" class="btn btn-success btn-sm">Lock All</button>
                        <button id="reopenAllButton" class="btn btn-danger btn-sm">Reopen All</button>
                    </div>

                    <!-- Dropdown de acciones -->
                    <div class="dropdown mt-1">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="actionDropdown">
                            <li><a class="dropdown-item" href="#" id="lockSelectedButton">Lock Selected</a></li>
                            <li><a class="dropdown-item" href="#" id="reopenSelectedButton">Reopen Selected</a></li>
                            <li><a class="dropdown-item" href="#" id="downloadTimesheetsButton">Download Timesheets</a></li>
                        </ul>
                    </div>
                </th>
                @foreach (var monthDetail in Model.MonthDetails)
                {
                    <th class="nombre-mes text-center sticky-header">
                        <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center; font-weight: bold;">@monthDetail.Key</div>
                        <div style="text-align: center; font-weight: bold;">@monthDetail.Value</div>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var person in Model.Persons.OrderBy(p => p.Personnel.Surname))
            {
                <tr>
                    <td class="font-weight-bold sticky-col">
                        @person.Personnel.Surname, @person.Personnel.Name
                        <div class="mt-2 d-flex flex-row justify-content-center gap-2">
                            <button class="btn btn-outline-success btn-sm lock-person-btn"
                                    data-personid="@person.Personnel.Id"
                                    data-projectid="@ViewBag.ProjectId"
                                    data-periodid="@ViewBag.PeriodId">
                                Lock
                            </button>
                            <button class="btn btn-outline-danger btn-sm unlock-person-btn"
                                    data-personid="@person.Personnel.Id"
                                    data-projectid="@ViewBag.ProjectId"
                                    data-periodid="@ViewBag.PeriodId">
                                Reopen
                            </button>
                        </div>
                    </td>

                    @foreach (var monthDetail in Model.MonthDetails)
                    {
                        var monthDate = DateTime.Parse(monthDetail.Value);
                        var hasLoginInv = false;
                        var hasLoginResp = false;
                        string loginInvDate = null;
                        string loginRespDate = null;

                        if (person.LoginStatusByMonth != null && person.LoginStatusByMonth.TryGetValue(monthDate, out var logins))
                        {
                            hasLoginInv = !string.IsNullOrWhiteSpace(logins.InvestigatorDate);
                            hasLoginResp = !string.IsNullOrWhiteSpace(logins.ResponsibleDate);
                            loginInvDate = logins.InvestigatorDate;
                            loginRespDate = logins.ResponsibleDate;
                        }


                        decimal declaredHours = person.DeclaredHours.ContainsKey(monthDate) ? person.DeclaredHours[monthDate] : 0;
                        decimal hoursInProject = person.HoursinProyect.ContainsKey(monthDate) ? person.HoursinProyect[monthDate] : 0;
                        decimal completionPercentage = person.CompletionPercentage.ContainsKey(monthDate) ? person.CompletionPercentage[monthDate] : 0;
                        decimal totalEffort = person.TotalEffortinProyect.ContainsKey(monthDate) ? person.TotalEffortinProyect[monthDate] : 0;
                        int personnelId = person.Personnel.Id;
                        int year = monthDate.Year;

                        var statusKey = $"{monthDate.Year}-{monthDate.Month:D2}";
                        var status = person.PersonStatusByMonth.ContainsKey(statusKey) ? person.PersonStatusByMonth[statusKey] : (OutOfContract: false, Overloaded: false);
                        var isLocked = person.LockStatusByMonth.ContainsKey(statusKey) && person.LockStatusByMonth[statusKey];
                        var backgroundColor = status.OutOfContract ? "#FF8C00" : (status.Overloaded ? "#FFFF00" : "");

                        <td class="position-relative"
                            style="background-color: @backgroundColor; padding: 4px; vertical-align: top;"
                            data-declared-hours="@declaredHours"
                            data-hours-in-project="@hoursInProject"
                            data-total-effort="@totalEffort"
                            personId="@personnelId"
                            year="@year"
                            data-month="@monthDate.Month">

                            @* ✅ Solo mostrar checkbox si NO está "Out of Contract" *@
                            @if (!status.OutOfContract)
                            {
                                <input type="checkbox"
                                       class="cell-checkbox"                                       
                                       data-personid="@personnelId"
                                       data-year="@year"
                                       data-month="@monthDate.Month"
                                       data-projectid="@ViewBag.ProjectId"
                                       data-islocked="@isLocked.ToString().ToLower()" />

                            }

                            <!-- I / R en la esquina superior derecha -->
                            <div class="cell-flags" title="I=@(loginInvDate ?? "—") · R=@(loginRespDate ?? "—")">
                                <span>I: <span class="icon @(hasLoginInv ? "ok" : "ko")">@(hasLoginInv ? "✔" : "✖")</span></span>
                                <span>R: <span class="icon @(hasLoginResp ? "ok" : "ko")">@(hasLoginResp ? "✔" : "✖")</span></span>
                            </div>


                            <div class="d-flex justify-content-center align-items-center" style="flex-grow: 1; font-size: 0.875rem; font-weight:bold;">
                                <span>@declaredHours | @hoursInProject</span>
                            </div>

                            @if (status.OutOfContract)
                            {
                                <div class="text-center mt-2" style="width: 100%; font-weight:bold; white-space: nowrap;">Out of Contract</div>
                            }
                            else
                            {
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: @(completionPercentage.ToString("0"))%;" aria-valuenow="@completionPercentage" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="text-center" style="font-size: 0.75rem;">@completionPercentage%</div>
                            }

                            @if (!status.OutOfContract)
                            {
                                @if (isLocked)
                                {
                                    <div class="button-container mt-2">
                                        <button class="btn btn-danger w-100 unlock-button"
                                                onclick="updateLockStatus('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId', '@ViewBag.PeriodId', '/Projects/Unlock')">
                                            Desbloquear
                                        </button>
                                        <a href="javascript:void(0);" class="btn btn-info w-100 mt-2"
                                           onclick="exportTimesheetWithDate('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId')">
                                            Timesheet
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <button class="btn btn-success w-100 mt-2 lock-button"
                                            onclick="updateLockStatus('@person.Personnel.Id', '@monthDate.Year', '@monthDate.Month', '@ViewBag.ProjectId', '@ViewBag.PeriodId', '/Projects/Lock')">
                                        Bloquear
                                    </button>
                                }
                            }
                        </td>

                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    .nombre-columna {
        min-width: 250px; /* Ajusta según necesites */
        max-width: 350px;

    }

    .nombre-mes{
        min-width: 130px; /* Ajusta según necesites */
        max-width: 175px;
    }

    .table-container-period {
        max-height: 800px; /* Ajusta esto según la altura deseada */
        overflow-y: auto;
        overflow-x: auto; /* Habilita el scroll horizontal */
        max-width: 1200px; /* Ancho máximo para la tabla */
        margin: 0 auto; /* Centra la tabla horizontalmente */
    }

        .table td {
            max-width: 100px; /* Ancho máximo para las columnas */
            max-height: 100px; /* Altura máxima para las filas */
            overflow: hidden; /* Oculta el contenido que exceda el tamaño */
            text-overflow: ellipsis; /* Añade puntos suspensivos al contenido que exceda el tamaño */
            white-space: nowrap; /* Evita que el texto se divida en varias líneas */
        }

    .button-container {
        display: flex;
        flex-direction: column;
    }

        .button-container .btn {
            margin-bottom: 5px; /* Espacio entre los botones */
        }

    .table-wrapper-custom {
        max-height: 700px;
        overflow: auto;
        position: relative;
        border: 1px solid #ccc;
    }

    table {
        border-collapse: separate !important;
        border-spacing: 0;
        width: max-content;
        min-width: 100%;
    }

    th,
    td {
        min-width: 120px;
        max-width: 300px;
        white-space: nowrap;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background-color: #343a40 !important; /* el fondo oscuro del thead */
        color: white;
        z-index: 10;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 9;
    }

    .sticky-header.sticky-col {
        z-index: 11;
    }

    .cell-checkbox {
        transform: scale(1.4); /* Tamaño ligeramente más grande */
        accent-color: #007bff; /* Color visible en blanco */
        border: 1px solid #333; /* Borde más marcado */
        margin-top: 2px;
        margin-left: 2px;
    }

    .cell-flags {
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: .8rem;
        font-weight: 700;
        display: flex;
        gap: 8px;
    }

    .icon.ok {
        color: #28a745;
    }
    /* verde */
    .icon.ko {
        color: #dc3545;
    }
    /* rojo  */

</style>



<script>
    document.body.addEventListener('click', function (event) {
        if (event.target.matches('#lockAllButton')) {
            console.log("🔒 Botón 'Lock All' presionado.");
            var lockButtons = document.querySelectorAll('.lock-button');

            if (lockButtons.length === 0) {
                console.log("⚠️ No hay botones de bloqueo disponibles.");
                return;
            }

            lockButtons.forEach(button => {
                console.log("🔒 Ejecutando bloqueo en:", button);
                button.click();
            });
        }

        if (event.target.matches('#reopenAllButton')) {
            console.log("🔓 Botón 'Reopen All' presionado.");
            var unlockButtons = document.querySelectorAll('.unlock-button');

            if (unlockButtons.length === 0) {
                console.log("⚠️ No hay botones de desbloqueo disponibles.");
                return;
            }

            unlockButtons.forEach(button => {
                console.log("🔓 Ejecutando desbloqueo en:", button);
                button.click();
            });
        }
    });

        function updateLockStatus(personId, year, month, projectId, periodId, actionUrl) {
        console.log("Updating lock status:", { personId, year, month, projectId, periodId, actionUrl });

        document.getElementById('loadingOverlay').style.display = 'flex';

        // Guardar scroll de la página
        const windowScrollTop = document.documentElement.scrollTop || document.body.scrollTop;

        // Guardar scroll interno del contenedor
        const oldContainer = document.getElementById('detallesPeriodoContainer');
        const containerScrollTop = oldContainer ? oldContainer.scrollTop : 0;
        const containerScrollLeft = oldContainer ? oldContainer.scrollLeft : 0;

        var data = { personId: personId, projectId: projectId, year: year, month: month };

        $.ajax({
            url: actionUrl,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                if (response.success) {
                    $.ajax({
                        url: '/Projects/PeriodDetails',
                        data: { id: periodId, projectId: projectId },
                        success: function (partialViewResult) {
                            $('#detallesPeriodoContainer').html(partialViewResult);

                            // Esperar al repaint completo del DOM antes de restaurar el scroll
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    const newContainer = document.getElementById('detallesPeriodoContainer');
                                    if (newContainer) {
                                        newContainer.scrollTop = containerScrollTop;
                                        newContainer.scrollLeft = containerScrollLeft;
                                    }

                                    // Restaurar scroll global de la ventana
                                    window.scrollTo({ top: windowScrollTop, behavior: 'instant' });
                                });
                            });
                        },
                        complete: function () {
                            document.getElementById('loadingOverlay').style.display = 'none';
                        }
                    });
                } else {
                    alert('No se pudo actualizar el estado de bloqueo.');
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            },
            error: function (error) {
                console.log(error);
                alert('Ocurrió un error al intentar actualizar el estado de bloqueo.');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    }

            


        document.body.addEventListener('click', function (event) {
        // Lock all cells of a person
        if (event.target.matches('.lock-person-btn')) {
            const personId = event.target.dataset.personid;
            const projectId = event.target.dataset.projectid;
            const periodId = event.target.dataset.periodid;

            const cells = document.querySelectorAll(`td[personId="${personId}"]`);
            cells.forEach(cell => {
                const year = cell.getAttribute('year');
                const month = cell.getAttribute('data-month');
                const isOutOfContract = cell.innerHTML.includes('Out of Contract');
                const isAlreadyLocked = cell.querySelector('.unlock-button') !== null;

                if (!isOutOfContract && !isAlreadyLocked) {
                    updateLockStatus(personId, year, month, projectId, periodId, '/Projects/Lock');
                }
            });
        }

        // Unlock all cells of a person
        if (event.target.matches('.unlock-person-btn')) {
            const personId = event.target.dataset.personid;
            const projectId = event.target.dataset.projectid;
            const periodId = event.target.dataset.periodid;

            const cells = document.querySelectorAll(`td[personId="${personId}"]`);
            cells.forEach(cell => {
                const year = cell.getAttribute('year');
                const month = cell.getAttribute('data-month');
                const isOutOfContract = cell.innerHTML.includes('Out of Contract');
                const isLocked = cell.querySelector('.unlock-button') !== null;

                if (!isOutOfContract && isLocked) {
                    updateLockStatus(personId, year, month, projectId, periodId, '/Projects/Unlock');
                }
            });
        }
    });

            document.body.addEventListener('click', async function (event) {
        if (event.target.id === 'lockSelectedButton' || event.target.id === 'reopenSelectedButton') {
            const isLock = event.target.id === 'lockSelectedButton';
            const action = isLock ? 'Lock' : 'Unlock';
            const actionUrl = `/Projects/${action}`;

            const selectedCheckboxes = document.querySelectorAll('.cell-checkbox:checked');
            const cellsToProcess = [];

            selectedCheckboxes.forEach(cb => {
                const td = cb.closest('td');
                const hasUnlockButton = td.querySelector('.unlock-button') !== null;
                const hasLockButton = td.querySelector('.lock-button') !== null;

                const shouldInclude =
                    (isLock && hasLockButton) ||
                    (!isLock && hasUnlockButton);

                if (shouldInclude) {
                    cellsToProcess.push({
                        personId: parseInt(cb.dataset.personid),
                        year: parseInt(cb.dataset.year),
                        month: parseInt(cb.dataset.month),
                        projectId: parseInt(@ViewBag.ProjectId),
                        periodId: parseInt(@ViewBag.PeriodId)
                    });
                }
            });

            if (cellsToProcess.length === 0) {
                alert("No hay celdas válidas seleccionadas para esta acción.");
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                for (const cell of cellsToProcess) {
                    await fetch(actionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cell)
                    });
                }

                // Recargar la vista parcial tras los cambios
                $.ajax({
                    url: '/Projects/PeriodDetails',
                    data: {
                        id: @ViewBag.PeriodId,
                        projectId: @ViewBag.ProjectId
                    },
                    success: function (partialViewResult) {
                        $('#detallesPeriodoContainer').html(partialViewResult);
                    },
                    error: function () {
                        alert("Error al recargar la tabla tras el bloqueo/desbloqueo.");
                    },
                    complete: function () {
                        document.getElementById('loadingOverlay').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Error al procesar los cambios.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
    });

        document.getElementById('downloadTimesheetsButton').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.cell-checkbox:checked');

        checkboxes.forEach(cb => {
            const td = cb.closest('td');
            const timesheetBtn = td.querySelector('.btn-info');

            if (timesheetBtn) {
                const personId = cb.dataset.personid;
                const year = cb.dataset.year;
                const month = cb.dataset.month;
                const projectId = @ViewBag.ProjectId;

                // Construir la URL y lanzar la descarga
                const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}`;
                window.open(url, '_blank');
            }
        });
    });

    function exportTimesheetWithDate(personId, year, month, projectId) {
    const manualDateEl = document.getElementById('manualDate');
    const manualDate = manualDateEl && manualDateEl.value
        ? `&manualDate=${encodeURIComponent(manualDateEl.value)}`
        : '';
    const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${manualDate}`;
    window.open(url, '_blank');
  }

  function getManualParams() {
    const dateEl = document.getElementById('manualDate');
    const codeEl = document.getElementById('manualCode');

    let query = '';
    if (dateEl && dateEl.value) {
      query += `&manualDate=${encodeURIComponent(dateEl.value)}`;
    }
    if (codeEl && codeEl.value && codeEl.value.trim().length > 0) {
      // No lo trates como número: puede llevar ceros a la izquierda o letras
      query += `&manualCode=${encodeURIComponent(codeEl.value.trim())}`;
    }
    return query;
  }

  // Botón individual de cada celda
  function exportTimesheetWithDate(personId, year, month, projectId) {
    const extra = getManualParams();
    const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${extra}`;
    window.open(url, '_blank');
  }

  // "Download Timesheets" (cabecera, múltiple)
  document.getElementById('downloadTimesheetsButton')?.addEventListener('click', function () {
    const checkboxes = document.querySelectorAll('.cell-checkbox:checked');
    const extra = getManualParams();

    checkboxes.forEach(cb => {
      const personId = cb.dataset.personid;
      const year = cb.dataset.year;
      const month = cb.dataset.month;
      const projectId = @ViewBag.ProjectId;

      const url = `/Timesheet/ExportTimesheetToPdf2?personId=${personId}&year=${year}&month=${month}&project=${projectId}${extra}`;
      window.open(url, '_blank');
    });
  });

</script>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_EffortBalanceTable.cshtml -----
@model TRS2._0.Models.ViewModels.PersonnelEffortPlanViewModel
@using TRS2._0.Models.DataModels

@if (ViewBag.SelectedWpId != null && ViewBag.EffortSumByMonth != null && ViewBag.FilteredProjectEfforts != null)
{
    var selectedWpId = ViewBag.SelectedWpId;
    var effortSumByMonth = ViewBag.EffortSumByMonth as Dictionary<DateTime, decimal>;
    var filteredProjectEfforts = ViewBag.FilteredProjectEfforts as List<Projeffort>;
    var months = effortSumByMonth.Keys.OrderBy(d => d).ToList();
    var wpName = Model.WorkPackages.FirstOrDefault(wp => wp.WpId == selectedWpId)?.WpName;
    <div class="unique-effort-balance-table">
        <table class="table table-striped table-dark effort-balance-table">
            <thead>
                <tr>
                    <th>Month</th>
                    @foreach (var month in months)
                    {
                        <th>@month.ToString("MMM yyyy")</th>
                    }
                </tr>
            </thead>
            <tbody>

                <tr>
                    <td>@wpName - Total</td>
                    @foreach (var month in months)
                    {
                        <td>@(effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month].ToString("0.00") : "0.00")</td>
                    }
                </tr>


                <tr>
                    <td>@wpName - Cumulative</td>
                    @{
                        decimal cumulativeTotal = 0;
                    }
                    @foreach (var month in months)
                    {
                        cumulativeTotal += effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                        <td>@cumulativeTotal.ToString("0.00")</td>
                    }
                </tr>


                <tr>
                    <td>@wpName - Balance</td>
                    @foreach (var month in months)
                    {
                        var planEffort = filteredProjectEfforts.FirstOrDefault(pe => pe.Month == month)?.Value ?? 0;
                        var realEffort = effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                        var balance = realEffort - planEffort ;
                        <td>@balance.ToString("0.00")</td>
                    }
                </tr>


                <tr>
                    <td>@wpName - Cumulative Balance</td>
                    @{
                        decimal cumulativeBalance = 0;
                    }
                    @foreach (var month in months)
                    {
                        var planEffort = filteredProjectEfforts.FirstOrDefault(pe => pe.Month == month)?.Value ?? 0;
                        var realEffort = effortSumByMonth.ContainsKey(month) ? effortSumByMonth[month] : 0;
                        var balance = realEffort - planEffort;
                        cumulativeBalance += balance;
                        <td>@cumulativeBalance.ToString("0.00")</td>
                    }
                </tr>
            </tbody>
        </table>
    </div>
}


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_Layout.cshtml -----
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TRS3.0</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- FullCalendar -->
    <link rel="stylesheet" href="/css/fullcalendar.min.css" />

    <!-- DataTables -->
    <link rel="stylesheet" href="/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" href="/css/jquery.dataTables.css" />

    <!-- Site Custom Styles -->
    <link rel="stylesheet" href="/css/site.css" asp-append-version="true" />

    <link rel="stylesheet" href="@Url.Content("~/lib/bootstrap-icons/bootstrap-icons.css")" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css" asp-append-version="true" />
    



    <!-- 🔹 Agregar referencia a _Layout.cshtml.css -->
    <link rel="stylesheet" href="~/css/layout-styles.css" asp-append-version="true">
</head>

<!-- Overlay de carga global -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">
                    <img src="~/Images/logo.png" alt="TRS 2.0 Logo" style="height: 50px;"> <!-- Ajusta la ruta y el tamaño según tus necesidades -->
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index">Inicio</a>
                        </li>
                        @if (User.Identity.IsAuthenticated)
                        {
                            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link text-dark" asp-area="" asp-controller="Projects" asp-action="InitialRedirect">Proyectos</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-dark" asp-area="" asp-controller="Personnels" asp-action="Index">Personal</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-dark" asp-area="" asp-controller="TimeSheet" asp-action="Index">Investigador</a>
                                </li>
                            }
                            @if (User.IsInRole("Admin"))
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle text-dark" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-shield-lock"></i> Admin
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                                        <li>
                                            <a class="dropdown-item" asp-controller="Admin" asp-action="Index">
                                                <i class="bi bi-house-door"></i> Principal
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Admin" asp-action="AjustarOverloadManual">
                                                <i class="bi bi-exclamation-triangle"></i> Ajuste Overloads
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Admin" asp-action="RemindersWeeklyDryRunView">
                                                <i class="bi bi-exclamation-triangle"></i> Reminders
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            }
                            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager") || User.IsInRole("User") || User.IsInRole("Researcher"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link text-dark" asp-area="" asp-controller="TimeSheet" asp-action="GetTimeSheetsForPerson">TimeSheet</a>
                                </li>
                            }
                            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager") || User.IsInRole("Researcher"))
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle text-dark" href="#" id="pmDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-tools"></i> Utilidades
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="pmDropdown">
                                        @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
                                        {
                                            <li>
                                                <a class="dropdown-item" asp-controller="ProjectManager" asp-action="Index">
                                                    <i class="bi bi-file-earmark-spreadsheet"></i> Cargar Timesheets
                                                </a>
                                            </li>
                                        }
                                        <li>
                                            <a class="dropdown-item" asp-controller="ProjectManager" asp-action="ReportError">
                                                <i class="bi bi-bug"></i> Reportar Error
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            }
                            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle text-dark" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-wrench-adjustable"></i> Tools
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
                                        <li>
                                            <a class="dropdown-item" asp-controller="Tools" asp-action="GlobalHours">
                                                <i class="bi bi-clock-history"></i> Global Hours
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Tools" asp-action="GlobalEffort">
                                                <i class="bi bi-bar-chart-steps"></i> Global Effort
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            }

                            @if (User.IsInRole("Admin") || User.IsInRole("Leader") || User.IsInRole("ProjectManager"))
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle text-dark" href="#" id="leaderDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-people"></i> Leader
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="leaderDropdown">
                                        <li>
                                            <a class="dropdown-item" asp-controller="Leader" asp-action="EffortSummary">
                                                <i class="bi bi-bar-chart"></i> Effort Summary
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Leader" asp-action="TimesheetOverview">
                                                <i class="bi bi-clock"></i> Timesheet Overview
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Leader" asp-action="GlobalEffortSummary">
                                                <i class="bi bi-graph-up-arrow"></i> Global Effort Summary
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            }


                        }
                    </ul>
                    <ul class="navbar-nav">
                        <partial name="_LoginPartial" />
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Menú secundario de proyectos, solo se muestra en las vistas de detalles de proyecto -->
    @if (Context.Request.Path.StartsWithSegments("/Projects/Details") ||
    Context.Request.Path.StartsWithSegments("/Projects/EffortPlan") ||
    Context.Request.Path.StartsWithSegments("/Projects/PersonnelSelection") ||
    Context.Request.Path.StartsWithSegments("/Projects/PersonnelEffortPlan") ||
    Context.Request.Path.StartsWithSegments("/Projects/GetPersonnelEffortsByPerson") ||
    Context.Request.Path.StartsWithSegments("/Projects/ProjectReport"))
    {
        <div class="project-details-menu">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <!-- Botón para Details & Wps -->
                    <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("Details", "Projects", new { id = ViewBag.ProjId })">
                        Details & Wps
                    </a>

                    <!-- Separador -->
                    <span class="vertical-separator"></span>

                    <!-- Botón para Effort Plan -->
                    <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("EffortPlan", "Projects", new { projId = ViewBag.ProjId })">
                        Effort Plan
                    </a>

                    <!-- Separador -->
                    <span class="vertical-separator"></span>

                    <!-- Botón para Personnel Selection -->
                    <a class="navbar-brand btn btn-outline-primary text-dark" href="@Url.Action("PersonnelSelection", "Projects", new { projId = ViewBag.ProjId })">
                        Personnel Selection
                    </a>
                    <!-- Separador -->
                    <span class="vertical-separator"></span>

                    <!-- Botón para Personnel Effort Plan -->
                    <a class="navbar-brand btn btn-outline-primary text-dark" href="@Url.Action("PersonnelEffortPlan", "Projects", new { projId = ViewBag.ProjId })">
                        Personnel Effort Plan
                    </a>

                    <!-- Botón para Personnel Project Report -->
                    <a class="navbar-brand btn btn-outline-primary text-dark" href="@Url.Action("ProjectReport", "Projects", new { projId = ViewBag.ProjId })">
                        Project Report
                    </a>

                </div>
            </nav>
        </div>
    }

    <!-- Menú secundario de personal, se muestra en las vistas relacionadas con personal -->
    @if (Context.Request.Path.StartsWithSegments("/Personnels"))
    {
        <div class="personal-details-menu">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <!-- Botones del Submenú -->
                    @if (TempData["SelectedPersonId"] != null)
                    {
                        TempData.Keep("SelectedPersonId"); // Mantener el valor para su uso posterior

                        <!-- Actualizar los enlaces del menú para incluir el SelectedPersonId -->
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("Calendar", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            Calendar
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("Dedication", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            Dedication
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("ExternalRate", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            External Rate
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("Travels", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            Travels
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("PendingTravels", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            Pending Travels
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark"
                           href="@Url.Action("LoginLog", "Personnels", new { id = TempData["SelectedPersonId"] })">
                            LoginLog
                        </a>
                    }
                    else
                    {
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("Calendar", "Personnels")">
                            Calendar
                        </a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("Dedication", "Personnels")">Dedication</a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("ExternalRate", "Personnels")">External Rate</a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("Travels", "Personnels")">Travels</a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary me-2 text-dark" href="@Url.Action("PendingTravels", "Personnels")">Pending Travels</a>
                        <span class="vertical-separator"></span>
                        <a class="navbar-brand btn btn-outline-primary text-dark" href="@Url.Action("LoginLog", "Personnels")">Login Log</a>
                    }
                </div>
            </nav>
        </div>
    }

    <div class="content-wrapper">
        @RenderBody()
    </div>

    <footer class="footer">
        <div class="container">
            &copy; 2025 - TRS 3.0 
        </div>
    </footer>

    <!-- Incluye jQuery primero -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    @* <script src="~/js/jquery-3.5.1.min.js"></script> *@

    <!-- Otros scripts -->
    <script src="/js/jquery.dataTables.min.js"></script>
    <script src="/js/datatables.min.js"></script>
    <script src="/js/dataTables.bootstrap4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src='~/js/index.global.min.js'></script>
    <script src='~/js/locales-all.global.min.js'></script>
    <script src="~/lib/sweetalert2/sweetalert2.all.min.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_LayoutSidebar.cshtml -----
@using Microsoft.AspNetCore.Identity
@using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    var currentProject = ViewBag.CurrentProject as string;
    var currentPerson = ViewBag.CurrentPerson as string;
    var projId = ViewBag.ProjId;
    var personId = ViewBag.PersonId;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TRS 3.0</title>

    <!-- ✅ Estilos heredados necesarios -->
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/fullcalendar.min.css" />
    <link rel="stylesheet" href="/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" href="/css/jquery.dataTables.css" />
    <link rel="stylesheet" href="/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/bootstrap-icons/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/layout-styles.css" asp-append-version="true" />

    <style>
        body {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .sidebar {
            width: 260px;
            background: #1d3557;
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

            .sidebar a,
            .sidebar button {
                color: #f1faee;
                padding: 10px 20px;
                display: block;
                text-decoration: none;
                border: none;
                background: none;
                text-align: left;
                width: 100%;
            }

                .sidebar a:hover,
                .sidebar .active,
                .sidebar button:hover {
                    background-color: #457b9d;
                }

            .sidebar .logo {
                font-size: 1.4rem;
                padding: 0 20px 20px;
                font-weight: bold;
                color: #f1faee;
            }

            .sidebar h6 {
                padding: 0 20px;
                margin-top: 15px;
                color: #a8dadc;
                font-size: 0.75rem;
                text-transform: uppercase;
            }

        .submenu {
            padding-left: 1.5rem;
            font-size: 0.95rem;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            color: #a8dadc;
            font-size: 0.85rem;
            border-top: 1px solid #ccc;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .user-profile img {
                border-radius: 50%;
                height: 40px;
                width: 40px;
                object-fit: cover;
            }

        .content-wrapper {
            flex-grow: 1;
            padding: 30px;
        }
    </style>
</head>
<body>

    <!-- ✅ Sidebar -->
    <div class="sidebar">
        <div class="logo">TRS 3.0</div>

        @if (User.Identity.IsAuthenticated)
        {
            <h6>Main</h6>
            <a asp-controller="Home" asp-action="Index"><i class="bi bi-house-door"></i> Home</a>

            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
            {
                <a asp-controller="Projects" asp-action="InitialRedirect"><i class="bi bi-diagram-3"></i> Projects</a>
            }

            @if (!string.IsNullOrEmpty(currentProject))
            {
                <h6>@currentProject</h6>
                <div class="submenu">
                    <a asp-controller="Projects" asp-action="Details" asp-route-projId="@projId">Details & Wps</a>
                    <a asp-controller="Projects" asp-action="EffortPlan" asp-route-projId="@projId">Effort Plan</a>
                    <a asp-controller="Projects" asp-action="PersonnelSelection" asp-route-projId="@projId">Personnel Selection</a>
                    <a asp-controller="Projects" asp-action="PersonnelEffortPlan" asp-route-projId="@projId">Personnel Effort Plan</a>
                    <a asp-controller="Projects" asp-action="ProjectReport" asp-route-projId="@projId">Project Report</a>
                </div>
            }

            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
            {
                <a asp-controller="Personnels" asp-action="Index"><i class="bi bi-people"></i> Personnel</a>
            }

            @if (!string.IsNullOrEmpty(currentPerson))
            {
                <h6>@currentPerson</h6>
                <div class="submenu">
                    <a asp-controller="Personnels" asp-action="Calendar" asp-route-id="@personId">Calendar</a>
                    <a asp-controller="Personnels" asp-action="Dedication" asp-route-id="@personId">Dedication</a>
                    <a asp-controller="Personnels" asp-action="ExternalRate" asp-route-id="@personId">External Rate</a>
                    <a asp-controller="Personnels" asp-action="Travels" asp-route-id="@personId">Travels</a>
                    <a asp-controller="Personnels" asp-action="PendingTravels" asp-route-id="@personId">Pending Travels</a>
                    <a asp-controller="Personnels" asp-action="LoginLog" asp-route-id="@personId">Login Log</a>
                </div>
            }

            <h6>Utilities</h6>
            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
            {
                <a asp-controller="ProjectManager" asp-action="Index"><i class="bi bi-upload"></i> Load Timesheets</a>
            }
            <a asp-controller="ProjectManager" asp-action="ReportError"><i class="bi bi-bug"></i> Report Error</a>

            @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager") || User.IsInRole("User") || User.IsInRole("Researcher"))
            {
                <a asp-controller="TimeSheet" asp-action="GetTimeSheetsForPerson"><i class="bi bi-clock"></i> Timesheet</a>
            }

            @if (User.IsInRole("Admin"))
            {
                <h6>Admin</h6>
                <a asp-controller="Admin" asp-action="Index"><i class="bi bi-shield-lock"></i> Admin Panel</a>
                <a asp-controller="Tools" asp-action="GlobalHours"><i class="bi bi-clock-history"></i> Global Hours</a>
            }

            <h6>Account</h6>
            <a asp-controller="Account" asp-action="ChangePassword"><i class="bi bi-key"></i> Change Password</a>
            <form asp-controller="Account" asp-action="Logout" method="post">
                <button type="submit"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </form>

            <!-- ✅ Pie con usuario -->
            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="~/Images/profile-placeholder.jpg" alt="Profile" />
                    <span>@User.Identity.Name</span>
                </div>
            </div>
        }
    </div>

    <!-- ✅ Contenido -->
    <div class="content-wrapper container-fluid">
        @RenderBody()
    </div>

    <!-- ✅ Scripts necesarios -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="/js/jquery.dataTables.min.js"></script>
    <script src="/js/datatables.min.js"></script>
    <script src="/js/dataTables.bootstrap4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src='~/js/index.global.min.js'></script>
    <script src='~/js/locales-all.global.min.js'></script>

    @RenderSection("Scripts", required: false)
</body>
</html>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_LoginPartial.cshtml -----
@using Microsoft.AspNetCore.Identity
@using TRS2._0.Models.DataModels.TRS2._0.Models.DataModels
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@if (SignInManager.IsSignedIn(User))
{
    <li class="nav-item">
        <span class="nav-link text-dark">@User.Identity.Name |</span>
    </li>
    <li class="nav-item">
        <a class="nav-link text-dark" asp-area="" asp-controller="Account" asp-action="ChangePassword">Change Password</a>
    </li>
    <li class="nav-item">
        <form method="post" asp-area="" asp-controller="Account" asp-action="Logout" id="logoutForm" class="navbar-right">
            <button type="submit" class="btn btn-link nav-link text-dark">Logout</button>
        </form>
    </li>
}
else
{
    <li class="nav-item">
        <a class="nav-link text-dark" asp-area="" asp-controller="Account" asp-action="Login">Login</a>
    </li>
}


----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_ReportPeriodForm.cshtml -----
<div class="row">
    <!-- Seleccionar por fecha específica -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title card-title-custom">Add period by specific dates</h5>
                <div class="form-row align-items-center">
                    <div class="col-auto">
                        <label for="specificStartDate" class="sr-only">Start Date</label>
                        <input type="date" class="form-control mb-2" id="specificStartDate" name="specificStartDate">
                    </div>
                    <div class="col-auto">
                        <label for="specificEndDate" class="sr-only">End Date</label>
                        <input type="date" class="form-control mb-2" id="specificEndDate" name="specificEndDate">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary mb-2" onclick="addPeriodBySpecificDate()">Add by Date</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seleccionar por mes -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title card-title-custom">Add period by month selection</h5>
                <div class="form-row align-items-center">
                    <div class="col-auto">
                        <label for="startMonthSelector" class="sr-only">Start Month</label>
                        <select class="form-control mb-2" id="startMonthSelector">
                            @foreach (var month in Model.MonthsList)
                            {
                                <option value="@month">@month</option>
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="endMonthSelector" class="sr-only">End Month</label>
                        <select class="form-control mb-2" id="endMonthSelector">
                            @foreach (var month in Model.MonthsList)
                            {
                                <option value="@month">@month</option>
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary mb-2" onclick="addPeriodByMonthSelection()">Add by Month</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function addPeriodBySpecificDate() {
        var startDate = $('#specificStartDate').val();
        var endDate = $('#specificEndDate').val();
        var projId = '@Model.Project.ProjId'; // Asume que el ID del proyecto está incluido en tu ViewModel
        // AJAX call to add period by specific date
        $.ajax({
            url: '/Projects/AddReportPeriodByDate', // Asegúrate de crear esta acción en tu controlador
            method: 'POST',
            data: {
                projId: projId,
                startDate: startDate,
                endDate: endDate
            },
            success: function () {
                location.reload(); // Recarga la página para reflejar los cambios
            }
        });
    }

    function addPeriodByMonthSelection() {
        var startMonth = $('#startMonthSelector').val();
        var endMonth = $('#endMonthSelector').val();
        var projId = '@Model.Project.ProjId';
        // Similar AJAX call for adding period by month selection
        $.ajax({
            url: '/Projects/AddReportPeriodByMonth', // Asegúrate de crear esta acción en tu controlador
            method: 'POST',
            data: {
                projId: projId,
                startMonth: startMonth,
                endMonth: endMonth
            },
            success: function () {
                location.reload(); // Recarga la página
            }
        });
    }


</script>

<style>
    .card-title-custom {
        text-transform: uppercase; /* Convierte el texto en mayúsculas */
        text-align: center; /* Centra el texto */
        /* Puedes usar colores de Bootstrap como bg-primary, o definir un color específico: */
        background-color: #007bff; /* Color azul de Bootstrap 'primary' como ejemplo */
        color: white; /* Color del texto */
        padding: 10px 0; /* Añade un poco de relleno para que se vea mejor */
    }
</style>






----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\_ValidationScriptsPartial.cshtml -----
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\AccessDenied.cshtml -----
@{
    ViewData["Title"] = "Access Denied";
}

<h1>Access Denied</h1>
<p>You do not have permission to access this resource.</p>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\Error.cshtml -----
@model ErrorViewModel
@{
    ViewData["Title"] = "Error";
}

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (Model.ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@Model.RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Shared\NotLeaderMessage.cshtml -----
<h3>No eres responsable de ningún grupo o departamento</h3>
<p>Actualmente, no tienes asignada ninguna responsabilidad de liderazgo. Contacta con administración si crees que se trata de un error.</p>




----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Timesheet\GetTimeSheetsForPerson.cshtml -----
@model TRS2._0.Models.ViewModels.TimesheetViewModel
@using System.Globalization
@using TRS2._0.Models.DataModels

@{
    ViewData["Title"] = "Timesheet Overview";
    var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(@Model.CurrentMonth);
    var monthNameCapitalized = new DateTime(Model.CurrentYear, Model.CurrentMonth, 1)
        .ToString("MMMM", System.Globalization.CultureInfo.CreateSpecificCulture("en"));
}    
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<div class="container-fluid" style="max-width: 2000px;  padding-right: 5; padding-left: 5; margin-right: auto; margin-left: auto;">   
    <h2 style="margin-bottom: 0;">Timesheet for @Model.Person.Name @Model.Person.Surname - @monthNameCapitalized @Model.CurrentYear</h2>

    <!-- Sección de controles para cambiar de mes, con el selector de fechas en el centro -->
    <div class="d-flex justify-content-between mb-3">
        <!-- Contenedor para botones, selectores y "Save All" -->
        <div class="d-flex align-items-center" style="width: 40%;">
            <!-- Botón Previous -->
            <button id="prevMonthButton" class="btn btn-primary">Previous</button>
            <!-- Botón Next -->
            <button id="nextMonthButton" class="btn btn-primary mx-2">Next</button
            <!-- Selectores de Mes y Año -->
            <select id="monthSelect" class="form-control mx-2">
                <option value="">Select the month</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <select id="yearSelect" class="form-control mx-2">
                <option value="">Select the year</option>
                @for (int year = DateTime.Now.Year - 10; year <= DateTime.Now.Year + 10; year++)
                {
                    <option value="@year">@year</option>
                }
            </select>
            <button id="goButton" class="btn btn-success mx-2">Go</button>
            
        </div>

        @if ((bool?)ViewBag.AllowEdit == true)
        {
            <div class="d-flex justify-content-center align-items-center gap-2" style="width: 20%;">
                <button id="saveAllButton" class="btn btn-success">Save All</button>

                @if ((bool?)ViewBag.ShowAutoFillButton == true)
                {
                    <button id="autoFillButton" class="btn btn-warning">Auto Fill</button>
                }
            </div>
        }



        <!-- Contenedor para la barra de progreso -->
        <div class="w-50 d-flex align-items-center">
            <span class="mr-2 font-weight-bold">Total Hours this month: @Model.TotalHours.ToString("0.0")</span>
            <div class="progress w-100 position-relative">
                <div class="progress-bar bg-success" role="progressbar" style="width: @ViewBag.PercentageUsed%" aria-valuenow="@ViewBag.PercentageUsed" aria-valuemin="0" aria-valuemax="100">
                    <span class="position-absolute w-100 text-center font-weight-bold" style="color: black;">@ViewBag.PercentageUsed%</span>
                </div>
            </div>

        </div>
    </div>



    <div class="table-responsive">
        <div class="scrollable-table-container">
            <table id="timesheetTable" class="table table-bordered table-striped table-hover">
                <!-- El resto de tu tabla aquí -->

                <thead class="thead-dark">
                    <tr>
                        <th class="sticky-column sticky-header">
                            <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center;">Project</div>
                            <div style="text-align: center;">WP - Title</div>

                        </th>
                        @* <th>Dedication - Estimated Hours</th> *@
                        @foreach (var day in Model.MonthDays)
                        {
                            <th class="sticky-day-header">
                                <div style="border-bottom: 1px solid white; margin-bottom: 2px; margin-top: 8px; text-align: center;">@day.Day.ToString("00")</div>
                                <div style="text-align: center;">@day.ToString("ddd", CultureInfo.CreateSpecificCulture("en")).ToUpper()</div>
                            </th>
                        }
                        <th class="sticky-penultimate-column">
                            <div style="border-bottom: 1px solid white; margin-bottom: 2px; text-align: center; font-weight: bold">ACTUAL</div>
                            <div style="text-align: center; font-weight: bold;">ESTIMATED HOURS</div>
                        </th>
                        <th class="sticky-last-column">%</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var wp in Model.WorkPackages)
                    {
                        <tr>
                            <td class="single-line-cell sticky-column">

                                <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center;">@* @wp.ProjectSAPCode*@@wp.ProjectName</div>
                                <div style="text-align: center;">@wp.WpName - @wp.WpTitle</div>

                            </td>

                            @* <td class="second-line-cell">
                                Dedication: @String.Format("{0:P1}", wp.Effort) - Estimated Hours: @wp.EstimatedHours
                            </td> *@

                            <!-- Celdas para cada día del mes -->
                            @foreach (var day in Model.MonthDays)
                            {
                                var isWeekend = day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday;
                                var leave = Model.LeavesthisMonth.FirstOrDefault(l => l.Day.Date == day.Date);
                                var hasTravel = Model.TravelsthisMonth.Any(t => day.Date >= t.StartDate && day.Date <= t.EndDate);
                                var isFuture = day.Date > DateTime.Now.Date;
                                var isHoliday = Model.Holidays.Any(h => h.Date == day.Date);
                                var cellStyle = "";
                                var hasTravelforthisProject = Model.TravelsthisMonth.Any(t => day.Date >= t.StartDate && day.Date <= t.EndDate && t.ProjId == wp.ProjectId);
                                var timesheetEntry = wp.Timesheets.FirstOrDefault(ts => ts.Day.Date == day.Date);
                                bool hasHours = timesheetEntry != null && timesheetEntry.Hours > 0;
                                bool normallyEditable =
                                (leave?.Type == 11 || leave?.Type == 12) || // Baja parcial
                                (!wp.IsLocked &&
                                !isWeekend &&
                                leave == null &&
                                (!hasTravel || hasTravelforthisProject) &&
                                !isFuture &&
                                !isHoliday);

                                bool editable = !wp.IsLocked && (normallyEditable || hasHours);

                                // Marcar el fondo amarillo solo si NO debería ser editable pero lo es por tener horas
                                bool highlightYellow = !wp.IsLocked && !normallyEditable && hasHours;

                                // Definir el estilo de la celda según las condiciones dadas
                                if (isHoliday)
                                {
                                    cellStyle = "background-color: green;";
                                }
                                else if (hasTravel && !isFuture)
                                {
                                    cellStyle = "background-color: pink;";
                                }
                                else if (isWeekend || isFuture)
                                {
                                    cellStyle = "background-color: #6c757d;";
                                }
                                else if (leave != null)
                                {
                                    switch (leave.Type)
                                    {
                                        case 1:
                                            cellStyle = "background-color: darkorange;";
                                            break;
                                        case 2:
                                            cellStyle = "background-color: lightblue;";
                                            break;
                                        case 3:
                                            cellStyle = "background-color: purple;";
                                            break;
                                        case 11: // Partial Leave - Light Orange
                                        case 12: // Partial Leave - Light Orange
                                            cellStyle = "background-color: lightcoral;";
                                            break;
                                    }
                                }

                                string inputStyle = highlightYellow ? "background-color: yellow;" : "";
                                <td class="hour-input-cell" style="@cellStyle">
                                    @if (editable && (bool?)ViewBag.AllowEdit == true)
                                    {                                        
                                        <input type="text" class="form-control input-hours"
                                               style="@inputStyle"
                                               value="@((timesheetEntry != null) ? timesheetEntry.Hours.ToString("0.##") : "0")"
                                               data-projectid="@wp.ProjectId"
                                               data-wpid="@wp.WpId"
                                               data-day="@day.ToString("yyyy-MM-dd")"
                                               data-original-value="@((timesheetEntry != null) ? timesheetEntry.Hours.ToString("0.##") : "0")" />
                                    }
                                    else
                                    {                                        
                                        <span class="font-weight-bold" style="display: block; text-align: center;">
                                            @((timesheetEntry != null) ? timesheetEntry.Hours.ToString("0.##") : "0")
                                        </span>
                                    }
                                </td>
                            }




                            <td class="sticky-penultimate-column">
                                @{
                                    var totalActual = wp.Timesheets.Sum(ts => ts.Hours);
                                    var totalEstimado = wp.EstimatedHours;
                                    var difference = Math.Abs(totalActual - totalEstimado); // diferencia absoluta
                                    string textColor;

                                    if (difference <= 0.5m)
                                    {
                                        textColor = "#006400"; // Verde oscuro
                                    }
                                    else if (totalActual > totalEstimado)
                                    {
                                        textColor = "#FF8C00"; // Naranja oscuro
                                    }
                                    else
                                    {
                                        textColor = "#00008B"; // Azul oscuro
                                    }
                                }
                                <div style="border-bottom: 1px solid #333; margin-bottom: 2px; margin-top: 8px; text-align: center; font-weight: bold; color: @textColor">
                                    @totalActual.ToString("0.#")
                                </div>
                                <div style="text-align: center; font-weight: bold; color: @textColor">
                                    @totalEstimado.ToString("0.#")
                                </div>
                            </td>
                            <td class="sticky-last-column">@String.Format("{0:P1}", wp.Effort)</td>
                        </tr>
                    }
                    <!-- Fila de Totales aquí -->
                </tbody>
                <tfoot>
                    <tr style="background-color: #343a40; color: white;">
                        <th class="sticky-column" style="background-color: #343a40; color: white;">Total Daily</th>
                        @foreach (var day in Model.MonthDays)
                        {
                            // Verificar si el día es un día festivo o tiene una ausencia
                            var leave = Model.LeavesthisMonth.FirstOrDefault(l => l.Day.Date == day.Date);
                            bool isHoliday = Model.Holidays.Any(h => h.Date == day);
                            bool isLeave = leave != null && leave.Type != 11 && leave.Type != 12; // No considera parciales como bajas completas

                            // Calcular los totales
                            var totalActualForDay = Model.TotalHoursWithDedication.ContainsKey(day) ? Model.TotalHoursWithDedication[day] : 0;
                            var totalEstimadoForDay = isHoliday || isLeave ? 0 : (Model.HoursPerDayWithDedication.ContainsKey(day) ? Model.HoursPerDayWithDedication[day] : 0);

                            // Para bajas parciales, ajustar el total estimado
                            if (leave?.Type == 11 || leave?.Type == 12)
                            {
                                totalEstimadoForDay = Model.HoursPerDayWithDedication.ContainsKey(day) ? Model.HoursPerDayWithDedication[day] : 0;
                            }

                            string textColorForDay;
                            string backgroundStyle;

                            if (totalActualForDay == totalEstimadoForDay)
                            {
                                textColorForDay = "#006400"; // Verde oscuro
                                backgroundStyle = "background-color: #e6ffe6;";
                            }
                            else if (totalActualForDay > totalEstimadoForDay)
                            {
                                textColorForDay = "#FF8C00"; // Naranja oscuro
                                backgroundStyle = "background-color: #fff0e6;";
                            }
                            else
                            {
                                textColorForDay = "#00008B"; // Azul oscuro
                                backgroundStyle = "background-color: #e6f3ff;";
                            }

                            <td style="@backgroundStyle font-weight: bold; color: @textColorForDay;">
                                <div style="border-bottom: 1px solid black; text-align: center;">
                                    @totalActualForDay.ToString("0.#")
                                </div>
                                <div style="text-align: center;">
                                    @totalEstimadoForDay.ToString("0.#")
                                </div>
                            </td>
                        }
                        <th class="sticky-penultimate-column" style="background-color: #343a40; color: white;"></th>
                        <th class="sticky-last-column" style="background-color: #343a40; color: white;"></th>
                    </tr>
                </tfoot>



            </table>
        </div>
    </div>
</div>
<hr/>
<div class="below-main-table" style="display: flex; justify-content: space-between; margin-top: 10px;">
    <div class="legend-box" style="width: 300px; margin-left:10px; padding: 10px; margin-top: 10px; margin-bottom: 15px; border: 1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,.1);">
    <h4 style="margin-bottom: 20px; text-align: center; font-weight: bold">Legend</h4>
    <div class="mb-2">
        <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: darkorange; border: 1px solid black;">&nbsp;</span>
        <span style="margin-left: 8px;">Leave</span>
    </div>
    <div class="mb-2">
        <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: lightcoral; border: 1px solid black;">&nbsp;</span>
        <span style="margin-left: 8px;">Partial Leave</span>
        </div>
    <div class="mb-2">
        <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: lightblue; border: 1px solid black;">&nbsp;</span>
        <span style="margin-left: 8px;">Holiday</span>
    </div>
    <div class="mb-2">
        <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: red; border: 1px solid black;">&nbsp;</span>
        <span style="margin-left: 8px;">Out of contract</span>
    </div>
    <div class="mb-2">
        <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: pink; border: 1px solid black;">&nbsp;</span>
        <span style="margin-left: 8px;">Travel</span>
    </div>
        <div class="mb-2">
            <span class="legend-color" style="display: inline-block; width: 20px; height: 20px; background-color: green; border: 1px solid black;">&nbsp;</span>
            <span style="margin-left: 8px;">National Holiday</span>
        </div>
</div>
    <div class="travel-table-container" style="flex-grow: 1; overflow-x: auto; margin-left: 20px; margin-right:20px;">
        <h4 style="margin-bottom: 5px; text-align: center; font-weight: bold">TRAVELS</h4>
        <table class="table table-bordered" style="min-width: 600px;">
            <thead>
                <tr>
                    <th>Liquidation Id</th>
                    <th>Project</th>
                    <th>Dedication</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.TravelsthisMonth != null && Model.TravelsthisMonth.Any())
                {
                    foreach (var travel in Model.TravelsthisMonth)
                    {
                        <tr>
                            <td>@travel.LiqId</td>
                            <td>@travel.ProjectSAPCode - @travel.ProjectAcronimo</td>
                            <td>@(travel.Dedication.ToString("0") + "%")</td>
                            <td>@travel.StartDate.ToString("yyyy-MM-dd")</td>
                            <td>@travel.EndDate.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5">There are no trips registered for this month</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>
<script>
    document.getElementById('prevMonthButton').addEventListener('click', function () {
        // Asumiendo que tienes un personId y el mes y año actuales disponibles
        var personId = @Model.Person.Id;
        var currentYear = @Model.CurrentYear;
        var currentMonth = @Model.CurrentMonth;

        // Ajusta el año y el mes para el botón Previous
        if (currentMonth === 1) {
            // Si es enero, cambia a diciembre del año anterior
            currentMonth = 12;
            currentYear -= 1;
        } else {
            // En cualquier otro caso, solo disminuye el mes
            currentMonth -= 1;
        }

        // Construye la URL con los parámetros ajustados
        var redirectUrl = `/Timesheet/GetTimeSheetsForPerson?personId=${personId}&year=${currentYear}&month=${currentMonth}`;

        // Redirige a la URL
        window.location.href = redirectUrl;
    });

    document.getElementById('nextMonthButton').addEventListener('click', function () {
        // Asumiendo que tienes un personId y el mes y año actuales disponibles
        var personId = @Model.Person.Id;
        var currentYear = @Model.CurrentYear;
        var currentMonth = @Model.CurrentMonth;

        // Ajusta el año y el mes para el botón Previous
        if (currentMonth === 12) {
            // Si es diciembre, cambia a enero del año siguiente
            currentMonth = 1;
            currentYear += 1;
        } else {
            // En cualquier otro caso, solo disminuye el mes
            currentMonth += 1;
        }

        // Construye la URL con los parámetros ajustados
        var redirectUrl = `/Timesheet/GetTimeSheetsForPerson?personId=${personId}&year=${currentYear}&month=${currentMonth}`;

        // Redirige a la URL
        window.location.href = redirectUrl;
    });

        
        document.getElementById('goButton').addEventListener('click', function () {
            var selectedMonth = document.getElementById('monthSelect').value;
            var selectedYear = document.getElementById('yearSelect').value;

            // Asumiendo que tienes un personId disponible, por ejemplo, guardado en un data attribute en algún lugar
            var personId = @Model.Person.Id

            // Construye la URL con los parámetros seleccionados
            var redirectUrl = `/Timesheet/GetTimeSheetsForPerson?personId=${personId}&year=${selectedYear}&month=${selectedMonth}`;

            // Redirige a la URL
            window.location.href = redirectUrl;
        });


    document.getElementById('saveAllButton').addEventListener('click', function () {
        var changedTimesheets = [];
        var invalidInputs = [];

        document.querySelectorAll('.input-hours').forEach(input => {
            // Reemplaza la coma por un punto para asegurar el correcto parsing del valor decimal
            var originalValue = input.getAttribute('data-original-value').replace(',', '.');
            var currentValue = input.value.replace(',', '.');

            // Parsea ambos valores como flotantes
            originalValue = parseFloat(originalValue);
            currentValue = parseFloat(currentValue);

            // Validación de que el valor sea entero o decimal con .5
                if (isNaN(currentValue) || currentValue < 0) {
                    invalidInputs.push(input);
                } else {
                if (Math.round(currentValue * 100) / 100 !== Math.round(originalValue * 100) / 100) {
                    changedTimesheets.push({
                        ProjectId: parseInt(input.getAttribute('data-projectid'), 10),
                        WpId: parseInt(input.getAttribute('data-wpid'), 10),
                        PersonId: @Model.Person.Id,
                        Day: input.getAttribute('data-day'),
                        Hours: currentValue
                    });
                }
            }
        });

        if (invalidInputs.length > 0) {
            alert('Some inputs are invalid. Please enter a positive number.');
            invalidInputs.forEach(input => input.classList.add('is-invalid'));
        } else {
            if (changedTimesheets.length > 0) {
                fetch('@Url.Action("SaveTimesheetHours", "Timesheet")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ TimesheetDataList: changedTimesheets })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Timesheets updated successfully.');
                            location.reload();
                        } else {
                            alert('Error saving timesheets.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('There was an error processing your request.');
                    });
            } else {
                alert('No changes to save.');
            }
        }
    });

    $(document).ready(function () {
        var table = $('#timesheetTable tbody');
        var rows = table.find('tr').get();

        rows.sort(function (a, b) {
            var projectA = $(a).find('td').eq(0).find('div').eq(0).text().match(/\(([^)]+)\)/)[1].toUpperCase();
            var projectB = $(b).find('td').eq(0).find('div').eq(0).text().match(/\(([^)]+)\)/)[1].toUpperCase();
            var wpA = $(a).find('td').eq(0).find('div').eq(1).text().split(' ')[0].toUpperCase();
            var wpB = $(b).find('td').eq(0).find('div').eq(1).text().split(' ')[0].toUpperCase();
                        
            // Ordenar por ProjectName
            if (projectA < projectB) return -1;
            if (projectA > projectB) return 1;

            // Ordenar por WpName, pero mantener "TRAVELS" al final
            if (wpA === 'TRAVELS') return 1;
            if (wpB === 'TRAVELS') return -1;

            if (wpA < wpB) return -1;
            if (wpA > wpB) return 1;

            return 0;
        });

        

        $.each(rows, function (index, row) {
            table.append(row);
        });
    });

    document.getElementById('autoFillButton')?.addEventListener('click', async function () {
        const personId = @Model.Person.Id;
        const year = @Model.CurrentYear;
        const month = @Model.CurrentMonth;

        if (!confirm(`Are you sure you want to automatically fill in the timesheet for ${month}/${year}? This action may overwrite existing data.`)) return;


        const response = await fetch('/Timesheet/AutoFillTimesheetForPersonAndMonth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                personId: personId,
                targetMonth: `${year}-${String(month).padStart(2, '0')}-01T00:00:00`
            })
        });

        const result = await response.json();
        alert(result.message);

        if (result.success) {
            location.reload(); // recarga para reflejar los cambios
        }
    });

</script>






<style>
    .single-line-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        max-width: 500px;
        max-height: 10px;
    }

    .second-line-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        max-width: 500px;
        max-height: 10px;
    }

    .table-responsive {
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .scrollable-table-container {
        max-height: 800px;
        overflow-y: auto;
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
    }

        .table td {
            padding: 8px; /* Ajusta el padding para permitir el centrado vertical */
            vertical-align: middle; /* Asegura que el contenido de la celda se alinee verticalmente en el centro */
            text-align: center; /* Alinea el contenido de la celda horizontalmente en el centro */
        }

    .table-bordered {
        border: 1px solid #dee2e6;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .table-hover tbody tr:hover {
        color: #212529;
        background-color: rgba(0, 0, 0, 0.075);
    }

    .thead-dark th {
        color: #fff;
        background-color: #343a40;
        border-color: #454d55;
        text-align: center; /* Centra el texto horizontalmente */
        vertical-align: middle; /* Centra el texto verticalmente */
    }

    th, td {
        text-align: center; /* Centra el texto horizontalmente */
        vertical-align: middle; /* Centra el texto verticalmente */
    }

    .table thead th {
        position: sticky;
        top: 0;
        z-index: 2; /* Asegura que la fila se mantenga sobre el contenido scrolleable */
    }

    .hour-input-cell {
        width: 75px;
        min-width: 75px;
        max-width: 75px;
        padding: .3rem;
        text-align: center;
        vertical-align: middle;
        line-height: 0.75;
    }

    .input-hours {
        width: 100%;
        border: 1px solid #ced4da;
        line-height: 0.75;
        padding: .375rem .75rem;
        text-align: center;
        vertical-align: middle;
    }

    /* Estilos para las celdas según el tipo de ausencia */
    .leave-absence {
        background-color: lightsalmon;
    }

    .personal-holiday {
        background-color: lightblue;
    }

    .out-of-contract {
        background-color: purple;
    }

    /* Estilo para días de viaje */
    .travel-day {
        background-color: lightgreen;
    }

        /* Asegura que los inputs en celdas de fin de semana o días no editables no sean modificables */
        .bg-secondary input, .leave-absence input, .personal-holiday input, .out-of-contract input, .travel-day input {
            pointer-events: none;
            background-color: inherit; /* Hace que el input sea transparente al color de fondo de la celda */
        }

    /* Establece un ancho fijo para la primera columna */
    .table .first-column {
        width: 200px; /* Define el ancho fijo */
        max-width: 200px; /* Previene que la celda se expanda más de lo necesario */
    }

    .bg-secondary, .leave-absence, .personal-holiday, .out-of-contract, .travel-day {
        pointer-events: none;
        background-color: inherit; /* Hace que el input sea transparente al color de fondo de la celda */
    }

    /* Estilos para resaltar las celdas según su estado */
    .leave-absence {
        background-color: lightsalmon;
    }

    .personal-holiday {
        background-color: lightblue;
    }

    .out-of-contract {
        background-color: purple;
    }

    .travel-day {
        background-color: lightgreen;
    }

    .effort-match, .effort-mismatch {
        font-weight: bold;
    }

    .effort-match {
        background-color: #90ee90;
        color: darkgreen;
    }

    .effort-mismatch {
        background-color: #ffcccc;
        color: darkred;
    }

    h2 {
        text-align: center;
        font-weight: bold;
        margin-top: 5px;
    }

    .d-flex.align-items-center select.form-control,
    .d-flex.align-items-center button.btn {
        height: calc(2.25rem + 2px); /* Asegura que todos los elementos tengan la misma altura */
        margin-bottom: 0; /* Elimina el margen inferior por defecto para los elementos del formulario */
    }

    /* Espaciado entre elementos para una mejor distribución y alineación */
    .mx-2 {
        margin-left: .5rem !important;
        margin-right: .5rem !important;
    }

    .sticky-column {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 3;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background-color: #343a40;
        z-index: 3;
    }

    .sticky-day-header {
        z-index: 2; /* Menor que el de la primera columna */
    }

    tfoot th {
        bottom: 0;
        top: auto;
        z-index: 2;
    }

    

    .legend-box {
        width: 300px;
        margin-left: 10px;
        padding: 10px;
        margin-top: 10px; /* Reducido desde 20px */
        border: 1px solid #ccc;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
    }

        .legend-box .mb-2 {
            margin-bottom: 15px; /* Incrementado para mayor separación */
        }

    .sticky-penultimate-column {
        position: sticky;
        right: 50px; /* Ajusta este valor según el ancho de la última columna */
        background-color: white;
        z-index: 1;
    }

    .sticky-last-column {
        position: sticky;
        right: 0;
        background-color: white;
        z-index: 1;
    }
    
</style>








----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Timesheet\Index.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Personnel>

@{
    ViewData["Title"] = "Personnel Selection";
}

<div class="container">
    <div class="row">
        <!-- Columna de selección de personal -->
        <div class="col-md-6">
            <h2>Person Selection</h2>

            <!-- Contenedor para seleccionar personal -->
            <div id="personnelSelectContainer" class="custom-select">
                <div id="personnelSelectHeader" class="person-result" data-person-id="">
                    <span>Please select a person from the list below:</span>
                </div>
                <div id="personnelSelect" class="search-results-container" style="display: none;">
                    @foreach (var person in Model)
                    {
                        <div class="person-result" data-person-id="@person.Id">
                            <span>@person.Name @person.Surname</span> <span class="badge bg-primary">@person.DepartmentNavigation.Name</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Barra de búsqueda -->
            <p>Or start typing here the name of the person:</p>
            <input type="text" id="searchTerm" class="form-control" placeholder="Start typing..." onkeyup="filterPersonnel()" />

            <!-- Resultados de búsqueda -->
            <div id="searchResults" class="search-results-container">
            </div>
        </div>

        <!-- Columna de detalles del personal -->
        <div class="col-md-6">
            <h2>Person Details</h2>
            <div id="personDetails" class="card">
                <!-- Aquí se cargarán los detalles del personal -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('personnelSelectHeader').addEventListener('click', function () {
            var personnelSelect = document.getElementById('personnelSelect');
            if (personnelSelect.style.display === 'none' || personnelSelect.style.display === '') {
                personnelSelect.style.display = 'block';
            } else {
                personnelSelect.style.display = 'none';
            }
        });

        document.getElementById('personnelSelect').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                window.location.href = '@Url.Action("GetTimeSheetsForPerson", "Timesheet", new { personId = "__personId__" })'.replace('__personId__', personId);
            }
        });

        function filterPersonnel() {
            var searchTerm = document.getElementById('searchTerm').value;

            $.ajax({
                url: '@Url.Action("GetFilteredPersonnel", "Personnels")',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = ''; // Limpiar resultados anteriores

                    data.forEach(function (person) {
                        var personDiv = document.createElement('div');
                        personDiv.className = 'person-result';
                        personDiv.innerHTML = `<span>${person.name} ${person.surname}</span> <span class="badge bg-primary">${person.departmentName || 'N/A'}</span>`;
                        personDiv.setAttribute('data-person-id', person.id);

                        personDiv.onclick = function () {
                            document.querySelectorAll('.person-result').forEach(function (el) {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');
                            window.location.href = '@Url.Action("GetTimeSheetsForPerson", "Timesheet", new { personId = "__personId__" })'.replace('__personId__', person.id);
                        };

                        resultsDiv.appendChild(personDiv);
                    });
                }
            });
        }

        document.getElementById('searchResults').addEventListener('click', function (event) {
            if (event.target && event.target.matches('div.person-result')) {
                var personId = event.target.getAttribute('data-person-id');
                window.location.href = '@Url.Action("GetTimeSheetsForPerson", "Timesheet", new { personId = "__personId__" })'.replace('__personId__', personId);
            }
        });

        // Mostrar la lista de resultados cuando el campo de búsqueda recibe el foco
        document.getElementById('searchTerm').addEventListener('focus', function () {
            document.getElementById('searchResults').style.display = 'block';
        });

        // Cerrar la lista de resultados cuando se hace clic fuera de ella
        document.addEventListener('click', function (event) {
            var personnelSelect = document.getElementById('personnelSelect');
            var personnelSelectHeader = document.getElementById('personnelSelectHeader');
            if (!personnelSelect.contains(event.target) && event.target !== personnelSelectHeader) {
                personnelSelect.style.display = 'none';
            }
        });
    </script>
}

<style>
    .person-result {
        cursor: pointer;
        padding: 5px;
    }

        .person-result:hover {
            background-color: #eee;
        }

        .person-result.active {
            background-color: #4c87c6;
        }

    .card-detail-label {
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    #searchResults {
        max-height: 200px; /* Ajusta esto según tus necesidades */
        overflow-y: auto;
        display: none; /* Inicialmente oculto */
    }

    .custom-select {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        padding: 10px;
        border-radius: 8px;
    }

    .search-results-container {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 5px;
        background-color: #fff;
        margin-top: 10px;
    }

    .person-result {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.3s;
    }

        .person-result:hover {
            background-color: #f1f1f1;
        }

        .person-result.active {
            background-color: #4c87c6;
            color: white;
        }
</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Tools\GlobalEffort.cshtml -----
@using System.Globalization
@model TRS2._0.Models.ViewModels.ToolsViewModel
@{
    ViewData["Title"] = "Global Effort";
    var year = Model.Year;
    var entries = Model.GlobalEffort.Entries;
}

<div class="container-fluid mt-3">
    <h2 class="text-center fw-bold">
        Global Effort — @Model.Year
        <div class="d-flex justify-content-center align-items-center gap-3 mt-2">
            <a class="btn btn-primary"
               asp-controller="Tools"
               asp-action="GlobalEffort"
               asp-route-year="@(Model.Year - 1)">
                ← @(@Model.Year - 1)
            </a>

            <span class="btn btn-outline-dark disabled">@Model.Year</span>

            <a class="btn btn-primary"
               asp-controller="Tools"
               asp-action="GlobalEffort"
               asp-route-year="@(Model.Year + 1)">
                @(@Model.Year + 1) →
            </a>

            <input type="text" id="searchByPerson" class="form-control bg-white text-dark"
                   placeholder="Search by surname..." style="max-width: 250px;" />
            <button class="btn btn-success" onclick="downloadCSV()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
    </h2>

    <div class="table-responsive scrollable-table-container mt-4">
        <table class="table table-bordered table-hover table-sm global-hours-table">
            <thead class="thead-dark">
                <tr>
                    <th>Person</th>
                    <th>Department</th>
                    <th>Group</th>
                    @foreach (var month in Model.GlobalEffort.Entries.First().MonthlyEffortSummary.Keys)
                    {
                        <th>@month</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.GlobalEffort.Entries)
                {
                    <tr data-personid="@row.PersonId"
                        data-name="@row.PersonName.ToLower()"
                        data-surname="@row.PersonName.Split(',')[0].Trim().ToLower()">
                        <td class="fw-bold person-toggle" style="cursor:pointer">
                            <i class="bi bi-caret-right-fill me-1"></i>@row.PersonName
                        </td>
                        <td>@row.Department</td>
                        <td title="@row.Group">@row.Group</td>

                        @foreach (var val in row.MonthlyEffortSummary.Values)
                        {
                            string cssClass;
                            string display = val;

                            {
                                var parts = val.Split('|');
                                var assigned = decimal.Parse(parts[0].Trim(), CultureInfo.InvariantCulture);
                                var maximum = decimal.Parse(parts[1].Trim(), CultureInfo.InvariantCulture);

                                if (assigned == maximum)
                                    cssClass = "effort-match";
                                else if (assigned > maximum)
                                    cssClass = "effort-over";
                                else
                                    cssClass = "effort-under";
                            }

                            <td class="@cssClass">@display</td>
                        }
                    </tr>
                    <!-- La fila de detalle se insertará dinámicamente aquí por JS -->
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // -------- Buscador por apellido/nombre (oculta también la fila de detalle asociada) --------
        document.getElementById('searchByPerson').addEventListener('input', function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('.global-hours-table tbody tr').forEach(row => {
                if (row.classList.contains('person-details')) return; // no filtrar sobre filas detalle
                const surname = row.getAttribute('data-surname') || '';
                const fullname = row.getAttribute('data-name') || '';
                const visible = surname.includes(search) || fullname.includes(search);
                row.style.display = visible ? '' : 'none';

                // oculta también la fila detalle inmediatamente siguiente si existe
                const next = row.nextElementSibling;
                if (next && next.classList.contains('person-details')) {
                    next.style.display = visible ? '' : 'none';
                }
            });
        });

        // -------- Exportación CSV (omite filas detalle) --------
        function downloadCSV() {
            let csvBody = "";

            const headerRow = ["Person", "Department", "Group"];
            document.querySelectorAll(".global-hours-table thead th")
                .forEach((th, index) => {
                    if (index >= 3) headerRow.push(th.innerText.trim());
                });
            csvBody += headerRow.join(";") + "\r\n";

            document.querySelectorAll(".global-hours-table tbody tr")
                .forEach(row => {
                    if (row.classList.contains('person-details')) return; // excluir filas detalle
                    const cols = row.querySelectorAll("td");
                    const rowData = [];
                    cols.forEach((td) => {
                        let value = td.innerText.trim();
                        if (!isNaN(value) && value.includes(".")) {
                            value = value.replace(".", ",");
                        }
                        value = value.replace(/(\r\n|\n|\r)/gm, "");
                        rowData.push(value);
                    });
                    csvBody += rowData.join(";") + "\r\n";
                });

            const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csvBody);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Global_Effort.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // -------- Expandible por persona (AJAX) --------
                    (function () {
          const year = @Model.Year;
          const totalCols = document.querySelectorAll('.global-hours-table thead th').length;

          const headerMonthNames = Array.from(document.querySelectorAll('.global-hours-table thead th'))
              .slice(3).map(th => th.innerText.trim());

          document.querySelectorAll('.global-hours-table tbody tr .person-toggle').forEach(cell => {
            cell.addEventListener('click', async function () {
              const personRow = this.closest('tr'); // <- ancla fija
              const personId = personRow.getAttribute('data-personid');
              const expanded = personRow.classList.contains('expanded');
              const icon = this.querySelector('i');

              if (expanded) {
                icon.classList.remove('bi-caret-down-fill');
                icon.classList.add('bi-caret-right-fill');
                let next = personRow.nextElementSibling;
                while (next && next.classList.contains('person-details')) {
                  const toRemove = next;
                  next = next.nextElementSibling;
                  toRemove.remove();
                }
                personRow.classList.remove('expanded');
                return;
              } else {
                icon.classList.remove('bi-caret-right-fill');
                icon.classList.add('bi-caret-down-fill');
                personRow.classList.add('expanded');
              }

              // placeholder
              const ph = document.createElement('tr');
              ph.className = 'person-details';
              ph.innerHTML = `<td colspan="${totalCols}">
                  <div class="p-2 text-muted">Loading breakdown…</div>
                </td>`;
              personRow.insertAdjacentElement('afterend', ph);

              try {
                const url = '@Url.Action("GetPersonEffortBreakdown", "Tools")' + `?personId=${personId}&year=${year}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Network error ' + resp.status);
                const data = await resp.json();
                const rows = data.rows || [];

                // quitamos placeholder
                ph.remove();

                // iremos insertando SIEMPRE debajo de "anchor"
                let anchor = personRow;

                rows.forEach(r => {
                  const trDet = document.createElement('tr');
                  trDet.className = 'person-details';

                  let html = `<td class="text-start text-muted">↳</td>`;
                  html += `<td>${sanitize(r.projectAcronym ?? "")}</td>`;
                  const wp = r.wpName ?? "";
                  html += `<td title="${sanitize(wp)}">${sanitize(wp)}</td>`;

                  for (let i = 0; i < headerMonthNames.length; i++) {
                    const m = i + 1;
                    const mv = (r.monthValues && (r.monthValues[m] ?? r.monthValues[String(m)])) || 0;
                    html += `<td>${mv > 0 ? Number(mv).toFixed(2) : ""}</td>`;
                  }

                  trDet.innerHTML = html;
                  anchor.insertAdjacentElement('afterend', trDet);
                  anchor = trDet; // <- ahora sí, avanzamos el ancla para la siguiente fila
                });

                if (rows.length === 0) {
                  const empty = document.createElement('tr');
                  empty.className = 'person-details';
                  empty.innerHTML = `<td colspan="${totalCols}">
                      <div class="p-2 text-muted">No assigned efforts for this year.</div>
                    </td>`;
                  personRow.insertAdjacentElement('afterend', empty);
                }

              } catch (e) {
                ph.innerHTML = `<td colspan="${totalCols}">
                    <div class="p-2 text-danger">Error loading breakdown: ${e.message}</div>
                  </td>`;
              }
            });
          });

          function sanitize(str) {
            if (str == null) return "";
            return String(str)
              .replace(/&/g, "&amp;").replace(/</g, "&lt;")
              .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }
        })();
    </script>
}

<style>
    .global-hours-table th,
    .global-hours-table td {
        box-sizing: border-box;
        border-right: 1px solid #dee2e6;
    }

    /* Contenedor con scroll */
    .scrollable-table-container {
        overflow: auto;
        max-height: 1000px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    /* Cabecera fija */
    .global-hours-table thead th {
        position: sticky;
        top: 0;
        background-color: #003366;
        color: white;
        z-index: 20;
        text-align: center;
        vertical-align: middle;
        height: 50px;
    }

    /* Celdas estándar */
    .global-hours-table td,
    .global-hours-table th {
        min-width: 100px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }

        /* Columna 1: Person */
        .global-hours-table th:first-child,
        .global-hours-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 15;
            width: 220px;
            min-width: 220px;
            max-width: 220px;
        }

        /* Columna 2: Department */
        .global-hours-table th:nth-child(2),
        .global-hours-table td:nth-child(2) {
            position: sticky;
            left: 220px;
            background-color: #f8f9fa;
            z-index: 15;
            width: 180px;
            min-width: 180px;
            max-width: 180px;
        }

        /* Columna 3: Group */
        .global-hours-table th:nth-child(3),
        .global-hours-table td:nth-child(3) {
            position: sticky;
            left: 400px; /* 220 + 180 */
            background-color: #f8f9fa;
            z-index: 15;
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    /* Unifica color de cabecera en las tres primeras columnas */
    .global-hours-table thead th:first-child,
    .global-hours-table thead th:nth-child(2),
    .global-hours-table thead th:nth-child(3) {
        background-color: #003366;
        color: white;
        z-index: 25;
    }

    /* Alternancia de filas */
    .global-hours-table tbody tr:nth-child(even):not(.person-details) {
        background-color: #f2f2f2;
    }

    /* Colores condicionales suaves para effort */
    .global-hours-table td.effort-match {
        background-color: #d4edda !important; /* verde claro */
        color: #155724 !important;
    }

    .global-hours-table td.effort-over {
        background-color: #fff3cd !important; /* amarillo claro */
        color: #856404 !important;
    }

    .global-hours-table td.effort-under {
        background-color: #d1ecf1 !important; /* azul claro */
        color: #0c5460 !important;
    }

    /* ---- Estilos del bloque expandido ---- */
    .person-details td {
        background: #fbfbfb;
        border-top: none;
        padding: 0 !important;
    }

    .person-breakdown-table thead th {
        background-color: #e9f0fb;
    }
</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Tools\GlobalHours.cshtml -----
@model TRS2._0.Models.ViewModels.ToolsViewModel

@{
    ViewData["Title"] = "Global Hours";
    var year = Model.Year;
    var entries = Model.GlobalHours.Entries;
}

<div class="container-fluid mt-3">
    <h2 class="text-center fw-bold">
        Global Hours — @Model.Year
        <div class="d-flex justify-content-center align-items-center gap-3 mt-2">
            <a class="btn btn-primary" asp-action="GlobalHours" asp-route-year="@(Model.Year - 1)">
                ← @(@Model.Year - 1)
            </a>
            <span class="btn btn-outline-dark disabled">@Model.Year</span>
            <a class="btn btn-primary" asp-action="GlobalHours" asp-route-year="@(Model.Year + 1)">
                @(@Model.Year + 1) →
            </a>
            <input type="text" id="searchByPerson" class="form-control bg-white text-dark"
                   placeholder="Search by surname..." style="max-width: 250px;" />
            <button class="btn btn-success" onclick="downloadCSV()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
    </h2>


<div class="table-responsive scrollable-table-container mt-4">
    <table class="table table-bordered table-hover table-sm global-hours-table">
        <thead class="thead-dark">
            <tr>
                <th>Person</th>
                <th>Department</th>
                <th>Group</th>
                @foreach (var month in Model.GlobalHours.Entries.First().MonthlyHours.Keys)
                {
                    <th>@month</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var row in Model.GlobalHours.Entries)
            {
                    <tr data-name="@row.PersonName.ToLower()" data-surname="@row.PersonName.Split(',')[0].Trim().ToLower()">
                    <td class="fw-bold">@row.PersonName</td>
                    <td>@row.Department</td>
                        <td title="@row.Group">@row.Group</td>
                    @foreach (var val in row.MonthlyHours.Values)
                    {
                        <td>@val.ToString("0.00")</td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>
</div>


@section Scripts {
    <script>
        // Filtro en tiempo real por apellido o nombre
        document.getElementById('searchByPerson').addEventListener('input', function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('.global-hours-table tbody tr').forEach(row => {
                const surname = row.getAttribute('data-surname');
                const fullname = row.getAttribute('data-name');
                const visible = surname.includes(search) || fullname.includes(search);
                row.style.display = visible ? '' : 'none';
            });
        });

        // Exportación CSV con coma decimal y punto y coma separador
        function downloadCSV() {
            let csvBody = "";

            const headerRow = ["Person", "Department", "Group"];
            document.querySelectorAll(".global-hours-table thead th")
                .forEach((th, index) => {
                    if (index >= 3) {
                        headerRow.push(th.innerText.trim());
                    }
                });
            csvBody += headerRow.join(";") + "\r\n";

            document.querySelectorAll(".global-hours-table tbody tr")
                .forEach(row => {
                    const cols = row.querySelectorAll("td");
                    const rowData = [];

                    cols.forEach((td, index) => {
                        let value = td.innerText.trim();
                        if (!isNaN(value) && value.includes(".")) {
                            value = value.replace(".", ",");
                        }
                        value = value.replace(/(\r\n|\n|\r)/gm, "");
                        rowData.push(value);
                    });

                    csvBody += rowData.join(";") + "\r\n";
                });

            const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csvBody);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Global_Hours.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
}

<style>
    .global-hours-table th,
    .global-hours-table td {
        box-sizing: border-box;
        border-right: 1px solid #dee2e6;
    }


    /* Contenedor con scroll */
    .scrollable-table-container {
        overflow: auto;
        max-height: 1000px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    /* Cabecera fija */
    .global-hours-table thead th {
        position: sticky;
        top: 0;
        background-color: #003366;
        color: white;
        z-index: 20;
        text-align: center;
        vertical-align: middle;
        height: 50px;
    }

    /* Celdas estándar */
    .global-hours-table td,
    .global-hours-table th {
        min-width: 100px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }

        /* Columna 1: Person */
        .global-hours-table th:first-child,
        .global-hours-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 15;
            width: 220px;
            min-width: 220px;
            max-width: 220px;
        }

        /* Columna 2: Department */
        .global-hours-table th:nth-child(2),
        .global-hours-table td:nth-child(2) {
            position: sticky;
            left: 220px;
            background-color: #f8f9fa;
            z-index: 15;
            width: 180px;
            min-width: 180px;
            max-width: 180px;
        }

        /* Columna 3: Group */
        .global-hours-table th:nth-child(3),
        .global-hours-table td:nth-child(3) {
            position: sticky;
            left: 400px; /* 220 + 180 */
            background-color: #f8f9fa;
            z-index: 15;
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }


    /* Unifica color de cabecera en las tres primeras columnas */
    .global-hours-table thead th:first-child,
    .global-hours-table thead th:nth-child(2),
    .global-hours-table thead th:nth-child(3) {
        background-color: #003366; /* mismo azul que el resto de la cabecera */
        color: white;
        z-index: 25;
    }

    /* Alternancia de filas */
    .global-hours-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }


</style>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Wps\Create.cshtml -----
@model TRS2._0.Models.DataModels.Wp

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Wp</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="ProjId" class="control-label"></label>
                <select asp-for="ProjId" class ="form-control" asp-items="ViewBag.ProjId"></select>
            </div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="StartDate" class="control-label"></label>
                <input asp-for="StartDate" class="form-control" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndDate" class="control-label"></label>
                <input asp-for="EndDate" class="form-control" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pms" class="control-label"></label>
                <input asp-for="Pms" class="form-control" />
                <span asp-validation-for="Pms" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Wps\Delete.cshtml -----
@model TRS2._0.Models.DataModels.Wp

@{
    ViewData["Title"] = "Delete";
}

<h1>Delete</h1>

<h3>Are you sure you want to delete this?</h3>
<div>
    <h4>Wp</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.StartDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.StartDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.EndDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.EndDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Pms)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Pms)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Proj)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Proj.ProjId)
        </dd>
    </dl>
    
    <form asp-action="Delete">
        <input type="hidden" asp-for="Id" />
        <input type="submit" value="Delete" class="btn btn-danger" /> |
        <a asp-action="Index">Back to List</a>
    </form>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Wps\Details.cshtml -----
@model TRS2._0.Models.DataModels.Wp

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Wp</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.StartDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.StartDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.EndDate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.EndDate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Pms)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Pms)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Proj)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Proj.ProjId)
        </dd>
    </dl>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Wps\Edit.cshtml -----
@model TRS2._0.Models.DataModels.Wp

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Wp</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            <div class="form-group">
                <label asp-for="ProjId" class="control-label"></label>
                <select asp-for="ProjId" class="form-control" asp-items="ViewBag.ProjId"></select>
                <span asp-validation-for="ProjId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="StartDate" class="control-label"></label>
                <input asp-for="StartDate" class="form-control" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="EndDate" class="control-label"></label>
                <input asp-for="EndDate" class="form-control" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pms" class="control-label"></label>
                <input asp-for="Pms" class="form-control" />
                <span asp-validation-for="Pms" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}



----- FILE: C:\Users\premo\source\repos\trs3.0nuevo\TRS2.0\Views\Wps\Index.cshtml -----
@model IEnumerable<TRS2._0.Models.DataModels.Wp>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Title)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.StartDate)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.EndDate)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Pms)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Proj)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Title)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.StartDate)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.EndDate)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Pms)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Proj.ProjId)
            </td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
            </td>
        </tr>
}
    </tbody>
</table>



